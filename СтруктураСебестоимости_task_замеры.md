# Задание: Замеры производительности алгоритма разузлования

## Цель

Определить узкие места в алгоритме разузлования себестоимости для принятия решения о приоритете оптимизаций.

---

## Выбор алгоритма для замеров

| Алгоритм | Параметр | Где добавлять замеры |
|----------|----------|---------------------|
| **Старый** (рекурсивный) | `ИспользоватьПакетнуюОбработку = Ложь` | См. раздел "Старый алгоритм" |
| **Новый** (пакетный) | `ИспользоватьПакетнуюОбработку = Истина` | См. раздел "Новый алгоритм" |

**Рекомендация**: Сначала замерить **старый** алгоритм — он эталонный. Затем замерить **новый** и сравнить.

---

## Что нужно измерить

### 1. Распределение времени по операциям

| Метрика | Описание |
|---------|----------|
| ВремяЗапросов | Суммарное время выполнения запросов `СебестоимостьУзла()` |
| ВремяОбработки | Время обработки результатов в `ОбработатьРезультатыУзла()` |
| ВремяПроверкиЦиклов | Время на проверку циклических зависимостей |
| КоличествоУзловНаУровне | Сколько узлов обрабатывается на каждом уровне |
| ГлубинаДерева | Максимальный уровень разузлования |

### 2. Статистика по данным

| Метрика | Описание |
|---------|----------|
| РазмерПройденныйПуть | Количество строк в таблице ПройденныйПуть |
| КоличествоПроверокЦиклов | Сколько раз выполнялась проверка на цикл |
| КоличествоЗапросов | Общее количество запросов к БД |
| ПовторяющиесяПартии | Партии, которые встречаются более одного раза |

---

## Общий код (для обоих алгоритмов)

### Шаг 0: Инициализация счётчиков

В процедуре `ikon_cost_ПостроитьДеревоСебестоимости` после строки:
```bsl
ПараметрыДерева.Вставить("КоличествоСтрок", 0);
```

Добавить:
```bsl
#Вставка
// === ЗАМЕРЫ ПРОИЗВОДИТЕЛЬНОСТИ ===
ПараметрыДерева.Вставить("Замер_ВремяНачала", ТекущаяУниверсальнаяДатаВМиллисекундах());
ПараметрыДерева.Вставить("Замер_ВремяЗапросов", 0);
ПараметрыДерева.Вставить("Замер_ВремяОбработки", 0);
ПараметрыДерева.Вставить("Замер_ВремяПроверкиЦиклов", 0);
ПараметрыДерева.Вставить("Замер_КоличествоЗапросов", 0);
ПараметрыДерева.Вставить("Замер_КоличествоПроверокЦиклов", 0);
ПараметрыДерева.Вставить("Замер_СтатистикаУровней", Новый Массив);  // для нового алгоритма
ПараметрыДерева.Вставить("Замер_МаксУровень", 0);                   // для старого алгоритма
#КонецВставки
```

---

## Замеры для СТАРОГО алгоритма (рекурсивный)

> **Применяется при**: `ИспользоватьПакетнуюОбработку = Ложь`

Старый алгоритм использует рекурсивную процедуру `РазузловатьУзелДереваСебестоимости`. Замеры добавляются в расширение `ikon_cost_РазузловатьУзелДереваСебестоимости`.

### Шаг С1: Замеры в РазузловатьУзелДереваСебестоимости

В процедуре `ikon_cost_РазузловатьУзелДереваСебестоимости`, найти вызов `СебестоимостьУзла`:

**Найти:**
```bsl
СебестоимостьУзла = СебестоимостьУзла(ПараметрыДерева, ПараметрыУзла, ВыводитьДопРасходы);
```

**Обернуть в замер:**
```bsl
// ЗАМЕР: время запроса
ВремяДоЗапроса = ТекущаяУниверсальнаяДатаВМиллисекундах();
СебестоимостьУзла = СебестоимостьУзла(ПараметрыДерева, ПараметрыУзла, ВыводитьДопРасходы);
Если ПараметрыДерева.Свойство("Замер_ВремяЗапросов") Тогда
    ПараметрыДерева.Замер_ВремяЗапросов = ПараметрыДерева.Замер_ВремяЗапросов 
        + (ТекущаяУниверсальнаяДатаВМиллисекундах() - ВремяДоЗапроса);
    ПараметрыДерева.Замер_КоличествоЗапросов = ПараметрыДерева.Замер_КоличествоЗапросов + 1;
КонецЕсли;
```

### Шаг С2: Замеры проверки циклов

В той же процедуре, найти проверку на цикл:

**Найти:**
```bsl
МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
```

**Обернуть в замер:**
```bsl
// ЗАМЕР: проверка циклов
ВремяДоПроверки = ТекущаяУниверсальнаяДатаВМиллисекундах();
МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
Если ПараметрыДерева.Свойство("Замер_ВремяПроверкиЦиклов") Тогда
    ПараметрыДерева.Замер_ВремяПроверкиЦиклов = ПараметрыДерева.Замер_ВремяПроверкиЦиклов 
        + (ТекущаяУниверсальнаяДатаВМиллисекундах() - ВремяДоПроверки);
    ПараметрыДерева.Замер_КоличествоПроверокЦиклов = ПараметрыДерева.Замер_КоличествоПроверокЦиклов + 1;
КонецЕсли;
```

### Шаг С3: Замер глубины рекурсии

В той же процедуре, после строки:
```bsl
УровеньУзла = ОписаниеПродукции.Уровень + 1;
```

Добавить:
```bsl
// ЗАМЕР: максимальная глубина
Если ПараметрыДерева.Свойство("Замер_МаксУровень") Тогда
    Если УровеньУзла > ПараметрыДерева.Замер_МаксУровень Тогда
        ПараметрыДерева.Замер_МаксУровень = УровеньУзла;
    КонецЕсли;
КонецЕсли;
```

И в Шаге 0 добавить:
```bsl
ПараметрыДерева.Вставить("Замер_МаксУровень", 0);
```

---

## Замеры для НОВОГО алгоритма (пакетный)

> **Применяется при**: `ИспользоватьПакетнуюОбработку = Истина`

### Шаг Н1: Замеры в РазузловатьУзлыПакетом

В функции `РазузловатьУзлыПакетом`, заменить цикл обработки узлов:

**Было:**
```bsl
Для Каждого Узел Из УзлыДляОбработки Цикл
    // ...
    СебестоимостьУзла = СебестоимостьУзла(ПараметрыДерева, Узел.ПараметрыУзла, ВыводитьДопРасходы);
    // ...
    ОбработатьРезультатыУзла(ПараметрыДерева, Узел, СебестоимостьУзла, ПройденныйПуть, УзлыСледующегоУровня);
КонецЦикла;
```

**Стало:**
```bsl
Для Каждого Узел Из УзлыДляОбработки Цикл
    // ...
    
    // ЗАМЕР: время запроса
    ВремяДоЗапроса = ТекущаяУниверсальнаяДатаВМиллисекундах();
    СебестоимостьУзла = СебестоимостьУзла(ПараметрыДерева, Узел.ПараметрыУзла, ВыводитьДопРасходы);
    ПараметрыДерева.Замер_ВремяЗапросов = ПараметрыДерева.Замер_ВремяЗапросов 
        + (ТекущаяУниверсальнаяДатаВМиллисекундах() - ВремяДоЗапроса);
    ПараметрыДерева.Замер_КоличествоЗапросов = ПараметрыДерева.Замер_КоличествоЗапросов + 1;
    
    // ЗАМЕР: время обработки
    ВремяДоОбработки = ТекущаяУниверсальнаяДатаВМиллисекундах();
    ОбработатьРезультатыУзла(ПараметрыДерева, Узел, СебестоимостьУзла, ПройденныйПуть, УзлыСледующегоУровня);
    ПараметрыДерева.Замер_ВремяОбработки = ПараметрыДерева.Замер_ВремяОбработки 
        + (ТекущаяУниверсальнаяДатаВМиллисекундах() - ВремяДоОбработки);
КонецЦикла;
```

### Шаг Н2: Замеры проверки циклов

В процедуре `ОбработатьРезультатыУзла`, найти строку:
```bsl
МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
```

Обернуть её в замер:
```bsl
// ЗАМЕР: проверка циклов
ВремяДоПроверки = ТекущаяУниверсальнаяДатаВМиллисекундах();
МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
ПараметрыДерева.Замер_ВремяПроверкиЦиклов = ПараметрыДерева.Замер_ВремяПроверкиЦиклов 
    + (ТекущаяУниверсальнаяДатаВМиллисекундах() - ВремяДоПроверки);
ПараметрыДерева.Замер_КоличествоПроверокЦиклов = ПараметрыДерева.Замер_КоличествоПроверокЦиклов + 1;
```

### Шаг Н3: Статистика по уровням

В процедуре `ikon_cost_ЗаполнитьДеревоСебестоимости`, в цикле обработки уровней, после строки:
```bsl
УзлыТекущегоУровня = УзлыСледующегоУровня;
НомерУровня = НомерУровня + 1;
```

Добавить:
```bsl
// ЗАМЕР: статистика уровня
Если ПараметрыДерева.Свойство("Замер_СтатистикаУровней") Тогда
    СтатистикаУровня = Новый Структура;
    СтатистикаУровня.Вставить("НомерУровня", НомерУровня - 1);
    СтатистикаУровня.Вставить("КоличествоУзлов", УзлыСледующегоУровня.Количество());
    СтатистикаУровня.Вставить("РазмерПройденныйПуть", ПройденныйПуть.Количество());
    ПараметрыДерева.Замер_СтатистикаУровней.Добавить(СтатистикаУровня);
КонецЕсли;
```

---

## Вывод результатов (общий для обоих алгоритмов)

### Шаг Ф: Вывод итоговых результатов

В процедуре `ikon_cost_ПостроитьДеревоСебестоимости`, перед строкой:
```bsl
ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(Замер, ...);
```

Добавить:
```bsl
#Вставка
// === ВЫВОД РЕЗУЛЬТАТОВ ЗАМЕРОВ ===
Если ПараметрыДерева.Свойство("Замер_ВремяНачала") Тогда
    
    ВремяОбщее = ТекущаяУниверсальнаяДатаВМиллисекундах() - ПараметрыДерева.Замер_ВремяНачала;
    ВремяПрочее = ВремяОбщее - ПараметрыДерева.Замер_ВремяЗапросов 
        - ПараметрыДерева.Замер_ВремяОбработки;
    
    ПроцентЗапросов = ?(ВремяОбщее > 0, 
        Окр(ПараметрыДерева.Замер_ВремяЗапросов / ВремяОбщее * 100, 1), 0);
    ПроцентОбработки = ?(ВремяОбщее > 0, 
        Окр(ПараметрыДерева.Замер_ВремяОбработки / ВремяОбщее * 100, 1), 0);
    ПроцентЦиклов = ?(ВремяОбщее > 0, 
        Окр(ПараметрыДерева.Замер_ВремяПроверкиЦиклов / ВремяОбщее * 100, 1), 0);
    
    // Определяем тип алгоритма
    ИспользуетсяПакетныйАлгоритм = ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
        И ПараметрыДерева.ИспользоватьПакетнуюОбработку;
    ТипАлгоритма = ?(ИспользуетсяПакетныйАлгоритм, "НОВЫЙ (пакетный)", "СТАРЫЙ (рекурсивный)");
    
    ТекстЗамера = "
|=== ЗАМЕРЫ ПРОИЗВОДИТЕЛЬНОСТИ ===
|Алгоритм: " + ТипАлгоритма + "
|Общее время: " + Строка(ВремяОбщее) + " мс
|
|ВРЕМЯ ПО ОПЕРАЦИЯМ:
|  Запросы к БД:      " + Строка(ПараметрыДерева.Замер_ВремяЗапросов) + " мс (" + Строка(ПроцентЗапросов) + "%)
|  Обработка:         " + Строка(ПараметрыДерева.Замер_ВремяОбработки) + " мс (" + Строка(ПроцентОбработки) + "%)
|  Проверка циклов:   " + Строка(ПараметрыДерева.Замер_ВремяПроверкиЦиклов) + " мс (" + Строка(ПроцентЦиклов) + "%)
|  Прочее:            " + Строка(ВремяПрочее) + " мс
|
|СТАТИСТИКА:
|  Запросов к БД:     " + Строка(ПараметрыДерева.Замер_КоличествоЗапросов) + "
|  Проверок циклов:   " + Строка(ПараметрыДерева.Замер_КоличествоПроверокЦиклов);
    
    // Статистика по уровням (только для нового алгоритма)
    Если ПараметрыДерева.Свойство("Замер_СтатистикаУровней") 
        И ПараметрыДерева.Замер_СтатистикаУровней.Количество() > 0 Тогда
        
        ТекстЗамера = ТекстЗамера + "
|  Уровней дерева:    " + Строка(ПараметрыДерева.Замер_СтатистикаУровней.Количество());
        
        Для Каждого СтатУровня Из ПараметрыДерева.Замер_СтатистикаУровней Цикл
            ТекстЗамера = ТекстЗамера + "
|    Уровень " + Строка(СтатУровня.НомерУровня) + ": узлов=" + Строка(СтатУровня.КоличествоУзлов) 
                + ", ПройденныйПуть=" + Строка(СтатУровня.РазмерПройденныйПуть);
        КонецЦикла;
    КонецЕсли;
    
    // Максимальный уровень (только для старого алгоритма)
    Если ПараметрыДерева.Свойство("Замер_МаксУровень") Тогда
        ТекстЗамера = ТекстЗамера + "
|  Макс. глубина:     " + Строка(ПараметрыДерева.Замер_МаксУровень);
    КонецЕсли;
    
    ЗаписьЖурналаРегистрации(
        "СтруктураСебестоимости.ЗАМЕРЫ",
        УровеньЖурналаРегистрации.Информация,
        ,
        ,
        ТекстЗамера);
        
КонецЕсли;
#КонецВставки
```

---

## Как провести замеры

### Для СТАРОГО алгоритма:
1. Установить `ИспользоватьПакетнуюОбработку = Ложь` в `ikon_cost_ПараметрыДереваСебестоимости`
2. Внести изменения согласно шагам: **0**, **С1**, **С2**, **С3**, **Ф**
3. Загрузить расширение в тестовую базу
4. Выполнить формирование отчёта о себестоимости за период с 01.01.2025 по 31.12.2025
5. Открыть журнал регистрации и найти событие `СтруктураСебестоимости.ЗАМЕРЫ`
6. Сохранить результаты как **"Замеры_СТАРЫЙ.txt"**

### Для НОВОГО алгоритма:
1. Установить `ИспользоватьПакетнуюОбработку = Истина` в `ikon_cost_ПараметрыДереваСебестоимости`
2. Внести изменения согласно шагам: **0**, **Н1**, **Н2**, **Н3**, **Ф**
3. Загрузить расширение в тестовую базу
4. Выполнить формирование отчёта о себестоимости за период с 01.01.2025 по 31.12.2025
5. Открыть журнал регистрации и найти событие `СтруктураСебестоимости.ЗАМЕРЫ`
6. Сохранить результаты как **"Замеры_НОВЫЙ.txt"**

---

## Ожидаемый формат результатов

### Старый алгоритм:
```
=== ЗАМЕРЫ ПРОИЗВОДИТЕЛЬНОСТИ ===
Алгоритм: СТАРЫЙ (рекурсивный)
Общее время: 45000 мс

ВРЕМЯ ПО ОПЕРАЦИЯМ:
  Запросы к БД:      38000 мс (84%)
  Обработка:         5000 мс (11%)
  Проверка циклов:   1500 мс (3%)
  Прочее:            500 мс

СТАТИСТИКА:
  Запросов к БД:     1250
  Проверок циклов:   8500
  Макс. глубина:     5
```

### Новый алгоритм:
```
=== ЗАМЕРЫ ПРОИЗВОДИТЕЛЬНОСТИ ===
Алгоритм: НОВЫЙ (пакетный)
Общее время: 42000 мс

ВРЕМЯ ПО ОПЕРАЦИЯМ:
  Запросы к БД:      35000 мс (83%)
  Обработка:         5500 мс (13%)
  Проверка циклов:   1200 мс (3%)
  Прочее:            300 мс

СТАТИСТИКА:
  Запросов к БД:     1250
  Проверок циклов:   8500
  Уровней дерева:    5
    Уровень 1: узлов=150, ПройденныйПуть=150
    Уровень 2: узлов=450, ПройденныйПуть=600
    Уровень 3: узлов=380, ПройденныйПуть=980
    Уровень 4: узлов=220, ПройденныйПуть=1200
    Уровень 5: узлов=50, ПройденныйПуть=1250
```

---

## Сравнение алгоритмов

После получения замеров обоих алгоритмов заполните таблицу:

| Метрика | Старый | Новый | Разница |
|---------|--------|-------|---------|
| Общее время (мс) | | | |
| Время запросов (мс) | | | |
| Количество запросов | | | |
| Время на запрос (мс) | | | |
| Время проверки циклов (мс) | | | |
| Проверок циклов | | | |

**Формулы:**
- Время на запрос = Время запросов / Количество запросов
- Разница = (Старый - Новый) / Старый × 100%

---

## Интерпретация результатов

| Показатель | Значение | Рекомендация |
|------------|----------|--------------|
| Запросы > 70% времени | ✅ | Приоритет: **Оптимизация 1** (пакетные запросы) |
| Узлов на уровне > 50 | ✅ | Приоритет: **Оптимизация 1** |
| ПройденныйПуть > 1000 | ✅ | Приоритет: **Оптимизация 2** (Соответствие) |
| Проверка циклов > 10% | ✅ | Приоритет: **Оптимизация 2** |
| КоличествоЗапросов ≈ КоличествоУзлов | ✅ | Подтверждает N+1 проблему |
| Новый медленнее Старого | ⚠️ | Возможно, накладные расходы на структуры данных |

---

## После замеров

1. Сохранить результаты обоих алгоритмов
2. Заполнить таблицу сравнения
3. Перейти к файлу `СтруктураСебестоимости_task_оптимизация.md`
4. Выбрать оптимизацию на основе результатов замеров
