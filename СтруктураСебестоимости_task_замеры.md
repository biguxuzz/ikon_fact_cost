# Задание: Замеры производительности алгоритма разузлования

## Цель

Определить узкие места в алгоритме разузлования себестоимости для принятия решения о приоритете оптимизаций.

---

## Общие требования

### Точность измерений
- Минимальная единица измерения времени в 1С — **секунда**
- Для получения достоверных данных рекомендуется тестировать на периоде с большим объёмом данных (например, год)
- Каждый замер повторить **3 раза** и взять среднее значение

### Тестовые данные
- Период: с 01.01.2025 по 31.12.2025 (или другой репрезентативный период)
- База: тестовая копия рабочей базы
- Условия: одинаковые для обоих алгоритмов (никаких других пользователей, одинаковый набор данных)

---

## Алгоритмы для сравнения

| Алгоритм | Параметр в коде | Описание |
|----------|-----------------|----------|
| **Старый** | `ИспользоватьПакетнуюОбработку = Ложь` | Рекурсивный, эталонный |
| **Новый** | `ИспользоватьПакетнуюОбработку = Истина` | Пакетный, оптимизируемый |

**Рекомендация**: Сначала замерить **старый** алгоритм — он эталонный и работает корректно.

---

## Что нужно измерить

### 1. Общее время выполнения

| Метрика | Описание | Как получить |
|---------|----------|--------------|
| **Общее время** | Время от начала до конца построения дерева себестоимости | Засечь время в начале и конце процедуры `ПостроитьДеревоСебестоимости` |

### 2. Распределение времени по операциям

| Метрика | Описание | Где замерять |
|---------|----------|--------------|
| **Время запросов к БД** | Суммарное время выполнения функции `СебестоимостьУзла` | Обернуть каждый вызов `СебестоимостьУзла` в замер |
| **Время обработки результатов** | Время обработки данных после запроса | Замерить время выполнения кода после получения результата запроса |
| **Время проверки циклов** | Время поиска в таблице `ПройденныйПуть` | Обернуть вызовы `ПройденныйПуть.НайтиСтроки()` |

### 3. Статистика по данным

| Метрика | Описание | Как получить |
|---------|----------|--------------|
| **Количество запросов к БД** | Сколько раз вызывалась `СебестоимостьУзла` | Счётчик при каждом вызове |
| **Количество проверок циклов** | Сколько раз искали в `ПройденныйПуть` | Счётчик при каждом поиске |
| **Размер ПройденныйПуть** | Количество строк в таблице в конце обработки | Вывести `ПройденныйПуть.Количество()` |
| **Максимальная глубина** | Максимальный уровень разузлования | Отслеживать максимальное значение `УровеньУзла` |

### 4. Статистика по уровням (только для нового алгоритма)

| Метрика | Описание |
|---------|----------|
| **Количество узлов на уровне** | Сколько узлов обрабатывается на каждом уровне дерева |
| **Размер ПройденныйПуть на уровне** | Как растёт таблица от уровня к уровню |

---

## Места добавления замеров

### Для обоих алгоритмов

| Место | Что добавить |
|-------|--------------|
| Начало `ikon_cost_ПостроитьДеревоСебестоимости` | Инициализация счётчиков и переменной начала замера |
| Конец `ikon_cost_ПостроитьДеревоСебестоимости` | Вывод результатов в журнал регистрации |

### Для старого алгоритма (рекурсивный)

| Место | Что замерять |
|-------|--------------|
| `ikon_cost_РазузловатьУзелДереваСебестоимости`: вызов `СебестоимостьУзла` | Время запроса, счётчик запросов |
| `ikon_cost_РазузловатьУзелДереваСебестоимости`: вызов `НайтиСтроки` | Время проверки циклов, счётчик проверок |
| `ikon_cost_РазузловатьУзелДереваСебестоимости`: после расчёта `УровеньУзла` | Максимальная глубина |

### Для нового алгоритма (пакетный)

| Место | Что замерять |
|-------|--------------|
| `РазузловатьУзлыПакетом`: вызов `СебестоимостьУзла` | Время запроса, счётчик запросов |
| `РазузловатьУзлыПакетом`: вызов `ОбработатьРезультатыУзла` | Время обработки |
| `ОбработатьРезультатыУзла`: вызов `НайтиСтроки` | Время проверки циклов, счётчик проверок |
| `ikon_cost_ЗаполнитьДеревоСебестоимости`: после обработки уровня | Статистика по уровням |

---

## Формат вывода результатов

Результаты выводить в **журнал регистрации** с событием `СтруктураСебестоимости.ЗАМЕРЫ` с важностью Предупреждение.

### Обязательные данные в выводе

```
Алгоритм: [СТАРЫЙ/НОВЫЙ]
Общее время: X сек

ВРЕМЯ ПО ОПЕРАЦИЯМ:
  Запросы к БД: X сек (X%)
  Обработка: X сек (X%)
  Проверка циклов: X сек (X%)

СТАТИСТИКА:
  Запросов к БД: X
  Проверок циклов: X
  Размер ПройденныйПуть: X строк
  Макс. глубина: X уровней
```

### Дополнительно для нового алгоритма

```
СТАТИСТИКА ПО УРОВНЯМ:
  Уровень 1: узлов=X, ПройденныйПуть=X
  Уровень 2: узлов=X, ПройденныйПуть=X
  ...
```

---

## Порядок проведения замеров

### Этап 1: Замер старого алгоритма

1. Установить параметр `ИспользоватьПакетнуюОбработку = Ложь`
2. Добавить код замеров в соответствующие места
3. Загрузить расширение в тестовую базу
4. Выполнить формирование отчёта о себестоимости
5. Записать результаты из журнала регистрации
6. Повторить пункты 4-5 ещё 2 раза
7. Вычислить средние значения

### Этап 2: Замер нового алгоритма

1. Установить параметр `ИспользоватьПакетнуюОбработку = Истина`
2. Добавить код замеров в соответствующие места (дополнительные для нового алгоритма)
3. Загрузить расширение в тестовую базу
4. Выполнить формирование отчёта о себестоимости
5. Записать результаты из журнала регистрации
6. Повторить пункты 4-5 ещё 2 раза
7. Вычислить средние значения

---

## Таблица для записи результатов

### Сырые данные (3 замера)

| Метрика | Старый (1) | Старый (2) | Старый (3) | Новый (1) | Новый (2) | Новый (3) |
|---------|------------|------------|------------|-----------|-----------|-----------|
| Общее время (сек) | | | | | | |
| Время запросов (сек) | | | | | | |
| Время обработки (сек) | | | | | | |
| Время проверки циклов (сек) | | | | | | |
| Количество запросов | | | | | | |
| Количество проверок циклов | | | | | | |
| Размер ПройденныйПуть | | | | | | |
| Макс. глубина | | | | | | |

### Средние значения и сравнение

| Метрика | Старый (среднее) | Новый (среднее) | Разница |
|---------|------------------|-----------------|---------|
| Общее время (сек) | | | |
| Время запросов (сек) | | | |
| Время обработки (сек) | | | |
| Время проверки циклов (сек) | | | |
| Количество запросов | | | |
| Время на 1 запрос (сек) | | | |
| Проверок циклов | | | |

**Формулы:**
- Время на 1 запрос = Время запросов / Количество запросов
- Разница = (Старый - Новый) / Старый × 100%

---

## Интерпретация результатов

| Показатель | Если да | Вывод |
|------------|---------|-------|
| Запросы занимают > 70% времени | ✅ | Приоритет: оптимизация запросов (пакетные запросы) |
| Количество запросов ≈ количеству узлов | ✅ | Подтверждает проблему N+1 |
| Проверка циклов занимает > 10% времени | ✅ | Приоритет: оптимизация `ПройденныйПуть` (замена на `Соответствие`) |
| Размер ПройденныйПуть > 1000 строк | ✅ | Приоритет: оптимизация `ПройденныйПуть` |
| Новый алгоритм медленнее старого | ⚠️ | Накладные расходы на структуры данных перевешивают выгоду |
| На каком-то уровне резкий рост узлов | ⚠️ | Возможно "взрыв" полуфабрикатов — точка для оптимизации |

---

## После замеров

1. Заполнить таблицы результатов
2. Проанализировать по критериям интерпретации
3. Перейти к файлу `СтруктураСебестоимости_task_оптимизация.md`
4. Выбрать приоритетную оптимизацию на основе результатов
