# Результаты замеров производительности алгоритма разузлования

## Сводка результатов

### Версия v0.1.0.48 (исправлена)

| Метрика | Старый | Новый | Разница | Статус |
|---------|--------|-------|---------|--------|
| **Итоговая стоимость** | 2 758 680,13 ₽ | 2 758 680,13 ₽ | 0 ₽ | ✅ |
| **Общее время** | 40 сек | 53 сек | +13 сек (+32,5%) | ⚠️ |
| **Время запросов** | 39 сек (97,5%) | 47 сек (88,7%) | +8 сек (+20,5%) | ⚠️ |
| **Время обработки** | 0 сек | 6 сек (11,3%) | +6 сек | ⚠️ |
| **Количество запросов** | 47 | 47 | 0 | ⚠️ |
| **Проверок циклов** | 13 | 13 | 0 | — |
| **Макс. глубина** | 7 | 7 | 0 | — |

### Версия v0.1.0.35 (с проблемой)

| Метрика | Старый | Новый | Разница | Статус |
|---------|--------|-------|---------|--------|
| **Итоговая стоимость** | 2 758 680,13 ₽ | 2 743 789,88 ₽ | -14 890,25 ₽ | ❌ |
| **Общее время** | 40 сек | 33 сек | -7 сек (-17,5%) | ✅ |
| **Время запросов** | 39 сек (97,5%) | 29 сек (87,9%) | -10 сек (-25,6%) | ✅ |
| **Время обработки** | 0 сек | 2 сек (6,1%) | +2 сек | ⚠️ |
| **Количество запросов** | 47 | 47 | 0 | ⚠️ |
| **Проверок циклов** | 13 | 13 | 0 | — |
| **Макс. глубина** | 7 | 7 | 0 | — |

---

## Детали расхождения

### Проблемная позиция

**Материал**: "(ОЕМ) Каучук натуральный STR 20"

| Показатель | Старый | Новый | Расхождение |
|------------|--------|-------|-------------|
| Количество | 243,043 кг | 243,043 кг | 0 |
| Цена | 229,96 ₽ | 168,69 ₽ | -61,27 ₽ |
| Материальные | 40 999,63 ₽ | 40 999,63 ₽ | 0 |
| **Доп. расходы** | **14 890,25 ₽** | **0 ₽** | **-14 890,25 ₽** |
| Стоимость | 55 889,89 ₽ | 40 999,64 ₽ | -14 890,25 ₽ |

### Диагноз (v0.1.0.35)

Новый алгоритм **НЕ учитывает дополнительные расходы** для данного материала. Вероятная причина — ошибка в условии `ВыводитьДопРасходы`.

### Решение (v0.1.0.48) ✅

**Проблема решена!** Причина была не в условии `ВыводитьДопРасходы`, а в том, что флаги `ТребуетсяРазузлование` и `ТребуетсяРазузлованиеДопРасходов` не сбрасывались для листовых материалов.

**Что было исправлено:**

1. **Добавлена установка `ТребуетсяРазузлование = Ложь`** для листовых материалов (строки 4152-4153 в `Module.bsl`), аналогично старому алгоритму (строка 424 в `СтруктураСебестоимости.bsl`).

2. **Добавлен флаг `ЭтоУзелДляДопРасходов`** при создании дочернего узла (строка 4343-4344), который идентифицирует узлы для дополнительных расходов, не требующих дальнейшего разузлования.

3. **Добавлена логика сброса `ТребуетсяРазузлованиеДопРасходов = Ложь`** в родительской строке (строки 4366-4371), когда узел для доп. расходов не добавляет новых строк. Это полностью реплицирует логику старого алгоритма (строки 533-538 в `СтруктураСебестоимости.bsl`).

**Результат:** Дополнительные расходы для "Каучук натуральный STR 20" теперь корректно учитываются: **14 890,25 ₽** (полностью совпадает со старым алгоритмом).

---

## Статистика по уровням (новый алгоритм)

| Уровень | Количество узлов |
|---------|------------------|
| 1 | 1 |
| 2 | 1 |
| 3 | 5 |
| 4 | 4 |
| 5 | 8 |
| 6 | 12 |
| 7 | 16 |
| **Итого** | **47** |

---

## Анализ производительности

### Распределение времени

| Операция | Старый | Новый |
|----------|--------|-------|
| Запросы к БД | 97,5% | 87,9% |
| Обработка | 0% | 6,1% |
| Прочее | 2,5% | 6,0% |

### Выводы по производительности

1. **Время запросов сократилось на 25,6%** — несмотря на то же количество запросов. Возможно, благодаря отсутствию накладных расходов на рекурсию.

2. **Появилось время обработки (2 сек)** — накладные расходы на управление массивами узлов по уровням.

3. **Количество запросов не изменилось (47)** — пакетная функция `СебестоимостьУзловПакетом` не используется. Потенциал сокращения до 7 запросов (по количеству уровней) не реализован.

---

## История замеров

| Версия | Алгоритм | Стоимость | Время | Запросов | Статус |
|--------|----------|-----------|-------|----------|--------|
| v0.1.0.34 | Старый | 2 758 680,13 ₽ | 40 сек | 47 | Эталон |
| v0.1.0.35 | Новый | 2 743 789,88 ₽ | 33 сек | 47 | ❌ Расхождение |
| v0.1.0.48 | Новый | 2 758 680,13 ₽ | 53 сек | 47 | ✅ Исправлено |
| — | Новый (цель) | 2 758 680,13 ₽ | < 10 сек | 7 | Цель |

---

## Целевые показатели

| Метрика | Текущее (v0.1.0.48) | Цель | Потенциал |
|---------|---------------------|------|-----------|
| Расхождение | **0 ₽** ✅ | **0 ₽** | — |
| Время | 53 сек | **< 10 сек** | -81% |
| Запросов | 47 | **7** | -85% |

---

## Следующие шаги

1. ✅ **ВЫПОЛНЕНО**: Исправить расхождение в дополнительных расходах (v0.1.0.48)
2. Реализовать настоящую пакетную обработку (7 запросов вместо 47)
3. Оптимизировать производительность (сократить время выполнения до < 10 сек)
4. Удалить диагностический код после финального тестирования
