# Задание: Оптимизация алгоритма разузлования

## Результаты анализа замеров

### Что показали замеры

| Факт | Значение | Вывод |
|------|----------|-------|
| Время на запросы к БД | **93-97%** | Единственное узкое место |
| Количество запросов | **47** (одинаково для обоих алгоритмов) | Пакетная обработка НЕ РАБОТАЕТ |
| Время на проверку циклов | **0 сек** | Оптимизация НЕ ТРЕБУЕТСЯ |
| Повторяющиеся партии | **0** (47 запросов = 47 узлов) | Кэширование бесполезно |

### Пересмотренный план оптимизаций

| # | Оптимизация | Статус | Причина |
|---|-------------|--------|---------|
| 1 | **Пакетные запросы** | ✅ ДЕЛАТЬ | Единственное узкое место, потенциал 80% ускорения |
| 2 | Соответствие для ПройденныйПуть | ❌ ОТМЕНИТЬ | Время проверки = 0 сек |
| 3 | Кэширование партий | ❌ ОТМЕНИТЬ | Нет повторяющихся партий |

---

## Оптимизация 1: Пакетные запросы (ЕДИНСТВЕННАЯ)

### Суть проблемы

Функция `РазузловатьУзлыПакетом` **по названию** должна обрабатывать узлы пакетами, но **по факту** выполняет отдельный запрос для каждого узла:

| Текущее поведение | Ожидаемое поведение |
|-------------------|---------------------|
| 47 узлов → 47 запросов | 47 узлов → 7 запросов (по уровням) |
| ~28 сек | ~4-6 сек |

### Что происходит сейчас

| Уровень | Узлов | Запросов (сейчас) | Запросов (должно быть) |
|---------|-------|-------------------|------------------------|
| 1 | 1 | 1 | **1** |
| 2 | 1 | 1 | **1** |
| 3 | 5 | 5 | **1** |
| 4 | 4 | 4 | **1** |
| 5 | 8 | 8 | **1** |
| 6 | 12 | 12 | **1** |
| 7 | 16 | 16 | **1** |
| **Итого** | **47** | **47** | **7** |

### Корень проблемы

В функции `РазузловатьУзлыПакетом` (строки 808-848) есть цикл:

```
Для Каждого Узел Из УзлыДляОбработки Цикл
    СебестоимостьУзла = СебестоимостьУзла(...)  ← ОТДЕЛЬНЫЙ ЗАПРОС!
КонецЦикла
```

При этом функция `СебестоимостьУзловПакетом` (строки 1133-1257) **существует**, но **не используется**.

---

## Что нужно сделать

### Задача 1.1: Интегрировать `СебестоимостьУзловПакетом` в `РазузловатьУзлыПакетом`

**Место**: функция `РазузловатьУзлыПакетом`, строки 808-848

**Текущая логика**:
1. Получаем массив узлов для обработки
2. **Цикл**: для каждого узла вызываем `СебестоимостьУзла()` — N запросов
3. Обрабатываем результаты

**Требуемая логика**:
1. Получаем массив узлов для обработки
2. Фильтруем узлы по глубине рекурсии
3. Собираем параметры **всех** узлов уровня
4. **Один вызов** `СебестоимостьУзловПакетом()` для всех узлов — **1 запрос**
5. Распределяем результаты по узлам
6. Обрабатываем результаты

### Задача 1.2: Доработать `СебестоимостьУзловПакетом`

**Место**: функция `СебестоимостьУзловПакетом`, строки 1133-1257

**Текущее состояние**: Функция существует, но требует анализа:
- Принимает ли она массив параметров узлов?
- Возвращает ли результаты в формате, пригодном для распределения по узлам?
- Как учитываются индивидуальные параметры (`Числитель`, `КоличествоПродукции`)?

**Требуемое**:
1. Проанализировать текущую реализацию
2. При необходимости доработать для поддержки пакетной обработки
3. Обеспечить возврат результатов с привязкой к узлам (ключ → данные)

### Задача 1.3: Создать механизм распределения результатов

**Цель**: После выполнения пакетного запроса нужно распределить общий результат по отдельным узлам

**Требуемое**:
1. Функция формирования уникального ключа узла
2. Соответствие «ключ узла» → «результат запроса»
3. Логика извлечения данных для конкретного узла из общего результата

---

## Ожидаемый результат

### Количественные показатели

| Метрика | До | После | Улучшение |
|---------|-----|-------|-----------|
| Количество запросов | 47 | 7 | **-85%** |
| Время выполнения | ~28 сек | ~4-6 сек | **-80%** |

### Качественные показатели

| Критерий | Требование |
|----------|------------|
| Результат отчёта | Идентичен эталону (старый алгоритм) |
| Ошибки в журнале | Отсутствуют |
| Обнаружение циклов | Работает корректно |

---

## Порядок выполнения

### Этап 1: Анализ существующей функции

| # | Действие |
|---|----------|
| 1 | Изучить функцию `СебестоимостьУзловПакетом` (строки 1133-1257) |
| 2 | Определить её текущие возможности |
| 3 | Составить список необходимых доработок |

### Этап 2: Реализация

| # | Действие |
|---|----------|
| 1 | Доработать `СебестоимостьУзловПакетом` (при необходимости) |
| 2 | Модифицировать `РазузловатьУзлыПакетом` для использования пакетного запроса |
| 3 | Реализовать распределение результатов по узлам |

### Этап 3: Тестирование

| # | Действие |
|---|----------|
| 1 | Загрузить расширение в тестовую базу |
| 2 | Выполнить отчёт и проверить журнал регистрации на ошибки |
| 3 | Сравнить результат с эталоном (старый алгоритм) |
| 4 | Провести замеры производительности |
| 5 | Убедиться, что количество запросов = количеству уровней (7) |

### Этап 4: Фиксация

| # | Действие |
|---|----------|
| 1 | Зафиксировать изменения в git |
| 2 | Обновить файл замеров с новыми результатами |

---

## Риски

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Несовпадение результатов после оптимизации | Средняя | Сравнение с эталоном перед коммитом |
| Сложности с распределением результатов по узлам | Средняя | Детальный анализ структуры данных |
| `СебестоимостьУзловПакетом` не поддерживает нужный функционал | Низкая | Доработка функции |

---

## Критерии успеха

| Метрика | Целевое значение |
|---------|------------------|
| Результат отчёта | Идентичен эталону |
| Количество запросов | **7** (вместо 47) |
| Время выполнения | **< 10 сек** (вместо 28-31) |
| Ошибки в журнале | Отсутствуют |

---

## Отменённые оптимизации

### ~~Оптимизация 2: Соответствие для ПройденныйПуть~~

**Причина отмены**: Замеры показали, что время на проверку циклов = **0 секунд**. При 13 проверках и ~47 записях в таблице текущая реализация через `ТаблицаЗначений.НайтиСтроки()` работает достаточно быстро.

### ~~Оптимизация 3: Кэширование партий~~

**Причина отмены**: Замеры показали, что количество запросов (47) равно количеству узлов (47). Это означает, что **нет повторяющихся партий** — каждая партия запрашивается ровно один раз. Кэширование не даст эффекта.
