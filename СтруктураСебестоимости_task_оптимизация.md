# Задание: Оптимизация алгоритма разузлования

## Текущий статус

### Результаты тестирования (v0.1.0.35)

| Показатель | Старый алгоритм | Новый алгоритм | Статус |
|------------|-----------------|----------------|--------|
| **Итоговая стоимость** | 2 758 680,13 ₽ | 2 743 789,88 ₽ | ❌ **РАСХОЖДЕНИЕ** |
| **Время выполнения** | 40 сек | 33 сек | ✅ -17,5% |
| **Время запросов** | 39 сек | 29 сек | ✅ -25,6% |
| **Количество запросов** | 47 | 47 | ⚠️ Без изменений |

### Выявленная проблема

**Расхождение: -14 890,25 ₽ (-0,54%)**

Проблемная позиция: **"(ОЕМ) Каучук натуральный STR 20"**

| Показатель | Старый | Новый | Проблема |
|------------|--------|-------|----------|
| Материальные | 40 999,63 ₽ | 40 999,63 ₽ | ✅ Совпадает |
| **Доп. расходы** | **14 890,25 ₽** | **0 ₽** | ❌ **ПОТЕРЯНЫ** |
| Стоимость | 55 889,89 ₽ | 40 999,64 ₽ | ❌ Расхождение |

---

## Анализ причины расхождения

### Механизм вывода дополнительных расходов

Дополнительные расходы добавляются в результат через отдельный блок запроса `ТекстДопРасходыОбъединение`, который выполняется **только** если параметр `ВыводитьДопРасходы = Истина`.

### Условие вывода дополнительных расходов

**Старый алгоритм** (строка 3174):
```
ВыводитьДопРасходы = РазворачиватьДопРасходы И НЕ (УровеньУзла = 1)
```
Где `УровеньУзла = ОписаниеПродукции.Уровень + 1`

**Новый алгоритм** (строки 3898-3899, 3941-3942):
```
ВыводитьДопРасходы = РазворачиватьДопРасходы И НЕ (ОписаниеПродукции.Уровень = 0)
```

### Математическая эквивалентность условий

| Старый | Новый | Эквивалентны? |
|--------|-------|---------------|
| `НЕ (УровеньУзла = 1)` | `НЕ (ОписаниеПродукции.Уровень = 0)` | ✅ Да |

Поскольку `УровеньУзла = ОписаниеПродукции.Уровень + 1`, условия **математически эквивалентны**.

### Гипотеза: Проблема в передаче уровня

Условия эквивалентны, **НО** значение `ОписаниеПродукции.Уровень` может отличаться в новом алгоритме из-за ошибки в передаче уровня между уровнями дерева.

#### Как формируется уровень для дочерних узлов

1. При создании узла для следующего уровня (строка 4210):
   - `НовоеОписаниеПродукции.Уровень = УровеньУзла`
   - Где `УровеньУзла = ОписаниеПродукции.Уровень + 1` (строка 3997)

2. Это означает, что для узла на глубине N:
   - `ОписаниеПродукции.Уровень = N - 1`

#### Возможные точки ошибки

| Место | Что может быть неверно |
|-------|------------------------|
| Строка 3544 | При добавлении узла в `УзлыДляПакетнойОбработки` передаётся исходный `ОписаниеПродукции`, а не модифицированный |
| Строка 4210 | При создании `НовоеОписаниеПродукции` уровень устанавливается неверно |
| Строки 3898-3899 | Условие проверяет не тот уровень |

---

## Варианты решения

### Вариант 1: Унификация условия с использованием УровеньУзла

**Суть**: В новом алгоритме уже вычисляется `УровеньУзла` (строка 3877), но в условии используется сырое значение `ОписаниеПродукции.Уровень`. Нужно использовать `УровеньУзла` для единообразия со старым алгоритмом.

**Изменение**: В строках 3898-3899 и 3941-3942 заменить условие:
- **Было**: проверка `ОписаниеПродукции.Уровень = 0`
- **Требуется**: проверка `УровеньУзла = 1` (как в старом алгоритме)

**Преимущества**:
- Полная идентичность логики со старым алгоритмом
- Минимальное изменение

**Риски**: Низкие

### Вариант 2: Диагностика передачи уровня

**Суть**: Добавить диагностический вывод в журнал регистрации для отслеживания значений `ОписаниеПродукции.Уровень` и `УровеньУзла` на каждом этапе обработки.

**Цель**: Найти точку, где уровень начинает отличаться от ожидаемого.

**Что вывести**:
1. При создании узла для пакетной обработки (строка 3544): значение `ОписаниеПродукции.Уровень`
2. При обработке узла (строки 3877, 3929): значения `Узел.ОписаниеПродукции.Уровень` и вычисленный `УровеньУзла`
3. При создании дочернего узла (строка 4210): значение `УровеньУзла`, которое устанавливается в `НовоеОписаниеПродукции`

**Формат диагностики**: Для каждого узла выводить материал/полуфабрикат и его уровень

### Вариант 3: Анализ конкретного материала

**Суть**: Добавить условную диагностику **только** для проблемного материала "(ОЕМ) Каучук натуральный STR 20".

**Что вывести**:
1. На каком уровне находится этот материал
2. Какое значение `ОписаниеПродукции.Уровень` передаётся
3. Какое значение `ВыводитьДопРасходы` получается
4. Вызывается ли блок запроса дополнительных расходов

---

## Рекомендуемый порядок действий

### Этап 1: Быстрое исправление (Вариант 1)

1. Изменить условие определения `ВыводитьДопРасходы` в новом алгоритме на идентичное старому: проверять `УровеньУзла = 1` вместо `ОписаниеПродукции.Уровень = 0`

2. Протестировать на тех же данных

3. Сравнить результаты:
   - Если совпадают — проблема решена
   - Если не совпадают — перейти к Этапу 2

### Этап 2: Детальная диагностика (если Этап 1 не помог)

1. Реализовать Вариант 3 — диагностику для конкретного материала

2. Проанализировать вывод:
   - На каком уровне материал
   - Какие значения передаются

3. На основе диагностики определить точную причину

### Этап 3: Исправление корневой причины

1. По результатам диагностики внести исправления

2. Удалить диагностический код

3. Финальное тестирование

---

## Критерии успеха

| Критерий | Требование |
|----------|------------|
| Итоговая стоимость | **2 758 680,13 ₽** (идентично старому) |
| Расхождение | **0 ₽** |
| Время выполнения | ≤ 35 сек (сохранить улучшение) |
| Ошибки в журнале | Отсутствуют |

---

## Дополнительные наблюдения

### Количество запросов не сократилось

Несмотря на название "пакетный", алгоритм по-прежнему выполняет **47 запросов** (столько же, сколько старый). Это означает, что функция `СебестоимостьУзловПакетом` **не используется** — каждый узел по-прежнему обрабатывается отдельным вызовом `СебестоимостьУзла`.

**Вывод**: После исправления проблемы с дополнительными расходами необходимо реализовать **настоящую** пакетную обработку для достижения целевого показателя (7 запросов вместо 47).

### Улучшение производительности

Несмотря на то же количество запросов, время сократилось на 17,5%. Возможные причины:
- Отсутствие накладных расходов на глубокую рекурсию
- Более эффективное управление памятью при итеративной обработке по уровням

---

## Приоритет задач

| # | Задача | Приоритет | Статус |
|---|--------|-----------|--------|
| 1 | Исправить расхождение в дополнительных расходах | **КРИТИЧЕСКИЙ** | В работе |
| 2 | Реализовать настоящую пакетную обработку (7 запросов) | Высокий | Ожидает |
| 3 | Удалить диагностический код после тестирования | Средний | Ожидает |
