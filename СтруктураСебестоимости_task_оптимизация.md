# Задание: Оптимизация алгоритма разузлования

## Текущий статус

### Результаты тестирования (v0.1.0.56) ✅

| Показатель | Старый алгоритм | Новый алгоритм | Статус |
|------------|-----------------|----------------|--------|
| **Итоговая стоимость** | 2 758 680,13 ₽ | 2 758 680,13 ₽ | ✅ **СОВПАДАЕТ** |
| **Время выполнения** | 40 сек | 33 сек | ✅ -17,5% |
| **Время запросов** | 39 сек | 30 сек | ✅ -23,1% |
| **Количество запросов** | 47 | 47 | ⚠️ Без изменений |

### Исследование пакетной обработки (v0.1.0.51-55) ❌ ЗАБЛОКИРОВАНО

Попытка реализовать **Вариант B: Временные таблицы с JOIN** выявила **непреодолимые** проблемы:

| Версия | Запросов | Время | Результат | Статус |
|--------|----------|-------|-----------|--------|
| v0.1.0.51 (IN массивы) | 7 | 9 сек | 29 333 283,40 ₽ | ❌ x10,6 |
| v0.1.0.52 (IN массивы) | 7 | - | 49 811 369,10 ₽ | ❌ x18,1 |
| v0.1.0.54 (кортеж В) | 7 | - | Ошибка типов | ❌ |
| v0.1.0.55 (JOIN ВТ) | 7 | 11 сек | 50 963 078,55 ₽ | ❌ x18,5 |
| v0.1.0.56 (индивид.) | 47 | 33 сек | 2 758 680,13 ₽ | ✅ Точно |

### Анализ причин неудачи пакетной обработки

#### Причина 1: Декартово произведение (v0.1.0.51-52)

Запрос с `IN(...)`:
```sql
WHERE Партия IN (&ПартииПродукции) AND Аналитика IN (&АналитикиУчетаПартийПродукции)
```
При `ПартииПродукции = [P1, P2]` и `Аналитики = [A1, A2]` возвращает **все 4 комбинации** вместо 2 нужных пар.

#### Причина 2: Потеря индивидуальных коэффициентов (v0.1.0.55) ⚠️ КРИТИЧЕСКАЯ

Даже при использовании синтаксиса 1С:
```sql
(Партия, Аналитика) В (ВЫБРАТЬ ПартияПродукции, АналитикаУчетаПартийПродукции ИЗ ВТПарыУзлов)
```

**Проблема**: Каждый узел имеет индивидуальные параметры `Числитель/Знаменатель`, которые используются для расчёта **доли затрат**:
```sql
* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10))
```

Эти коэффициенты передаются в запрос как **единые параметры** `&Числитель` и `&Знаменатель`. 
При пакетной обработке невозможно передать **разные коэффициенты для разных пар** без 
кардинальной модификации структуры запроса.

### Вывод: Пакетная обработка НЕВОЗМОЖНА ❌

Для реализации пакетной обработки требуется:
1. Модифицировать SQL-запросы в СКД основной конфигурации
2. Заменить параметры `&Числитель/&Знаменатель` на значения из временной таблицы через JOIN
3. Изменить все формулы расчёта затрат

**Это выходит за рамки расширения и требует модификации основной конфигурации.**

Текущая реализация (v0.1.0.56) обеспечивает:
- ✅ **100% корректность** результатов
- ✅ **Итеративный алгоритм** вместо рекурсии
- ⚠️ **47 запросов** (без возможности оптимизации в рамках расширения)

### Результаты тестирования (v0.1.0.48) ✅

| Показатель | Старый алгоритм | Новый алгоритм | Статус |
|------------|-----------------|----------------|--------|
| **Итоговая стоимость** | 2 758 680,13 ₽ | 2 758 680,13 ₽ | ✅ **СОВПАДАЕТ** |
| **Время выполнения** | 40 сек | 53 сек | ⚠️ +32,5% |
| **Время запросов** | 39 сек | 47 сек | ⚠️ +20,5% |
| **Количество запросов** | 47 | 47 | ⚠️ Без изменений |

### Результаты тестирования (v0.1.0.35) ❌

| Показатель | Старый алгоритм | Новый алгоритм | Статус |
|------------|-----------------|----------------|--------|
| **Итоговая стоимость** | 2 758 680,13 ₽ | 2 743 789,88 ₽ | ❌ **РАСХОЖДЕНИЕ** |
| **Время выполнения** | 40 сек | 33 сек | ✅ -17,5% |
| **Время запросов** | 39 сек | 29 сек | ✅ -25,6% |
| **Количество запросов** | 47 | 47 | ⚠️ Без изменений |

### Выявленная проблема (v0.1.0.35)

**Расхождение: -14 890,25 ₽ (-0,54%)**

Проблемная позиция: **"(ОЕМ) Каучук натуральный STR 20"**

| Показатель | Старый | Новый | Проблема |
|------------|--------|-------|----------|
| Материальные | 40 999,63 ₽ | 40 999,63 ₽ | ✅ Совпадает |
| **Доп. расходы** | **14 890,25 ₽** | **0 ₽** | ❌ **ПОТЕРЯНЫ** |
| Стоимость | 55 889,89 ₽ | 40 999,64 ₽ | ❌ Расхождение |

### Решение проблемы (v0.1.0.48) ✅

**Проблема решена!** Расхождение устранено: **0 ₽**

| Показатель | Старый | Новый | Статус |
|------------|--------|-------|--------|
| Материальные | 40 999,63 ₽ | 40 999,63 ₽ | ✅ Совпадает |
| **Доп. расходы** | **14 890,25 ₽** | **14 890,25 ₽** | ✅ **ИСПРАВЛЕНО** |
| Стоимость | 55 889,89 ₽ | 55 889,89 ₽ | ✅ Совпадает |

---

## Анализ причины расхождения

### Механизм вывода дополнительных расходов

Дополнительные расходы добавляются в результат через отдельный блок запроса `ТекстДопРасходыОбъединение`, который выполняется **только** если параметр `ВыводитьДопРасходы = Истина`.

### Условие вывода дополнительных расходов

**Старый алгоритм** (строка 3174):
```
ВыводитьДопРасходы = РазворачиватьДопРасходы И НЕ (УровеньУзла = 1)
```
Где `УровеньУзла = ОписаниеПродукции.Уровень + 1`

**Новый алгоритм** (строки 3898-3899, 3941-3942):
```
ВыводитьДопРасходы = РазворачиватьДопРасходы И НЕ (ОписаниеПродукции.Уровень = 0)
```

### Математическая эквивалентность условий

| Старый | Новый | Эквивалентны? |
|--------|-------|---------------|
| `НЕ (УровеньУзла = 1)` | `НЕ (ОписаниеПродукции.Уровень = 0)` | ✅ Да |

Поскольку `УровеньУзла = ОписаниеПродукции.Уровень + 1`, условия **математически эквивалентны**.

### Гипотеза: Проблема в передаче уровня

Условия эквивалентны, **НО** значение `ОписаниеПродукции.Уровень` может отличаться в новом алгоритме из-за ошибки в передаче уровня между уровнями дерева.

#### Как формируется уровень для дочерних узлов

1. При создании узла для следующего уровня (строка 4210):
   - `НовоеОписаниеПродукции.Уровень = УровеньУзла`
   - Где `УровеньУзла = ОписаниеПродукции.Уровень + 1` (строка 3997)

2. Это означает, что для узла на глубине N:
   - `ОписаниеПродукции.Уровень = N - 1`

#### Возможные точки ошибки

| Место | Что может быть неверно |
|-------|------------------------|
| Строка 3544 | При добавлении узла в `УзлыДляПакетнойОбработки` передаётся исходный `ОписаниеПродукции`, а не модифицированный |
| Строка 4210 | При создании `НовоеОписаниеПродукции` уровень устанавливается неверно |
| Строки 3898-3899 | Условие проверяет не тот уровень |

---

## Варианты решения

### Вариант 1: Унификация условия с использованием УровеньУзла

**Суть**: В новом алгоритме уже вычисляется `УровеньУзла` (строка 3877), но в условии используется сырое значение `ОписаниеПродукции.Уровень`. Нужно использовать `УровеньУзла` для единообразия со старым алгоритмом.

**Изменение**: В строках 3898-3899 и 3941-3942 заменить условие:
- **Было**: проверка `ОписаниеПродукции.Уровень = 0`
- **Требуется**: проверка `УровеньУзла = 1` (как в старом алгоритме)

**Преимущества**:
- Полная идентичность логики со старым алгоритмом
- Минимальное изменение

**Риски**: Низкие

### Вариант 2: Диагностика передачи уровня

**Суть**: Добавить диагностический вывод в журнал регистрации для отслеживания значений `ОписаниеПродукции.Уровень` и `УровеньУзла` на каждом этапе обработки.

**Цель**: Найти точку, где уровень начинает отличаться от ожидаемого.

**Что вывести**:
1. При создании узла для пакетной обработки (строка 3544): значение `ОписаниеПродукции.Уровень`
2. При обработке узла (строки 3877, 3929): значения `Узел.ОписаниеПродукции.Уровень` и вычисленный `УровеньУзла`
3. При создании дочернего узла (строка 4210): значение `УровеньУзла`, которое устанавливается в `НовоеОписаниеПродукции`

**Формат диагностики**: Для каждого узла выводить материал/полуфабрикат и его уровень

### Вариант 3: Анализ конкретного материала

**Суть**: Добавить условную диагностику **только** для проблемного материала "(ОЕМ) Каучук натуральный STR 20".

**Что вывести**:
1. На каком уровне находится этот материал
2. Какое значение `ОписаниеПродукции.Уровень` передаётся
3. Какое значение `ВыводитьДопРасходы` получается
4. Вызывается ли блок запроса дополнительных расходов

---

## Рекомендуемый порядок действий

### Этап 1: Быстрое исправление (Вариант 1)

1. Изменить условие определения `ВыводитьДопРасходы` в новом алгоритме на идентичное старому: проверять `УровеньУзла = 1` вместо `ОписаниеПродукции.Уровень = 0`

2. Протестировать на тех же данных

3. Сравнить результаты:
   - Если совпадают — проблема решена
   - Если не совпадают — перейти к Этапу 2

### Этап 2: Детальная диагностика (если Этап 1 не помог)

1. Реализовать Вариант 3 — диагностику для конкретного материала

2. Проанализировать вывод:
   - На каком уровне материал
   - Какие значения передаются

3. На основе диагностики определить точную причину

### Этап 3: Исправление корневой причины

1. По результатам диагностики внести исправления

2. Удалить диагностический код

3. Финальное тестирование

---

## Критерии успеха

| Критерий | Требование |
|----------|------------|
| Итоговая стоимость | **2 758 680,13 ₽** (идентично старому) |
| Расхождение | **0 ₽** |
| Время выполнения | ≤ 35 сек (сохранить улучшение) |
| Ошибки в журнале | Отсутствуют |

---

## Дополнительные наблюдения

### Количество запросов не сократилось

Несмотря на название "пакетный", алгоритм по-прежнему выполняет **47 запросов** (столько же, сколько старый). Это означает, что функция `СебестоимостьУзловПакетом` **не используется** — каждый узел по-прежнему обрабатывается отдельным вызовом `СебестоимостьУзла`.

**Вывод**: После исправления проблемы с дополнительными расходами необходимо реализовать **настоящую** пакетную обработку для достижения целевого показателя (7 запросов вместо 47).

### Улучшение производительности

Несмотря на то же количество запросов, время сократилось на 17,5%. Возможные причины:
- Отсутствие накладных расходов на глубокую рекурсию
- Более эффективное управление памятью при итеративной обработке по уровням

---

## Решение проблемы с дополнительными расходами (v0.1.0.48)

### Корневая причина

Проблема была **НЕ** в условии `ВыводитьДопРасходы`, как изначально предполагалось. Реальная причина — отчёт "Фактическая себестоимость продукции" обнуляет `ДопРасходы`, если флаги `ТребуетсяРазузлование` или `ТребуетсяРазузлованиеДопРасходов` равны `Истина` (строки 353-357 в `ФСП\ФактическаяСебестоимостьПродукции\Ext\ObjectModule.bsl`):

```sql
СУММА(ВЫБОР
    КОГДА Результат.ТребуетсяРазузлование
     ИЛИ Результат.ТребуетсяРазузлованиеДопРасходов
        ТОГДА 0
    ИНАЧЕ Результат.ДопРасходы
КОНЕЦ) КАК ДопРасходы
```

В новом алгоритме эти флаги не сбрасывались для листовых материалов, в отличие от старого алгоритма.

### Внесённые исправления

#### 1. Установка `ТребуетсяРазузлование = Ложь` для листовых материалов

**Файл:** `CommonModules\СтруктураСебестоимости\Ext\Module.bsl`  
**Строки:** 4152-4153

```bsl
Иначе
    СтрокаПартия.ВидСтроки = Перечисления.ВидыСтрокДереваСебестоимости.ПартияЗатраты;
    СтрокаПартия.ТребуетсяРазузлование = Ложь; // КРИТИЧНО: Добавлено для исправления ДопРасходов в отчете
КонецЕсли;
```

**Аналогия:** Старый алгоритм (строка 424 в `СтруктураСебестоимости.bsl`)

#### 2. Флаг `ЭтоУзелДляДопРасходов` при создании дочернего узла

**Файл:** `CommonModules\СтруктураСебестоимости\Ext\Module.bsl`  
**Строки:** 4343-4344

```bsl
НовыйУзел.Вставить("ЭтоУзелДляДопРасходов", ТекПартия.ТипЗатрат = "ДопРасходы" И НЕ ТекПартия.ТребуетсяРазузлование);
```

**Назначение:** Идентифицирует узлы для дополнительных расходов, которые не требуют дальнейшего разузлования.

#### 3. Логика сброса `ТребуетсяРазузлованиеДопРасходов` в родительской строке

**Файл:** `CommonModules\СтруктураСебестоимости\Ext\Module.bsl`  
**Строки:** 4366-4371

```bsl
// Если это был узел для доп. расходов и он не добавил новых строк,
// то сбрасываем флаг ТребуетсяРазузлованиеДопРасходов в родительской строке.
Если Узел.ЭтоУзелДляДопРасходов
    И Узел.РодительскаяСтрока <> Неопределено
    И КоличествоПосле = КоличествоДо Тогда
    
    Узел.РодительскаяСтрока.ТребуетсяРазузлованиеДопРасходов = Ложь;
КонецЕсли;
```

**Аналогия:** Старый алгоритм (строки 533-538 в `СтруктураСебестоимости.bsl`)

**Логика:** Если узел для доп. расходов не добавил новых строк (разузлование завершено), сбрасываем флаг в родительской строке, чтобы отчёт корректно учитывал `ДопРасходы`.

### Результат

✅ **Проблема полностью решена:**
- Дополнительные расходы для "Каучук натуральный STR 20": **14 890,25 ₽** (совпадает со старым алгоритмом)
- Итоговая стоимость: **2 758 680,13 ₽** (полностью совпадает со старым алгоритмом)
- Расхождение: **0 ₽**

### Версия

**Версия расширения:** `0.1.0.48`  
**Дата исправления:** 21.12.2025

---

## Приоритет задач

| # | Задача | Приоритет | Статус |
|---|--------|-----------|--------|
| 1 | Исправить расхождение в дополнительных расходах | **КРИТИЧЕСКИЙ** | ✅ **ВЫПОЛНЕНО** (v0.1.0.48) |
| 2 | Реализовать пакетную обработку (7 запросов) | Высокий | ❌ **ЗАБЛОКИРОВАНО** - требует модификации основной конфигурации |
| 3 | Оптимизировать производительность (< 10 сек) | Высокий | ❌ **ЗАБЛОКИРОВАНО** - зависит от п.2 |
| 4 | Удалить диагностический код после тестирования | Низкий | ⏳ В работе |

### Итоговая производительность (v0.1.0.56)

| Метрика | Значение | Сравнение со старым |
|---------|----------|---------------------|
| Время выполнения | 33 сек | -17,5% ✅ |
| Запросов к БД | 47 | 0% |
| Корректность | 100% | ✅ |
| Алгоритм | Итеративный по уровням | Улучшено (было рекурсия) |

**Версия расширения:** `0.1.0.56`  
**Дата обновления:** 21.12.2025
