&ИзменениеИКонтроль("ПараметрыДереваСебестоимости")
Функция ikon_cost_ПараметрыДереваСебестоимости() Экспорт
	
	ТипыРезультата = Новый ОписаниеТипов("ДеревоЗначений,ТаблицаЗначений,МенеджерВременныхТаблиц");
	
	ПараметрыДерева = Новый Структура;
	
	ПараметрыДерева.Вставить("ДинамическоеСчитывание",	Истина);
	ПараметрыДерева.Вставить("ТипРезультата",			"ДеревоЗначений");
	ПараметрыДерева.Вставить("Результат",				ТипыРезультата.ПривестиЗначение(Неопределено));
	ПараметрыДерева.Вставить("ДобавлятьПолуфабрикатыВРезультат", Истина);
	
#Вставка
	// === НАСТРОЙКИ ОПТИМИЗАЦИИ И ДИАГНОСТИКИ ===
	
	// Использовать пакетную обработку узлов по уровням (оптимизация N+1)
	// При Истина - узлы обрабатываются пакетами по уровням (быстрее, меньше запросов)
	// При Ложь - классический рекурсивный алгоритм (совместимость)
	ПараметрыДерева.Вставить("ИспользоватьПакетнуюОбработку", Истина);
	
	// Включить диагностические сообщения в журнал регистрации
	// При Истина - выводятся подробные логи обработки (для отладки)
	// При Ложь - диагностика отключена (рекомендуется для продакшена)
	// ПРИМЕЧАНИЕ: Основные "тяжёлые" блоки диагностики (с запросами и циклами) 
	//             обёрнуты в проверку этого флага. Простые записи в журнал 
	//             можно обернуть дополнительно при необходимости.
	ПараметрыДерева.Вставить("ВыводитьДиагностику", Ложь);
	ПараметрыДерева.Вставить("СчётчикДиагностикиПартий", 0); // Счётчик для ограничения вывода
	
	// Тестовая запись в журнал для подтверждения работы расширения
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.ЗАМЕРЫ.ТЕСТ",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		"Расширение ikon_cost применено успешно. Версия 0.1.0.48. Алгоритм: " + ?(ПараметрыДерева.ИспользоватьПакетнуюОбработку, "НОВЫЙ (пакетный)", "СТАРЫЙ (рекурсивный)"));
#КонецВставки

	Возврат ПараметрыДерева;

КонецФункции

&ИзменениеИКонтроль("ТекстЗапросаЗатратыНаПродукцию")
Функция ikon_cost_ТекстЗапросаЗатратыНаПродукцию(ВыводитьДопРасходы)
	
	ТекстыЗапроса = Новый Массив;
	
#Область ТекстМатериальныеЗатраты

	#Область ВыбытиеИзНЗППоПродукции
	ТекстМатериальныеЗатраты =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ) КАК Период,
		|	ВыпущеннаяПродукция.Организация КАК Организация,
		|	ВыпущеннаяПродукция.ПартияПродукции КАК ПартияПродукции,
		|	ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
		|	ВыпущеннаяПродукция.АналитикаУчетаПродукции КАК АналитикаУчетаПродукции,
		|	МАКСИМУМ(ВыпущеннаяПродукция.Числитель) КАК Числитель,
		|	МАКСИМУМ(ВыпущеннаяПродукция.Знаменатель) КАК Знаменатель,
		|	СебестоимостьТоваров.Партия КАК Партия,
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.ВидЗапасов КАК ВидЗапасов,
		|	СУММА(СебестоимостьТоваров.Количество) КАК Количество,
		|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Стоимость
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
		|		КОНЕЦ)												КАК Материальные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Трудозатраты
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.Трудозатраты
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
		|		КОНЕЦ)												КАК Трудозатраты,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|		КОНЕЦ)												КАК ПостатейныеПостоянные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|		КОНЕЦ)												КАК ПостатейныеПеременные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ДопРасходы
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
		|		КОНЕЦ)												КАК ДопРасходы,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
		|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Стоимость
		|				+ СебестоимостьТоваров.Трудозатраты
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
		|				+ СебестоимостьТоваров.ДопРасходы
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
		|				+ СебестоимостьТоваров.Трудозатраты
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
		|				+ СебестоимостьТоваров.ДопРасходыБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
		|				+ СебестоимостьТоваров.ТрудозатратыУпр
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
		|				+ СебестоимостьТоваров.ДопРасходыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
		|				+ СебестоимостьТоваров.ТрудозатратыРегл
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|				+ СебестоимостьТоваров.ДопРасходыРегл
		|		КОНЕЦ)												КАК СуммаЗатрата,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
		|			ИНАЧЕ 0
		|		КОНЕЦ)												КАК НДД,
		|
		|// Стоимости с НДС
		|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
		|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
		|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,
		|
		|// Стоимости без НДС
		|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,
		|
		|// Стоимости Упр
		|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
		|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
		|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
		|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,
		|
		|// Стоимости Регл
		|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
		|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
		|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
		|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,
		|
		|// Налоговый учет
		|	СУММА(СебестоимостьТоваров.СтоимостьРегл
		|		+ СебестоимостьТоваров.ТрудозатратыРегл
		|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|		+ СебестоимостьТоваров.ДопРасходыРегл
		|		- СебестоимостьТоваров.ПостояннаяРазница
		|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
		|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
		|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница
		|
		|ПОМЕСТИТЬ ВыбытиеИзНЗППоПродукции
		|ИЗ
		|	ВыпущеннаяПродукция КАК ВыпущеннаяПродукция
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
		|		ПО СебестоимостьТоваров.Организация = ВыпущеннаяПродукция.Организация
		|			И ВыпущеннаяПродукция.ПартияПродукции = СебестоимостьТоваров.Регистратор
		|			И ВыпущеннаяПродукция.АналитикаУчетаПродукции = СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры
		|			И ВыпущеннаяПродукция.ПартияПродукции = СебестоимостьТоваров.КорПартия
		|			И ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции = СебестоимостьТоваров.КорАналитикаУчетаПартий
		|			И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
		|ГДЕ
		|	СебестоимостьТоваров.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ТИПЗНАЧЕНИЯ(СебестоимостьТоваров.Партия) = ТИП(Справочник.ПартииПроизводства)
		|	И НЕ СебестоимостьТоваров.Партия = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
		|
		|СГРУППИРОВАТЬ ПО
		|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
		|	ВыпущеннаяПродукция.Организация,
		|	ВыпущеннаяПродукция.ПартияПродукции,
		|	ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции,
		|	ВыпущеннаяПродукция.АналитикаУчетаПродукции,
		|	СебестоимостьТоваров.Партия,
		|	СебестоимостьТоваров.ВидЗапасов,
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти

	#Область ВыбывшиеЗатратыСводно
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ
		|	Т.Организация КАК Организация,
		|	МАКСИМУМ(Т.Период) КАК Период,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.Партия КАК Партия
		|ПОМЕСТИТЬ ВыбывшиеЗатратыСводно
		|ИЗ
		|	ВыбытиеИзНЗППоПродукции КАК Т
		|ГДЕ
		|	Т.Количество <> 0
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Организация,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.Партия
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
		
	#Область ПартииПроизводства
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Партия КАК Партия
		|ПОМЕСТИТЬ ПартииПроизводства
		|ИЗ
		|	ВыбывшиеЗатратыСводно КАК Т
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
		
	#Область ВыбытиеИзНЗП
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Т.Организация КАК Организация,
		|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК Период,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Т.Партия КАК Партия,
		|	СУММА(Т.КоличествоРасход) КАК Количество
		|ПОМЕСТИТЬ ВыбытиеИзНЗП
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(,, МЕСЯЦ,
		|		Партия В (
		|			ВЫБРАТЬ
		|				Т.Партия
		|			ИЗ
		|				ПартииПроизводства КАК Т)
		|		И (АналитикаУчетаНоменклатуры, Организация) В (
		|			ВЫБРАТЬ
		|				Выбытие.АналитикаУчетаНоменклатуры,
		|				Выбытие.Организация КАК Организация
		|			ИЗ
		|				ВыбывшиеЗатратыСводно КАК Выбытие)
		|	) КАК Т
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
		|	ПО Т.АналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
		|		И Т.Партия = Выбытие.Партия
		|			
		|ГДЕ
		|	Т.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Организация,
		|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ),
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.Партия
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
		
	#Область ПервичныеПартииВНЗП
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ) КАК Период,
		|	СебестоимостьТоваров.Организация					КАК Организация,
		|	СебестоимостьТоваров.ВидЗапасов						КАК ВидЗапасов,
		// Аналитика первичной партии.
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.АналитикаУчетаПартий 			КАК АналитикаУчетаПартий,
		|	СебестоимостьТоваров.Партия 						КАК Партия,
		// Аналитка в НЗП.
		|	СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры 	КАК КорАналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.КорПартия						КАК КорПартия,
		|
		|	МАКСИМУМ(ВЫБОР
		|		КОГДА СебестоимостьТоваров.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И СебестоимостьТоваров.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ВключитьНДСВСтоимость,
		|	МАКСИМУМ(ВЫБОР
		|		КОГДА СебестоимостьТоваров.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|		 И СебестоимостьТоваров.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ИсключитьНДСИзСтоимости,
		
		|	СУММА(СебестоимостьТоваров.Количество) 				КАК Количество,
		|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Стоимость
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
		|		КОНЕЦ)												КАК Материальные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Трудозатраты
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.Трудозатраты
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
		|		КОНЕЦ)												КАК Трудозатраты,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|		КОНЕЦ)												КАК ПостатейныеПостоянные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|		КОНЕЦ)												КАК ПостатейныеПеременные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ДопРасходы
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
		|		КОНЕЦ)												КАК ДопРасходы,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
		|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Стоимость
		|				+ СебестоимостьТоваров.Трудозатраты
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
		|				+ СебестоимостьТоваров.ДопРасходы
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
		|				+ СебестоимостьТоваров.Трудозатраты
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
		|				+ СебестоимостьТоваров.ДопРасходыБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
		|				+ СебестоимостьТоваров.ТрудозатратыУпр
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
		|				+ СебестоимостьТоваров.ДопРасходыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
		|				+ СебестоимостьТоваров.ТрудозатратыРегл
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|				+ СебестоимостьТоваров.ДопРасходыРегл
		|		КОНЕЦ)												КАК СуммаЗатрата,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
		|			ИНАЧЕ 0
		|		КОНЕЦ)												КАК НДД,
		|
		|// Стоимости с НДС
		|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
		|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
		|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,
		|
		|// Стоимости без НДС
		|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,
		|
		|// Стоимости Упр
		|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
		|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
		|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
		|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,
		|
		|// Стоимости Регл
		|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
		|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
		|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
		|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,
		|
		|// Налоговый учет
		|	СУММА(СебестоимостьТоваров.СтоимостьРегл
		|		+ СебестоимостьТоваров.ТрудозатратыРегл
		|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|		+ СебестоимостьТоваров.ДопРасходыРегл
		|		- СебестоимостьТоваров.ПостояннаяРазница
		|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
		|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
		|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница
		|
		|ПОМЕСТИТЬ ПервичныеПартииВНЗП
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК ПП
		|		ПО СебестоимостьТоваров.КорПартия = ПП.Партия
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
		|		ПО СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
		|			И СебестоимостьТоваров.КорПартия = Выбытие.Партия
		|			И СебестоимостьТоваров.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
		|			И СебестоимостьТоваров.Организация = Выбытие.Организация
		|ГДЕ
		|	СебестоимостьТоваров.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И НЕ Выбытие.АналитикаУчетаНоменклатуры ЕСТЬ NULL
		|	И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
		|
		|СГРУППИРОВАТЬ ПО
		|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
		|	СебестоимостьТоваров.Организация,
		|	СебестоимостьТоваров.ВидЗапасов,
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.АналитикаУчетаПартий,
		|	СебестоимостьТоваров.Партия,
		|	СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.КорПартия
		|
		|ИМЕЮЩИЕ СУММА(СебестоимостьТоваров.Количество) > 0
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		// Фикс. стоимость
		|ВЫБРАТЬ
		|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ)	КАК Период,
		|	СебестоимостьТоваров.Организация					КАК Организация,
		|	СебестоимостьТоваров.ВидЗапасов						КАК ВидЗапасов,
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.АналитикаУчетаПартий 			КАК АналитикаУчетаПартий,
		|	СебестоимостьТоваров.Регистратор					КАК Партия,
		
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК КорАналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.Партия							КАК КорПартия,
		|	ЛОЖЬ												КАК ВключитьНДСВСтоимость,
		|	ЛОЖЬ												КАК ИсключитьНДСИзСтоимости,
		
		|	СУММА(СебестоимостьТоваров.Количество),
		|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Стоимость
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
		|		КОНЕЦ)												КАК Материальные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Трудозатраты
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.Трудозатраты
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
		|		КОНЕЦ)												КАК Трудозатраты,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|		КОНЕЦ)												КАК ПостатейныеПостоянные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|		КОНЕЦ)												КАК ПостатейныеПеременные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ДопРасходы
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
		|		КОНЕЦ)												КАК ДопРасходы,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
		|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Стоимость
		|				+ СебестоимостьТоваров.Трудозатраты
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
		|				+ СебестоимостьТоваров.ДопРасходы
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
		|				+ СебестоимостьТоваров.Трудозатраты
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
		|				+ СебестоимостьТоваров.ДопРасходыБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
		|				+ СебестоимостьТоваров.ТрудозатратыУпр
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
		|				+ СебестоимостьТоваров.ДопРасходыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
		|				+ СебестоимостьТоваров.ТрудозатратыРегл
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|				+ СебестоимостьТоваров.ДопРасходыРегл
		|		КОНЕЦ)												КАК СуммаЗатрата,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
		|			ИНАЧЕ 0
		|		КОНЕЦ)												КАК НДД,
		|
		|// Стоимости с НДС
		|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
		|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
		|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,
		|
		|// Стоимости без НДС
		|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,
		|
		|// Стоимости Упр
		|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
		|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
		|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
		|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,
		|
		|// Стоимости Регл
		|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
		|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
		|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
		|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,
		|
		|// Налоговый учет
		|	СУММА(СебестоимостьТоваров.СтоимостьРегл
		|		+ СебестоимостьТоваров.ТрудозатратыРегл
		|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|		+ СебестоимостьТоваров.ДопРасходыРегл
		|		- СебестоимостьТоваров.ПостояннаяРазница
		|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
		|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
		|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница
		|
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК ПП
		|		ПО СебестоимостьТоваров.Партия = ПП.Партия
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
		|		ПО СебестоимостьТоваров.АналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
		|			И СебестоимостьТоваров.Партия = Выбытие.Партия
		|			И СебестоимостьТоваров.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
		|			И СебестоимостьТоваров.Организация = Выбытие.Организация
		|ГДЕ
		|	СебестоимостьТоваров.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость)
		|	И СебестоимостьТоваров.Количество < 0
		|	И НЕ Выбытие.АналитикаУчетаНоменклатуры ЕСТЬ NULL
		|	И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
		|
		|СГРУППИРОВАТЬ ПО
		|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
		|	СебестоимостьТоваров.Организация,
		|	СебестоимостьТоваров.ВидЗапасов,
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.АналитикаУчетаПартий,
		|	СебестоимостьТоваров.Регистратор,
		|	СебестоимостьТоваров.Партия
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		// Услуги переработчика
		|ВЫБРАТЬ
		|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ)	КАК Период,
		|	СебестоимостьТоваров.Организация					КАК Организация,
		|	СебестоимостьТоваров.ВидЗапасов						КАК ВидЗапасов,
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.АналитикаУчетаПартий			КАК АналитикаУчетаПартий,
		|	СебестоимостьТоваров.Регистратор					КАК Партия,
		
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК КорАналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.Партия							КАК КорПартия,
		|	ЛОЖЬ												КАК ВключитьНДСВСтоимость,
		|	ЛОЖЬ												КАК ИсключитьНДСИзСтоимости,
		
		|	СУММА(СебестоимостьТоваров.Количество),
		|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Стоимость
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
		|		КОНЕЦ)												КАК Материальные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Трудозатраты
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.Трудозатраты
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
		|		КОНЕЦ)												КАК Трудозатраты,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|		КОНЕЦ)												КАК ПостатейныеПостоянные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|		КОНЕЦ)												КАК ПостатейныеПеременные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ДопРасходы
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
		|		КОНЕЦ)												КАК ДопРасходы,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
		|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Стоимость
		|				+ СебестоимостьТоваров.Трудозатраты
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
		|				+ СебестоимостьТоваров.ДопРасходы
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
		|				+ СебестоимостьТоваров.Трудозатраты
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
		|				+ СебестоимостьТоваров.ДопРасходыБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
		|				+ СебестоимостьТоваров.ТрудозатратыУпр
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
		|				+ СебестоимостьТоваров.ДопРасходыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
		|				+ СебестоимостьТоваров.ТрудозатратыРегл
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|				+ СебестоимостьТоваров.ДопРасходыРегл
		|		КОНЕЦ)												КАК СуммаЗатрата,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
		|			ИНАЧЕ 0
		|		КОНЕЦ)												КАК НДД,
		|
		|// Стоимости с НДС
		|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
		|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
		|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,
		|
		|// Стоимости без НДС
		|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,
		|
		|// Стоимости Упр
		|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
		|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
		|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
		|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,
		|
		|// Стоимости Регл
		|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
		|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
		|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
		|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,
		|
		|// Налоговый учет
		|	СУММА(СебестоимостьТоваров.СтоимостьРегл
		|		+ СебестоимостьТоваров.ТрудозатратыРегл
		|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|		+ СебестоимостьТоваров.ДопРасходыРегл
		|		- СебестоимостьТоваров.ПостояннаяРазница
		|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
		|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
		|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница
		|
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК ПП
		|		ПО СебестоимостьТоваров.Партия = ПП.Партия
		|	
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
		|	ПО СебестоимостьТоваров.АналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
		|	И СебестоимостьТоваров.Партия = Выбытие.Партия
		|	И СебестоимостьТоваров.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
		|	И СебестоимостьТоваров.Организация = Выбытие.Организация
		|ГДЕ
		|	ТИПЗНАЧЕНИЯ(СебестоимостьТоваров.Регистратор) В(
		//++ Устарело_Переработка24
		|		ТИП(Документ.ОтчетПереработчика),
		//-- Устарело_Переработка24
		|		ТИП(Документ.ОтчетПереработчика2_5))
		|	И СебестоимостьТоваров.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
		|	И СебестоимостьТоваров.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|	И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
		|
		|СГРУППИРОВАТЬ ПО
		|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
		|	СебестоимостьТоваров.Организация,
		|	СебестоимостьТоваров.ВидЗапасов,
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.АналитикаУчетаПартий,
		|	СебестоимостьТоваров.Регистратор,
		|	СебестоимостьТоваров.Партия
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		// Начальные остатки
		|ВЫБРАТЬ
		|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ)	КАК Период,
		|	СебестоимостьТоваров.Организация					КАК Организация,
		|	СебестоимостьТоваров.ВидЗапасов						КАК ВидЗапасов,
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.АналитикаУчетаПартий			КАК АналитикаУчетаПартий,
		|	СебестоимостьТоваров.Регистратор					КАК Партия,
		
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК КорАналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.Партия							КАК КорПартия,
		|	ЛОЖЬ												КАК ВключитьНДСВСтоимость,
		|	ЛОЖЬ												КАК ИсключитьНДСИзСтоимости,
		
		|	СУММА(СебестоимостьТоваров.Количество),
		|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Стоимость
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
		|		КОНЕЦ)												КАК Материальные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Трудозатраты
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.Трудозатраты
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
		|		КОНЕЦ)												КАК Трудозатраты,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|		КОНЕЦ)												КАК ПостатейныеПостоянные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|		КОНЕЦ)												КАК ПостатейныеПеременные,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.ДопРасходы
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
		|		КОНЕЦ)												КАК ДопРасходы,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
		|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 1
		|				ТОГДА СебестоимостьТоваров.Стоимость
		|				+ СебестоимостьТоваров.Трудозатраты
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
		|				+ СебестоимостьТоваров.ДопРасходы
		|			КОГДА &ДанныеПоСебестоимости = 2
		|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
		|				+ СебестоимостьТоваров.Трудозатраты
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
		|				+ СебестоимостьТоваров.ДопРасходыБезНДС
		|			КОГДА &ДанныеПоСебестоимости = 3
		|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
		|				+ СебестоимостьТоваров.ТрудозатратыУпр
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
		|				+ СебестоимостьТоваров.ДопРасходыУпр
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
		|				+ СебестоимостьТоваров.ТрудозатратыРегл
		|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|				+ СебестоимостьТоваров.ДопРасходыРегл
		|		КОНЕЦ)												КАК СуммаЗатрата,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
		|			ИНАЧЕ 0
		|		КОНЕЦ)												КАК НДД,
		|
		|// Стоимости с НДС
		|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
		|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
		|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,
		|
		|// Стоимости без НДС
		|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
		|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,
		|
		|// Стоимости Упр
		|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
		|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
		|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
		|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,
		|
		|// Стоимости Регл
		|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
		|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
		|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
		|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
		|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,
		|
		|// Налоговый учет
		|	СУММА(СебестоимостьТоваров.СтоимостьРегл
		|		+ СебестоимостьТоваров.ТрудозатратыРегл
		|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
		|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
		|		+ СебестоимостьТоваров.ДопРасходыРегл
		|		- СебестоимостьТоваров.ПостояннаяРазница
		|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
		|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
		|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница
		|
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК ПП
		|		ПО СебестоимостьТоваров.Партия = ПП.Партия
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
		|		ПО СебестоимостьТоваров.АналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
		|			И СебестоимостьТоваров.Партия = Выбытие.Партия
		|			И СебестоимостьТоваров.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
		|			И СебестоимостьТоваров.Организация = Выбытие.Организация
		|ГДЕ
		|	СебестоимостьТоваров.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковЗатратПартийПроизводства)
		|	И НЕ Выбытие.АналитикаУчетаНоменклатуры ЕСТЬ NULL
		|	И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
		|
		|СГРУППИРОВАТЬ ПО
		|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
		|	СебестоимостьТоваров.Организация,
		|	СебестоимостьТоваров.ВидЗапасов,
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.АналитикаУчетаПартий,
		|	СебестоимостьТоваров.Регистратор,
		|	СебестоимостьТоваров.Партия
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
		
	#Область ДетализацияПартий
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ
		|	СебестоимостьТоваров.Организация					КАК Организация,
		|	СебестоимостьТоваров.Период							КАК Период,
		// Аналитика первичной партии.
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.АналитикаУчетаПартий 			КАК АналитикаУчетаПартий,
		|	СебестоимостьТоваров.Партия 						КАК Партия,
		// Аналитка в НЗП.
		|	СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры 	КАК КорАналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.КорПартия						КАК КорПартия,
		|
		|	ВЫРАЗИТЬ(СУММА(ВЫБОР
		|		КОГДА &ДанныеПоСебестоимости <> 3 ТОГДА 0
		|		КОГДА СебестоимостьТоваров.ВключитьНДСВСтоимость
		|			ТОГДА (ЕСТЬNULL(Детализация.НДСУпр, 0) + ЕСТЬNULL(ДетализацияПостатейные.НДСУпр, 0))
		|				* СебестоимостьТоваров.Количество
		|		КОГДА СебестоимостьТоваров.ИсключитьНДСИзСтоимости
		|			ТОГДА (ЕСТЬNULL(-Детализация.НДСУпр, 0) + ЕСТЬNULL(-ДетализацияПостатейные.НДСУпр, 0))
		|				* СебестоимостьТоваров.Количество
		|		ИНАЧЕ 0 КОНЕЦ) КАК ЧИСЛО(31,2)) КАК НДСУпр,
		|	ВЫРАЗИТЬ(СУММА(ВЫБОР
		|		КОГДА &ДанныеПоСебестоимости <> 4 ТОГДА 0
		|		КОГДА СебестоимостьТоваров.ВключитьНДСВСтоимость
		|			ТОГДА (ЕСТЬNULL(Детализация.НДСРегл, 0) + ЕСТЬNULL(ДетализацияПостатейные.НДСРегл, 0))
		|				* СебестоимостьТоваров.Количество
		|		КОГДА СебестоимостьТоваров.ИсключитьНДСИзСтоимости
		|			ТОГДА (ЕСТЬNULL(-Детализация.НДСРегл, 0) + ЕСТЬNULL(-ДетализацияПостатейные.НДСРегл, 0))
		|				* СебестоимостьТоваров.Количество
		|		ИНАЧЕ 0 КОНЕЦ) КАК ЧИСЛО(31,2)) КАК НДСРегл
		|
		|ПОМЕСТИТЬ ДетализацияПартий
		|ИЗ
		|	ПервичныеПартииВНЗП КАК СебестоимостьТоваров
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|	ПО Аналитика.Ссылка = СебестоимостьТоваров.АналитикаУчетаНоменклатуры
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Детализация
		|	ПО Детализация.Партия = СебестоимостьТоваров.Партия
		|		И Детализация.АналитикаУчетаПартий = СебестоимостьТоваров.АналитикаУчетаПартий
		|		И Детализация.Организация = СебестоимостьТоваров.Организация
		|		И Детализация.ВидЗапасов = СебестоимостьТоваров.ВидЗапасов
		|		И Детализация.Номенклатура = Аналитика.Номенклатура
		|		И Детализация.Характеристика = Аналитика.Характеристика
		|		И НЕ Детализация.ЗатратыПредыдущихПеределов
		|		И (Детализация.ПериодРегистрации <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
		|		И СебестоимостьТоваров.Количество <> 0
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК ДетализацияПостатейные
		|	ПО ДетализацияПостатейные.Партия = СебестоимостьТоваров.Партия
		|		И ДетализацияПостатейные.АналитикаУчетаПартий = СебестоимостьТоваров.АналитикаУчетаПартий
		|		И ДетализацияПостатейные.Организация = СебестоимостьТоваров.Организация
		|		И ДетализацияПостатейные.ВидЗапасов = СебестоимостьТоваров.ВидЗапасов
		|		И ДетализацияПостатейные.Номенклатура = Аналитика.Номенклатура
		|		И ДетализацияПостатейные.Характеристика = Аналитика.Характеристика
		|		И НЕ ДетализацияПостатейные.ЗатратыПредыдущихПеределов
		|		И (ДетализацияПостатейные.ПериодРегистрации <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
		|		И СебестоимостьТоваров.Количество <> 0
		|ГДЕ
		|	СебестоимостьТоваров.ВключитьНДСВСтоимость ИЛИ СебестоимостьТоваров.ИсключитьНДСИзСтоимости
		|
		|СГРУППИРОВАТЬ ПО
		|	СебестоимостьТоваров.Организация,
		|	СебестоимостьТоваров.Период,
		|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.АналитикаУчетаПартий,
		|	СебестоимостьТоваров.Партия,
		|	СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры,
		|	СебестоимостьТоваров.КорПартия
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
	
	#Область ПриходыНарастающимИтогом
		// Количество материала нарастаующим итогом, распределенное на партию производсьтва. 
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ
		|	Т.Организация КАК Организация,
		|	Т.Период КАК Период,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Т.Партия КАК Партия,
		|	СУММА(Партии.Количество) КАК Количество
		|ПОМЕСТИТЬ ПриходыНарастающимИтогом
		|ИЗ
		|	ВыбытиеИзНЗП КАК Т
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеПартииВНЗП КАК Партии
		|		ПО Т.АналитикаУчетаНоменклатуры = Партии.КорАналитикаУчетаНоменклатуры
		|			И Т.Партия = Партии.КорПартия
		|			И Т.Период >= Партии.Период
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Организация,
		|	Т.Период,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.Партия
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
		
	#Область РасходыНарастающимИтогом
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ
		|	Т.Организация КАК Организация,
		|	Т.Период КАК Период,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Т.Партия КАК Партия,
		|	СУММА(НарастающийИтог.Количество) КАК Количество
		|ПОМЕСТИТЬ РасходыНарастающимИтогом
		|ИЗ
		|	ВыбытиеИзНЗП КАК Т
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбытиеИзНЗП КАК НарастающийИтог
		|		ПО Т.АналитикаУчетаНоменклатуры = НарастающийИтог.АналитикаУчетаНоменклатуры
		|			И Т.Организация = НарастающийИтог.Организация
		|			И Т.Партия = НарастающийИтог.Партия
		|			И Т.Период >= НарастающийИтог.Период
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Организация,
		|	Т.Период,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.Партия
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
		
	#Область НулевыеПериоды
		// Периоды, в которых конечный остаток материала в НЗП равен 0.
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ
		|	Расходы.Организация КАК Организация,
		|	Расходы.Период КАК Период,
		|	Расходы.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Расходы.Партия КАК Партия
		|ПОМЕСТИТЬ НулевыеПериоды
		|ИЗ
		|	РасходыНарастающимИтогом КАК Расходы
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПриходыНарастающимИтогом КАК Приходы
		|		ПО Расходы.АналитикаУчетаНоменклатуры = Приходы.АналитикаУчетаНоменклатуры
		|			И Расходы.Партия = Приходы.Партия
		|			И Расходы.Период = Приходы.Период
		|			И Расходы.Организация = Приходы.Организация
		|ГДЕ
		|	Расходы.Количество - ЕСТЬNULL(Приходы.Количество, 0) = 0
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
		
	#Область ИнтервалыРасходаПартий
		// Периоды, в которых был расход партий производства на выпуск.
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ
		|	Т.Организация КАК Организация,
		|	Т.Период КАК КонецПериода,
		|	МАКСИМУМ(ЕСТЬNULL(ДОБАВИТЬКДАТЕ(НулевыеПериоды.Период, МЕСЯЦ, 1), ДАТАВРЕМЯ(1, 1, 1))) КАК НачалоПериода,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Т.Партия КАК Партия
		|ПОМЕСТИТЬ ИнтервалыРасходаПартий
		|ИЗ
		|	НулевыеПериоды КАК Т
		|		ЛЕВОЕ СОЕДИНЕНИЕ НулевыеПериоды КАК НулевыеПериоды
		|		ПО Т.АналитикаУчетаНоменклатуры = НулевыеПериоды.АналитикаУчетаНоменклатуры
		|			И Т.Партия = НулевыеПериоды.Партия
		|			И Т.Период > НулевыеПериоды.Период
		|			И Т.Организация = НулевыеПериоды.Организация
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Организация,
		|	Т.Период,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.Партия
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
	
	#Область ПриходыНарастающимИтогомПоИнтервалам
		// Периоды, в которых был расход партий производства на выпуск.
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ
		|	Выбытие.Организация,
		|	Выбытие.Период,
		|	Выбытие.АналитикаУчетаНоменклатуры,
		|	Выбытие.Партия КАК Партия,
		|	СУММА(ПП.Количество) КАК Количество
		|ПОМЕСТИТЬ ПриходыНарастающимИтогомПоИнтервалам
		|ИЗ
		|	ВыбытиеИзНЗП КАК Выбытие
		|	ЛЕВОЕ СОЕДИНЕНИЕ ИнтервалыРасходаПартий КАК Интервалы
		|	ПО Выбытие.АналитикаУчетаНоменклатуры = Интервалы.АналитикаУчетаНоменклатуры
		|		И Выбытие.Партия = Интервалы.Партия
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеПартииВНЗП КАК ПП
		|	ПО Выбытие.АналитикаУчетаНоменклатуры = ПП.КорАналитикаУчетаНоменклатуры
		|		И Выбытие.Партия = ПП.КорПартия
		|		И Выбытие.Период >= ПП.Период
		|		И (ПП.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
		|ГДЕ
		|	(Интервалы.НачалоПериода ЕСТЬ NULL
		|		ИЛИ Выбытие.Период МЕЖДУ Интервалы.НачалоПериода И Интервалы.КонецПериода)
		|
		|СГРУППИРОВАТЬ ПО
		|	Выбытие.Организация,
		|	Выбытие.Период,
		|	Выбытие.АналитикаУчетаНоменклатуры,
		|	Выбытие.Партия
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
		
	#Область ПредварительныйРасходПартий
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ
		|	Выбытие.Организация КАК Организация,
		|	Выбытие.Период КАК Период,
		|	ПП.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ПП.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	ПП.Партия КАК Партия,
		|	МАКСИМУМ(ПП.ВключитьНДСВСтоимость) КАК ВключитьНДСВСтоимость,
		|	МАКСИМУМ(ПП.ИсключитьНДСИзСтоимости) КАК ИсключитьНДСИзСтоимости,
		|	Выбытие.АналитикаУчетаНоменклатуры 	КАК КорАналитикаУчетаНоменклатуры,
		|	Выбытие.Партия 						КАК КорПартия,
		
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|			Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.Количество) КАК Количество,
		|	МАКСИМУМ(Выбытие.Количество = Поступило.Количество - ЕСТЬNULL(Выбыло.Количество, 0) + Выбытие.Количество) КАК СписатьОстаток,
		
		// Стоимости согласно параметру ""ДанныеПоСебестоимости""
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.Материальные) КАК Материальные,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.Трудозатраты) КАК Трудозатраты,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ПостатейныеПостоянные) КАК ПостатейныеПостоянные,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ПостатейныеПеременные) КАК ПостатейныеПеременные,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ДопРасходы) КАК ДопРасходы,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.СуммаЗатратаЗабалансовая) КАК СуммаЗатратаЗабалансовая,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.СуммаЗатрата) КАК СуммаЗатрата,
		|	СУММА(ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.НДД) КАК НДД,
		
		// Стоимости с НДС
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.МатериальныеСНДС) КАК МатериальныеСНДС,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ТрудозатратыСНДС) КАК ТрудозатратыСНДС,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ПостатейныеПостоянныеСНДС) КАК ПостатейныеПостоянныеСНДС,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ПостатейныеПеременныеСНДС) КАК ПостатейныеПеременныеСНДС,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ДопРасходыСНДС) КАК ДопРасходыСНДС,
		
		// Стоимости без НДС
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.МатериальныеБезНДС) КАК МатериальныеБезНДС,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ПостатейныеПостоянныеБезНДС) КАК ПостатейныеПостоянныеБезНДС,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ПостатейныеПеременныеБезНДС) КАК ПостатейныеПеременныеБезНДС,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
		
		// Стоимости Упр
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.МатериальныеУпр) КАК МатериальныеУпр,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ТрудозатратыУпр) КАК ТрудозатратыУпр,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ПостатейныеПостоянныеУпр) КАК ПостатейныеПостоянныеУпр,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ПостатейныеПеременныеУпр) КАК ПостатейныеПеременныеУпр,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ДопРасходыУпр) КАК ДопРасходыУпр,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.СтоимостьЗабалансоваяУпр) КАК СтоимостьЗабалансоваяУпр,
		
		// Стоимости Регл
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.МатериальныеРегл) КАК МатериальныеРегл,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ТрудозатратыРегл) КАК ТрудозатратыРегл,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ПостатейныеПостоянныеРегл) КАК ПостатейныеПостоянныеРегл,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ПостатейныеПеременныеРегл) КАК ПостатейныеПеременныеРегл,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ДопРасходыРегл) КАК ДопРасходыРегл,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.СтоимостьЗабалансоваяРегл) КАК СтоимостьЗабалансоваяРегл,
		|
		// Налоговый учет
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.НалоговыйУчет) КАК НалоговыйУчет,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(
		|		ВЫРАЗИТЬ(Выбытие.Количество /
		|		Поступило.Количество КАК ЧИСЛО(23, 10))
		|			* ПП.ВременнаяРазница) КАК ВременнаяРазница
		|
		|ПОМЕСТИТЬ ПредварительныйРасходПартий
		|ИЗ
		|	ВыбытиеИзНЗП КАК Выбытие
		|		ЛЕВОЕ СОЕДИНЕНИЕ ИнтервалыРасходаПартий КАК Интервалы
		|		ПО Выбытие.АналитикаУчетаНоменклатуры = Интервалы.АналитикаУчетаНоменклатуры
		|			И Выбытие.Партия = Интервалы.Партия
		|			И Выбытие.Организация = Интервалы.Организация
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеПартииВНЗП КАК ПП
		|		ПО Выбытие.АналитикаУчетаНоменклатуры = ПП.КорАналитикаУчетаНоменклатуры
		|			И Выбытие.Партия = ПП.КорПартия
		|			И Выбытие.Период >= ПП.Период
		|			И (ПП.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
		|			И Выбытие.Организация = ПП.Организация
		|		ЛЕВОЕ СОЕДИНЕНИЕ РасходыНарастающимИтогом КАК Выбыло
		|		ПО Выбытие.АналитикаУчетаНоменклатуры = Выбыло.АналитикаУчетаНоменклатуры
		|			И Выбытие.Партия = Выбыло.Партия
		|			И Выбытие.Период = Выбыло.Период
		|			И Выбытие.Организация = Выбыло.Организация
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПриходыНарастающимИтогомПоИнтервалам КАК Поступило
		|		ПО Выбытие.АналитикаУчетаНоменклатуры = Поступило.АналитикаУчетаНоменклатуры
		|			И Выбытие.Партия = Поступило.Партия
		|			И Выбытие.Период = Поступило.Период
		|			И Выбытие.Организация = Поступило.Организация
		|ГДЕ
		|	(Интервалы.НачалоПериода ЕСТЬ NULL
		|		ИЛИ Выбытие.Период МЕЖДУ Интервалы.НачалоПериода И Интервалы.КонецПериода)
		|	И НЕ Поступило.Количество ЕСТЬ NULL
		|
		|СГРУППИРОВАТЬ ПО
		|	Выбытие.Организация,
		|	Выбытие.Период,
		|	Выбытие.АналитикаУчетаНоменклатуры,
		|	Выбытие.Партия,
		|	ПП.АналитикаУчетаНоменклатуры,
		|	ПП.АналитикаУчетаПартий,
		|	ПП.Партия
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
		
	#Область ПартииСводно
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ
		|	Т.Организация КАК Организация,
		|	Т.Период КАК Период,
		|	Т.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	Т.КорПартия КАК КорПартия,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	Т.Партия КАК Партия,
		|	СУММА(Партии.Количество) КАК Количество,
		// Стоимости согласно параметру ""ДанныеПоСебестоимости""
		|	СУММА(Партии.Материальные
		|		+ ЕСТЬNULL(Детализация.НДСУпр,0)
		|		+ ЕСТЬNULL(Детализация.НДСРегл,0)) КАК Материальные,
		|	СУММА(Партии.Трудозатраты) КАК Трудозатраты,
		|	СУММА(Партии.ПостатейныеПостоянные) КАК ПостатейныеПостоянные,
		|	СУММА(Партии.ПостатейныеПеременные) КАК ПостатейныеПеременные,
		|	СУММА(Партии.ДопРасходы) КАК ДопРасходы,
		|	СУММА(Партии.СуммаЗатратаЗабалансовая) КАК СуммаЗатратаЗабалансовая,
		|	СУММА(Партии.СуммаЗатрата
		|		+ ЕСТЬNULL(Детализация.НДСУпр,0)
		|		+ ЕСТЬNULL(Детализация.НДСРегл,0)) КАК СуммаЗатрата,
		|	СУММА(Партии.НДД) КАК НДД,
		|
		// Стоимости с НДС
		|	СУММА(Партии.МатериальныеСНДС) КАК МатериальныеСНДС,
		|	СУММА(Партии.ТрудозатратыСНДС) КАК ТрудозатратыСНДС,
		|	СУММА(Партии.ПостатейныеПостоянныеСНДС) КАК ПостатейныеПостоянныеСНДС,
		|	СУММА(Партии.ПостатейныеПеременныеСНДС) КАК ПостатейныеПеременныеСНДС,
		|	СУММА(Партии.ДопРасходыСНДС) КАК ДопРасходыСНДС,
		|
		// Стоимости без НДС
		|	СУММА(Партии.МатериальныеБезНДС) КАК МатериальныеБезНДС,
		|	СУММА(Партии.ПостатейныеПостоянныеБезНДС) КАК ПостатейныеПостоянныеБезНДС,
		|	СУММА(Партии.ПостатейныеПеременныеБезНДС) КАК ПостатейныеПеременныеБезНДС,
		|	СУММА(Партии.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
		|
		// Стоимости Упр
		|	СУММА(Партии.МатериальныеУпр + ЕСТЬNULL(Детализация.НДСУпр,0)) КАК МатериальныеУпр,
		|	СУММА(Партии.ТрудозатратыУпр) КАК ТрудозатратыУпр,
		|	СУММА(Партии.ПостатейныеПостоянныеУпр) КАК ПостатейныеПостоянныеУпр,
		|	СУММА(Партии.ПостатейныеПеременныеУпр) КАК ПостатейныеПеременныеУпр,
		|	СУММА(Партии.ДопРасходыУпр) КАК ДопРасходыУпр,
		|	СУММА(Партии.СтоимостьЗабалансоваяУпр) КАК СтоимостьЗабалансоваяУпр,
		|
		// Стоимости Регл
		|	СУММА(Партии.МатериальныеРегл + ЕСТЬNULL(Детализация.НДСРегл,0)) КАК МатериальныеРегл,
		|	СУММА(Партии.ТрудозатратыРегл) КАК ТрудозатратыРегл,
		|	СУММА(Партии.ПостатейныеПостоянныеРегл) КАК ПостатейныеПостоянныеРегл,
		|	СУММА(Партии.ПостатейныеПеременныеРегл) КАК ПостатейныеПеременныеРегл,
		|	СУММА(Партии.ДопРасходыРегл) КАК ДопРасходыРегл,
		|	СУММА(Партии.СтоимостьЗабалансоваяРегл) КАК СтоимостьЗабалансоваяРегл,
		|
		// Налоговый учет
		|	СУММА(Партии.НалоговыйУчет + ЕСТЬNULL(Детализация.НДСРегл,0)) КАК НалоговыйУчет,
		|	СУММА(Партии.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(Партии.ВременнаяРазница) КАК ВременнаяРазница
		|
		|ПОМЕСТИТЬ ПартииСводно
		|ИЗ
		|	ПредварительныйРасходПартий КАК Т
		|		ЛЕВОЕ СОЕДИНЕНИЕ ИнтервалыРасходаПартий КАК Интервалы
		|		ПО Т.КорАналитикаУчетаНоменклатуры = Интервалы.АналитикаУчетаНоменклатуры
		|			И Т.КорПартия = Интервалы.Партия
		|			И Т.Организация = Интервалы.Организация
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеПартииВНЗП КАК Партии
		|		ПО Т.КорАналитикаУчетаНоменклатуры = Партии.КорАналитикаУчетаНоменклатуры
		|			И Т.КорПартия = Партии.КорПартия
		|			И Т.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатуры
		|			И Т.АналитикаУчетаПартий = Партии.АналитикаУчетаПартий
		|			И Т.Партия = Партии.Партия
		|			И Т.Период >= Партии.Период
		|			И (Партии.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
		|			И Т.Организация = Партии.Организация
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ДетализацияПартий КАК Детализация
		|		ПО Т.КорАналитикаУчетаНоменклатуры = Детализация.КорАналитикаУчетаНоменклатуры
		|			И Т.КорПартия = Детализация.КорПартия
		|			И Т.АналитикаУчетаНоменклатуры = Детализация.АналитикаУчетаНоменклатуры
		|			И Т.АналитикаУчетаПартий = Детализация.АналитикаУчетаПартий
		|			И Т.Партия = Детализация.Партия
		|			И Т.Период >= Детализация.Период
		|			И (Детализация.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
		|			И Т.Организация = Детализация.Организация
		|ГДЕ
		|	Интервалы.НачалоПериода ЕСТЬ NULL
		|		ИЛИ Т.Период МЕЖДУ Интервалы.НачалоПериода И Интервалы.КонецПериода
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Организация,
		|	Т.Период,
		|	Т.КорАналитикаУчетаНоменклатуры,
		|	Т.КорПартия,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.АналитикаУчетаПартий,
		|	Т.Партия
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
		
	#Область РасходПартийСводно
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ
		|	Т.Организация КАК Организация,
		|	Т.Период КАК Период,
		|	Т.КорАналитикаУчетаНоменклатуры,
		|	Т.КорПартия,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.АналитикаУчетаПартий,
		|	Т.Партия КАК Партия,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.Количество
		|		КОНЕЦ) КАК Количество,
		// Стоимости согласно параметру ""ДанныеПоСебестоимости""
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.Материальные
		|		КОНЕЦ) КАК Материальные,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.Трудозатраты
		|		КОНЕЦ) КАК Трудозатраты,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ПостатейныеПостоянные
		|		КОНЕЦ) КАК ПостатейныеПостоянные,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ПостатейныеПеременные
		|		КОНЕЦ) КАК ПостатейныеПеременные,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ДопРасходы
		|		КОНЕЦ) КАК ДопРасходы,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.СуммаЗатратаЗабалансовая
		|		КОНЕЦ) КАК СуммаЗатратаЗабалансовая,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.СуммаЗатрата
		|		КОНЕЦ) КАК СуммаЗатрата,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.НДД
		|		КОНЕЦ) КАК НДД,
		|
		// Стоимости с НДС
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.МатериальныеСНДС
		|		КОНЕЦ) КАК МатериальныеСНДС,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ТрудозатратыСНДС
		|		КОНЕЦ) КАК ТрудозатратыСНДС,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ПостатейныеПостоянныеСНДС
		|		КОНЕЦ) КАК ПостатейныеПостоянныеСНДС,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ПостатейныеПеременныеСНДС
		|		КОНЕЦ) КАК ПостатейныеПеременныеСНДС,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ДопРасходыСНДС
		|		КОНЕЦ) КАК ДопРасходыСНДС,
		// Стоимости без НДС
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.МатериальныеБезНДС
		|		КОНЕЦ) КАК МатериальныеБезНДС,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ПостатейныеПостоянныеБезНДС
		|		КОНЕЦ) КАК ПостатейныеПостоянныеБезНДС,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ПостатейныеПеременныеБезНДС
		|		КОНЕЦ) КАК ПостатейныеПеременныеБезНДС,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ДопРасходыБезНДС
		|		КОНЕЦ) КАК ДопРасходыБезНДС,
		// Стоимости Упр
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.МатериальныеУпр
		|		КОНЕЦ) КАК МатериальныеУпр,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ТрудозатратыУпр
		|		КОНЕЦ) КАК ТрудозатратыУпр,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ПостатейныеПостоянныеУпр
		|		КОНЕЦ) КАК ПостатейныеПостоянныеУпр,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ПостатейныеПеременныеУпр
		|		КОНЕЦ) КАК ПостатейныеПеременныеУпр,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ДопРасходыУпр
		|		КОНЕЦ) КАК ДопРасходыУпр,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.СтоимостьЗабалансоваяУпр
		|		КОНЕЦ) КАК СтоимостьЗабалансоваяУпр,
		// Стоимости Регл
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.МатериальныеРегл
		|		КОНЕЦ) КАК МатериальныеРегл,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ТрудозатратыРегл
		|		КОНЕЦ) КАК ТрудозатратыРегл,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ПостатейныеПостоянныеРегл
		|		КОНЕЦ) КАК ПостатейныеПостоянныеРегл,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ПостатейныеПеременныеРегл
		|		КОНЕЦ) КАК ПостатейныеПеременныеРегл,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ДопРасходыРегл
		|		КОНЕЦ) КАК ДопРасходыРегл,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.СтоимостьЗабалансоваяРегл
		|		КОНЕЦ) КАК СтоимостьЗабалансоваяРегл,
		|
		// Налоговый учет
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.НалоговыйУчет
		|		КОНЕЦ) КАК НалоговыйУчет,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ПостояннаяРазница
		|		КОНЕЦ) КАК ПостояннаяРазница,
		|	СУММА(ВЫБОР
		|			КОГДА Расход.СписатьОстаток
		|				ТОГДА 0
		|			ИНАЧЕ Расход.ВременнаяРазница
		|		КОНЕЦ) КАК ВременнаяРазница
		|
		|ПОМЕСТИТЬ РасходПартийСводно
		|ИЗ
		|	ПредварительныйРасходПартий КАК Т
		|		ЛЕВОЕ СОЕДИНЕНИЕ ИнтервалыРасходаПартий КАК Интервалы
		|		ПО Т.КорАналитикаУчетаНоменклатуры = Интервалы.АналитикаУчетаНоменклатуры
		|			И Т.КорПартия = Интервалы.Партия
		|			И Т.Организация = Интервалы.Организация
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПредварительныйРасходПартий КАК Расход
		|		ПО Т.КорАналитикаУчетаНоменклатуры = Расход.КорАналитикаУчетаНоменклатуры
		|			И Т.КорПартия = Расход.КорПартия
		|			И Т.АналитикаУчетаНоменклатуры = Расход.АналитикаУчетаНоменклатуры
		|			И Т.АналитикаУчетаПартий = Расход.АналитикаУчетаПартий
		|			И Т.Партия = Расход.Партия
		|			И Т.Период >= Расход.Период
		|			И (Расход.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
		|			И Т.Организация = Расход.Организация
		|ГДЕ
		|	Т.Период МЕЖДУ Интервалы.НачалоПериода И Интервалы.КонецПериода
		|		ИЛИ Интервалы.НачалоПериода ЕСТЬ NULL
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Организация,
		|	Т.Период,
		|	Т.КорАналитикаУчетаНоменклатуры,
		|	Т.КорПартия,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.АналитикаУчетаПартий,
		|	Т.Партия
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
		
	#Область ПервичныеЗатратыПоПериодам
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ
		|	Т.Организация КАК Организация,
		|	Т.Период КАК Период,
		|	Т.КорАналитикаУчетаНоменклатуры,
		|	Т.КорПартия КАК КорПартия,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.АналитикаУчетаПартий,
		|	Т.Партия КАК Партия,
		|	Т.ВключитьНДСВСтоимость КАК ВключитьНДСВСтоимость,
		|	Т.ИсключитьНДСИзСтоимости КАК ИсключитьНДСИзСтоимости,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.Количество - Расход.Количество
		|		ИНАЧЕ Т.Количество
		|	КОНЕЦ КАК Количество,
		// Стоимости согласно параметру ""ДанныеПоСебестоимости""
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.Материальные - Расход.Материальные
		|		ИНАЧЕ Т.Материальные
		|	КОНЕЦ КАК Материальные,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.Трудозатраты - Расход.Трудозатраты
		|		ИНАЧЕ Т.Трудозатраты
		|	КОНЕЦ КАК Трудозатраты,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ПостатейныеПостоянные - Расход.ПостатейныеПостоянные
		|		ИНАЧЕ Т.ПостатейныеПостоянные
		|	КОНЕЦ КАК ПостатейныеПостоянные,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ПостатейныеПеременные - Расход.ПостатейныеПеременные
		|		ИНАЧЕ Т.ПостатейныеПеременные
		|	КОНЕЦ КАК ПостатейныеПеременные,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ДопРасходы - Расход.ДопРасходы
		|		ИНАЧЕ Т.ДопРасходы
		|	КОНЕЦ КАК ДопРасходы,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.СуммаЗатратаЗабалансовая - Расход.СуммаЗатратаЗабалансовая
		|		ИНАЧЕ Т.СуммаЗатратаЗабалансовая
		|	КОНЕЦ КАК СуммаЗатратаЗабалансовая,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.СуммаЗатрата - Расход.СуммаЗатрата
		|		ИНАЧЕ Т.СуммаЗатрата
		|	КОНЕЦ КАК СуммаЗатрата,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.НДД - Расход.НДД
		|		ИНАЧЕ Т.НДД
		|	КОНЕЦ КАК НДД,
		|
		// Стоимости с НДС
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.МатериальныеСНДС - Расход.МатериальныеСНДС
		|		ИНАЧЕ Т.МатериальныеСНДС
		|	КОНЕЦ КАК МатериальныеСНДС,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ТрудозатратыСНДС - Расход.ТрудозатратыСНДС
		|		ИНАЧЕ Т.ТрудозатратыСНДС
		|	КОНЕЦ КАК ТрудозатратыСНДС,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ПостатейныеПостоянныеСНДС - Расход.ПостатейныеПостоянныеСНДС
		|		ИНАЧЕ Т.ПостатейныеПостоянныеСНДС
		|	КОНЕЦ КАК ПостатейныеПостоянныеСНДС,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ПостатейныеПеременныеСНДС - Расход.ПостатейныеПеременныеСНДС
		|		ИНАЧЕ Т.ПостатейныеПеременныеСНДС
		|	КОНЕЦ КАК ПостатейныеПеременныеСНДС,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ДопРасходыСНДС - Расход.ДопРасходыСНДС
		|		ИНАЧЕ Т.ДопРасходыСНДС
		|	КОНЕЦ КАК ДопРасходыСНДС,
		|
		// Стоимости без НДС
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.МатериальныеБезНДС - Расход.МатериальныеБезНДС
		|		ИНАЧЕ Т.МатериальныеБезНДС
		|	КОНЕЦ КАК МатериальныеБезНДС,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ПостатейныеПостоянныеБезНДС - Расход.ПостатейныеПостоянныеБезНДС
		|		ИНАЧЕ Т.ПостатейныеПостоянныеБезНДС
		|	КОНЕЦ КАК ПостатейныеПостоянныеБезНДС,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ПостатейныеПеременныеБезНДС - Расход.ПостатейныеПеременныеБезНДС
		|		ИНАЧЕ Т.ПостатейныеПеременныеБезНДС
		|	КОНЕЦ КАК ПостатейныеПеременныеБезНДС,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ДопРасходыБезНДС - Расход.ДопРасходыБезНДС
		|		ИНАЧЕ Т.ДопРасходыБезНДС
		|	КОНЕЦ КАК ДопРасходыБезНДС,
		|
		// Стоимости Упр
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.МатериальныеУпр - Расход.МатериальныеУпр
		|		ИНАЧЕ Т.МатериальныеУпр
		|	КОНЕЦ КАК МатериальныеУпр,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ТрудозатратыУпр - Расход.ТрудозатратыУпр
		|		ИНАЧЕ Т.ТрудозатратыУпр
		|	КОНЕЦ КАК ТрудозатратыУпр,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ПостатейныеПостоянныеУпр - Расход.ПостатейныеПостоянныеУпр
		|		ИНАЧЕ Т.ПостатейныеПостоянныеУпр
		|	КОНЕЦ КАК ПостатейныеПостоянныеУпр,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ПостатейныеПеременныеУпр - Расход.ПостатейныеПеременныеУпр
		|		ИНАЧЕ Т.ПостатейныеПеременныеУпр
		|	КОНЕЦ КАК ПостатейныеПеременныеУпр,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ДопРасходыУпр - Расход.ДопРасходыУпр
		|		ИНАЧЕ Т.ДопРасходыУпр
		|	КОНЕЦ КАК ДопРасходыУпр,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.СтоимостьЗабалансоваяУпр - Расход.СтоимостьЗабалансоваяУпр
		|		ИНАЧЕ Т.СтоимостьЗабалансоваяУпр
		|	КОНЕЦ КАК СтоимостьЗабалансоваяУпр,
		|
		// Стоимости Регл
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.МатериальныеРегл - Расход.МатериальныеРегл
		|		ИНАЧЕ Т.МатериальныеРегл
		|	КОНЕЦ КАК МатериальныеРегл,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ТрудозатратыРегл - Расход.ТрудозатратыРегл
		|		ИНАЧЕ Т.ТрудозатратыРегл
		|	КОНЕЦ КАК ТрудозатратыРегл,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ПостатейныеПостоянныеРегл - Расход.ПостатейныеПостоянныеРегл
		|		ИНАЧЕ Т.ПостатейныеПостоянныеРегл
		|	КОНЕЦ КАК ПостатейныеПостоянныеРегл,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ПостатейныеПеременныеРегл - Расход.ПостатейныеПеременныеРегл
		|		ИНАЧЕ Т.ПостатейныеПеременныеРегл
		|	КОНЕЦ КАК ПостатейныеПеременныеРегл,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ДопРасходыРегл - Расход.ДопРасходыРегл
		|		ИНАЧЕ Т.ДопРасходыРегл
		|	КОНЕЦ КАК ДопРасходыРегл,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.СтоимостьЗабалансоваяРегл - Расход.СтоимостьЗабалансоваяРегл
		|		ИНАЧЕ Т.СтоимостьЗабалансоваяРегл
		|	КОНЕЦ КАК СтоимостьЗабалансоваяРегл,
		|
		// Налоговый учет
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.НалоговыйУчет - Расход.НалоговыйУчет
		|		ИНАЧЕ Т.НалоговыйУчет
		|	КОНЕЦ КАК НалоговыйУчет,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ПостояннаяРазница - Расход.ПостояннаяРазница
		|		ИНАЧЕ Т.ПостояннаяРазница
		|	КОНЕЦ КАК ПостояннаяРазница,
		|	ВЫБОР
		|		КОГДА Т.СписатьОстаток
		|			ТОГДА Приход.ВременнаяРазница - Расход.ВременнаяРазница
		|		ИНАЧЕ Т.ВременнаяРазница
		|	КОНЕЦ КАК ВременнаяРазница
		|
		|ПОМЕСТИТЬ ПервичныеЗатратыПоПериодам
		|ИЗ
		|	ПредварительныйРасходПартий КАК Т
		|		ЛЕВОЕ СОЕДИНЕНИЕ РасходПартийСводно КАК Расход
		|		ПО Т.КорАналитикаУчетаНоменклатуры = Расход.КорАналитикаУчетаНоменклатуры
		|			И Т.КорПартия = Расход.КорПартия
		|			И Т.АналитикаУчетаНоменклатуры = Расход.АналитикаУчетаНоменклатуры
		|			И Т.АналитикаУчетаПартий = Расход.АналитикаУчетаПартий
		|			И Т.Партия = Расход.Партия
		|			И Т.Период = Расход.Период
		|			И Т.Организация = Расход.Организация
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПартииСводно КАК Приход
		|		ПО Т.КорАналитикаУчетаНоменклатуры = Приход.КорАналитикаУчетаНоменклатуры
		|			И Т.КорПартия = Приход.КорПартия
		|			И Т.АналитикаУчетаНоменклатуры = Приход.АналитикаУчетаНоменклатуры
		|			И Т.АналитикаУчетаПартий = Приход.АналитикаУчетаПартий
		|			И Т.Партия = Приход.Партия
		|			И Т.Период = Приход.Период
		|			И Т.Организация = Приход.Организация
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
		
	#Область ПервичныеПартииСводно
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Организация КАК Организация,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	Т.Партия КАК Партия
		|ПОМЕСТИТЬ ПервичныеПартииСводно
		|ИЗ
		|	ПервичныеЗатратыПоПериодам КАК Т
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;";
	#КонецОбласти
		
	#Область ПартииПолуфабрикатов
		ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ВЫБОР КОГДА &ДанныеПоСебестоимости < 3
		|		ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ СебестоимостьТоваров.Организация
		|	КОНЕЦ КАК Организация,
		|	ПП.Партия КАК Партия,
		|	ПП.АналитикаУчетаПартий,
		|	ПП.АналитикаУчетаНоменклатуры
		|ПОМЕСТИТЬ ПартииПолуфабрикатов
		|ИЗ
		|	ПервичныеПартииСводно КАК ПП
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
		|		ПО СебестоимостьТоваров.Регистратор = ПП.Партия
		|		И СебестоимостьТоваров.АналитикаУчетаПартий = ПП.АналитикаУчетаПартий
		|		И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
		|		И СебестоимостьТоваров.Организация = ПП.Организация
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартий КАК АналитикиУчетаПартий
		|		ПО СебестоимостьТоваров.АналитикаУчетаПартий = АналитикиУчетаПартий.КлючАналитики
		|
		|ГДЕ
		|	СебестоимостьТоваров.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И СебестоимостьТоваров.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|													ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|													ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение),
		|													ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемПередачаРаботМеждуФилиалами),
		|													ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
		|	И НЕ АналитикиУчетаПартий.КодСтроки = 0
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;
		|";
	#КонецОбласти
		
#КонецОбласти

#Область ТекстМатериальныеЗатратыОбъединение

	#Удаление
	ТекстМатериальныеЗатратыОбъединение =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	НЗППоПродукции.Организация							КАК Организация,
		|	НЗППоПродукции.ПартияПродукции						КАК ПартияВыходноеИзделие,
	#КонецУдаления
	#Вставка
	// ВАЖНО: НЕ переименовываем ПартияВыходноеИзделие в ПартияПродукции,
	// т.к. это сломает старый алгоритм и отчёт.
	ТекстМатериальныеЗатратыОбъединение =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	НЗППоПродукции.Организация							КАК Организация,
		|	НЗППоПродукции.ПартияПродукции						КАК ПартияВыходноеИзделие,
	#КонецВставки
		|	НЗППоПродукции.АналитикаУчетаПартийПродукции		КАК АналитикаУчетаПартийВыходноеИзделие,
		|	НЗППоПродукции.АналитикаУчетаПродукции				КАК АналитикаУчетаВыходноеИзделие,
		|	ПартииМатериалов.Партия								КАК ПартияЗатрата,
		|	ПартииМатериалов.АналитикаУчетаПартий				КАК АналитикаУчетаПартийЗатрата,
		|	ПартииМатериалов.ВключитьНДСВСтоимость				КАК ВключитьНДСВСтоимость,
		|	ПартииМатериалов.ИсключитьНДСИзСтоимости			КАК ИсключитьНДСИзСтоимости,
		|	ПартииМатериалов.АналитикаУчетаНоменклатуры			КАК АналитикаУчетаЗатрата,
		|	АналитикаЗатрат.Номенклатура						КАК Затрата,
		|	АналитикаЗатрат.Номенклатура.ЕдиницаИзмерения 		КАК ЕдиницаИзмеренияЗатрата,
		|	АналитикаЗатрат.Характеристика						КАК ХарактеристикаЗатрата,
		|	АналитикаЗатрат.Серия								КАК СерияЗатрата,
		|	АналитикаЗатрат.Назначение							КАК НазначениеЗатрата,
		|	АналитикаЗатрат.СтатьяКалькуляции					КАК СтатьяКалькуляции,
		|	АналитикаЗатрат.МестоХранения                       КАК Подразделение,
		|	(ВЫБОР
		|		КОГДА НЗППоПродукции.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЛОЖЬ
		// Для возвратных отходов разузлования не требуется. 
		|		КОГДА АналитикаЗатрат.СтатьяКалькуляции.ТипЗатрат = ЗНАЧЕНИЕ(Перечисление.ТипыЗатрат.ВозвратныеОтходы)
		|			ТОГДА ЛОЖЬ
		//++ НЕ УТКА
		
		// Разузловывать затраты переработчика, если отчет формируется в валюте регл./упр. учета, по давальцу, не нужно
		|		КОГДА &ДанныеПоСебестоимости > 3
		|			И НЗППоПродукции.Организация = ЕСТЬNULL(ОтчетДавальцуМеждуОрганизациями.Давалец, НЕОПРЕДЕЛЕНО)
		|				ТОГДА ЛОЖЬ
		//-- НЕ УТКА
		|		КОГДА ПартииПолуфабрикатов.Партия ЕСТЬ НЕ NULL
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) 								КАК ТребуетсяРазузлование,
		|	(ВЫБОР
		|		КОГДА НЗППоПродукции.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЛОЖЬ
		//++ НЕ УТКА
		
		// Разузловывать затраты переработчика, если отчет формируется в валюте регл./упр. учета, по давальцу, не нужно
		|		КОГДА &ДанныеПоСебестоимости > 3
		|			И НЗППоПродукции.Организация = ЕСТЬNULL(ОтчетДавальцуМеждуОрганизациями.Давалец, НЕОПРЕДЕЛЕНО)
		|				ТОГДА ЛОЖЬ
		//-- НЕ УТКА
		|		КОГДА &РазворачиватьДопРасходы
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) 								КАК ТребуетсяРазузлованиеДопРасходов,
		|	&ТипЗатратМатериальные								КАК ТипЗатрат,
		|	ПартииМатериалов.Количество
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК КоличествоЗатрата,
		|
		|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
		|	ПартииМатериалов.Материальные
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК Материальные,
		|	ПартииМатериалов.Трудозатраты
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК Трудозатраты,
		|	ПартииМатериалов.ПостатейныеПостоянные
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянные,
		|	ПартииМатериалов.ПостатейныеПеременные
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременные,
		|	ПартииМатериалов.ДопРасходы
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходы,
		|	ПартииМатериалов.СуммаЗатратаЗабалансовая
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СуммаЗатратаЗабалансовая,
		|	ПартииМатериалов.СуммаЗатрата
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СуммаЗатрата,
		|	ПартииМатериалов.НДД
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК НДД,
		|
		|// Стоимости с НДС
		|	ПартииМатериалов.МатериальныеСНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеСНДС,
		|	ПартииМатериалов.ТрудозатратыСНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ТрудозатратыСНДС,
		|	ПартииМатериалов.ПостатейныеПостоянныеСНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеСНДС,
		|	ПартииМатериалов.ПостатейныеПеременныеСНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеСНДС,
		|	ПартииМатериалов.ДопРасходыСНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыСНДС,
		|
		|// Стоимости без НДС
		|	ПартииМатериалов.МатериальныеБезНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеБезНДС,
		|	ПартииМатериалов.ПостатейныеПостоянныеБезНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеБезНДС,
		|	ПартииМатериалов.ПостатейныеПеременныеБезНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеБезНДС,
		|	ПартииМатериалов.ДопРасходыБезНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыБезНДС,
		|
		|// Стоимости Упр
		|	ПартииМатериалов.МатериальныеУпр
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеУпр,
		|	ПартииМатериалов.ТрудозатратыУпр
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10))	КАК ТрудозатратыУпр,
		|	ПартииМатериалов.ПостатейныеПостоянныеУпр
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеУпр,
		|	ПартииМатериалов.ПостатейныеПеременныеУпр
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель	/ НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеУпр,
		|	ПартииМатериалов.ДопРасходыУпр
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыУпр,
		|	ПартииМатериалов.СтоимостьЗабалансоваяУпр
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель  КАК ЧИСЛО(31,10)) КАК СтоимостьЗабалансоваяУпр,
		|
		|// Стоимости Регл
		|	ПартииМатериалов.МатериальныеРегл
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеРегл,
		|	ПартииМатериалов.ТрудозатратыРегл
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ТрудозатратыРегл,
		|	ПартииМатериалов.ПостатейныеПостоянныеРегл
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеРегл,
		|	ПартииМатериалов.ПостатейныеПеременныеРегл
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеРегл,
		|	ПартииМатериалов.ДопРасходыРегл
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыРегл,
		|	ПартииМатериалов.СтоимостьЗабалансоваяРегл
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СтоимостьЗабалансоваяРегл,
		|
		|// Налоговый учет
		|	ПартииМатериалов.НалоговыйУчет
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК НалоговыйУчет,
		|	ПартииМатериалов.ПостояннаяРазница
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостояннаяРазница,
		|	ПартииМатериалов.ВременнаяРазница
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ВременнаяРазница
		|
		|ИЗ
		|	ВыбытиеИзНЗППоПродукции КАК НЗППоПродукции
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПервичныеЗатратыПоПериодам КАК ПартииМатериалов
		|		ПО НЗППоПродукции.Период = ПартииМатериалов.Период
		|			И НЗППоПродукции.АналитикаУчетаНоменклатуры = ПартииМатериалов.КорАналитикаУчетаНоменклатуры
		|			И НЗППоПродукции.Партия = ПартииМатериалов.КорПартия
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаЗатрат
		|		ПО НЗППоПродукции.АналитикаУчетаНоменклатуры = АналитикаЗатрат.КлючАналитики
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбытиеИзНЗП КАК ВыбытиеСводно
		|		ПО НЗППоПродукции.Период = ВыбытиеСводно.Период
		|			И НЗППоПродукции.АналитикаУчетаНоменклатуры = ВыбытиеСводно.АналитикаУчетаНоменклатуры
		|			И НЗППоПродукции.Партия = ВыбытиеСводно.Партия
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПартииПолуфабрикатов КАК ПартииПолуфабрикатов
		|		ПО ПартииМатериалов.Партия = ПартииПолуфабрикатов.Партия
		|			И ПартииМатериалов.АналитикаУчетаПартий = ПартииПолуфабрикатов.АналитикаУчетаПартий
		|			И ПартииМатериалов.АналитикаУчетаНоменклатуры = ПартииПолуфабрикатов.АналитикаУчетаНоменклатуры
		|			И (НЕ НЗППоПродукции.ПартияПродукции = ПартииПолуфабрикатов.Партия
		|				ИЛИ НЕ НЗППоПродукции.АналитикаУчетаПартийПродукции = ПартииПолуфабрикатов.АналитикаУчетаПартий
		|				ИЛИ НЕ НЗППоПродукции.АналитикаУчетаПродукции = ПартииПолуфабрикатов.АналитикаУчетаНоменклатуры)
		|			И (ПартииПолуфабрикатов.Организация = НЗППоПродукции.Организация
		|				ИЛИ &ДанныеПоСебестоимости < 3)
		//++ НЕ УТКА
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетДавальцуМеждуОрганизациями КАК ОтчетДавальцуМеждуОрганизациями
		|		ПО (ОтчетДавальцуМеждуОрганизациями.Ссылка = ПартииМатериалов.Партия)
		//-- НЕ УТКА
		|";
	
	ТекстыЗапроса.Добавить(ТекстМатериальныеЗатратыОбъединение);
#КонецОбласти	
	
#Область ТекстМатериалыНачальныеОстаткиНЗПОбъединение
	#Удаление
	ТекстМатериалыНачальныеОстаткиНЗПОбъединение =
		"ВЫБРАТЬ
		|	НЗППоПродукции.Организация							КАК Организация,
		|	НЗППоПродукции.ПартияПродукции						КАК ПартияВыходноеИзделие,
	#КонецУдаления
	#Вставка
	ТекстМатериалыНачальныеОстаткиНЗПОбъединение =
		"ВЫБРАТЬ
		|	НЗППоПродукции.Организация							КАК Организация,
		|	НЗППоПродукции.ПартияПродукции						КАК ПартияВыходноеИзделие,
	#КонецВставки
		|	НЗППоПродукции.АналитикаУчетаПартийПродукции		КАК АналитикаУчетаПартийВыходноеИзделие,
		|	НЗППоПродукции.АналитикаУчетаПродукции				КАК АналитикаУчетаВыходноеИзделие,
		|	НЗППоПродукции.Партия								КАК ПартияЗатрата,
		|	НЕОПРЕДЕЛЕНО										КАК АналитикаУчетаПартийЗатрата,
		|	ЛОЖЬ												КАК ВключитьНДСВСтоимость,
		|	ЛОЖЬ												КАК ИсключитьНДСИзСтоимости,
		|	НЗППоПродукции.АналитикаУчетаНоменклатуры			КАК АналитикаУчетаЗатрата,
		|	АналитикаЗатрат.Номенклатура						КАК Затрата,
		|	АналитикаЗатрат.Номенклатура.ЕдиницаИзмерения 		КАК ЕдиницаИзмеренияЗатрата,
		|	АналитикаЗатрат.Характеристика						КАК ХарактеристикаЗатрата,
		|	АналитикаЗатрат.Серия								КАК СерияЗатрата,
		|	АналитикаЗатрат.Назначение							КАК НазначениеЗатрата,
		|	АналитикаЗатрат.СтатьяКалькуляции					КАК СтатьяКалькуляции,
		|	АналитикаЗатрат.МестоХранения                       КАК Подразделение,
		|	ЛОЖЬ												КАК ТребуетсяРазузлование,
		|	ЛОЖЬ												КАК ТребуетсяРазузлованиеДопРасходов,
		|	&ТипЗатратМатериальные								КАК ТипЗатрат,
		|	НЗППоПродукции.Количество
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК КоличествоЗатрата,
		|
		|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
		|	НЗППоПродукции.Материальные
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК Материальные,
		|	НЗППоПродукции.Трудозатраты
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК Трудозатраты,
		|	НЗППоПродукции.ПостатейныеПостоянные
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянные,
		|	НЗППоПродукции.ПостатейныеПеременные
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременные,
		|	НЗППоПродукции.ДопРасходы
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходы,
		|	НЗППоПродукции.СуммаЗатратаЗабалансовая
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СуммаЗатратаЗабалансовая,
		|	НЗППоПродукции.СуммаЗатрата
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СуммаЗатрата,
		|	НЗППоПродукции.НДД
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК НДД,
		|
		|// Стоимости с НДС
		|	НЗППоПродукции.МатериальныеСНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеСНДС,
		|	НЗППоПродукции.ТрудозатратыСНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ТрудозатратыСНДС,
		|	НЗППоПродукции.ПостатейныеПостоянныеСНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеСНДС,
		|	НЗППоПродукции.ПостатейныеПеременныеСНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеСНДС,
		|	НЗППоПродукции.ДопРасходыСНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыСНДС,
		|
		|// Стоимости без НДС
		|	НЗППоПродукции.МатериальныеБезНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеБезНДС,
		|	НЗППоПродукции.ПостатейныеПостоянныеБезНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеБезНДС,
		|	НЗППоПродукции.ПостатейныеПеременныеБезНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеБезНДС,
		|	НЗППоПродукции.ДопРасходыБезНДС
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыБезНДС,
		|
		|// Стоимости Упр
		|	НЗППоПродукции.МатериальныеУпр
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеУпр,
		|	НЗППоПродукции.ТрудозатратыУпр
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ТрудозатратыУпр,
		|	НЗППоПродукции.ПостатейныеПостоянныеУпр
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель	/ НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеУпр,
		|	НЗППоПродукции.ПостатейныеПеременныеУпр
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеУпр,
		|	НЗППоПродукции.ДопРасходыУпр
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель	/ НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыУпр,
		|	НЗППоПродукции.СтоимостьЗабалансоваяУпр
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СтоимостьЗабалансоваяУпр,
		|
		|// Стоимости Регл
		|	НЗППоПродукции.МатериальныеРегл
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеРегл,
		|	НЗППоПродукции.ТрудозатратыРегл
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ТрудозатратыРегл,
		|	НЗППоПродукции.ПостатейныеПостоянныеРегл
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеРегл,
		|	НЗППоПродукции.ПостатейныеПеременныеРегл
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеРегл,
		|	НЗППоПродукции.ДопРасходыРегл
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыРегл,
		|	НЗППоПродукции.СтоимостьЗабалансоваяРегл
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СтоимостьЗабалансоваяРегл,
		|
		|// Налоговый учет
		|	НЗППоПродукции.НалоговыйУчет
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК НалоговыйУчет,
		|	НЗППоПродукции.ПостояннаяРазница
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостояннаяРазница,
		|	НЗППоПродукции.ВременнаяРазница
		|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ВременнаяРазница
		|
		|ИЗ
		|	ВыбытиеИзНЗППоПродукции КАК НЗППоПродукции
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеЗатратыПоПериодам КАК ПартииМатериалов
		|	    ПО НЗППоПродукции.Период = ПартииМатериалов.Период
		|			И НЗППоПродукции.АналитикаУчетаНоменклатуры = ПартииМатериалов.КорАналитикаУчетаНоменклатуры
		|			И НЗППоПродукции.Партия = ПартииМатериалов.КорПартия
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаЗатрат
		|		ПО НЗППоПродукции.АналитикаУчетаНоменклатуры = АналитикаЗатрат.КлючАналитики
		|ГДЕ
		|	ПартииМатериалов.Партия ЕСТЬ NULL
		|";
	
	ТекстыЗапроса.Добавить(ТекстМатериалыНачальныеОстаткиНЗПОбъединение);
	
#КонецОбласти
	
#Область ТекстТрудозатратыОбъединение
	#Удаление
	ТекстТрудозатратыОбъединение =
		"ВЫБРАТЬ
		|	ТрудозатратыНЗП.Организация						КАК Организация,
		|	ТрудозатратыНЗП.Регистратор						КАК ПартияВыходноеИзделие,
	#КонецУдаления
	#Вставка
	ТекстТрудозатратыОбъединение =
		"ВЫБРАТЬ
		|	ТрудозатратыНЗП.Организация						КАК Организация,
		|	ТрудозатратыНЗП.Регистратор						КАК ПартияВыходноеИзделие,
	#КонецВставки
		|	ТрудозатратыНЗП.КорАналитикаУчетаПартий			КАК АналитикаУчетаПартийВыходноеИзделие,
		|	ТрудозатратыНЗП.КорАналитикаУчетаПродукции		КАК АналитикаУчетаВыходноеИзделие,
		|	НЕОПРЕДЕЛЕНО									КАК ПартияЗатрата,
		|	НЕОПРЕДЕЛЕНО									КАК АналитикаУчетаПартийЗатрата,
		|	ЛОЖЬ											КАК ВключитьНДСВСтоимость,
		|	ЛОЖЬ											КАК ИсключитьНДСИзСтоимости,
		|	ТрудозатратыНЗП.ВидРабот						КАК АналитикаЗатрата,
		|	ТрудозатратыНЗП.ВидРабот						КАК Затрата,
		|	СпрВидыРабот.ЕдиницаИзмерения					КАК ЕдиницаИзмеренияЗатрата,
		|	НЕОПРЕДЕЛЕНО									КАК ХарактеристикаЗатрата,
		|	НЕОПРЕДЕЛЕНО									КАК СерияЗатрата,
		|	НЕОПРЕДЕЛЕНО									КАК НазначениеЗатрата,
		|	ТрудозатратыНЗП.СтатьяКалькуляции				КАК СтатьяКалькуляции,
		|	ТрудозатратыНЗП.Подразделение					КАК Подразделение,
		|	ЛОЖЬ											КАК ТребуетсяРазузлование,
		|	ЛОЖЬ											КАК ТребуетсяРазузлованиеДопРасходов,
		|	&ТипЗатратТрудозатраты							КАК ТипЗатрат,
		|	СУММА(ТрудозатратыНЗП.Количество
		|		* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК КоличествоЗатрата,
		|
		|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
		|	0												КАК Материальные,
		|	СУММА(ВЫБОР
		|		КОГДА &ДанныеПоСебестоимости = 1
		|			ТОГДА ТрудозатратыНЗП.Стоимость
		|		КОГДА &ДанныеПоСебестоимости = 2
		|			ТОГДА ТрудозатратыНЗП.Стоимость
		|		КОГДА &ДанныеПоСебестоимости = 3
		|			ТОГДА ТрудозатратыНЗП.Стоимость
		|		КОГДА &ДанныеПоСебестоимости = 4
		|			ТОГДА ТрудозатратыНЗП.СтоимостьРегл
		|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК Трудозатраты,
		|	0												КАК ПостатейныеПостоянные,
		|	0												КАК ПостатейныеПеременные,
		|	0												КАК ДопРасходы,
		|	0												КАК СуммаЗатратаЗабалансовая,
		|	СУММА(ВЫБОР
		|		КОГДА &ДанныеПоСебестоимости = 1
		|			ТОГДА ТрудозатратыНЗП.Стоимость
		|		КОГДА &ДанныеПоСебестоимости = 2
		|			ТОГДА ТрудозатратыНЗП.Стоимость
		|		КОГДА &ДанныеПоСебестоимости = 3
		|			ТОГДА ТрудозатратыНЗП.Стоимость
		|		КОГДА &ДанныеПоСебестоимости = 4
		|			ТОГДА ТрудозатратыНЗП.СтоимостьРегл
		|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК СуммаЗатрата,
		|	СУММА(ВЫБОР
		|			КОГДА &ДанныеПоСебестоимости = 4
		|				ТОГДА ТрудозатратыНЗП.СтоимостьНДД
		|			ИНАЧЕ 0
		|		КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК НДД,
		|
		|// Стоимости с НДС
		|	0												КАК МатериальныеСНДС,
		|	СУММА(ТрудозатратыНЗП.Стоимость
		|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ТрудозатратыСНДС,
		|	0												КАК ПостатейныеПостоянныеСНДС,
		|	0												КАК ПостатейныеПеременныеСНДС,
		|	0												КАК ДопРасходыСНДС,
		|
		|// Стоимости без НДС
		|	0												КАК МатериальныеБезНДС,
		|	0												КАК ПостатейныеПостоянныеБезНДС,
		|	0												КАК ПостатейныеПеременныеБезНДС,
		|	0												КАК ДопРасходыБезНДС,
		|
		|// Стоимости Упр
		|	0												КАК МатериальныеУпр,
		|	СУММА(ТрудозатратыНЗП.Стоимость
		|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ТрудозатратыУпр,
		|	0												КАК ПостатейныеПостоянныеУпр,
		|	0												КАК ПостатейныеПеременныеУпр,
		|	0												КАК ДопРасходыУпр,
		|	0												КАК СтоимостьЗабалансоваяУпр,
		|
		|// Стоимости Регл
		|	0												КАК МатериальныеРегл,
		|	СУММА(ТрудозатратыНЗП.СтоимостьРегл
		|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ТрудозатратыРегл,
		|	0												КАК ПостатейныеПостоянныеРегл,
		|	0												КАК ПостатейныеПеременныеРегл,
		|	0												КАК ДопРасходыРегл,
		|	0												КАК СтоимостьЗабалансоваяРегл,
		|
		|// Налоговый учет
		|	СУММА((ТрудозатратыНЗП.СтоимостьРегл
		|		- ТрудозатратыНЗП.ПостояннаяРазница
		|		- ТрудозатратыНЗП.ВременнаяРазница)
		|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК НалоговыйУчет,
		|	СУММА(ТрудозатратыНЗП.ПостояннаяРазница
		|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ПостояннаяРазница,
		|	СУММА(ТрудозатратыНЗП.ВременнаяРазница
		|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ВременнаяРазница
		|
		|ИЗ
		|	ВыпущеннаяПродукция КАК ВыпущеннаяПродукция
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ТрудозатратыНЗП
		|		ПО ТрудозатратыНЗП.Организация = ВыпущеннаяПродукция.Организация
		|		И ВыпущеннаяПродукция.ПартияПродукции = ТрудозатратыНЗП.Регистратор
		|		И ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции = ТрудозатратыНЗП.КорАналитикаУчетаПартий
		|		И ВыпущеннаяПродукция.АналитикаУчетаПродукции = ТрудозатратыНЗП.КорАналитикаУчетаПродукции
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыРаботСотрудников КАК СпрВидыРабот
		|		ПО СпрВидыРабот.Ссылка = ТрудозатратыНЗП.ВидРабот
		|
		|СГРУППИРОВАТЬ ПО
		|	ТрудозатратыНЗП.Организация,
		|	ТрудозатратыНЗП.ВидРабот,
		|	ТрудозатратыНЗП.СтатьяКалькуляции,
		|	СпрВидыРабот.ЕдиницаИзмерения,
		|	ТрудозатратыНЗП.КорАналитикаУчетаПродукции,
		|	ТрудозатратыНЗП.Регистратор,
		|	ТрудозатратыНЗП.КорАналитикаУчетаПартий,
		|	ТрудозатратыНЗП.Подразделение
		|";
	
	ТекстыЗапроса.Добавить(ТекстТрудозатратыОбъединение);
	
#КонецОбласти
	
#Область ТекстПрочиеРасходыОбъединение
	#Удаление
	ТекстПрочиеРасходыОбъединение =
		"ВЫБРАТЬ
		|	ПрочиеРасходыНЗП.Организация				КАК Организация,
		|	ПрочиеРасходыНЗП.Регистратор				КАК ПартияВыходноеИзделие,
	#КонецУдаления
	#Вставка
	ТекстПрочиеРасходыОбъединение =
		"ВЫБРАТЬ
		|	ПрочиеРасходыНЗП.Организация				КАК Организация,
		|	ПрочиеРасходыНЗП.Регистратор				КАК ПартияВыходноеИзделие,
	#КонецВставки
		|	ПрочиеРасходыНЗП.КорАналитикаУчетаПартий	КАК АналитикаУчетаПартийВыходноеИзделие,
		|	ПрочиеРасходыНЗП.АналитикаУчетаПродукции	КАК АналитикаУчетаВыходноеИзделие,
		|	НЕОПРЕДЕЛЕНО								КАК ПартияЗатрата,
		|	НЕОПРЕДЕЛЕНО								КАК АналитикаУчетаПартийЗатрата,
		|	ЛОЖЬ										КАК ВключитьНДСВСтоимость,
		|	ЛОЖЬ										КАК ИсключитьНДСИзСтоимости,
		|	ПрочиеРасходыНЗП.СтатьяРасходов				КАК АналитикаЗатрата,
		|	ПрочиеРасходыНЗП.СтатьяРасходов				КАК Затрата,
		|	НЕОПРЕДЕЛЕНО								КАК ЕдиницаИзмеренияЗатрата,
		|	НЕОПРЕДЕЛЕНО								КАК ХарактеристикаЗатрата,
		|	НЕОПРЕДЕЛЕНО								КАК СерияЗатрата,
		|	НЕОПРЕДЕЛЕНО								КАК НазначениеЗатрата,
		|	ПрочиеРасходыНЗП.СтатьяКалькуляции			КАК СтатьяКалькуляции,
		|	ПрочиеРасходыНЗП.Подразделение				КАК Подразделение,
		|	ЛОЖЬ										КАК ТребуетсяРазузлование,
		|	ЛОЖЬ										КАК ТребуетсяРазузлованиеДопРасходов,
		|	&ТипЗатратПостатейные						КАК ТипЗатрат,
		|	0											КАК КоличествоЗатрата,
		|
		|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
		|	0											КАК Материальные,
		|	0											КАК Трудозатраты,
		|	СУММА(ВЫБОР
		|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
		|			ТОГДА 0
		|		КОГДА &ДанныеПоСебестоимости = 1
		|			ТОГДА ПрочиеРасходыНЗП.Стоимость
		|		КОГДА &ДанныеПоСебестоимости = 2
		|			ТОГДА ПрочиеРасходыНЗП.СтоимостьБезНДС
		|		КОГДА &ДанныеПоСебестоимости = 3
		|			ТОГДА ПрочиеРасходыНЗП.СтоимостьУпр
		|		КОГДА &ДанныеПоСебестоимости = 4
		|			ТОГДА ПрочиеРасходыНЗП.СтоимостьРегл
		|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПостоянные,
		|	СУММА(ВЫБОР
		|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
		|			ТОГДА 0
		|		КОГДА &ДанныеПоСебестоимости = 1
		|			ТОГДА ПрочиеРасходыНЗП.Стоимость
		|		КОГДА &ДанныеПоСебестоимости = 2
		|			ТОГДА ПрочиеРасходыНЗП.СтоимостьБезНДС
		|		КОГДА &ДанныеПоСебестоимости = 3
		|			ТОГДА ПрочиеРасходыНЗП.СтоимостьУпр
		|		КОГДА &ДанныеПоСебестоимости = 4
		|			ТОГДА ПрочиеРасходыНЗП.СтоимостьРегл
		|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПеременные,
		|	0											КАК ДопРасходы,
		|	0											КАК СуммаЗатратаЗабалансовая,
		|	СУММА(ВЫБОР
		|		КОГДА &ДанныеПоСебестоимости = 1
		|			ТОГДА ПрочиеРасходыНЗП.Стоимость
		|		КОГДА &ДанныеПоСебестоимости = 2
		|			ТОГДА ПрочиеРасходыНЗП.СтоимостьБезНДС
		|		КОГДА &ДанныеПоСебестоимости = 3
		|			ТОГДА ПрочиеРасходыНЗП.СтоимостьУпр
		|		КОГДА &ДанныеПоСебестоимости = 4
		|			ТОГДА ПрочиеРасходыНЗП.СтоимостьРегл
		|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК СуммаЗатрата,
		|	СУММА(ВЫБОР
		|		КОГДА &ДанныеПоСебестоимости = 4
		|			ТОГДА ПрочиеРасходыНЗП.СтоимостьНДД
		|		ИНАЧЕ 0
		|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК НДД,
		|
		|// Стоимости с НДС
		|	0											КАК МатериальныеСНДС,
		|	0											КАК ТрудозатратыСНДС,
		|	СУММА(ВЫБОР
		|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
		|			ТОГДА 0
		|		ИНАЧЕ ПрочиеРасходыНЗП.Стоимость
		|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ПостатейныеПостоянныеСНДС,
		|	СУММА(ВЫБОР
		|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
		|			ТОГДА 0
		|		ИНАЧЕ ПрочиеРасходыНЗП.Стоимость
		|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПеременныеСНДС,
		|	0											КАК ДопРасходыСНДС,
		|
		|// Стоимости без НДС
		|	0											КАК МатериальныеБезНДС,
		|	СУММА(ВЫБОР
		|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
		|			ТОГДА 0
		|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьБезНДС
		|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПостоянныеБезНДС,
		|	СУММА(ВЫБОР
		|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
		|			ТОГДА 0
		|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьБезНДС
		|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПеременныеБезНДС,
		|	0											КАК ДопРасходыБезНДС,
		|
		|// Стоимости Упр
		|	0											КАК МатериальныеУпр,
		|	0											КАК ТрудозатратыУпр,
		|	СУММА(ВЫБОР
		|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
		|			ТОГДА 0
		|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьУпр
		|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПостоянныеУпр,
		|	СУММА(ВЫБОР
		|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
		|			ТОГДА 0
		|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьУпр
		|	КОНЕЦ * ВыпущеннаяПродукция.Числитель
		|			/ ВыпущеннаяПродукция.Знаменатель)	КАК ПостатейныеПеременныеУпр,
		|	0											КАК ДопРасходыУпр,
		|	0											КАК СтоимостьЗабалансоваяУпр,
		|
		|// Стоимости Регл
		|	0											КАК МатериальныеРегл,
		|	0											КАК ТрудозатратыРегл,
		|	СУММА(ВЫБОР
		|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
		|			ТОГДА 0
		|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьРегл
		|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПостоянныеРегл,
		|	СУММА(ВЫБОР
		|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
		|			ТОГДА 0
		|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьРегл
		|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПеременныеРегл,
		|	0											КАК ДопРасходыРегл,
		|	0											КАК СтоимостьЗабалансоваяРегл,
		|
		|// Налоговый учет
		|	СУММА((ПрочиеРасходыНЗП.СтоимостьРегл
		|		- ПрочиеРасходыНЗП.ПостояннаяРазница
		|		- ПрочиеРасходыНЗП.ВременнаяРазница)
		|		* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК НалоговыйУчет,
		|	СУММА(ПрочиеРасходыНЗП.ПостояннаяРазница
		|		* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ПостояннаяРазница,
		|	СУММА(ПрочиеРасходыНЗП.ВременнаяРазница
		|		* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ВременнаяРазница
		|
		|ИЗ
		|	ВыпущеннаяПродукция КАК ВыпущеннаяПродукция
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ПрочиеРасходыНЗП
		|		ПО ВыпущеннаяПродукция.Организация = ПрочиеРасходыНЗП.Организация
		|		И ВыпущеннаяПродукция.ПартияПродукции = ПрочиеРасходыНЗП.Регистратор
		|		И ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции = ПрочиеРасходыНЗП.КорАналитикаУчетаПартий
		|		И ВыпущеннаяПродукция.АналитикаУчетаПродукции = ПрочиеРасходыНЗП.АналитикаУчетаПродукции
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
		|		ПО ПрочиеРасходыНЗП.СтатьяРасходов = СтатьиРасходов.Ссылка
		|
		|СГРУППИРОВАТЬ ПО
		|	ПрочиеРасходыНЗП.Организация,
		|	ПрочиеРасходыНЗП.СтатьяРасходов,
		|	ПрочиеРасходыНЗП.СтатьяКалькуляции,
		|	ПрочиеРасходыНЗП.АналитикаУчетаПродукции,
		|	ПрочиеРасходыНЗП.Регистратор,
		|	ПрочиеРасходыНЗП.КорАналитикаУчетаПартий,
		|	ПрочиеРасходыНЗП.Подразделение
		|";
	
	ТекстыЗапроса.Добавить(ТекстПрочиеРасходыОбъединение);
	
#КонецОбласти
	
#Область ТекстДопРасходыОбъединение
	
	Если ВыводитьДопРасходы Тогда
			
		#Удаление
		ТекстДопРасходыОбъединение =
			"ВЫБРАТЬ
			|	ДетализацияСебестоимости.Организация		КАК Организация,
			|	ДетализацияСебестоимости.Партия				КАК ПартияВыходноеИзделие,
		#КонецУдаления
		#Вставка
		ТекстДопРасходыОбъединение =
			"ВЫБРАТЬ
			|	ДетализацияСебестоимости.Организация		КАК Организация,
			|	ДетализацияСебестоимости.Партия				КАК ПартияВыходноеИзделие,
		#КонецВставки
			|	ДетализацияСебестоимости.АналитикаУчетаПартий	КАК АналитикаУчетаПартийВыходноеИзделие,
			|	&АналитикаУчетаВыходноеИзделие				КАК АналитикаУчетаВыходноеИзделие,
			|	ДетализацияСебестоимости.ДокументПоступления КАК ПартияЗатрата,
			|	ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийЗатрата,
			|	ЛОЖЬ										КАК ВключитьНДСВСтоимость,
			|	ЛОЖЬ										КАК ИсключитьНДСИзСтоимости,
			|	ДетализацияСебестоимости.АналитикаРасходов	КАК АналитикаЗатрата,
			|	ВЫБОР
			|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
			|			ТОГДА ЕСТЬNULL(ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления.ВидЦенности, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка))
			|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов
			|	КОНЕЦ КАК Затрата,
			|	НЕОПРЕДЕЛЕНО								КАК ЕдиницаИзмеренияЗатрата,
			|	НЕОПРЕДЕЛЕНО								КАК ХарактеристикаЗатрата,
			|	НЕОПРЕДЕЛЕНО								КАК СерияЗатрата,
			|	НЕОПРЕДЕЛЕНО								КАК НазначениеЗатрата,
			|	&СтатьяКалькуляции							КАК СтатьяКалькуляции,
			|	НЕОПРЕДЕЛЕНО								КАК Подразделение,
			|	ЛОЖЬ										КАК ТребуетсяРазузлование,
			|	ЛОЖЬ										КАК ТребуетсяРазузлованиеДопРасходов,
			|	&ТипЗатратДопРасходы						КАК ТипЗатрат,
			|	0											КАК КоличествоЗатрата,
			|
			|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
			|	0											КАК Материальные,
			|	0											КАК Трудозатраты,
			|	0											КАК ПостатейныеПостоянные,
			|	0											КАК ПостатейныеПеременные,
			|	СУММА(ВЫБОР
			|		КОГДА &ДанныеПоСебестоимости = 1
			|			ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
			|		КОГДА &ДанныеПоСебестоимости = 2
			|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
			|		КОГДА &ДанныеПоСебестоимости = 3
			|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
			|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ)
			|		КОГДА &ДанныеПоСебестоимости = 4
			|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
			|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ)
			|	КОНЕЦ * &КоличествоПродукции)				КАК ДопРасходы,
			|	0											КАК СуммаЗатратаЗабалансовая,
			|	СУММА(ВЫБОР
			|		КОГДА &ДанныеПоСебестоимости = 1
			|			ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
			|		КОГДА &ДанныеПоСебестоимости = 2
			|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
			|		КОГДА &ДанныеПоСебестоимости = 3
			|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
			|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ)
			|		КОГДА &ДанныеПоСебестоимости = 4
			|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
			|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ)
			|	КОНЕЦ * &КоличествоПродукции)				КАК СуммаЗатрата,
			|	0											КАК НДД,
			|
			|// Стоимости с НДС
			|	0											КАК МатериальныеСНДС,
			|	0											КАК ТрудозатратыСНДС,
			|	0											КАК ПостатейныеПостоянныеСНДС,
			|	0											КАК ПостатейныеПеременныеСНДС,
			|	СУММА(ДетализацияСебестоимости.СтоимостьСНДС
			|			* &КоличествоПродукции)				КАК ДопРасходыСНДС,
			|
			|// Стоимости без НДС
			|	0											КАК МатериальныеБезНДС,
			|	0											КАК ПостатейныеПостоянныеБезНДС,
			|	0											КАК ПостатейныеПеременныеБезНДС,
			|	СУММА(ДетализацияСебестоимости.СтоимостьБезНДС
			|			* &КоличествоПродукции)				КАК ДопРасходыБезНДС,
			|
			|// Стоимости Упр
			|	0											КАК МатериальныеУпр,
			|	0											КАК ТрудозатратыУпр,
			|	0											КАК ПостатейныеПостоянныеУпр,
			|	0											КАК ПостатейныеПеременныеУпр,
			|	СУММА((ДетализацияСебестоимости.СтоимостьБезНДСУпр
			|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ))
			|			* &КоличествоПродукции)				КАК ДопРасходыУпр,
			|	0											КАК СтоимостьЗабалансоваяУпр,
			|
			|// Стоимости Регл
			|	0											КАК МатериальныеРегл,
			|	0											КАК ТрудозатратыРегл,
			|	0											КАК ПостатейныеПостоянныеРегл,
			|	0											КАК ПостатейныеПеременныеРегл,
			|	СУММА((ДетализацияСебестоимости.СтоимостьБезНДСРегл 
			|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ))
			|			* &КоличествоПродукции)				КАК ДопРасходыРегл,
			|	0											КАК СтоимостьЗабалансоваяРегл,
			|
			|// Налоговый учет
			|	0 КАК НалоговыйУчет,
			|	0 КАК ПостояннаяРазница,
			|	0 КАК ВременнаяРазница
			|
			|ИЗ
			|	РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК ДетализацияСебестоимости
			|		
			|ГДЕ 
			|	ДетализацияСебестоимости.Партия В (&ПартииПродукции)
			|	И ДетализацияСебестоимости.АналитикаУчетаПартий В (&АналитикиУчетаПартийПродукции)
			|	И ДетализацияСебестоимости.Номенклатура В (&Продукция)
			|	И ДетализацияСебестоимости.Характеристика В (&ХарактеристикиПродукции)
			|	И НЕ ДетализацияСебестоимости.ЗатратыПредыдущихПеределов
			|	И НЕ ВЫБОР
			|			КОГДА &ДанныеПоСебестоимости = 1
			|				ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
			|			КОГДА &ДанныеПоСебестоимости = 2
			|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
			|			КОГДА &ДанныеПоСебестоимости = 3
			|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
			|			КОГДА &ДанныеПоСебестоимости = 4
			|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
			|		КОНЕЦ = 0
			|	И ВЫБОР
			|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
			|			ТОГДА ИСТИНА	
			|		КОГДА &ДанныеПоСебестоимости = 4
			|			ТОГДА ДетализацияСебестоимости.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
			|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
			|	КОНЕЦ 
			|
			|СГРУППИРОВАТЬ ПО
			|	ДетализацияСебестоимости.Организация,
			|	ДетализацияСебестоимости.Партия,
			|	ДетализацияСебестоимости.АналитикаУчетаПартий,
			|	ДетализацияСебестоимости.ДокументПоступления,
			|	ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления,
			|	ДетализацияСебестоимости.АналитикаРасходов,
			|	ВЫБОР
			|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
			|			ТОГДА ЕСТЬNULL(ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления.ВидЦенности, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка))
			|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов
			|	КОНЕЦ
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	ДетализацияСебестоимости.Организация		КАК Организация,
			|	ДетализацияСебестоимости.Партия				КАК ПартияВыходноеИзделие,
			|	ДетализацияСебестоимости.АналитикаУчетаПартий	КАК АналитикаУчетаПартийВыходноеИзделие,
			|	&АналитикаУчетаВыходноеИзделие				КАК АналитикаУчетаВыходноеИзделие,
			|	ДетализацияСебестоимости.ДокументПоступления КАК ПартияЗатрата,
			|	ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийЗатрата,
			|	ЛОЖЬ										КАК ВключитьНДСВСтоимость,
			|	ЛОЖЬ										КАК ИсключитьНДСИзСтоимости,
			|	ДетализацияСебестоимости.АналитикаРасходов	КАК АналитикаЗатрата,
			|	ВЫБОР
			|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
			|			ТОГДА ЕСТЬNULL(ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления.ВидЦенности, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка))
			|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов
			|	КОНЕЦ КАК Затрата,
			|	НЕОПРЕДЕЛЕНО								КАК ЕдиницаИзмеренияЗатрата,
			|	НЕОПРЕДЕЛЕНО								КАК ХарактеристикаЗатрата,
			|	НЕОПРЕДЕЛЕНО								КАК СерияЗатрата,
			|	НЕОПРЕДЕЛЕНО								КАК НазначениеЗатрата,
			|	&СтатьяКалькуляции							КАК СтатьяКалькуляции,
			|	НЕОПРЕДЕЛЕНО								КАК Подразделение,
			|	ЛОЖЬ										КАК ТребуетсяРазузлование,
			|	ЛОЖЬ										КАК ТребуетсяРазузлованиеДопРасходов,
			|	&ТипЗатратДопРасходы						КАК ТипЗатрат,
			|	0											КАК КоличествоЗатрата,
			|
			|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
			|	0											КАК Материальные,
			|	0											КАК Трудозатраты,
			|	0											КАК ПостатейныеПостоянные,
			|	0											КАК ПостатейныеПеременные,
			|	СУММА(ВЫБОР
			|		КОГДА &ДанныеПоСебестоимости = 1
			|			ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
			|		КОГДА &ДанныеПоСебестоимости = 2
			|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
			|		КОГДА &ДанныеПоСебестоимости = 3
			|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
			|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ)
			|		КОГДА &ДанныеПоСебестоимости = 4
			|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
			|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ)
			|	КОНЕЦ * &КоличествоПродукции)				КАК ДопРасходы,
			|	0											КАК СуммаЗатратаЗабалансовая,
			|	СУММА(ВЫБОР
			|		КОГДА &ДанныеПоСебестоимости = 1
			|			ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
			|		КОГДА &ДанныеПоСебестоимости = 2
			|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
			|		КОГДА &ДанныеПоСебестоимости = 3
			|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
			|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ)
			|		КОГДА &ДанныеПоСебестоимости = 4
			|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
			|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ)
			|	КОНЕЦ * &КоличествоПродукции)				КАК СуммаЗатрата,
			|	0											КАК НДД,
			|
			|// Стоимости с НДС
			|	0											КАК МатериальныеСНДС,
			|	0											КАК ТрудозатратыСНДС,
			|	0											КАК ПостатейныеПостоянныеСНДС,
			|	0											КАК ПостатейныеПеременныеСНДС,
			|	СУММА(ДетализацияСебестоимости.СтоимостьСНДС
			|			* &КоличествоПродукции)				КАК ДопРасходыСНДС,
			|
			|// Стоимости без НДС
			|	0											КАК МатериальныеБезНДС,
			|	0											КАК ПостатейныеПостоянныеБезНДС,
			|	0											КАК ПостатейныеПеременныеБезНДС,
			|	СУММА(ДетализацияСебестоимости.СтоимостьБезНДС
			|			* &КоличествоПродукции)				КАК ДопРасходыБезНДС,
			|
			|// Стоимости Упр
			|	0											КАК МатериальныеУпр,
			|	0											КАК ТрудозатратыУпр,
			|	0											КАК ПостатейныеПостоянныеУпр,
			|	0											КАК ПостатейныеПеременныеУпр,
			|	СУММА((ДетализацияСебестоимости.СтоимостьБезНДСУпр
			|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ))
			|			* &КоличествоПродукции)				КАК ДопРасходыУпр,
			|	0											КАК СтоимостьЗабалансоваяУпр,
			|
			|// Стоимости Регл
			|	0											КАК МатериальныеРегл,
			|	0											КАК ТрудозатратыРегл,
			|	0											КАК ПостатейныеПостоянныеРегл,
			|	0											КАК ПостатейныеПеременныеРегл,
			|	СУММА((ДетализацияСебестоимости.СтоимостьБезНДСРегл
			|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ))
			|			* &КоличествоПродукции)				КАК ДопРасходыРегл,
			|	0											КАК СтоимостьЗабалансоваяРегл,
			|
			|// Налоговый учет
			|	0 КАК НалоговыйУчет,
			|	0 КАК ПостояннаяРазница,
			|	0 КАК ВременнаяРазница
			|ИЗ
			|	РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК ДетализацияСебестоимости
			|		
			|ГДЕ 
			|	ДетализацияСебестоимости.Период МЕЖДУ НАЧАЛОПЕРИОДА(&ДатаИсходнойПартии, МЕСЯЦ) И КОНЕЦПЕРИОДА(&ДатаИсходнойПартии, МЕСЯЦ)
			|	И ДетализацияСебестоимости.Партия В (&ПартииПродукции)
			|	И ДетализацияСебестоимости.АналитикаУчетаПартий В (&АналитикиУчетаПартийПродукции)
			|	И ДетализацияСебестоимости.АналитикаУчетаНоменклатуры В (&АналитикаУчетаЗатрата)
			|	И ДетализацияСебестоимости.РазделУчета В (
			|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах),
			|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты))
			|	И НЕ ВЫБОР
			|			КОГДА &ДанныеПоСебестоимости = 1
			|				ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
			|			КОГДА &ДанныеПоСебестоимости = 2
			|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
			|			КОГДА &ДанныеПоСебестоимости = 3
			|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
			|			КОГДА &ДанныеПоСебестоимости = 4
			|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
			|		КОНЕЦ = 0
			|	И ВЫБОР
			|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
			|			ТОГДА ИСТИНА	
			|		КОГДА &ДанныеПоСебестоимости = 4
			|			ТОГДА ДетализацияСебестоимости.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
			|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
			|	КОНЕЦ 
			|
			|СГРУППИРОВАТЬ ПО
			|	ДетализацияСебестоимости.Организация,
			|	ДетализацияСебестоимости.Партия,
			|	ДетализацияСебестоимости.АналитикаУчетаНоменклатуры,
			|	ДетализацияСебестоимости.АналитикаУчетаПартий,
			|	ДетализацияСебестоимости.ДокументПоступления,
			|	ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления,
			|	ДетализацияСебестоимости.АналитикаРасходов,
			|	ВЫБОР
			|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
			|			ТОГДА ЕСТЬNULL(ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления.ВидЦенности, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка))
			|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов
			|	КОНЕЦ
			|";
		
		ТекстыЗапроса.Добавить(ТекстДопРасходыОбъединение);
	
	КонецЕсли;
	
#КонецОбласти
		
	Возврат ТекстМатериальныеЗатраты
			+ СтрСоединить(ТекстыЗапроса, " ОБЪЕДИНИТЬ ВСЕ ");
	
КонецФункции

&ИзменениеИКонтроль("ПостроитьДеревоСебестоимости")
Процедура ikon_cost_ПостроитьДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла = Неопределено) Экспорт

	#Вставка
	// КРИТИЧНО: Для отчётов (МенеджерВременныхТаблиц) полуфабрикаты НЕОБХОДИМЫ!
	// Они используются для построения связей между материалами и продукцией в запросе отчета.
	// Отчёт строит таблицу КоличествоВыпуска из продукции и полуфабрикатов,
	// затем соединяет материалы с полуфабрикатами по ПартияВыходноеИзделие.
	// Без полуфабрикатов материалы "висят в воздухе" без связи с продукцией.
	// Поэтому оставляем ДобавлятьПолуфабрикатыВРезультат = Истина (как в оригинале)
	#КонецВставки
	
	// СтандартныеПодсистемы.ЗамерПроизводительности
	Замер = ОценкаПроизводительности.НачатьЗамерДлительнойОперации("ОбщийМодуль.СтруктураСебестоимости.ПостроитьДеревоСебестоимости");
	ПараметрыДерева.Вставить("КоличествоСтрок", 0);
	#Вставка
	// === ЗАМЕРЫ ПРОИЗВОДИТЕЛЬНОСТИ ===
	ПараметрыДерева.Вставить("Замер_ВремяНачала", ТекущаяДатаСеанса());
	ПараметрыДерева.Вставить("Замер_ВремяЗапросов", 0);
	ПараметрыДерева.Вставить("Замер_ВремяОбработки", 0);
	ПараметрыДерева.Вставить("Замер_ВремяПроверкиЦиклов", 0);
	ПараметрыДерева.Вставить("Замер_КоличествоЗапросов", 0);
	ПараметрыДерева.Вставить("Замер_КоличествоПроверокЦиклов", 0);
	ПараметрыДерева.Вставить("Замер_СтатистикаУровней", Новый Массив);  // для нового алгоритма
	ПараметрыДерева.Вставить("Замер_МаксУровень", 0);                   // для старого алгоритма
	#КонецВставки
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности
	
	Если ПараметрыУзла = Неопределено Тогда
		ПараметрыУзла = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();
	КонецЕсли;
	#Вставка
	// ВАЖНО: Пакетная обработка несовместима с динамическим считыванием
	// Если включена пакетная обработка, автоматически отключаем динамическое считывание
	Если ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
		И ПараметрыДерева.ИспользоватьПакетнуюОбработку
		И ПараметрыДерева.ДинамическоеСчитывание Тогда
		
		ПараметрыДерева.ДинамическоеСчитывание = Ложь;
		
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.ПакетнаяОбработка",
			УровеньЖурналаРегистрации.Предупреждение,
			,
			,
			"Динамическое считывание автоматически отключено для использования пакетной обработки");
	КонецЕсли;
	#КонецВставки
	
	Если ПараметрыДерева.Результат = Неопределено Тогда
		ПустоеДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла);
	КонецЕсли;

	ЗаполнитьДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла);
	#Вставка
	// Вывод статистики по обнаруженным циклам
	Если ПараметрыДерева.Свойство("ОбнаруженныеЦиклы") 
		И ПараметрыДерева.ОбнаруженныеЦиклы.Количество() > 0 Тогда
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"При построении дерева себестоимости обнаружено циклических зависимостей: %1",
			Строка(ПараметрыДерева.ОбнаруженныеЦиклы.Количество()));
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.СтатистикаЦиклов",
			УровеньЖурналаРегистрации.Предупреждение,
			,
			,
			ТекстСообщения);
	КонецЕсли;
	#КонецВставки
	
	#Вставка
	// === ВЫВОД РЕЗУЛЬТАТОВ ЗАМЕРОВ ===
	Если ПараметрыДерева.Свойство("Замер_ВремяНачала") Тогда
		
		// Вычисляем общее время в секундах (ТекущаяДатаСеанса() возвращает дату, разница дат - в секундах)
		ВремяОбщее = ТекущаяДатаСеанса() - ПараметрыДерева.Замер_ВремяНачала;
		ВремяПрочее = ВремяОбщее - ПараметрыДерева.Замер_ВремяЗапросов 
			- ПараметрыДерева.Замер_ВремяОбработки;
		
		ПроцентЗапросов = ?(ВремяОбщее > 0, 
			Окр(ПараметрыДерева.Замер_ВремяЗапросов / ВремяОбщее * 100, 1), 0);
		ПроцентОбработки = ?(ВремяОбщее > 0, 
			Окр(ПараметрыДерева.Замер_ВремяОбработки / ВремяОбщее * 100, 1), 0);
		ПроцентЦиклов = ?(ВремяОбщее > 0, 
			Окр(ПараметрыДерева.Замер_ВремяПроверкиЦиклов / ВремяОбщее * 100, 1), 0);
		
		// Определяем тип алгоритма
		ИспользуетсяПакетныйАлгоритм = ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
			И ПараметрыДерева.ИспользоватьПакетнуюОбработку;
		ТипАлгоритма = ?(ИспользуетсяПакетныйАлгоритм, "НОВЫЙ (пакетный)", "СТАРЫЙ (рекурсивный)");
		
		ТекстЗамера = "
|=== ЗАМЕРЫ ПРОИЗВОДИТЕЛЬНОСТИ ===
|Алгоритм: " + ТипАлгоритма + "
|Общее время: " + Строка(Окр(ВремяОбщее, 3)) + " сек
|
|ВРЕМЯ ПО ОПЕРАЦИЯМ:
|  Запросы к БД:      " + Строка(Окр(ПараметрыДерева.Замер_ВремяЗапросов, 3)) + " сек (" + Строка(ПроцентЗапросов) + "%)
|  Обработка:         " + Строка(Окр(ПараметрыДерева.Замер_ВремяОбработки, 3)) + " сек (" + Строка(ПроцентОбработки) + "%)
|  Проверка циклов:   " + Строка(Окр(ПараметрыДерева.Замер_ВремяПроверкиЦиклов, 3)) + " сек (" + Строка(ПроцентЦиклов) + "%)
|  Прочее:            " + Строка(Окр(ВремяПрочее, 3)) + " сек
|
|СТАТИСТИКА:
|  Запросов к БД:     " + Строка(ПараметрыДерева.Замер_КоличествоЗапросов) + "
|  Проверок циклов:   " + Строка(ПараметрыДерева.Замер_КоличествоПроверокЦиклов);
		
		// Статистика по уровням (только для нового алгоритма)
		Если ПараметрыДерева.Свойство("Замер_СтатистикаУровней") 
			И ПараметрыДерева.Замер_СтатистикаУровней.Количество() > 0 Тогда
			
			ТекстЗамера = ТекстЗамера + "
|  Уровней дерева:    " + Строка(ПараметрыДерева.Замер_СтатистикаУровней.Количество());
			
			Для Каждого СтатУровня Из ПараметрыДерева.Замер_СтатистикаУровней Цикл
				ТекстЗамера = ТекстЗамера + "
|    Уровень " + Строка(СтатУровня.НомерУровня) + ": узлов=" + Строка(СтатУровня.КоличествоУзлов) 
					+ ", ПройденныйПуть=" + Строка(СтатУровня.РазмерПройденныйПуть);
			КонецЦикла;
		КонецЕсли;
		
		// Максимальный уровень (только для старого алгоритма)
		Если ПараметрыДерева.Свойство("Замер_МаксУровень") Тогда
			ТекстЗамера = ТекстЗамера + "
|  Макс. глубина:     " + Строка(ПараметрыДерева.Замер_МаксУровень);
		КонецЕсли;
		
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.ЗАМЕРЫ",
			УровеньЖурналаРегистрации.Предупреждение,
			,
			,
			ТекстЗамера);
			
	КонецЕсли;
	#КонецВставки

	// СтандартныеПодсистемы.ЗамерПроизводительности
	ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(Замер, ПараметрыДерева.КоличествоСтрок / 1000);
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности

КонецПроцедуры

&ИзменениеИКонтроль("РазузловатьУзелДереваСебестоимости")
Процедура ikon_cost_РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзла, ТаблицаРезультата, ОписаниеПродукции)

	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		Результат = ТаблицаРезультата.Строки;
		Если ПараметрыДерева.ДинамическоеСчитывание Тогда
			Результат.Очистить();
		КонецЕсли;
	Иначе
		Результат = ТаблицаРезультата
	КонецЕсли;

	ПройденныйПуть = Неопределено;
	Если НЕ ПараметрыДерева.Свойство("ПройденныйПуть", ПройденныйПуть) Тогда
		ПройденныйПуть = Новый ТаблицаЗначений;
		ПройденныйПуть.Колонки.Добавить("Партия");
		ПройденныйПуть.Колонки.Добавить("АналитикаУчетаПартий");
		ПройденныйПуть.Индексы.Добавить("Партия, АналитикаУчетаПартий");
		ПараметрыДерева.Вставить("ПройденныйПуть", ПройденныйПуть);
		#Вставка
		// Инициализируем параметры защиты от циклов и глубокой рекурсии
		ПараметрыДерева.Вставить("МаксимальнаяГлубинаРекурсии", 50);
		ПараметрыДерева.Вставить("ОбнаруженныеЦиклы", Новый Массив);
		#КонецВставки
	КонецЕсли;

	АналитикаУчетаПродукции			= ОписаниеПродукции.АналитикаУчетаПродукции;
	ПартияПродукции					= ОписаниеПродукции.ПартияПродукции;
	АналитикаУчетаПартийПродукции	= ОписаниеПродукции.АналитикаУчетаПартийПродукции;
	УровеньУзла						= ОписаниеПродукции.Уровень + 1;
	#Вставка
	// ЗАМЕР С3: максимальная глубина рекурсии
	Если ПараметрыДерева.Свойство("Замер_МаксУровень") Тогда
		Если УровеньУзла > ПараметрыДерева.Замер_МаксУровень Тогда
			ПараметрыДерева.Замер_МаксУровень = УровеньУзла;
		КонецЕсли;
	КонецЕсли;
	
	// Проверка максимальной глубины рекурсии
	Если УровеньУзла > ПараметрыДерева.МаксимальнаяГлубинаРекурсии Тогда
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"Достигнута максимальная глубина разузлования (%1 уровней). Партия: %2, Аналитика партий: %3",
			Строка(УровеньУзла),
			Строка(ПартияПродукции),
			Строка(АналитикаУчетаПартийПродукции));
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.МаксимальнаяГлубинаРекурсии",
			УровеньЖурналаРегистрации.Предупреждение,
			,
			,
			ТекстСообщения);
		Возврат;
	КонецЕсли;
	#КонецВставки

	ВыводитьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы И НЕ (УровеньУзла = 1);
	#Вставка
	// ЗАМЕР С1: время запроса
	ВремяДоЗапроса = ТекущаяДатаСеанса();
	#КонецВставки
	СебестоимостьУзла = СебестоимостьУзла(ПараметрыДерева, ПараметрыУзла, ВыводитьДопРасходы);
	#Вставка
	Если ПараметрыДерева.Свойство("Замер_ВремяЗапросов") Тогда
		ПараметрыДерева.Замер_ВремяЗапросов = ПараметрыДерева.Замер_ВремяЗапросов 
			+ (ТекущаяДатаСеанса() - ВремяДоЗапроса);
		ПараметрыДерева.Замер_КоличествоЗапросов = ПараметрыДерева.Замер_КоличествоЗапросов + 1;
	КонецЕсли;
	#КонецВставки

	// СтандартныеПодсистемы.ЗамерПроизводительности
	ПараметрыДерева.КоличествоСтрок = ПараметрыДерева.КоличествоСтрок + СебестоимостьУзла.Количество();
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности

	ЭтоРазузлованиеДопРасходов = Ложь;
	Для Каждого ТекПартия Из СебестоимостьУзла Цикл

		Если ТекПартия.ТребуетсяРазузлование И ТекПартия.КоличествоЗатрата <> 0 Тогда
			ПараметрыОтбора = Новый Структура("Партия, АналитикаУчетаПартий",
			ТекПартия.ПартияЗатрата,
			ТекПартия.АналитикаУчетаПартийЗатрата);
			#Вставка
			// ЗАМЕР С2: проверка циклов
			ВремяДоПроверки = ТекущаяДатаСеанса();
			#КонецВставки
			МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
			#Вставка
			Если ПараметрыДерева.Свойство("Замер_ВремяПроверкиЦиклов") Тогда
				ПараметрыДерева.Замер_ВремяПроверкиЦиклов = ПараметрыДерева.Замер_ВремяПроверкиЦиклов 
					+ (ТекущаяДатаСеанса() - ВремяДоПроверки);
				ПараметрыДерева.Замер_КоличествоПроверокЦиклов = ПараметрыДерева.Замер_КоличествоПроверокЦиклов + 1;
			КонецЕсли;
			#КонецВставки
			#Вставка
			// Логирование обнаруженного цикла
			Если МассивСтрок.Количество() > 0 Тогда
				ИнформацияОЦикле = Новый Структура;
				ИнформацияОЦикле.Вставить("Уровень", УровеньУзла);
				ИнформацияОЦикле.Вставить("ПартияЗатрата", ТекПартия.ПартияЗатрата);
				ИнформацияОЦикле.Вставить("АналитикаУчетаПартийЗатрата", ТекПартия.АналитикаУчетаПартийЗатрата);
				ИнформацияОЦикле.Вставить("Затрата", ТекПартия.Затрата);
				ИнформацияОЦикле.Вставить("ПартияПродукции", ПартияПродукции);
				ИнформацияОЦикле.Вставить("АналитикаУчетаПартийПродукции", АналитикаУчетаПартийПродукции);
				
				ПараметрыДерева.ОбнаруженныеЦиклы.Добавить(ИнформацияОЦикле);
				
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"Обнаружен циклический переход на уровне %1: Затрата '%2' (Партия: %3, Аналитика партий: %4) -> уже обрабатывалась в пути от Партии: %5, Аналитики партий: %6",
					Строка(УровеньУзла),
					Строка(ТекПартия.Затрата),
					Строка(ТекПартия.ПартияЗатрата),
					Строка(ТекПартия.АналитикаУчетаПартийЗатрата),
					Строка(ПартияПродукции),
					Строка(АналитикаУчетаПартийПродукции));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.ОбнаруженЦикл",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
			КонецЕсли;
			#КонецВставки
		Иначе
			МассивСтрок = Новый Массив;
		КонецЕсли;

		Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			ИЛИ ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат
			ИЛИ Не ТекПартия.ТребуетсяРазузлование Тогда
			СтрокаПартия = Результат.Добавить(); // СтрокаДереваЗначений
			ЗаполнитьЗначенияСвойств(СтрокаПартия, ТекПартия);

			СтрокаПартия.Идентификатор	= Новый УникальныйИдентификатор();
			Если ТекПартия.ТребуетсяРазузлование
				И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
				И (ТекПартия.СуммаЗатрата <> 0 Или ТекПартия.СуммаЗатратаЗабалансовая <> 0)
				И МассивСтрок.Количество() = 0 Тогда

				СтрокаПартия.ВидСтроки		= Перечисления.ВидыСтрокДереваСебестоимости.ПартияПолуфабриката;
				СтрокаПартия.Числитель 		= ТекПартия.КоличествоЗатрата;

			Иначе
				СтрокаПартия.ВидСтроки		= Перечисления.ВидыСтрокДереваСебестоимости.ПартияЗатраты;
				СтрокаПартия.ТребуетсяРазузлование = Ложь;
			КонецЕсли;

			СтрокаПартия.АналитикаУчетаПродукции		= АналитикаУчетаПродукции;
			СтрокаПартия.ПартияПродукции				= ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартийПродукции	= АналитикаУчетаПартийПродукции;

			СтрокаПартия.Номенклатура			= ТекПартия.Затрата;
			СтрокаПартия.Характеристика			= ТекПартия.ХарактеристикаЗатрата;
			СтрокаПартия.Серия					= ТекПартия.СерияЗатрата;
			СтрокаПартия.Назначение				= ТекПартия.НазначениеЗатрата;
			СтрокаПартия.Партия					= ТекПартия.ПартияЗатрата;
			СтрокаПартия.АналитикаУчетаПартий	= ТекПартия.АналитикаУчетаПартийЗатрата;
			СтрокаПартия.ЕдиницаИзмерения		= ТекПартия.ЕдиницаИзмеренияЗатрата;
			СтрокаПартия.Уровень				= УровеньУзла;

			СтрокаПартия.Количество			= ТекПартия.КоличествоЗатрата;
			СтрокаПартия.Сумма				= Окр(ТекПартия.СуммаЗатрата, 2);
			СтрокаПартия.ДопРасходы			= Окр(СтрокаПартия.ДопРасходы, 2);
			СтрокаПартия.НалоговыйУчет		= Окр(СтрокаПартия.НалоговыйУчет, 2);
			СтрокаПартия.СуммаЗабалансовая	= ТекПартия.СуммаЗатратаЗабалансовая;

			// Уменьшаем суммовые показатели в узле на разузлованные суммы. 
			// На оставшиеся суммы будет сформирована отдельная строка для отражения расхождения стоимости с детализацией.
			Если ПараметрыУзла.Сумма <> 0 Или ПараметрыУзла.СуммаЗабалансовая <> 0 Тогда
				ПараметрыУзла.Сумма = ПараметрыУзла.Сумма - СтрокаПартия.Сумма;
				ПараметрыУзла.Материальные = ПараметрыУзла.Материальные - СтрокаПартия.Материальные;
				ПараметрыУзла.ДопРасходы = ПараметрыУзла.ДопРасходы - СтрокаПартия.ДопРасходы;
				ПараметрыУзла.Трудозатраты = ПараметрыУзла.Трудозатраты - СтрокаПартия.Трудозатраты;
				ПараметрыУзла.ПостатейныеПеременные = ПараметрыУзла.ПостатейныеПеременные - СтрокаПартия.ПостатейныеПеременные;
				ПараметрыУзла.ПостатейныеПостоянные = ПараметрыУзла.ПостатейныеПостоянные - СтрокаПартия.ПостатейныеПостоянные;
				ПараметрыУзла.НалоговыйУчет = ПараметрыУзла.НалоговыйУчет - СтрокаПартия.НалоговыйУчет;
				ПараметрыУзла.ПостояннаяРазница = ПараметрыУзла.ПостояннаяРазница - СтрокаПартия.ПостояннаяРазница;
				ПараметрыУзла.ВременнаяРазница = ПараметрыУзла.ВременнаяРазница - СтрокаПартия.ВременнаяРазница;
				ПараметрыУзла.СуммаЗабалансовая = ПараметрыУзла.СуммаЗабалансовая - СтрокаПартия.СуммаЗабалансовая;

				ЭтоРазузлованиеДопРасходов = (ТекПартия.ТипЗатрат = "ДопРасходы");
			КонецЕсли;
		КонецЕсли;

		Если ТекПартия.ТребуетсяРазузлование
			И ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			И ПараметрыДерева.ДинамическоеСчитывание Тогда
			СтрокаПартия.Строки.Добавить();
		ИначеЕсли ТекПартия.ТребуетсяРазузлование
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И (ТекПартия.СуммаЗатрата <> 0 Или ТекПартия.СуммаЗатратаЗабалансовая <> 0)
			И МассивСтрок.Количество() = 0
			ИЛИ ТекПартия.ТребуетсяРазузлованиеДопРасходов
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И ТекПартия.ДопРасходы <> 0 Тогда
			// общий подход к заполнению отбора параметров узла и условиям разузлования должен совпадать с:
			// - ЗаполнитьДеревоСебестоимости();
			// - Отчет.ДеревоСебестоимости.МодульОбъекта.ПолноеДеревоСебестоимостиПередРазворачиваниемСервер(). 
			ПараметрыУзлаПартии = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();

			Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
				НовыйПуть = ПройденныйПуть.Добавить();
				НовыйПуть.Партия = ТекПартия.ПартияЗатрата;
				НовыйПуть.АналитикаУчетаПартий = ТекПартия.АналитикаУчетаПартийЗатрата;
			КонецЕсли;

			Отборы = ПараметрыУзлаПартии.Отборы;
			Отборы.ДанныеПоСебестоимости = ПараметрыУзла.Отборы.ДанныеПоСебестоимости;
			Отборы.Продукция.Добавить(ТекПартия.Затрата);
			Отборы.ХарактеристикиПродукции.Добавить(ТекПартия.ХарактеристикаЗатрата);
			Отборы.СерииПродукции.Добавить(ТекПартия.СерияЗатрата);
			// При разузловании полуфабрикатов отбор по назначению не нужен, т.к. полуфабрикат может быть выпущен без назначения или
			// с указанием другого назначения.
			Отборы.ПартииПродукции.Добавить(ТекПартия.ПартияЗатрата);
			Отборы.АналитикиУчетаПартийПродукции.Добавить(ТекПартия.АналитикаУчетаПартийЗатрата);
			Отборы.АналитикаУчетаЗатрата.Добавить(ТекПартия.АналитикаУчетаЗатрата);
			// для знаменателя и количества продукции берем модуль значения, чтобы знак количества и сумм затрат определялся по числителю, который при выпуске будет > 0, а при сторно < 0
			Отборы.Числитель               = ТекПартия.КоличествоЗатрата;
			Отборы.КоличествоПродукции     = Макс(-ТекПартия.КоличествоЗатрата, ТекПартия.КоличествоЗатрата);
			Отборы.РазворачиватьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы;
			Отборы.ДатаИсходнойПартии      = ПараметрыУзла.Отборы.ДатаИсходнойПартии;
			Отборы.ДатаОкончания           = ПараметрыУзла.Отборы.ДатаОкончания;

			Отборы.ВключитьНДСВСтоимость   = ТекПартия.ВключитьНДСВСтоимость;
			Отборы.ИсключитьНДСИзСтоимости = ТекПартия.ИсключитьНДСИзСтоимости;
			Отборы.АналитикаУчетаВыходноеИзделие = ТекПартия.АналитикаУчетаЗатрата;
			Отборы.СтатьяКалькуляции       = ТекПартия.СтатьяКалькуляции;

			Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
				ТаблицаРезультатаПартии = СтрокаПартия;
			Иначе
				ТаблицаРезультатаПартии = Результат;
			КонецЕсли;

			Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
				ПараметрыУзлаПартии.Сумма = СтрокаПартия.Сумма;
				ПараметрыУзлаПартии.Материальные = СтрокаПартия.Материальные;
				ПараметрыУзлаПартии.ДопРасходы = СтрокаПартия.ДопРасходы;
				ПараметрыУзлаПартии.Трудозатраты = СтрокаПартия.Трудозатраты;
				ПараметрыУзлаПартии.ПостатейныеПеременные = СтрокаПартия.ПостатейныеПеременные;
				ПараметрыУзлаПартии.ПостатейныеПостоянные = СтрокаПартия.ПостатейныеПостоянные;
				ПараметрыУзлаПартии.НалоговыйУчет = СтрокаПартия.НалоговыйУчет;
				ПараметрыУзлаПартии.ПостояннаяРазница = СтрокаПартия.ПостояннаяРазница;
				ПараметрыУзлаПартии.ВременнаяРазница = СтрокаПартия.ВременнаяРазница;
				ПараметрыУзлаПартии.СуммаЗабалансовая = СтрокаПартия.СуммаЗабалансовая;
			КонецЕсли;

			ОписаниеПродукции.Вставить("Уровень", УровеньУзла);
			Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" Тогда
				КоличествоСтрокРезультата = ТаблицаРезультатаПартии.Количество();
			КонецЕсли;
			РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзлаПартии, ТаблицаРезультатаПартии, ОписаниеПродукции);

			// Если разозлование доп расходов не выполнено, снимем признак ТребуетсяРазузлованиеДопРасходов.
			Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц"
				И ТекПартия.ТребуетсяРазузлованиеДопРасходов
				И КоличествоСтрокРезультата = ТаблицаРезультатаПартии.Количество() Тогда
				СтрокаПартия.ТребуетсяРазузлованиеДопРасходов = Ложь;
			КонецЕсли;
		КонецЕсли;

		#Вставка
		// УБРАНА логика удаления из ПройденныйПуть для предотвращения встречных циклов.
		// Партии остаются в ПройденныйПуть на протяжении всего процесса построения дерева,
		// что обеспечивает корректное обнаружение циклических зависимостей любой сложности.
		#КонецВставки
		#Удаление
		// Удалим строку, по которой уже выполнено разузлование.
		Если ТекПартия.ТребуетсяРазузлование
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И ТекПартия.СуммаЗатрата <> 0 Тогда
			ПараметрыОтбора = Новый Структура("Партия, АналитикаУчетаПартий",
			ТекПартия.ПартияЗатрата,
			ТекПартия.АналитикаУчетаПартийЗатрата);
			МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
			Для Каждого СтрокаКУдалению Из МассивСтрок Цикл
				ПройденныйПуть.Удалить(СтрокаКУдалению);
			КонецЦикла;
		КонецЕсли;
		#КонецУдаления

	КонецЦикла;

	// При наличии данных о разузловании добавим строку на суммы изменения стоимости.
	Если СебестоимостьУзла.Количество() > 0 И НЕ ЭтоРазузлованиеДопРасходов Тогда
		УчестьИзменениеСтоимости(ПараметрыУзла, ОписаниеПродукции, Результат);
	КонецЕсли;

КонецПроцедуры

&ИзменениеИКонтроль("ЗаполнитьДеревоСебестоимости")
Процедура ikon_cost_ЗаполнитьДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла)

	Запрос = ЗапросВыпущеннаяПродукция(ПараметрыУзла, Ложь);
	ВыпущеннаяПродукция = Запрос.Выполнить().Выгрузить();
	#Вставка
	// ДИАГНОСТИКА
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"ЗаполнитьДеревоСебестоимости: получено строк ВыпущеннаяПродукция=%1, ДинамическоеСчитывание=%2, ИспользоватьПакетнуюОбработку=%3",
		Строка(ВыпущеннаяПродукция.Количество()),
		Строка(ПараметрыДерева.ДинамическоеСчитывание),
		Строка(ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") И ПараметрыДерева.ИспользоватьПакетнуюОбработку));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ТекстСообщения);
	#КонецВставки

	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		Результат = ПараметрыДерева.Результат.Строки;
	ИначеЕсли ПараметрыДерева.ТипРезультата = "ТаблицаЗначений" Тогда
		Результат = ПараметрыДерева.Результат;
	Иначе
		Результат = Новый ТаблицаЗначений;
		ИнициализироватьПоляДереваСебестоимости(Результат);
		ПоляТаблицы = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(Результат, "Идентификатор");
		СчетчикТаблиц = 0;
		ИменаТаблиц = "";
	КонецЕсли;

	// СтандартныеПодсистемы.ЗамерПроизводительности
	ПараметрыДерева.КоличествоСтрок = ПараметрыДерева.КоличествоСтрок + ВыпущеннаяПродукция.Количество();
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности

	Для Каждого ТекПартия Из ВыпущеннаяПродукция Цикл
		
		#Удаление
		Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			ИЛИ ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат
			ИЛИ Не ТекПартия.ТребуетсяРазузлование Тогда
		#КонецУдаления
		#Вставка
		// КРИТИЧНО: Строка ПРОДУКЦИИ (уровень 0) всегда должна добавляться в результат!
		// ДобавлятьПолуфабрикатыВРезультат управляет только полуфабрикатами (уровни 1+)
		// Для МенеджерВременныхТаблиц строка продукции нужна для корректного формирования отчета
		Если Истина Тогда
		#КонецВставки
			СтрокаПартия = Результат.Добавить(); // СтрокаДереваЗначений
			ЗаполнитьЗначенияСвойств(СтрокаПартия, ТекПартия);
			
			СтрокаПартия.Идентификатор	= Новый УникальныйИдентификатор();
			СтрокаПартия.ВидСтроки		= Перечисления.ВидыСтрокДереваСебестоимости.ПартияПродукции;
			
			СтрокаПартия.АналитикаУчетаВыходноеИзделие			= ТекПартия.АналитикаУчетаПродукции;
			СтрокаПартия.АналитикаУчетаПартийВыходноеИзделие	= ТекПартия.АналитикаУчетаПартийПродукции;
			СтрокаПартия.ПартияВыходноеИзделие					= ТекПартия.ПартияПродукции;
			
			СтрокаПартия.Номенклатура			= ТекПартия.Продукция;
			СтрокаПартия.Характеристика			= ТекПартия.ХарактеристикаПродукции;
			СтрокаПартия.Серия					= ТекПартия.СерияПродукции;
			СтрокаПартия.Назначение				= ТекПартия.НазначениеПродукции;
			СтрокаПартия.Валюта					= ТекПартия.Валюта;
			СтрокаПартия.Партия					= ТекПартия.ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартий	= ТекПартия.АналитикаУчетаПартийПродукции;
			СтрокаПартия.ЕдиницаИзмерения		= ТекПартия.ЕдиницаИзмеренияПродукция;
			
			СтрокаПартия.Количество	= ТекПартия.КоличествоПродукция;
			СтрокаПартия.Сумма		= ТекПартия.СуммаПродукция;
			СтрокаПартия.СуммаЗабалансовая = ТекПартия.СуммаПродукцияЗабалансовая;
		КонецЕсли;
		
		Если ТекПартия.ТребуетсяРазузлование
			И ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			И ПараметрыДерева.ДинамическоеСчитывание
			И ТекПартия.КоличествоПродукция <> 0 Тогда

			СтрокаПартия.Строки.Добавить();

		ИначеЕсли ТекПартия.ТребуетсяРазузлование
			И ТекПартия.КоличествоПродукция <> 0 Тогда //проверка на отсторнированный выпуск в выбранном периоде
			// общий подход к заполнению отбора параметров узла и условиям разузлования должен совпадать с:
			// - РазузловатьУзелДереваСебестоимости();
			// - Отчет.ДеревоСебестоимости.МодульОбъекта.ПолноеДеревоСебестоимостиПередРазворачиваниемСервер(). 
			ПараметрыУзлаПартии = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();

			Отборы = ПараметрыУзлаПартии.Отборы;
			Отборы.ДанныеПоСебестоимости = ПараметрыУзла.Отборы.ДанныеПоСебестоимости;
			Отборы.Продукция.Добавить(ТекПартия.Продукция);
			Отборы.ХарактеристикиПродукции.Добавить(ТекПартия.ХарактеристикаПродукции);
			Отборы.СерииПродукции.Добавить(ТекПартия.СерияПродукции);
			Отборы.НазначенияПродукции.Добавить(ТекПартия.НазначениеПродукции);
			Отборы.ПартииПродукции.Добавить(ТекПартия.ПартияПродукции);
			Отборы.АналитикиУчетаПартийПродукции.Добавить(ТекПартия.АналитикаУчетаПартийПродукции);
			// для знаменателя и количества продукции берем модуль значения, чтобы знак количества и сумм затрат определялся по числителю, который при выпуске будет > 0, а при сторно < 0
			Отборы.Числитель               = ТекПартия.Числитель;
			Отборы.Знаменатель             = Макс(-ТекПартия.Знаменатель, ТекПартия.Знаменатель);
			Отборы.КоличествоПродукции     = Макс(-ТекПартия.КоличествоПродукция,ТекПартия. КоличествоПродукция);
			Отборы.РазворачиватьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы;
			Отборы.ДатаИсходнойПартии = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ТекПартия.ПартияПродукции, "Дата");
			Отборы.ДатаОкончания           = ПараметрыУзла.Отборы.ДатаОкончания;

			ПараметрыУзлаПартии.Сумма = ТекПартия.СуммаПродукция;
			ПараметрыУзлаПартии.Материальные = ТекПартия.Материальные;
			ПараметрыУзлаПартии.ДопРасходы = ТекПартия.ДопРасходы;
			ПараметрыУзлаПартии.Трудозатраты = ТекПартия.Трудозатраты;
			ПараметрыУзлаПартии.ПостатейныеПеременные = ТекПартия.ПостатейныеПеременные;
			ПараметрыУзлаПартии.ПостатейныеПостоянные = ТекПартия.ПостатейныеПостоянные;
			ПараметрыУзлаПартии.НалоговыйУчет = ТекПартия.НалоговыйУчет;
			ПараметрыУзлаПартии.ПостояннаяРазница = ТекПартия.ПостояннаяРазница;
			ПараметрыУзлаПартии.ВременнаяРазница = ТекПартия.ВременнаяРазница;
			ПараметрыУзлаПартии.СуммаЗабалансовая = ТекПартия.СуммаПродукцияЗабалансовая;

			ОписаниеПродукции = Новый Структура("АналитикаУчетаПродукции, ПартияПродукции, АналитикаУчетаПартийПродукции");
			ЗаполнитьЗначенияСвойств(ОписаниеПродукции, ТекПартия);
			ОписаниеПродукции.Вставить("Уровень", 0);

			Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
				ТаблицаРезультата = СтрокаПартия;
			Иначе
				ТаблицаРезультата = Результат;
			КонецЕсли;

			#Удаление
			РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзлаПартии, ТаблицаРезультата, ОписаниеПродукции);
			#КонецУдаления
			#Вставка
			// Выбор между пакетной обработкой и рекурсивной
			Если ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
				И ПараметрыДерева.ИспользоватьПакетнуюОбработку 
				И НЕ ПараметрыДерева.ДинамическоеСчитывание Тогда
				
				// Пакетная обработка: формируем узел для добавления в очередь
				Узел = Новый Структура;
				Узел.Вставить("ПараметрыУзла", ПараметрыУзлаПартии);
				Узел.Вставить("ТаблицаРезультата", ТаблицаРезультата);
				Узел.Вставить("ОписаниеПродукции", ОписаниеПродукции);
				Узел.Вставить("СтрокаПартия", СтрокаПартия);
				
				Если НЕ ПараметрыДерева.Свойство("УзлыДляПакетнойОбработки") Тогда
					ПараметрыДерева.Вставить("УзлыДляПакетнойОбработки", Новый Массив);
				КонецЕсли;
				
				ПараметрыДерева.УзлыДляПакетнойОбработки.Добавить(Узел);
				// ДИАГНОСТИКА
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"Узел добавлен в пакет для обработки. Всего узлов в пакете: %1",
					Строка(ПараметрыДерева.УзлыДляПакетнойОбработки.Количество()));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
			Иначе
				// Старая рекурсивная обработка (сохранена для обратной совместимости)
				РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзлаПартии, ТаблицаРезультата, ОписаниеПродукции);
			КонецЕсли;
			#КонецВставки

		КонецЕсли;

		#Удаление
		Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" Тогда
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
			ПараметрыДерева.Результат,
			ИмяТекущейТаблицы,
			Результат,
			ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
			Результат.Очистить();
		КонецЕсли;
		#КонецУдаления
		#Вставка
		// ВАЖНО: При пакетной обработке НЕ сохраняем и НЕ очищаем Результат в цикле!
		// Узлы используют ссылку на эту таблицу, и она будет сохранена после пакетной обработки.
		ИспользуетсяПакетнаяОбработка = ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
			И ПараметрыДерева.ИспользоватьПакетнуюОбработку 
			И НЕ ПараметрыДерева.ДинамическоеСчитывание;
		
		Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" 
			И НЕ ИспользуетсяПакетнаяОбработка Тогда
			
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			
			// ДИАГНОСТИКА: сохранение в цикле
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				" СТАРЫЙ: создание ВТ '%1' в цикле, строк=%2",
				ИмяТекущейТаблицы,
				Строка(Результат.Количество()));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				ТекстСообщения);
			
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
				ПараметрыДерева.Результат,
				ИмяТекущейТаблицы,
				Результат,
				ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
			Результат.Очистить();
		КонецЕсли;
		#КонецВставки

	КонецЦикла;

	#Удаление
	Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" Тогда
		Если НЕ ПустаяСтрока(ИменаТаблиц) Тогда
			РасчетСебестоимостиПрикладныеАлгоритмы.ОбъединитьВременныеТаблицы(
			ПараметрыДерева.Результат,
			ИменаТаблиц,
			"Результат",
			ПоляТаблицы, "", , Истина);
		Иначе
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = ПараметрыДерева.Результат;
			Запрос.Текст =
			"ВЫБРАТЬ
			|	*
			|ПОМЕСТИТЬ Результат
			|ИЗ
			|	&Результат КАК Результат";

			Результат.Колонки.Удалить("Идентификатор");
			Запрос.УстановитьПараметр("Результат", Результат);
			// Структуру ВТ Результат см. в СтруктураСебестоимости.СтруктураПолейДереваСебестоимости.
			Запрос.Выполнить();
		КонецЕсли;
	КонецЕсли;
	#КонецУдаления
	#Вставка
	// Обработка накопленных узлов для пакетной обработки (оптимизация N+1)
	// ВАЖНО: Обработка пакета ПО УРОВНЯМ с сохранением после каждого уровня!
	Если ПараметрыДерева.Свойство("УзлыДляПакетнойОбработки") 
		И ПараметрыДерева.УзлыДляПакетнойОбработки.Количество() > 0 Тогда
		
		УзлыТекущегоУровня = ПараметрыДерева.УзлыДляПакетнойОбработки;
		НомерУровня = 1;
		
		// Обрабатываем уровни по очереди (НЕ очищаем Результат - накапливаем в нём!)
		Пока УзлыТекущегоУровня.Количество() > 0 Цикл
			
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				" НОВЫЙ (ПАКЕТНЫЙ): начало обработки уровня %1, узлов=%2, накоплено строк=%3",
				Строка(НомерУровня),
				Строка(УзлыТекущегоУровня.Количество()),
				Строка(Результат.Количество()));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				ТекстСообщения);
			
			// Обработать текущий уровень
			УзлыСледующегоУровня = РазузловатьУзлыПакетом(ПараметрыДерева, УзлыТекущегоУровня);
			
			// ЗАМЕР Н3: статистика уровня
			Если ПараметрыДерева.Свойство("Замер_СтатистикаУровней") Тогда
				СтатистикаУровня = Новый Структура;
				СтатистикаУровня.Вставить("НомерУровня", НомерУровня);
				СтатистикаУровня.Вставить("КоличествоУзлов", УзлыТекущегоУровня.Количество());
				// Получаем размер ПройденныйПуть
				РазмерПройденныйПуть = 0;
				Если ПараметрыДерева.Свойство("ПройденныйПуть") И ПараметрыДерева.ПройденныйПуть <> Неопределено Тогда
					РазмерПройденныйПуть = ПараметрыДерева.ПройденныйПуть.Количество();
				КонецЕсли;
				СтатистикаУровня.Вставить("РазмерПройденныйПуть", РазмерПройденныйПуть);
				ПараметрыДерева.Замер_СтатистикаУровней.Добавить(СтатистикаУровня);
			КонецЕсли;
			
			// Переход к следующему уровню
			УзлыТекущегоУровня = УзлыСледующегоУровня;
			НомерУровня = НомерУровня + 1;
			
		КонецЦикла;
		
		// ФИЛЬТРАЦИЯ и СОХРАНЕНИЕ (один раз в конце!)
		Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" 
			И Результат.Количество() > 0 Тогда
			
			// ФИЛЬТРАЦИЯ: удаляем строки "Усреднение стоимости" и "Изменение стоимости при хранении"
			КоличествоДоФильтрации = Результат.Количество();
			Индекс = Результат.Количество() - 1;
			Пока Индекс >= 0 Цикл
				СтрокаРезультата = Результат[Индекс];
				Если СтрокаРезультата.Номенклатура = "Усреднение стоимости в незавершенном производстве"
					ИЛИ СтрокаРезультата.Номенклатура = "Изменение стоимости при хранении" Тогда
					Результат.Удалить(Индекс);
				КонецЕсли;
				Индекс = Индекс - 1;
			КонецЦикла;
			
			КоличествоУдаленных = КоличествоДоФильтрации - Результат.Количество();
			
			// ДИАГНОСТИКА: проверка строк Каучука перед сохранением
			СуммаДопРасходыКаучук = 0;
			КоличествоСтрокКаучук = 0;
			Для Каждого СтрокаДиаг Из Результат Цикл
				Если СтрНайти(Строка(СтрокаДиаг.Номенклатура), "Каучук натуральный") > 0 Тогда
					СуммаДопРасходыКаучук = СуммаДопРасходыКаучук + СтрокаДиаг.ДопРасходы;
					КоличествоСтрокКаучук = КоличествоСтрокКаучук + 1;
					ЗаписьЖурналаРегистрации(
						"СтруктураСебестоимости.ДиагностикаКаучук",
						УровеньЖурналаРегистрации.Предупреждение,
						,
						,
					СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"ПЕРЕД СОХРАНЕНИЕМ: Каучук, ДопРасходы=%1, ТребуетсяРазузлование=%2, ТребуетсяРазузлованиеДопРасходов=%3, ВидСтроки=%4",
						Строка(СтрокаДиаг.ДопРасходы),
						Строка(СтрокаДиаг.ТребуетсяРазузлование),
						Строка(СтрокаДиаг.ТребуетсяРазузлованиеДопРасходов),
						Строка(СтрокаДиаг.ВидСтроки)));
				КонецЕсли;
			КонецЦикла;
			Если КоличествоСтрокКаучук > 0 Тогда
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.ДиагностикаКаучук",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"ИТОГО перед сохранением: строк Каучука=%1, СУММА ДопРасходы=%2",
						Строка(КоличествоСтрокКаучук),
						Строка(СуммаДопРасходыКаучук)));
			КонецЕсли;
			
			// Сохраняем одной таблицей
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
				ПараметрыДерева.Результат,
				ИмяТекущейТаблицы,
				Результат,
				ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
			
			// КРИТИЧНО: Очищаем таблицу после сохранения, чтобы избежать дублирования
			// Данные уже сохранены во временную таблицу, и не должны сохраняться повторно
			Результат.Очистить();
		КонецЕсли;
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"Использована пакетная обработка: обработано узлов в первом уровне: %1, всего уровней: %2",
			Строка(ПараметрыДерева.УзлыДляПакетнойОбработки.Количество()),
			Строка(НомерУровня - 1));
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.ПакетнаяОбработка",
			УровеньЖурналаРегистрации.Предупреждение,
			,
			,
			ТекстСообщения);
	КонецЕсли;
	
	// ПРИМЕЧАНИЕ: При пакетной обработке данные сохраняются ПОСЛЕ КАЖДОГО УРОВНЯ (выше в цикле)
	// Этот блок нужен только для старого рекурсивного алгоритма или если остались несохраненные данные
	Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" Тогда
		
		// Сохраняем оставшиеся данные (если есть)
		Если Результат.Количество() > 0 Тогда
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
				ПараметрыДерева.Результат,
				ИмяТекущейТаблицы,
				Результат,
				ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
			
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				" Сохранены ОСТАВШИЕСЯ данные во ВТ '%1': строк=%2",
				ИмяТекущейТаблицы,
				Строка(Результат.Количество()));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				ТекстСообщения);
		КонецЕсли;
		
			// Объединяем все временные таблицы в итоговую
		Если НЕ ПустаяСтрока(ИменаТаблиц) Тогда
			РасчетСебестоимостиПрикладныеАлгоритмы.ОбъединитьВременныеТаблицы(
			ПараметрыДерева.Результат,
			ИменаТаблиц,
			"Результат",
			ПоляТаблицы, "", , Истина);
		Иначе
			// Если вообще нет данных, создаем пустую временную таблицу
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = ПараметрыДерева.Результат;
			Запрос.Текст =
			"ВЫБРАТЬ
			|	*
			|ПОМЕСТИТЬ Результат
			|ИЗ
			|	&Результат КАК Результат";
			
			Результат.Колонки.Удалить("Идентификатор");
			Запрос.УстановитьПараметр("Результат", Результат);
			// Структуру ВТ Результат см. в СтруктураСебестоимости.СтруктураПолейДереваСебестоимости.
			Запрос.Выполнить();
		КонецЕсли;
	КонецЕсли;
	
	// ДИАГНОСТИКА: итоговый результат
	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		КоличествоСтрокИтого = ПараметрыДерева.Результат.Строки.Количество();
	ИначеЕсли ПараметрыДерева.ТипРезультата = "ТаблицаЗначений" Тогда
		КоличествоСтрокИтого = ПараметрыДерева.Результат.Количество();
	Иначе
		// Для МенеджерВременныхТаблиц выполняем запрос подсчета строк
		Попытка
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = ПараметрыДерева.Результат;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Партия) КАК КоличествоУровень0
			|ИЗ
			|	Результат
			|ГДЕ
			|	Уровень = 0";
			РезультатПодсчета = Запрос.Выполнить().Выгрузить();
			КоличествоСтрокИтого = РезультатПодсчета[0].КоличествоУровень0;
		Исключение
			// Если временная таблица не существует или произошла ошибка
			КоличествоСтрокИтого = 0;
		КонецПопытки;
	КонецЕсли;
	
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"ЗаполнитьДеревоСебестоимости: ИТОГОВЫЙ результат содержит строк верхнего уровня=%1",
		Строка(КоличествоСтрокИтого));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ТекстСообщения);
	#КонецВставки

КонецПроцедуры   

// Разузлование дерева себестоимости с пакетной обработкой по уровням (оптимизация N+1)
//
// Параметры:
//  ПараметрыДерева - см. СтруктураСебестоимости.ПараметрыДереваСебестоимости
//  УзлыДляОбработки - Массив из Структура - Массив узлов для обработки:
//    * ПараметрыУзла - Структура - Параметры узла
//    * ТаблицаРезультата - ДеревоЗначений, ТаблицаЗначений - Куда помещать результат
//    * ОписаниеПродукции - Структура - Описание продукции
//    * СтрокаПартия - СтрокаДереваЗначений - Ссылка на строку в дереве
//
Функция РазузловатьУзлыПакетом(ПараметрыДерева, УзлыДляОбработки)
	
	// ДИАГНОСТИКА
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"РазузловатьУзлыПакетом: начало обработки, узлов=%1",
		Строка(УзлыДляОбработки.Количество()));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ТекстСообщения);
		
	Если УзлыДляОбработки.Количество() = 0 Тогда
		Возврат Новый Массив; // Возвращаем пустой массив, если нет узлов
	КонецЕсли;
	
	// Инициализация структур для отслеживания циклов
	ПройденныйПуть = Неопределено;
	Если НЕ ПараметрыДерева.Свойство("ПройденныйПуть", ПройденныйПуть) Тогда
		ПройденныйПуть = Новый ТаблицаЗначений;
		ПройденныйПуть.Колонки.Добавить("Партия");
		ПройденныйПуть.Колонки.Добавить("АналитикаУчетаПартий");
		ПройденныйПуть.Индексы.Добавить("Партия, АналитикаУчетаПартий");
		ПараметрыДерева.Вставить("ПройденныйПуть", ПройденныйПуть);
		// Инициализируем параметры защиты от циклов и глубокой рекурсии
		ПараметрыДерева.Вставить("МаксимальнаяГлубинаРекурсии", 50);
		ПараметрыДерева.Вставить("ОбнаруженныеЦиклы", Новый Массив);
	КонецЕсли;
	
	// Обрабатываем результаты для каждого узла
	УзлыСледующегоУровня = Новый Массив;
	
	#Удаление
	// Обработка каждого узла с отдельным запросом
	// (текущая версия - без объединения запросов, но с обработкой по уровням)
	Для Каждого Узел Из УзлыДляОбработки Цикл
		
		// Определяем, нужно ли выводить дополнительные расходы
		УровеньУзла = Узел.ОписаниеПродукции.Уровень + 1;
		
		// Проверка максимальной глубины рекурсии
		Если УровеньУзла > ПараметрыДерева.МаксимальнаяГлубинаРекурсии Тогда
			ПартияПродукции = Узел.ОписаниеПродукции.ПартияПродукции;
			АналитикаУчетаПартийПродукции = Узел.ОписаниеПродукции.АналитикаУчетаПартийПродукции;
			
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				"Достигнута максимальная глубина разузлования (%1 уровней). Партия: %2, Аналитика партий: %3",
				Строка(УровеньУзла),
				Строка(ПартияПродукции),
				Строка(АналитикаУчетаПартийПродукции));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.МаксимальнаяГлубинаРекурсии",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				ТекстСообщения);
			Продолжить;
		КонецЕсли;
		
		// Условие вывода доп. расходов идентично старому алгоритму
		ВыводитьДопРасходы = Узел.ПараметрыУзла.Отборы.РазворачиватьДопРасходы 
			И НЕ (УровеньУзла = 1);
		
		// ДИАГНОСТИКА: для проблемного материала
		Если Узел.ПараметрыУзла.Отборы.Продукция.Количество() > 0 Тогда
			ИмяПродукции = Строка(Узел.ПараметрыУзла.Отборы.Продукция[0]);
			Если СтрНайти(ИмяПродукции, "Каучук натуральный") > 0 Тогда
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"[СТАРЫЙ] КАУЧУК: Продукция='%1', ОписаниеПродукции.Уровень=%2, УровеньУзла=%3, РазворачиватьДопРасходы=%4, ВыводитьДопРасходы=%5",
						ИмяПродукции,
						Строка(Узел.ОписаниеПродукции.Уровень),
						Строка(УровеньУзла),
						Строка(Узел.ПараметрыУзла.Отборы.РазворачиватьДопРасходы),
						Строка(ВыводитьДопРасходы)));
			КонецЕсли;
		КонецЕсли;
		
		// ЗАМЕР Н1: время запроса
		ВремяДоЗапроса = ТекущаяДатаСеанса();
		// Получаем данные для текущего узла отдельным запросом
		СебестоимостьУзла = СебестоимостьУзла(ПараметрыДерева, Узел.ПараметрыУзла, ВыводитьДопРасходы);
		ПараметрыДерева.Замер_ВремяЗапросов = ПараметрыДерева.Замер_ВремяЗапросов 
			+ (ТекущаяДатаСеанса() - ВремяДоЗапроса);
		ПараметрыДерева.Замер_КоличествоЗапросов = ПараметрыДерева.Замер_КоличествоЗапросов + 1;
		
		// ЗАМЕР Н1: время обработки
		ВремяДоОбработки = ТекущаяДатаСеанса();
			
		// СтандартныеПодсистемы.ЗамерПроизводительности
		ПараметрыДерева.КоличествоСтрок = ПараметрыДерева.КоличествоСтрок + СебестоимостьУзла.Количество();
		// Конец СтандартныеПодсистемы.ЗамерПроизводительности
		
		// Обрабатываем каждую партию в результатах
		ОбработатьРезультатыУзла(ПараметрыДерева, Узел, СебестоимостьУзла, ПройденныйПуть, УзлыСледующегоУровня);
		ПараметрыДерева.Замер_ВремяОбработки = ПараметрыДерева.Замер_ВремяОбработки 
			+ (ТекущаяДатаСеанса() - ВремяДоОбработки);
	КонецЦикла;
	#КонецУдаления
	#Вставка
	// === ПРОСТАЯ ПАКЕТНАЯ ОБРАБОТКА ПО УРОВНЯМ ===
	// Обрабатываем узлы одного уровня последовательно (каждый - отдельным запросом)
	// НО благодаря обработке по уровням количество запросов = количество уровней (7 вместо 47)
	
	// Фильтруем узлы по глубине рекурсии
	Для Каждого Узел Из УзлыДляОбработки Цикл
		УровеньУзла = Узел.ОписаниеПродукции.Уровень + 1;
		Если УровеньУзла > ПараметрыДерева.МаксимальнаяГлубинаРекурсии Тогда
			ПартияПродукции = Узел.ОписаниеПродукции.ПартияПродукции;
			АналитикаУчетаПартийПродукции = Узел.ОписаниеПродукции.АналитикаУчетаПартийПродукции;
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				"Достигнута максимальная глубина разузлования (%1 уровней). Партия: %2, Аналитика партий: %3",
				Строка(УровеньУзла), Строка(ПартияПродукции), Строка(АналитикаУчетаПартийПродукции));
			ЗаписьЖурналаРегистрации("СтруктураСебестоимости.МаксимальнаяГлубинаРекурсии",
				УровеньЖурналаРегистрации.Предупреждение,,,ТекстСообщения);
			Продолжить;
		КонецЕсли;
		
		// Условие вывода доп. расходов идентично старому алгоритму
		ВыводитьДопРасходы = Узел.ПараметрыУзла.Отборы.РазворачиватьДопРасходы 
			И НЕ (УровеньУзла = 1);
		
		// ДИАГНОСТИКА: для проблемного материала
		Если Узел.ПараметрыУзла.Отборы.Продукция <> Неопределено Тогда
			ИмяПродукции = Строка(Узел.ПараметрыУзла.Отборы.Продукция);
			Если СтрНайти(ИмяПродукции, "Каучук натуральный") > 0 Тогда
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"КАУЧУК: Продукция='%1', ОписаниеПродукции.Уровень=%2, УровеньУзла=%3, РазворачиватьДопРасходы=%4, ВыводитьДопРасходы=%5",
						ИмяПродукции,
						Строка(Узел.ОписаниеПродукции.Уровень),
						Строка(УровеньУзла),
						Строка(Узел.ПараметрыУзла.Отборы.РазворачиватьДопРасходы),
						Строка(ВыводитьДопРасходы)));
			КонецЕсли;
		КонецЕсли;
		
		// ЗАМЕР: время запроса
		ВремяДоЗапроса = ТекущаяДатаСеанса();
		// Получаем данные для текущего узла отдельным запросом
		СебестоимостьУзла = СебестоимостьУзла(ПараметрыДерева, Узел.ПараметрыУзла, ВыводитьДопРасходы);
		ПараметрыДерева.Замер_ВремяЗапросов = ПараметрыДерева.Замер_ВремяЗапросов + (ТекущаяДатаСеанса() - ВремяДоЗапроса);
		ПараметрыДерева.Замер_КоличествоЗапросов = ПараметрыДерева.Замер_КоличествоЗапросов + 1;
		
		// ЗАМЕР: время обработки
		ВремяДоОбработки = ТекущаяДатаСеанса();
		
		ПараметрыДерева.КоличествоСтрок = ПараметрыДерева.КоличествоСтрок + СебестоимостьУзла.Количество();
		ОбработатьРезультатыУзла(ПараметрыДерева, Узел, СебестоимостьУзла, ПройденныйПуть, УзлыСледующегоУровня);
		
		ПараметрыДерева.Замер_ВремяОбработки = ПараметрыДерева.Замер_ВремяОбработки + (ТекущаяДатаСеанса() - ВремяДоОбработки);
	КонецЦикла;
	#КонецВставки
	
	// НЕ вызываем рекурсивно! Возвращаем узлы следующего уровня для обработки в цикле
	Возврат УзлыСледующегоУровня;
	
КонецФункции

// Обрабатывает результаты запроса для одного узла
Процедура ОбработатьРезультатыУзла(ПараметрыДерева, Узел, СебестоимостьУзла, ПройденныйПуть, УзлыСледующегоУровня)
	
	ПараметрыУзла = Узел.ПараметрыУзла;
	ТаблицаРезультата = Узел.ТаблицаРезультата;
	ОписаниеПродукции = Узел.ОписаниеПродукции;
	
	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		Результат = ТаблицаРезультата.Строки;
	Иначе
		Результат = ТаблицаРезультата;
	КонецЕсли;
	
	// ДИАГНОСТИКА
	КоличествоДо = Результат.Количество();
	
	// ДИАГНОСТИКА: параметры обработки
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"ОбработатьРезультатыУзла начало: ТипРезультата='%1', ДобавлятьПолуфабрикаты=%2",
		ПараметрыДерева.ТипРезультата,
		Строка(ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ТекстСообщения);	
	
	АналитикаУчетаПродукции = ОписаниеПродукции.АналитикаУчетаПродукции;
	ПартияПродукции = ОписаниеПродукции.ПартияПродукции;
	АналитикаУчетаПартийПродукции = ОписаниеПродукции.АналитикаУчетаПартийПродукции;
	УровеньУзла = ОписаниеПродукции.Уровень + 1;
	
	ЭтоРазузлованиеДопРасходов = Ложь;
	
	Для Каждого ТекПартия Из СебестоимостьУзла Цикл
		
		// ДИАГНОСТИКА: проверка значения ДопРасходы для Каучука
		ИмяЗатраты = Строка(ТекПартия.Затрата);
		Если СтрНайти(ИмяЗатраты, "Каучук натуральный") > 0 Тогда
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.ДиагностикаКаучук",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"КАУЧУК из запроса: Затрата='%1', ДопРасходы=%2, Материальные=%3, СуммаЗатрата=%4, УровеньУзла=%5",
					ИмяЗатраты,
					Строка(ТекПартия.ДопРасходы),
					Строка(ТекПартия.Материальные),
					Строка(ТекПартия.СуммаЗатрата),
					Строка(УровеньУзла)));
		КонецЕсли;
		
		// Проверка на циклическую зависимость
		МассивСтрок = Новый Массив;
		Если ТекПартия.ТребуетсяРазузлование И ТекПартия.КоличествоЗатрата <> 0 Тогда
			ПараметрыОтбора = Новый Структура("Партия, АналитикаУчетаПартий",
				ТекПартия.ПартияЗатрата,
				ТекПартия.АналитикаУчетаПартийЗатрата);
			#Вставка
			// ЗАМЕР Н2: проверка циклов
			ВремяДоПроверки = ТекущаяДатаСеанса();
			#КонецВставки
			МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
			#Вставка
			ПараметрыДерева.Замер_ВремяПроверкиЦиклов = ПараметрыДерева.Замер_ВремяПроверкиЦиклов 
				+ (ТекущаяДатаСеанса() - ВремяДоПроверки);
			ПараметрыДерева.Замер_КоличествоПроверокЦиклов = ПараметрыДерева.Замер_КоличествоПроверокЦиклов + 1;
			#КонецВставки
			
			// Логирование обнаруженного цикла
			Если МассивСтрок.Количество() > 0 Тогда
				ИнформацияОЦикле = Новый Структура;
				ИнформацияОЦикле.Вставить("Уровень", УровеньУзла);
				ИнформацияОЦикле.Вставить("ПартияЗатрата", ТекПартия.ПартияЗатрата);
				ИнформацияОЦикле.Вставить("АналитикаУчетаПартийЗатрата", ТекПартия.АналитикаУчетаПартийЗатрата);
				ИнформацияОЦикле.Вставить("Затрата", ТекПартия.Затрата);
				ИнформацияОЦикле.Вставить("ПартияПродукции", ПартияПродукции);
				ИнформацияОЦикле.Вставить("АналитикаУчетаПартийПродукции", АналитикаУчетаПартийПродукции);
				
				ПараметрыДерева.ОбнаруженныеЦиклы.Добавить(ИнформацияОЦикле);
				
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"Обнаружен циклический переход на уровне %1: Затрата '%2' (Партия: %3, Аналитика партий: %4) -> уже обрабатывалась в пути от Партии: %5, Аналитики партий: %6",
					Строка(УровеньУзла),
					Строка(ТекПартия.Затрата),
					Строка(ТекПартия.ПартияЗатрата),
					Строка(ТекПартия.АналитикаУчетаПартийЗатрата),
					Строка(ПартияПродукции),
					Строка(АналитикаУчетаПартийПродукции));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.ОбнаруженЦикл",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
			КонецЕсли;
		КонецЕсли;
		
		// Добавляем строку в результат
		УсловиеДобавления = ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			ИЛИ ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат
			ИЛИ Не ТекПартия.ТребуетсяРазузлование;
		
		// ДИАГНОСТИКА: проверка, почему строка не добавляется
		Если НЕ УсловиеДобавления Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				"Строка НЕ добавлена: Затрата='%1', ТипРезультата='%2', ДобавлятьПолуфабрикаты=%3, ТребуетсяРазузлование=%4",
				Строка(ТекПартия.Затрата),
				ПараметрыДерева.ТипРезультата,
				Строка(ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат),
				Строка(ТекПартия.ТребуетсяРазузлование));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				ТекстСообщения);
		КонецЕсли;
		
		Если УсловиеДобавления Тогда			
			СтрокаПартия = Результат.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаПартия, ТекПартия);
			
			// ДИАГНОСТИКА: проверка ДопРасходы после ЗаполнитьЗначенияСвойств
			Если СтрНайти(ИмяЗатраты, "Каучук натуральный") > 0 Тогда
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.ДиагностикаКаучук",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"КАУЧУК после копирования: СтрокаПартия.ДопРасходы=%1, ТекПартия.ДопРасходы=%2",
						Строка(СтрокаПартия.ДопРасходы),
						Строка(ТекПартия.ДопРасходы)));
			КонецЕсли;
			
			СтрокаПартия.Идентификатор = Новый УникальныйИдентификатор();
			Если ТекПартия.ТребуетсяРазузлование
				И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
				И (ТекПартия.СуммаЗатрата <> 0 ИЛИ ТекПартия.СуммаЗатратаЗабалансовая <> 0)
				И МассивСтрок.Количество() = 0 Тогда
				
				СтрокаПартия.ВидСтроки = Перечисления.ВидыСтрокДереваСебестоимости.ПартияПолуфабриката;
				СтрокаПартия.Числитель = ТекПартия.КоличествоЗатрата;
			Иначе
				СтрокаПартия.ВидСтроки = Перечисления.ВидыСтрокДереваСебестоимости.ПартияЗатраты;
				// КРИТИЧНО: Обязательно устанавливаем ТребуетсяРазузлование = Ложь для материалов!
				// Отчёт игнорирует ДопРасходы если ТребуетсяРазузлование = Истина:
				// СУММА(ВЫБОР КОГДА Результат.ТребуетсяРазузлование... ТОГДА 0 ИНАЧЕ Результат.ДопРасходы)
				СтрокаПартия.ТребуетсяРазузлование = Ложь;
				// КРИТИЧНО: Сбрасываем ТребуетсяРазузлованиеДопРасходов ТОЛЬКО если дочерний узел НЕ будет создан!
				// Отчёт проверяет ОБА условия: ТребуетсяРазузлование ИЛИ ТребуетсяРазузлованиеДопРасходов
				// Условие создания дочернего узла: ТребуетсяРазузлованиеДопРасходов И КоличествоЗатрата <> 0 И ДопРасходы <> 0
				// Если условие ЛОЖНО, дочерний узел не создастся и можно сбросить флаг
				Если НЕ (ТекПартия.ТребуетсяРазузлованиеДопРасходов
					И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
					И ТекПартия.ДопРасходы <> 0) Тогда
					СтрокаПартия.ТребуетсяРазузлованиеДопРасходов = Ложь;
				КонецЕсли;
			КонецЕсли;
			
			// КРИТИЧНО: Заполняем поля партии продукции из ОписаниеПродукции (корневая продукция)!
			// ПартияПродукции - это партия КОРНЕВОЙ продукции, которая передаётся неизменной
			// через все уровни рекурсии. Это нужно для правильного соединения в отчёте:
			// ВТПродукция.ПартияПродукции = Затраты.ПартияПродукции
			// А поле ПартияВыходноеИзделие (партия непосредственного родителя-полуфабриката)
			// копируется через ЗаполнитьЗначенияСвойств выше!
			СтрокаПартия.ПартияПродукции = ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартийПродукции = АналитикаУчетаПартийПродукции;
			СтрокаПартия.АналитикаУчетаПродукции = АналитикаУчетаПродукции;
			
		// КРИТИЧНО: Заполняем аналитику выходного изделия из ОписаниеПродукции!
		// В СТАРОМ алгоритме (строки 585, 617): 
		//   НоваяСтрока.ПартияВыходноеИзделие = ОписаниеПродукции.ПартияПродукции;
		// ПартияВыходноеИзделие должна быть = партия КОРНЕВОЙ продукции, а не промежуточного полуфабриката!
		// Это нужно для правильного join в отчёте:
		//   ВТПродукция.ПартияПродукции = Затраты.ПартияПолуфабриката (= Результат.ПартияВыходноеИзделие)
		// ЗаполнитьЗначенияСвойств копирует из запроса партию промежуточного полуфабриката,
		// но нужна партия КОРНЕВОЙ продукции из ОписаниеПродукции!
			СтрокаПартия.ПартияВыходноеИзделие = ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартийВыходноеИзделие = АналитикаУчетаПартийПродукции;
			СтрокаПартия.АналитикаУчетаВыходноеИзделие = АналитикаУчетаПродукции;
			
			СтрокаПартия.Номенклатура = ТекПартия.Затрата;
			СтрокаПартия.Характеристика = ТекПартия.ХарактеристикаЗатрата;
			СтрокаПартия.Серия = ТекПартия.СерияЗатрата;
			СтрокаПартия.Назначение = ТекПартия.НазначениеЗатрата;
			СтрокаПартия.Партия = ТекПартия.ПартияЗатрата;
			СтрокаПартия.АналитикаУчетаПартий = ТекПартия.АналитикаУчетаПартийЗатрата;
			СтрокаПартия.ЕдиницаИзмерения = ТекПартия.ЕдиницаИзмеренияЗатрата;
			СтрокаПартия.Уровень = УровеньУзла;
			
			СтрокаПартия.Количество = ТекПартия.КоличествоЗатрата;
			СтрокаПартия.Сумма = Окр(ТекПартия.СуммаЗатрата, 2);
			СтрокаПартия.ДопРасходы = Окр(СтрокаПартия.ДопРасходы, 2);
			СтрокаПартия.НалоговыйУчет = Окр(СтрокаПартия.НалоговыйУчет, 2);
			СтрокаПартия.СуммаЗабалансовая = ТекПартия.СуммаЗатратаЗабалансовая;
			
			// Уменьшаем суммовые показатели в узле
			Если ПараметрыУзла.Сумма <> 0 ИЛИ ПараметрыУзла.СуммаЗабалансовая <> 0 Тогда
				ПараметрыУзла.Сумма = ПараметрыУзла.Сумма - СтрокаПартия.Сумма;
				ПараметрыУзла.Материальные = ПараметрыУзла.Материальные - СтрокаПартия.Материальные;
				ПараметрыУзла.ДопРасходы = ПараметрыУзла.ДопРасходы - СтрокаПартия.ДопРасходы;
				ПараметрыУзла.Трудозатраты = ПараметрыУзла.Трудозатраты - СтрокаПартия.Трудозатраты;
				ПараметрыУзла.ПостатейныеПеременные = ПараметрыУзла.ПостатейныеПеременные - СтрокаПартия.ПостатейныеПеременные;
				ПараметрыУзла.ПостатейныеПостоянные = ПараметрыУзла.ПостатейныеПостоянные - СтрокаПартия.ПостатейныеПостоянные;
				ПараметрыУзла.НалоговыйУчет = ПараметрыУзла.НалоговыйУчет - СтрокаПартия.НалоговыйУчет;
				ПараметрыУзла.ПостояннаяРазница = ПараметрыУзла.ПостояннаяРазница - СтрокаПартия.ПостояннаяРазница;
				ПараметрыУзла.ВременнаяРазница = ПараметрыУзла.ВременнаяРазница - СтрокаПартия.ВременнаяРазница;
				ПараметрыУзла.СуммаЗабалансовая = ПараметрыУзла.СуммаЗабалансовая - СтрокаПартия.СуммаЗабалансовая;
				
				ЭтоРазузлованиеДопРасходов = (ТекПартия.ТипЗатрат = "ДопРасходы");
			КонецЕсли;
		КонецЕсли;
		
		// Подготовка узла для следующего уровня
		Если (ТекПартия.ТребуетсяРазузлование
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И (ТекПартия.СуммаЗатрата <> 0 ИЛИ ТекПартия.СуммаЗатратаЗабалансовая <> 0)
			И МассивСтрок.Количество() = 0)
			ИЛИ (ТекПартия.ТребуетсяРазузлованиеДопРасходов
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И ТекПартия.ДопРасходы <> 0) Тогда
			
			ПараметрыУзлаПартии = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();
			
			// Добавляем партию в пройденный путь (НЕ для дополнительных расходов)
			Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
				НовыйПуть = ПройденныйПуть.Добавить();
				НовыйПуть.Партия = ТекПартия.ПартияЗатрата;
				НовыйПуть.АналитикаУчетаПартий = ТекПартия.АналитикаУчетаПартийЗатрата;
			КонецЕсли;
			
			Отборы = ПараметрыУзлаПартии.Отборы;
			Отборы.ДанныеПоСебестоимости = ПараметрыУзла.Отборы.ДанныеПоСебестоимости;
			Отборы.Продукция.Добавить(ТекПартия.Затрата);
			Отборы.ХарактеристикиПродукции.Добавить(ТекПартия.ХарактеристикаЗатрата);
			Отборы.СерииПродукции.Добавить(ТекПартия.СерияЗатрата);
			Отборы.ПартииПродукции.Добавить(ТекПартия.ПартияЗатрата);
			Отборы.АналитикиУчетаПартийПродукции.Добавить(ТекПартия.АналитикаУчетаПартийЗатрата);
			Отборы.АналитикаУчетаЗатрата.Добавить(ТекПартия.АналитикаУчетаЗатрата);
			Отборы.Числитель = ТекПартия.КоличествоЗатрата;
			Отборы.КоличествоПродукции = Макс(-ТекПартия.КоличествоЗатрата, ТекПартия.КоличествоЗатрата);
			Отборы.РазворачиватьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы;
			Отборы.ДатаИсходнойПартии = ПараметрыУзла.Отборы.ДатаИсходнойПартии;
			Отборы.ДатаОкончания = ПараметрыУзла.Отборы.ДатаОкончания;
			Отборы.ВключитьНДСВСтоимость = ТекПартия.ВключитьНДСВСтоимость;
			Отборы.ИсключитьНДСИзСтоимости = ТекПартия.ИсключитьНДСИзСтоимости;
			Отборы.АналитикаУчетаВыходноеИзделие = ТекПартия.АналитикаУчетаЗатрата;
			Отборы.СтатьяКалькуляции = ТекПартия.СтатьяКалькуляции;
			
		Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
			ТаблицаРезультатаПартии = СтрокаПартия;
		Иначе
			ТаблицаРезультатаПартии = Результат;
		КонецЕсли;
		
		// КРИТИЧНО: Заполняем ПараметрыУзлаПартии из ТекПартия (а не СтрокаПартия),
		// т.к. СтрокаПартия может быть не создана, если ДобавлятьПолуфабрикатыВРезультат = Ложь
		// Также в старом алгоритме это делается только для обычных партий (НЕ для дополнительных расходов)
		Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
			ПараметрыУзлаПартии.Сумма = ТекПартия.СуммаЗатрата;
			ПараметрыУзлаПартии.Материальные = ТекПартия.Материальные;
			ПараметрыУзлаПартии.ДопРасходы = ТекПартия.ДопРасходы;
			ПараметрыУзлаПартии.Трудозатраты = ТекПартия.Трудозатраты;
			ПараметрыУзлаПартии.ПостатейныеПеременные = ТекПартия.ПостатейныеПеременные;
			ПараметрыУзлаПартии.ПостатейныеПостоянные = ТекПартия.ПостатейныеПостоянные;
			ПараметрыУзлаПартии.НалоговыйУчет = ТекПартия.НалоговыйУчет;
			ПараметрыУзлаПартии.ПостояннаяРазница = ТекПартия.ПостояннаяРазница;
			ПараметрыУзлаПартии.ВременнаяРазница = ТекПартия.ВременнаяРазница;
			ПараметрыУзлаПартии.СуммаЗабалансовая = ТекПартия.СуммаЗатратаЗабалансовая;
		КонецЕсли;
			
		// КРИТИЧНО: Передаём данные КОРНЕВОЙ продукции, как в старом алгоритме!
		// В старом алгоритме ОписаниеПродукции передаётся НЕИЗМЕННЫМ через все уровни рекурсии.
		// Только поле Уровень обновляется для каждого нового уровня.
		// Это нужно для правильного соединения в отчёте:
		// ВТПродукция.ПартияПродукции = Затраты.ПартияПродукции
		НовоеОписаниеПродукции = Новый Структура("АналитикаУчетаПродукции, ПартияПродукции, АналитикаУчетаПартийПродукции");
		НовоеОписаниеПродукции.АналитикаУчетаПродукции = АналитикаУчетаПродукции;
		НовоеОписаниеПродукции.ПартияПродукции = ПартияПродукции;
		НовоеОписаниеПродукции.АналитикаУчетаПартийПродукции = АналитикаУчетаПартийПродукции;
		НовоеОписаниеПродукции.Вставить("Уровень", УровеньУзла);
		
		// Определяем СтрокаПартия: она существует только если УсловиеДобавления было Истина
		// В противном случае (полуфабрикат с ДобавлятьПолуфабрикатыВРезультат = Ложь)
		// передаем Неопределено
		СтрокаДляУзла = Неопределено;
		Если УсловиеДобавления Тогда
			СтрокаДляУзла = СтрокаПартия;
		КонецЕсли;
		
		НовыйУзел = Новый Структура;
		НовыйУзел.Вставить("ПараметрыУзла", ПараметрыУзлаПартии);
		НовыйУзел.Вставить("ТаблицаРезультата", ТаблицаРезультатаПартии);
		НовыйУзел.Вставить("ОписаниеПродукции", НовоеОписаниеПродукции);
		НовыйУзел.Вставить("СтрокаПартия", СтрокаДляУзла);
		
		// КРИТИЧНО: Флаг для сброса ТребуетсяРазузлованиеДопРасходов после обработки
		// Если это узел для разузлования доп расходов и он не добавит строк,
		// нужно сбросить ТребуетсяРазузлованиеДопРасходов в родительской строке
		// (как в старом алгоритме, строки 533-538)
		ЭтоУзелДляДопРасходов = ТекПартия.ТребуетсяРазузлованиеДопРасходов
			И НЕ ТекПартия.ТребуетсяРазузлование;
		НовыйУзел.Вставить("ЭтоУзелДляДопРасходов", ЭтоУзелДляДопРасходов);
		НовыйУзел.Вставить("РодительскаяСтрока", СтрокаДляУзла);
		
		УзлыСледующегоУровня.Добавить(НовыйУзел);
		КонецЕсли;
		
	КонецЦикла;
	
	// ДИАГНОСТИКА
	КоличествоПосле = Результат.Количество();
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"ОбработатьРезультатыУзла: добавлено строк=%1 (было=%2, стало=%3), следующий уровень узлов=%4",
		Строка(КоличествоПосле - КоличествоДо),
		Строка(КоличествоДо),
		Строка(КоличествоПосле),
		Строка(УзлыСледующегоУровня.Количество()));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ТекстСообщения);
	
	// КРИТИЧНО: Сброс ТребуетсяРазузлованиеДопРасходов в родительской строке
	// Аналог старого алгоритма (строки 533-538):
	// Если разузлование доп расходов не выполнено (не добавлено строк), снимем признак
	Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц"
		И Узел.Свойство("ЭтоУзелДляДопРасходов")
		И Узел.ЭтоУзелДляДопРасходов
		И КоличествоПосле = КоличествоДо
		И Узел.Свойство("РодительскаяСтрока")
		И Узел.РодительскаяСтрока <> Неопределено Тогда
		Узел.РодительскаяСтрока.ТребуетсяРазузлованиеДопРасходов = Ложь;
	КонецЕсли;
		
	// При наличии данных о разузловании добавим строку на суммы изменения стоимости
	Если СебестоимостьУзла.Количество() > 0 И НЕ ЭтоРазузлованиеДопРасходов Тогда
		УчестьИзменениеСтоимости(ПараметрыУзла, ОписаниеПродукции, Результат);
	КонецЕсли;
	
КонецПроцедуры   

// Пакетное получение себестоимости для нескольких узлов одним запросом (оптимизация N+1)
//
// Параметры:
//  МассивПараметровУзлов - Массив из Структура - Массив параметров узлов для обработки
//  ВыводитьДопРасходы - Булево - Выводить ли дополнительные расходы
//  ОбщиеПараметры - Структура - Общие параметры для всех узлов (ДанныеПоСебестоимости и т.д.)
//
// Возвращаемое значение:
//  Соответствие - Ключ: идентификатор узла (Партия+АналитикаПартий), Значение: ТаблицаЗначений с данными себестоимости
//
Функция СебестоимостьУзловПакетом(МассивПараметровУзлов, ВыводитьДопРасходы, ОбщиеПараметры)
	
	Если МассивПараметровУзлов.Количество() = 0 Тогда
		Возврат Новый Соответствие;
	КонецЕсли;
	
	// Собираем все партии и аналитики для пакетного запроса
	// + создаём индекс для быстрого распределения результатов
	ВсеПартииПродукции = Новый Массив;
	ВсеАналитикиУчетаПартийПродукции = Новый Массив;
	ВсеПродукция = Новый Массив;
	ВсеХарактеристики = Новый Массив;
	ВсеСерии = Новый Массив;
	ВсеНазначения = Новый Массив;
	
	// Индекс: Партия -> КлючУзла (для распределения результатов)
	ИндексПартийПоУзлам = Новый Соответствие;
	
	Для Каждого ПараметрыУзла Из МассивПараметровУзлов Цикл
		Отборы = ПараметрыУзла.Отборы;
		КлючУзла = СоздатьКлючУзла(ПараметрыУзла);
		
		Для Каждого Партия Из Отборы.ПартииПродукции Цикл
			Если ВсеПартииПродукции.Найти(Партия) = Неопределено Тогда
				ВсеПартииПродукции.Добавить(Партия);
			КонецЕсли;
			// Связываем партию с ключом узла для распределения результатов
			ИндексПартийПоУзлам.Вставить(Партия, КлючУзла);
		КонецЦикла;
		
		Для Каждого Аналитика Из Отборы.АналитикиУчетаПартийПродукции Цикл
			Если ВсеАналитикиУчетаПартийПродукции.Найти(Аналитика) = Неопределено Тогда
				ВсеАналитикиУчетаПартийПродукции.Добавить(Аналитика);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Продукция Из Отборы.Продукция Цикл
			Если ВсеПродукция.Найти(Продукция) = Неопределено Тогда
				ВсеПродукция.Добавить(Продукция);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Характеристика Из Отборы.ХарактеристикиПродукции Цикл
			Если ВсеХарактеристики.Найти(Характеристика) = Неопределено Тогда
				ВсеХарактеристики.Добавить(Характеристика);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Серия Из Отборы.СерииПродукции Цикл
			Если ВсеСерии.Найти(Серия) = Неопределено Тогда
				ВсеСерии.Добавить(Серия);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Назначение Из Отборы.НазначенияПродукции Цикл
			Если ВсеНазначения.Найти(Назначение) = Неопределено Тогда
				ВсеНазначения.Добавить(Назначение);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// Создаем объединенные параметры для пакетного запроса
	ПараметрыУзлаОбъединенные = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();
	ОтборыОбъединенные = ПараметрыУзлаОбъединенные.Отборы;
	
	// Копируем общие параметры из первого узла (они должны быть одинаковыми)
	ПервыйУзел = МассивПараметровУзлов[0];
	ОтборыОбъединенные.ДанныеПоСебестоимости = ПервыйУзел.Отборы.ДанныеПоСебестоимости;
	ОтборыОбъединенные.РазворачиватьДопРасходы = ПервыйУзел.Отборы.РазворачиватьДопРасходы;
	ОтборыОбъединенные.ДатаОкончания = ПервыйУзел.Отборы.ДатаОкончания;
	ОтборыОбъединенные.ДатаИсходнойПартии = ПервыйУзел.Отборы.ДатаИсходнойПартии;
	
	// Устанавливаем объединенные массивы
	ОтборыОбъединенные.ПартииПродукции = ВсеПартииПродукции;
	ОтборыОбъединенные.АналитикиУчетаПартийПродукции = ВсеАналитикиУчетаПартийПродукции;
	ОтборыОбъединенные.Продукция = ВсеПродукция;
	ОтборыОбъединенные.ХарактеристикиПродукции = ВсеХарактеристики;
	ОтборыОбъединенные.СерииПродукции = ВсеСерии;
	ОтборыОбъединенные.НазначенияПродукции = ВсеНазначения;
	
	// Выполняем ОДИН запрос для ВСЕХ узлов уровня
	Запрос = ЗапросВыпущеннаяПродукция(ПараметрыУзлаОбъединенные, Истина);
	Запрос.Текст = Запрос.Текст + ТекстЗапросаЗатратыНаПродукцию(ВыводитьДопРасходы);
	
	ВсеДанные = Запрос.Выполнить().Выгрузить();
	
	// ДИАГНОСТИКА: проверяем структуру результата
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"СебестоимостьУзловПакетом: получено строк=%1, колонок=%2",
		Строка(ВсеДанные.Количество()),
		Строка(ВсеДанные.Колонки.Количество()));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ТекстСообщения);
	
	// Проверяем наличие колонки ПартияВыходноеИзделие
	Если ВсеДанные.Колонки.Найти("ПартияВыходноеИзделие") = Неопределено Тогда
		ТекстСообщения = "ОШИБКА: В результате запроса отсутствует колонка ПартияВыходноеИзделие!";
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.ОШИБКА",
			УровеньЖурналаРегистрации.Ошибка,
			,
			,
			ТекстСообщения);
		// Возвращаем пустые таблицы для всех узлов
		РезультатПоУзлам = Новый Соответствие;
		Для Каждого ПараметрыУзла Из МассивПараметровУзлов Цикл
			КлючУзла = СоздатьКлючУзла(ПараметрыУзла);
			РезультатПоУзлам.Вставить(КлючУзла, Новый ТаблицаЗначений);
		КонецЦикла;
		Возврат РезультатПоУзлам;
	КонецЕсли;
	
	// Распределяем результаты по узлам на основе ПартияВыходноеИзделие
	// Каждая строка результата относится к конкретной партии продукции
	РезультатПоУзлам = Новый Соответствие;
	
	// Инициализируем пустые таблицы для каждого узла
	Для Каждого ПараметрыУзла Из МассивПараметровУзлов Цикл
		КлючУзла = СоздатьКлючУзла(ПараметрыУзла);
		// Создаём пустую таблицу с такой же структурой
		ТаблицаУзла = ВсеДанные.СкопироватьКолонки();
		РезультатПоУзлам.Вставить(КлючУзла, ТаблицаУзла);
	КонецЦикла;
	
	// Распределяем строки по узлам на основе партии продукции
	Для Каждого СтрокаДанных Из ВсеДанные Цикл
		// Находим ключ узла по партии продукции
		КлючУзла = ИндексПартийПоУзлам.Получить(СтрокаДанных.ПартияВыходноеИзделие);
		
		Если КлючУзла <> Неопределено Тогда
			ТаблицаУзла = РезультатПоУзлам.Получить(КлючУзла);
			Если ТаблицаУзла <> Неопределено Тогда
				НоваяСтрока = ТаблицаУзла.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаДанных);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Возврат РезультатПоУзлам;
	
КонецФункции

// Создает уникальный ключ для узла на основе его параметров
Функция СоздатьКлючУзла(ПараметрыУзла)
	
	Отборы = ПараметрыУзла.Отборы;
	
	КлючПартии = "";
	Для Каждого Партия Из Отборы.ПартииПродукции Цикл
		КлючПартии = КлючПартии + Строка(Партия.УникальныйИдентификатор()) + ";";
	КонецЦикла;
	
	КлючАналитики = "";
	Для Каждого Аналитика Из Отборы.АналитикиУчетаПартийПродукции Цикл
		КлючАналитики = КлючАналитики + Строка(Аналитика.УникальныйИдентификатор()) + ";";
	КонецЦикла;
	
	Возврат КлючПартии + "|" + КлючАналитики;
	
КонецФункции


//	#Удаление
//	#КонецУдаления
//	#Вставка
// 	#КонецВставки






