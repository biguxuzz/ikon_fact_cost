// Возвращает параметры узла дерева с кешированием СхемаКД
//
// Параметры:
//  ПараметрыДерева - Структура - параметры дерева себестоимости, содержащие КэшСхемаКД
//
// Возвращаемое значение:
//  Структура - параметры узла дерева с кешированной СхемаКД
//
Функция ikon_cost_ПараметрыУзлаСКэшем(ПараметрыДерева)
	
	// Запись версии в журнал регистрации (однократно при первом вызове)
	Если НЕ ПараметрыДерева.Свойство("ЖурналВерсииЗаписан") Тогда
		ЗаписьЖурналаРегистрации("ikon_cost_ПараметрыУзлаСКэшем", УровеньЖурналаРегистрации.Информация,,,
			"v0.1.1.225: Исправление: при выгрузке после подпакета не удаляем строки текущего уровня (они нужны как РодительскаяСтрока для узлов следующего уровня)");
		ПараметрыДерева.Вставить("ЖурналВерсииЗаписан", Истина);
	КонецЕсли;
	
	ПараметрыУзла = Новый Структура;
	
	// Ленивая инициализация кеша СхемаКД
	Если НЕ ПараметрыДерева.Свойство("КэшСхемаКД") ИЛИ ПараметрыДерева.КэшСхемаКД = Неопределено Тогда
		ПараметрыДерева.Вставить("КэшСхемаКД", Отчеты.ДеревоСебестоимостиПродукции.ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных"));
	КонецЕсли;
	
	ПараметрыУзла.Вставить("ИнтерактивнаяНастройка",	Ложь);
	ПараметрыУзла.Вставить("СхемаКД",					ПараметрыДерева.КэшСхемаКД);
	ПараметрыУзла.Вставить("НастройкиКД",				Неопределено); // Не используем НастройкиПоУмолчанию - экономия памяти
	
	Отборы = ikon_cost_НоваяСтруктураОтборов();
	ПараметрыУзла.Вставить("Отборы", Отборы);
	
	ПараметрыУзла.Вставить("Сумма",                 0);
	ПараметрыУзла.Вставить("Материальные",          0);
	ПараметрыУзла.Вставить("ДопРасходы",            0);
	ПараметрыУзла.Вставить("Трудозатраты",          0);
	ПараметрыУзла.Вставить("ПостатейныеПеременные", 0);
	ПараметрыУзла.Вставить("ПостатейныеПостоянные", 0);
	ПараметрыУзла.Вставить("НалоговыйУчет",         0);
	ПараметрыУзла.Вставить("ПостояннаяРазница",     0);
	ПараметрыУзла.Вставить("ВременнаяРазница",      0);
	ПараметрыУзла.Вставить("СуммаЗабалансовая",     0);
	
	Возврат ПараметрыУзла;
	
КонецФункции

// Создаёт новую структуру отборов для параметров узла дерева
// (локальная копия функции из базового модуля для оптимизации)
//
// Возвращаемое значение:
//  Структура - структура отборов с инициализированными значениями
//
Функция ikon_cost_НоваяСтруктураОтборов()
	
	Регистраторы = Новый Массив; // Массив из ДокументСсылка
	Организации = Новый Массив; // Массив из СправочникСсылка.Организации
	Подразделения = Новый Массив; // Массив из СправочникСсылка.СтруктураПредприятия
	Продукция = Новый Массив; // Массив из СправочникСсылка.Номенклатура
	ХарактеристикиПродукции = Новый Массив; // Массив из СправочникСсылка.ХарактеристикиНоменклатуры
	СерииПродукции = Новый Массив; // Массив из СправочникСсылка.СерииНоменклатуры
	НазначенияПродукции = Новый Массив; // Массив из СправочникСсылка.Назначения
	ПартииПродукции = Новый Массив; // Массив из ДокументСсылка
	АналитикиУчетаПартийПродукции = Новый Массив; // Массив из СправочникСсылка.КлючиАналитикиУчетаПартий
	АналитикаУчетаЗатрата = Новый Массив; // Массив из СправочникСсылка.КлючиАналитикиУчетаНоменклатуры
	
	Отборы = Новый Структура;
	
	Отборы.Вставить("ДанныеПоСебестоимости",			1);
	Отборы.Вставить("ДатаНачала",						'00010101');
	Отборы.Вставить("ДатаОкончания",					'00010101');
	Отборы.Вставить("Регистраторы",						Регистраторы);
	Отборы.Вставить("Организации",						Организации);
	Отборы.Вставить("Подразделения",					Подразделения);
	Отборы.Вставить("Продукция",						Продукция);
	Отборы.Вставить("ХарактеристикиПродукции",			ХарактеристикиПродукции);
	Отборы.Вставить("СерииПродукции",					СерииПродукции);
	Отборы.Вставить("НазначенияПродукции",				НазначенияПродукции);
	Отборы.Вставить("ПартииПродукции",					ПартииПродукции);
	Отборы.Вставить("АналитикиУчетаПартийПродукции",	АналитикиУчетаПартийПродукции);
	Отборы.Вставить("АналитикаУчетаЗатрата",			АналитикаУчетаЗатрата);
	Отборы.Вставить("Числитель",						0);
	Отборы.Вставить("Знаменатель",						0);
	Отборы.Вставить("ВалютаУправленческогоУчета",		Справочники.Валюты.ПустаяСсылка());
	Отборы.Вставить("АналитикаУчетаВыходноеИзделие",	Справочники.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка());
	Отборы.Вставить("СтатьяКалькуляции",				Справочники.СтатьиКалькуляции.ПустаяСсылка());
	Отборы.Вставить("КоличествоПродукции",				0);
	Отборы.Вставить("РазворачиватьДопРасходы",			Истина);
	Отборы.Вставить("ДатаИсходнойПартии",				'00010101');
	Отборы.Вставить("ВключитьНДСВСтоимость",			Ложь);
	Отборы.Вставить("ИсключитьНДСИзСтоимости",			Ложь);
	
	Возврат Отборы;
	
КонецФункции

// Строит дерево себестоимости для изделия.
//
// Параметры:
//  ПараметрыДерева - Структура - см. СтруктураСебестоимости.ПараметрыДереваСебестоимости
//  ПараметрыУзла - Структура - см. СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости; если Неопределено,
//		параметры узла будут сформированы внутри (через ikon_cost_ПараметрыУзлаСКэшем()).
//
// Изменения относительно базового модуля СтруктураСебестоимости:
//  - При ПараметрыУзла = Неопределено используется ikon_cost_ПараметрыУзлаСКэшем(), который кеширует макет СКД
//    в ПараметрыДерева.КэшСхемаКД, чтобы уменьшить накладные расходы и расход памяти на повторное получение макета.
//  - При включенном ИспользоватьПакетнуюОбработку автоматически отключается ДинамическоеСчитывание, т.к. режимы
//    несовместимы и приводят к некорректному/непредсказуемому заполнению результата.
//  - Сохранено поведение по добавлению полуфабрикатов в результат (как в оригинале), т.к. они нужны для построения
//    связей «материалы → продукция» в запросах отчёта при использовании МенеджерВременныхТаблиц.
&Вместо("ПостроитьДеревоСебестоимости")
Процедура ikon_cost_ПостроитьДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла = Неопределено) Экспорт

	
	// КРИТИЧНО: Для отчётов (МенеджерВременныхТаблиц) полуфабрикаты НЕОБХОДИМЫ!
	// Они используются для построения связей между материалами и продукцией в запросе отчета.
	// Отчёт строит таблицу КоличествоВыпуска из продукции и полуфабрикатов,
	// затем соединяет материалы с полуфабрикатами по ПартияВыходноеИзделие.
	// Без полуфабрикатов материалы "висят в воздухе" без связи с продукцией.
	// Поэтому оставляем ДобавлятьПолуфабрикатыВРезультат = Истина (как в оригинале)
	
	
	// СтандартныеПодсистемы.ЗамерПроизводительности
	Замер = ОценкаПроизводительности.НачатьЗамерДлительнойОперации("ОбщийМодуль.СтруктураСебестоимости.ПостроитьДеревоСебестоимости");
	ПараметрыДерева.Вставить("КоличествоСтрок", 0);
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности
	
	Если ПараметрыУзла = Неопределено Тогда
		ПараметрыУзла = ikon_cost_ПараметрыУзлаСКэшем(ПараметрыДерева);
	КонецЕсли;
	
	// ВАЖНО: Пакетная обработка несовместима с динамическим считыванием
	// Если включена пакетная обработка, автоматически отключаем динамическое считывание
	Если ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
		И ПараметрыДерева.ИспользоватьПакетнуюОбработку
		И ПараметрыДерева.ДинамическоеСчитывание Тогда
		
		ПараметрыДерева.ДинамическоеСчитывание = Ложь;
	КонецЕсли;
	
	// ОПТИМИЗАЦИЯ ПАМЯТИ: дробление пакета узлов на подпакеты для снижения пика памяти внутри уровня
	// При обработке уровня с большим количеством узлов (тысячи), каждый узел добавляет десятки строк в Результат.
	// Дробим узлы уровня на порции, чтобы не копить миллионы строк в ТаблицаЗначений одновременно.
	// После каждой порции выгружаем Результат в МВТ и очищаем (освобождая память для следующей порции).
	Если ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
		И ПараметрыДерева.ИспользоватьПакетнуюОбработку
		И НЕ ПараметрыДерева.Свойство("РазмерПодпакетаУзлов") Тогда
		// По умолчанию: обрабатываем по 50 узлов за раз (баланс между числом операций с МВТ и пиком памяти)
		// Можно уменьшить до 20-30 при критичной нехватке памяти, или увеличить до 100-200 при избытке.
		ПараметрыДерева.Вставить("РазмерПодпакетаУзлов", 50);
	КонецЕсли;
	
	
	Если ПараметрыДерева.Результат = Неопределено Тогда
		ПустоеДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла);
	КонецЕсли;

	ЗаполнитьДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла);

	// СтандартныеПодсистемы.ЗамерПроизводительности
	ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(Замер, ПараметрыДерева.КоличествоСтрок / 1000);
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности

КонецПроцедуры

// Разузловывает (раскрывает) узел дерева себестоимости: формирует строки затрат/полуфабрикатов,
// добавляет их в результат и при необходимости запускает дальнейшее разузлование по дочерним узлам.
//
// Параметры:
//  ПараметрыДерева - Структура - см. СтруктураСебестоимости.ПараметрыДереваСебестоимости
//  ПараметрыУзла - Структура - см. СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости
//  ТаблицаРезультата - ДеревоЗначений, ТаблицаЗначений, МенеджерВременныхТаблиц - текущий контейнер результата
//  ОписаниеПродукции - Структура - Аналитика учета, партия и уровень продукции (контекст разузлования)
//
// Изменения относительно базового модуля СтруктураСебестоимости:
//  - Добавлена защита от бесконечной рекурсии/зацикливаний: инициализация параметров
//    МаксимальнаяГлубинаРекурсии и ОбнаруженныеЦиклы в ПараметрыДерева и проверка глубины перед обработкой узла.
&Вместо("РазузловатьУзелДереваСебестоимости")
Процедура ikon_cost_РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзла, ТаблицаРезультата, ОписаниеПродукции)

	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		Результат = ТаблицаРезультата.Строки;
		Если ПараметрыДерева.ДинамическоеСчитывание Тогда
			Результат.Очистить();
		КонецЕсли;
	Иначе
		Результат = ТаблицаРезультата
	КонецЕсли;

	ПройденныйПуть = Неопределено;
	Если НЕ ПараметрыДерева.Свойство("ПройденныйПуть", ПройденныйПуть) Тогда
		ПройденныйПуть = Новый ТаблицаЗначений;
		ПройденныйПуть.Колонки.Добавить("Партия");
		ПройденныйПуть.Колонки.Добавить("АналитикаУчетаПартий");
		ПройденныйПуть.Индексы.Добавить("Партия, АналитикаУчетаПартий");
		ПараметрыДерева.Вставить("ПройденныйПуть", ПройденныйПуть);
		
		// Инициализируем параметры защиты от циклов и глубокой рекурсии
		ПараметрыДерева.Вставить("МаксимальнаяГлубинаРекурсии", 50);
		ПараметрыДерева.Вставить("ОбнаруженныеЦиклы", Новый Массив);
		
	КонецЕсли;

	АналитикаУчетаПродукции			= ОписаниеПродукции.АналитикаУчетаПродукции;
	ПартияПродукции					= ОписаниеПродукции.ПартияПродукции;
	АналитикаУчетаПартийПродукции	= ОписаниеПродукции.АналитикаУчетаПартийПродукции;
	УровеньУзла						= ОписаниеПродукции.Уровень + 1;
	
	// Проверка максимальной глубины рекурсии
	Если УровеньУзла > ПараметрыДерева.МаксимальнаяГлубинаРекурсии Тогда
		Возврат;
	КонецЕсли;

	ВыводитьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы И НЕ (УровеньУзла = 1);
	СебестоимостьУзла = СебестоимостьУзла(ПараметрыДерева, ПараметрыУзла, ВыводитьДопРасходы);

	// СтандартныеПодсистемы.ЗамерПроизводительности
	ПараметрыДерева.КоличествоСтрок = ПараметрыДерева.КоличествоСтрок + СебестоимостьУзла.Количество();
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности

	ЭтоРазузлованиеДопРасходов = Ложь;
	Для Каждого ТекПартия Из СебестоимостьУзла Цикл

		Если ТекПартия.ТребуетсяРазузлование И ТекПартия.КоличествоЗатрата <> 0 Тогда
			ПараметрыОтбора = Новый Структура("Партия, АналитикаУчетаПартий",
			ТекПартия.ПартияЗатрата,
			ТекПартия.АналитикаУчетаПартийЗатрата);
			МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
		Иначе
			МассивСтрок = Новый Массив;
		КонецЕсли;

		Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			ИЛИ ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат
			ИЛИ Не ТекПартия.ТребуетсяРазузлование Тогда
			СтрокаПартия = Результат.Добавить(); // СтрокаДереваЗначений
			ЗаполнитьЗначенияСвойств(СтрокаПартия, ТекПартия);

			СтрокаПартия.Идентификатор	= Новый УникальныйИдентификатор();
			Если ТекПартия.ТребуетсяРазузлование
				И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
				И (ТекПартия.СуммаЗатрата <> 0 Или ТекПартия.СуммаЗатратаЗабалансовая <> 0)
				И МассивСтрок.Количество() = 0 Тогда

				СтрокаПартия.ВидСтроки		= Перечисления.ВидыСтрокДереваСебестоимости.ПартияПолуфабриката;
				СтрокаПартия.Числитель 		= ТекПартия.КоличествоЗатрата;

			Иначе
				СтрокаПартия.ВидСтроки		= Перечисления.ВидыСтрокДереваСебестоимости.ПартияЗатраты;
				СтрокаПартия.ТребуетсяРазузлование = Ложь;
			КонецЕсли;

			СтрокаПартия.АналитикаУчетаПродукции		= АналитикаУчетаПродукции;
			СтрокаПартия.ПартияПродукции				= ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартийПродукции	= АналитикаУчетаПартийПродукции;

			СтрокаПартия.Номенклатура			= ТекПартия.Затрата;
			СтрокаПартия.Характеристика			= ТекПартия.ХарактеристикаЗатрата;
			СтрокаПартия.Серия					= ТекПартия.СерияЗатрата;
			СтрокаПартия.Назначение				= ТекПартия.НазначениеЗатрата;
			СтрокаПартия.Партия					= ТекПартия.ПартияЗатрата;
			СтрокаПартия.АналитикаУчетаПартий	= ТекПартия.АналитикаУчетаПартийЗатрата;
			СтрокаПартия.ЕдиницаИзмерения		= ТекПартия.ЕдиницаИзмеренияЗатрата;
			СтрокаПартия.Уровень				= УровеньУзла;

			СтрокаПартия.Количество			= ТекПартия.КоличествоЗатрата;
			СтрокаПартия.Сумма				= Окр(ТекПартия.СуммаЗатрата, 2);
			СтрокаПартия.ДопРасходы			= Окр(СтрокаПартия.ДопРасходы, 2);
			СтрокаПартия.НалоговыйУчет		= Окр(СтрокаПартия.НалоговыйУчет, 2);
			СтрокаПартия.СуммаЗабалансовая	= ТекПартия.СуммаЗатратаЗабалансовая;

			// Уменьшаем суммовые показатели в узле на разузлованные суммы. 
			// На оставшиеся суммы будет сформирована отдельная строка для отражения расхождения стоимости с детализацией.
			Если ПараметрыУзла.Сумма <> 0 Или ПараметрыУзла.СуммаЗабалансовая <> 0 Тогда
				ПараметрыУзла.Сумма = ПараметрыУзла.Сумма - СтрокаПартия.Сумма;
				ПараметрыУзла.Материальные = ПараметрыУзла.Материальные - СтрокаПартия.Материальные;
				ПараметрыУзла.ДопРасходы = ПараметрыУзла.ДопРасходы - СтрокаПартия.ДопРасходы;
				ПараметрыУзла.Трудозатраты = ПараметрыУзла.Трудозатраты - СтрокаПартия.Трудозатраты;
				ПараметрыУзла.ПостатейныеПеременные = ПараметрыУзла.ПостатейныеПеременные - СтрокаПартия.ПостатейныеПеременные;
				ПараметрыУзла.ПостатейныеПостоянные = ПараметрыУзла.ПостатейныеПостоянные - СтрокаПартия.ПостатейныеПостоянные;
				ПараметрыУзла.НалоговыйУчет = ПараметрыУзла.НалоговыйУчет - СтрокаПартия.НалоговыйУчет;
				ПараметрыУзла.ПостояннаяРазница = ПараметрыУзла.ПостояннаяРазница - СтрокаПартия.ПостояннаяРазница;
				ПараметрыУзла.ВременнаяРазница = ПараметрыУзла.ВременнаяРазница - СтрокаПартия.ВременнаяРазница;
				ПараметрыУзла.СуммаЗабалансовая = ПараметрыУзла.СуммаЗабалансовая - СтрокаПартия.СуммаЗабалансовая;

				ЭтоРазузлованиеДопРасходов = (ТекПартия.ТипЗатрат = "ДопРасходы");
			КонецЕсли;
		КонецЕсли;

		Если ТекПартия.ТребуетсяРазузлование
			И ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			И ПараметрыДерева.ДинамическоеСчитывание Тогда
			СтрокаПартия.Строки.Добавить();
		ИначеЕсли ТекПартия.ТребуетсяРазузлование
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И (ТекПартия.СуммаЗатрата <> 0 Или ТекПартия.СуммаЗатратаЗабалансовая <> 0)
			И МассивСтрок.Количество() = 0
			ИЛИ ТекПартия.ТребуетсяРазузлованиеДопРасходов
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И ТекПартия.ДопРасходы <> 0 Тогда
		// общий подход к заполнению отбора параметров узла и условиям разузлования должен совпадать с:
		// - ЗаполнитьДеревоСебестоимости();
		// - Отчет.ДеревоСебестоимости.МодульОбъекта.ПолноеДеревоСебестоимостиПередРазворачиваниемСервер(). 
		ПараметрыУзлаПартии = ikon_cost_ПараметрыУзлаСКэшем(ПараметрыДерева);

			Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
				НовыйПуть = ПройденныйПуть.Добавить();
				НовыйПуть.Партия = ТекПартия.ПартияЗатрата;
				НовыйПуть.АналитикаУчетаПартий = ТекПартия.АналитикаУчетаПартийЗатрата;
			КонецЕсли;

			Отборы = ПараметрыУзлаПартии.Отборы;
			Отборы.ДанныеПоСебестоимости = ПараметрыУзла.Отборы.ДанныеПоСебестоимости;
			Отборы.Продукция.Добавить(ТекПартия.Затрата);
			Отборы.ХарактеристикиПродукции.Добавить(ТекПартия.ХарактеристикаЗатрата);
			Отборы.СерииПродукции.Добавить(ТекПартия.СерияЗатрата);
			// При разузловании полуфабрикатов отбор по назначению не нужен, т.к. полуфабрикат может быть выпущен без назначения или
			// с указанием другого назначения.
			Отборы.ПартииПродукции.Добавить(ТекПартия.ПартияЗатрата);
			Отборы.АналитикиУчетаПартийПродукции.Добавить(ТекПартия.АналитикаУчетаПартийЗатрата);
			Отборы.АналитикаУчетаЗатрата.Добавить(ТекПартия.АналитикаУчетаЗатрата);
			// для знаменателя и количества продукции берем модуль значения, чтобы знак количества и сумм затрат определялся по числителю, который при выпуске будет > 0, а при сторно < 0
			// для знаменателя и количества продукции берем модуль значения, чтобы знак количества и сумм затрат определялся по числителю, который при выпуске будет > 0, а при сторно < 0
			Отборы.Числитель               = ТекПартия.КоличествоЗатрата;
			Отборы.КоличествоПродукции     = Макс(-ТекПартия.КоличествоЗатрата, ТекПартия.КоличествоЗатрата);
			Отборы.РазворачиватьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы;
			Отборы.ДатаИсходнойПартии      = ПараметрыУзла.Отборы.ДатаИсходнойПартии;
			Отборы.ДатаОкончания           = ПараметрыУзла.Отборы.ДатаОкончания;

			Отборы.ВключитьНДСВСтоимость   = ТекПартия.ВключитьНДСВСтоимость;
			Отборы.ИсключитьНДСИзСтоимости = ТекПартия.ИсключитьНДСИзСтоимости;
			Отборы.АналитикаУчетаВыходноеИзделие = ТекПартия.АналитикаУчетаЗатрата;
			Отборы.СтатьяКалькуляции       = ТекПартия.СтатьяКалькуляции;

			Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
				ТаблицаРезультатаПартии = СтрокаПартия;
			Иначе
				ТаблицаРезультатаПартии = Результат;
			КонецЕсли;

			Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
				ПараметрыУзлаПартии.Сумма = СтрокаПартия.Сумма;
				ПараметрыУзлаПартии.Материальные = СтрокаПартия.Материальные;
				ПараметрыУзлаПартии.ДопРасходы = СтрокаПартия.ДопРасходы;
				ПараметрыУзлаПартии.Трудозатраты = СтрокаПартия.Трудозатраты;
				ПараметрыУзлаПартии.ПостатейныеПеременные = СтрокаПартия.ПостатейныеПеременные;
				ПараметрыУзлаПартии.ПостатейныеПостоянные = СтрокаПартия.ПостатейныеПостоянные;
				ПараметрыУзлаПартии.НалоговыйУчет = СтрокаПартия.НалоговыйУчет;
				ПараметрыУзлаПартии.ПостояннаяРазница = СтрокаПартия.ПостояннаяРазница;
				ПараметрыУзлаПартии.ВременнаяРазница = СтрокаПартия.ВременнаяРазница;
				ПараметрыУзлаПартии.СуммаЗабалансовая = СтрокаПартия.СуммаЗабалансовая;
			КонецЕсли;

			ОписаниеПродукции.Вставить("Уровень", УровеньУзла);
			Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" Тогда
				КоличествоСтрокРезультата = ТаблицаРезультатаПартии.Количество();
			КонецЕсли;
			РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзлаПартии, ТаблицаРезультатаПартии, ОписаниеПродукции);

			// Если разозлование доп расходов не выполнено, снимем признак ТребуетсяРазузлованиеДопРасходов.
			Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц"
				И ТекПартия.ТребуетсяРазузлованиеДопРасходов
				И КоличествоСтрокРезультата = ТаблицаРезультатаПартии.Количество() Тогда
				СтрокаПартия.ТребуетсяРазузлованиеДопРасходов = Ложь;
			КонецЕсли;
		КонецЕсли;


	КонецЦикла;

	// При наличии данных о разузловании добавим строку на суммы изменения стоимости.
	Если СебестоимостьУзла.Количество() > 0 И НЕ ЭтоРазузлованиеДопРасходов Тогда
		УчестьИзменениеСтоимости(ПараметрыУзла, ОписаниеПродукции, Результат);
	КонецЕсли;

КонецПроцедуры

// Возвращает таблицу себестоимости для текущего узла дерева на основании параметров узла и флага вывода доп. расходов.
//
// Параметры:
//  ПараметрыДерева - см. СтруктураСебестоимости.ПараметрыДереваСебестоимости
//  ПараметрыУзла - см. СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости
//  ВыводитьДопРасходы - Булево - признак необходимости разворачивать дополнительные расходы для узла
//
// Возвращаемое значение:
//  ТаблицаЗначений - результат выполнения запроса себестоимости узла (выгрузка из Запрос.Выполнить())
//
// Изменения относительно базового модуля СтруктураСебестоимости:
//  - При ВыводитьДопРасходы = Истина формируется и добавляется ВТКоличествПоПарам (из параметра &ТаблицаКоличествПоПарам),
//    чтобы в запросе можно было вычислять пропорции распределения дополнительных расходов по текущей паре
//    (ПартияПродукции, АналитикаУчетаПартийПродукции).
&Вместо("СебестоимостьУзла")
Функция ikon_cost_СебестоимостьУзла(ПараметрыДерева, ПараметрыУзла, ВыводитьДопРасходы)
	
	Запрос = ЗапросВыпущеннаяПродукция(ПараметрыУзла, Истина);
	
	// Если ВыводитьДопРасходы, создаём ВТКоличествПоПарам через параметр и ПОМЕСТИТЬ
	Если ВыводитьДопРасходы Тогда
		Отборы = ПараметрыУзла.Отборы;
		
		// Создаем таблицу количеств для текущего узла (одна пара)
		КвалификаторыЧисла = Новый КвалификаторыЧисла(15, 3);
		ТаблицаКоличествПоПарам = Новый ТаблицаЗначений;
		ТаблицаКоличествПоПарам.Колонки.Добавить("ПартияУИД", Новый ОписаниеТипов("УникальныйИдентификатор"));
		ТаблицаКоличествПоПарам.Колонки.Добавить("АналитикаУИД", Новый ОписаниеТипов("УникальныйИдентификатор"));
		ТаблицаКоличествПоПарам.Колонки.Добавить("КоличествоПродукции", Новый ОписаниеТипов("Число", КвалификаторыЧисла));
		
		// Добавляем строку с текущей парой и количеством
		НоваяСтрока = ТаблицаКоличествПоПарам.Добавить();
		// Берем первую пару из отборов (в непакетном режиме обрабатывается одна пара)
		Если Отборы.ПартииПродукции.Количество() > 0 Тогда
			НоваяСтрока.ПартияУИД = Отборы.ПартииПродукции[0].УникальныйИдентификатор();
		КонецЕсли;
		Если Отборы.АналитикиУчетаПартийПродукции.Количество() > 0 Тогда
			НоваяСтрока.АналитикаУИД = Отборы.АналитикиУчетаПартийПродукции[0].УникальныйИдентификатор();
		КонецЕсли;
		НоваяСтрока.КоличествоПродукции = Отборы.КоличествоПродукции;
		
		// Устанавливаем параметр с таблицей количеств
		Запрос.УстановитьПараметр("ТаблицаКоличествПоПарам", ТаблицаКоличествПоПарам);
		
		// Добавляем создание ВТ перед основным запросом затрат
		ТекстВТКоличеств = 
		"ВЫБРАТЬ
		|	Таблица.ПартияУИД КАК ПартияУИД,
		|	Таблица.АналитикаУИД КАК АналитикаУИД,
		|	Таблица.КоличествоПродукции КАК КоличествоПродукции
		|ПОМЕСТИТЬ ВТКоличествПоПарам
		|ИЗ &ТаблицаКоличествПоПарам КАК Таблица;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|";
		
		Запрос.Текст = Запрос.Текст + ТекстВТКоличеств;
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст + ТекстЗапросаЗатратыНаПродукцию(ВыводитьДопРасходы);
	
	Результат = Запрос.Выполнить();
	ТаблицаРезультата = Результат.Выгрузить();
	
	Возврат ТаблицаРезультата;
	
КонецФункции

// Заполняет дерево себестоимости.
//
// Параметры:
//  ПараметрыДерева	- см. СтруктураСебестоимости.ПараметрыДереваСебестоимости
//  ПараметрыУзла - см. СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости
//
// Изменения относительно базового модуля СтруктураСебестоимости:
//  - Строка ПРОДУКЦИИ (уровень 0) добавляется в результат всегда, независимо от ДобавлятьПолуфабрикатыВРезультат,
//    т.к. при формировании результата через МенеджерВременныхТаблиц строка продукции нужна для корректного запроса отчёта.
&Вместо("ЗаполнитьДеревоСебестоимости")
Процедура ikon_cost_ЗаполнитьДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла)

	Запрос = ЗапросВыпущеннаяПродукция(ПараметрыУзла, Ложь);
	ВыпущеннаяПродукция = Запрос.Выполнить().Выгрузить();

	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		Результат = ПараметрыДерева.Результат.Строки;
	ИначеЕсли ПараметрыДерева.ТипРезультата = "ТаблицаЗначений" Тогда
		Результат = ПараметрыДерева.Результат;
	Иначе
		Результат = Новый ТаблицаЗначений;
		ИнициализироватьПоляДереваСебестоимости(Результат);
		ПоляТаблицы = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(Результат, "Идентификатор");
		СчетчикТаблиц = 0;
		ИменаТаблиц = "";
	КонецЕсли;

	// СтандартныеПодсистемы.ЗамерПроизводительности
	ПараметрыДерева.КоличествоСтрок = ПараметрыДерева.КоличествоСтрок + ВыпущеннаяПродукция.Количество();
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности

	Для Каждого ТекПартия Из ВыпущеннаяПродукция Цикл
		
		// КРИТИЧНО: Строка ПРОДУКЦИИ (уровень 0) всегда должна добавляться в результат!
		// ДобавлятьПолуфабрикатыВРезультат управляет только полуфабрикатами (уровни 1+)
		// Для МенеджерВременныхТаблиц строка продукции нужна для корректного формирования отчета
		Если Истина Тогда
			СтрокаПартия = Результат.Добавить(); // СтрокаДереваЗначений
			ЗаполнитьЗначенияСвойств(СтрокаПартия, ТекПартия);
			
			СтрокаПартия.Идентификатор	= Новый УникальныйИдентификатор();
			// Явно задаем уровень для строки продукции (уровень 0),
			// чтобы в пакетной обработке можно было безопасно выгружать "старые" уровни в МВТ.
			СтрокаПартия.Уровень = 0;
			СтрокаПартия.ВидСтроки		= Перечисления.ВидыСтрокДереваСебестоимости.ПартияПродукции;
			
			СтрокаПартия.АналитикаУчетаВыходноеИзделие			= ТекПартия.АналитикаУчетаПродукции;
			СтрокаПартия.АналитикаУчетаПартийВыходноеИзделие	= ТекПартия.АналитикаУчетаПартийПродукции;
			СтрокаПартия.ПартияВыходноеИзделие					= ТекПартия.ПартияПродукции;
			
			СтрокаПартия.Номенклатура			= ТекПартия.Продукция;
			СтрокаПартия.Характеристика			= ТекПартия.ХарактеристикаПродукции;
			СтрокаПартия.Серия					= ТекПартия.СерияПродукции;
			СтрокаПартия.Назначение				= ТекПартия.НазначениеПродукции;
			СтрокаПартия.Валюта					= ТекПартия.Валюта;
			СтрокаПартия.Партия					= ТекПартия.ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартий	= ТекПартия.АналитикаУчетаПартийПродукции;
			СтрокаПартия.ЕдиницаИзмерения		= ТекПартия.ЕдиницаИзмеренияПродукция;
			
			СтрокаПартия.Количество	= ТекПартия.КоличествоПродукция;
			СтрокаПартия.Сумма		= ТекПартия.СуммаПродукция;
			СтрокаПартия.СуммаЗабалансовая = ТекПартия.СуммаПродукцияЗабалансовая;
		КонецЕсли;
		
		Если ТекПартия.ТребуетсяРазузлование
			И ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			И ПараметрыДерева.ДинамическоеСчитывание
			И ТекПартия.КоличествоПродукция <> 0 Тогда

			СтрокаПартия.Строки.Добавить();

		ИначеЕсли ТекПартия.ТребуетсяРазузлование
			И ТекПартия.КоличествоПродукция <> 0 Тогда //проверка на отсторнированный выпуск в выбранном периоде
		// общий подход к заполнению отбора параметров узла и условиям разузлования должен совпадать с:
		// - РазузловатьУзелДереваСебестоимости();
		// - Отчет.ДеревоСебестоимости.МодульОбъекта.ПолноеДеревоСебестоимостиПередРазворачиваниемСервер(). 
		ПараметрыУзлаПартии = ikon_cost_ПараметрыУзлаСКэшем(ПараметрыДерева);

			Отборы = ПараметрыУзлаПартии.Отборы;
			Отборы.ДанныеПоСебестоимости = ПараметрыУзла.Отборы.ДанныеПоСебестоимости;
			Отборы.Продукция.Добавить(ТекПартия.Продукция);
			Отборы.ХарактеристикиПродукции.Добавить(ТекПартия.ХарактеристикаПродукции);
			Отборы.СерииПродукции.Добавить(ТекПартия.СерияПродукции);
			Отборы.НазначенияПродукции.Добавить(ТекПартия.НазначениеПродукции);
			Отборы.ПартииПродукции.Добавить(ТекПартия.ПартияПродукции);
			Отборы.АналитикиУчетаПартийПродукции.Добавить(ТекПартия.АналитикаУчетаПартийПродукции);
			// для знаменателя и количества продукции берем модуль значения, чтобы знак количества и сумм затрат определялся по числителю, который при выпуске будет > 0, а при сторно < 0
			Отборы.Числитель               = ТекПартия.Числитель;
			Отборы.Знаменатель             = Макс(-ТекПартия.Знаменатель, ТекПартия.Знаменатель);
			Отборы.КоличествоПродукции     = Макс(-ТекПартия.КоличествоПродукция,ТекПартия. КоличествоПродукция);
			Отборы.РазворачиватьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы;
			Отборы.ДатаИсходнойПартии = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ТекПартия.ПартияПродукции, "Дата");
			Отборы.ДатаОкончания           = ПараметрыУзла.Отборы.ДатаОкончания;

			ПараметрыУзлаПартии.Сумма = ТекПартия.СуммаПродукция;
			ПараметрыУзлаПартии.Материальные = ТекПартия.Материальные;
			ПараметрыУзлаПартии.ДопРасходы = ТекПартия.ДопРасходы;
			ПараметрыУзлаПартии.Трудозатраты = ТекПартия.Трудозатраты;
			ПараметрыУзлаПартии.ПостатейныеПеременные = ТекПартия.ПостатейныеПеременные;
			ПараметрыУзлаПартии.ПостатейныеПостоянные = ТекПартия.ПостатейныеПостоянные;
			ПараметрыУзлаПартии.НалоговыйУчет = ТекПартия.НалоговыйУчет;
			ПараметрыУзлаПартии.ПостояннаяРазница = ТекПартия.ПостояннаяРазница;
			ПараметрыУзлаПартии.ВременнаяРазница = ТекПартия.ВременнаяРазница;
			ПараметрыУзлаПартии.СуммаЗабалансовая = ТекПартия.СуммаПродукцияЗабалансовая;

			ОписаниеПродукции = Новый Структура("АналитикаУчетаПродукции, ПартияПродукции, АналитикаУчетаПартийПродукции");
			ЗаполнитьЗначенияСвойств(ОписаниеПродукции, ТекПартия);
			ОписаниеПродукции.Вставить("Уровень", 0);

			Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
				ТаблицаРезультата = СтрокаПартия;
			Иначе
				ТаблицаРезультата = Результат;
			КонецЕсли;

			// Выбор между пакетной обработкой и рекурсивной
			Если ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
				И ПараметрыДерева.ИспользоватьПакетнуюОбработку 
				И НЕ ПараметрыДерева.ДинамическоеСчитывание Тогда
				
				// Пакетная обработка: формируем узел для добавления в очередь
				Узел = Новый Структура;
				Узел.Вставить("ПараметрыУзла", ПараметрыУзлаПартии);
				Узел.Вставить("ТаблицаРезультата", ТаблицаРезультата);
				Узел.Вставить("ОписаниеПродукции", ОписаниеПродукции);
				Узел.Вставить("СтрокаПартия", СтрокаПартия);
				
				Если НЕ ПараметрыДерева.Свойство("УзлыДляПакетнойОбработки") Тогда
					ПараметрыДерева.Вставить("УзлыДляПакетнойОбработки", Новый Массив);
				КонецЕсли;
				
				ПараметрыДерева.УзлыДляПакетнойОбработки.Добавить(Узел);
			Иначе
				// Старая рекурсивная обработка (сохранена для обратной совместимости)
				РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзлаПартии, ТаблицаРезультата, ОписаниеПродукции);
			КонецЕсли;

		КонецЕсли;

		// ВАЖНО: При пакетной обработке НЕ сохраняем и НЕ очищаем Результат в цикле!
		// Узлы используют ссылку на эту таблицу, и она будет сохранена после пакетной обработки.
		ИспользуетсяПакетнаяОбработка = ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
			И ПараметрыДерева.ИспользоватьПакетнуюОбработку 
			И НЕ ПараметрыДерева.ДинамическоеСчитывание;
		
		Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" 
			И НЕ ИспользуетсяПакетнаяОбработка Тогда
			
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
				ПараметрыДерева.Результат,
				ИмяТекущейТаблицы,
				Результат,
				ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
			Результат.Очистить();
		КонецЕсли;

	КонецЦикла;

	// Обработка накопленных узлов для пакетной обработки (оптимизация N+1)
	// ВАЖНО: Обработка пакета ПО УРОВНЯМ с сохранением после каждого уровня!
	Если ПараметрыДерева.Свойство("УзлыДляПакетнойОбработки") 
		И ПараметрыДерева.УзлыДляПакетнойОбработки.Количество() > 0 Тогда
		
		УзлыТекущегоУровня = ПараметрыДерева.УзлыДляПакетнойОбработки;
		НомерУровня = 1;
		
		// Обрабатываем уровни по очереди (НЕ очищаем Результат - накапливаем в нём!)
		Пока УзлыТекущегоУровня.Количество() > 0 Цикл
			
			// === Предварительная выгрузка "старых" уровней (до обработки текущего уровня) ===
			// Критично для снижения пика памяти ВНУТРИ РазузловатьУзлыПакетом():
			// перед обработкой уровня N достаточно держать в памяти только строки уровня N-1 (родители),
			// а уровни <= N-2 можно уже выгрузить в МВТ и удалить из таблицы результата.
			Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц"
				И Результат.Количество() > 0
				И НомерУровня > 1 Тогда
				
				ПорогУровняДляВыгрузки = НомерУровня - 2;
				Если ПорогУровняДляВыгрузки >= 0 Тогда
					
					ТаблицаДляВыгрузки = Новый ТаблицаЗначений;
					ИнициализироватьПоляДереваСебестоимости(ТаблицаДляВыгрузки);
					
					Индекс = Результат.Количество() - 1;
					Пока Индекс >= 0 Цикл
						
						СтрокаРезультата = Результат[Индекс];
						УровеньСтроки = ?(ЗначениеЗаполнено(СтрокаРезультата.Уровень), СтрокаРезультата.Уровень, 0);
						
						Если УровеньСтроки <= ПорогУровняДляВыгрузки Тогда
							
							// ФИЛЬТРАЦИЯ: удаляем строки "Усреднение стоимости" и "Изменение стоимости при хранении"
							Если СтрокаРезультата.Номенклатура = "Усреднение стоимости в незавершенном производстве"
								ИЛИ СтрокаРезультата.Номенклатура = "Изменение стоимости при хранении" Тогда
								
								Результат.Удалить(Индекс);
								
							Иначе
								
								// КРИТИЧНО: Сброс флага ТребуетсяРазузлованиеДопРасходов перед сохранением
								Если СтрокаРезультата.ТребуетсяРазузлованиеДопРасходов = Истина Тогда
									СтрокаРезультата.ТребуетсяРазузлованиеДопРасходов = Ложь;
								КонецЕсли;
								
								НоваяСтрока = ТаблицаДляВыгрузки.Добавить();
								ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаРезультата);
								
								// Удаляем из исходной таблицы, освобождая память
								Результат.Удалить(Индекс);
								
							КонецЕсли;
							
						КонецЕсли;
						
						Индекс = Индекс - 1;
					КонецЦикла;
					
					// Сохраняем выгруженную порцию в МВТ
					Если ТаблицаДляВыгрузки.Количество() > 0 Тогда
						СчетчикТаблиц = СчетчикТаблиц + 1;
						ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
						
						РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
							ПараметрыДерева.Результат,
							ИмяТекущейТаблицы,
							ТаблицаДляВыгрузки,
							ПоляТаблицы);
						ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
			// === ДРОБЛЕНИЕ УРОВНЯ НА ПОДПАКЕТЫ (снижение пика памяти внутри уровня) ===
			// Если уровень содержит тысячи узлов, каждый из которых добавляет десятки строк в Результат,
			// то пик памяти будет огромным. Дробим узлы на порции по РазмерПодпакетаУзлов,
			// обрабатываем каждую порцию отдельно и выгружаем Результат в МВТ после каждой порции.
			РазмерПодпакета = 0;
			Если ПараметрыДерева.Свойство("РазмерПодпакетаУзлов", РазмерПодпакета) 
				И ЗначениеЗаполнено(РазмерПодпакета) 
				И РазмерПодпакета > 0 Тогда
				// Дробление включено
			Иначе
				// Дробление отключено - обрабатываем все узлы уровня за раз
				РазмерПодпакета = УзлыТекущегоУровня.Количество();
			КонецЕсли;
			
			УзлыСледующегоУровня = Новый Массив;
			НачалоПодпакета = 0;
			
			Пока НачалоПодпакета < УзлыТекущегоУровня.Количество() Цикл
				
				КонецПодпакета = Мин(НачалоПодпакета + РазмерПодпакета, УзлыТекущегоУровня.Количество());
				
				// Формируем подпакет узлов
				УзлыПодпакета = Новый Массив;
				Для Индекс = НачалоПодпакета По КонецПодпакета - 1 Цикл
					УзлыПодпакета.Добавить(УзлыТекущегоУровня[Индекс]);
				КонецЦикла;
				
				// Обрабатываем подпакет
				УзлыСледующегоУровняПодпакета = РазузловатьУзлыПакетом(ПараметрыДерева, УзлыПодпакета);
				
				// Добавляем узлы следующего уровня в общий массив
				Для Каждого Узел Из УзлыСледующегоУровняПодпакета Цикл
					УзлыСледующегоУровня.Добавить(Узел);
				КонецЦикла;
				
				// КРИТИЧНО: После каждого подпакета (кроме последнего) выгружаем строки "СТАРЫХ" уровней в МВТ
				// НО НЕ выгружаем строки текущего уровня (НомерУровня) - они могут понадобиться как РодительскаяСтрока
				// для узлов следующего уровня, которые мы только что добавили!
				// Выгружаем только строки уровней < НомерУровня-1 (т.е. ещё более старые).
				Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц"
					И Результат.Количество() > 0
					И КонецПодпакета < УзлыТекущегоУровня.Количество() // Не последний подпакет
					И НомерУровня > 1 Тогда
					
					ПорогУровняДляВыгрузки = НомерУровня - 2;
					
					ТаблицаДляВыгрузки = Новый ТаблицаЗначений;
					ИнициализироватьПоляДереваСебестоимости(ТаблицаДляВыгрузки);
					
					Индекс = Результат.Количество() - 1;
					Пока Индекс >= 0 Цикл
						
						СтрокаРезультата = Результат[Индекс];
						УровеньСтроки = ?(ЗначениеЗаполнено(СтрокаРезультата.Уровень), СтрокаРезультата.Уровень, 0);
						
						// Выгружаем только строки "очень старых" уровней (<= НомерУровня-2)
						// Строки уровня НомерУровня-1 и НомерУровня оставляем (они нужны как родители)
						Если УровеньСтроки <= ПорогУровняДляВыгрузки Тогда
							
							// ФИЛЬТРАЦИЯ: удаляем строки "Усреднение стоимости" и "Изменение стоимости при хранении"
							Если СтрокаРезультата.Номенклатура = "Усреднение стоимости в незавершенном производстве"
								ИЛИ СтрокаРезультата.Номенклатура = "Изменение стоимости при хранении" Тогда
								
								Результат.Удалить(Индекс);
								
							Иначе
								
								// КРИТИЧНО: Сброс флага ТребуетсяРазузлованиеДопРасходов перед сохранением
								Если СтрокаРезультата.ТребуетсяРазузлованиеДопРасходов = Истина Тогда
									СтрокаРезультата.ТребуетсяРазузлованиеДопРасходов = Ложь;
								КонецЕсли;
								
								НоваяСтрока = ТаблицаДляВыгрузки.Добавить();
								ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаРезультата);
								
								// Удаляем из исходной таблицы, освобождая память
								Результат.Удалить(Индекс);
								
							КонецЕсли;
							
						КонецЕсли;
						
						Индекс = Индекс - 1;
					КонецЦикла;
					
					// Сохраняем выгруженную порцию в МВТ
					Если ТаблицаДляВыгрузки.Количество() > 0 Тогда
						СчетчикТаблиц = СчетчикТаблиц + 1;
						ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
						
						РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
							ПараметрыДерева.Результат,
							ИмяТекущейТаблицы,
							ТаблицаДляВыгрузки,
							ПоляТаблицы);
						ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
					КонецЕсли;
					
				КонецЕсли;
				
				НачалоПодпакета = КонецПодпакета;
			КонецЦикла;
			
			// === Инкрементальная выгрузка "старых" уровней в МВТ (снижение пика памяти) ===
			// Узлы следующего уровня могут хранить ссылку РодительскаяСтрока на строки ТЕКУЩЕГО уровня,
			// поэтому нельзя очищать/заменять таблицу Результат целиком.
			// Однако строки уровней < НомерУровня уже не понадобятся как РодительскаяСтрока,
			// поэтому их можно выгрузить во временные таблицы и удалить из Результат.
			Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц"
				И Результат.Количество() > 0 Тогда
				
				ПорогУровняДляВыгрузки = НомерУровня - 1;
				Если ПорогУровняДляВыгрузки >= 0 Тогда
					
					ТаблицаДляВыгрузки = Новый ТаблицаЗначений;
					ИнициализироватьПоляДереваСебестоимости(ТаблицаДляВыгрузки);
					
					Индекс = Результат.Количество() - 1;
					Пока Индекс >= 0 Цикл
						
						СтрокаРезультата = Результат[Индекс];
						УровеньСтроки = ?(ЗначениеЗаполнено(СтрокаРезультата.Уровень), СтрокаРезультата.Уровень, 0);
						
						Если УровеньСтроки <= ПорогУровняДляВыгрузки Тогда
							
							// ФИЛЬТРАЦИЯ: удаляем строки "Усреднение стоимости" и "Изменение стоимости при хранении"
							Если СтрокаРезультата.Номенклатура = "Усреднение стоимости в незавершенном производстве"
								ИЛИ СтрокаРезультата.Номенклатура = "Изменение стоимости при хранении" Тогда
								
								Результат.Удалить(Индекс);
								
							Иначе
								
								// КРИТИЧНО: Сброс флага ТребуетсяРазузлованиеДопРасходов перед сохранением
								Если СтрокаРезультата.ТребуетсяРазузлованиеДопРасходов = Истина Тогда
									СтрокаРезультата.ТребуетсяРазузлованиеДопРасходов = Ложь;
								КонецЕсли;
								
								НоваяСтрока = ТаблицаДляВыгрузки.Добавить();
								ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаРезультата);
								
								// Удаляем из исходной таблицы, освобождая память
								Результат.Удалить(Индекс);
								
							КонецЕсли;
							
						КонецЕсли;
						
						Индекс = Индекс - 1;
					КонецЦикла;
					
					// Сохраняем выгруженную порцию в МВТ
					Если ТаблицаДляВыгрузки.Количество() > 0 Тогда
						СчетчикТаблиц = СчетчикТаблиц + 1;
						ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
						
						РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
							ПараметрыДерева.Результат,
							ИмяТекущейТаблицы,
							ТаблицаДляВыгрузки,
							ПоляТаблицы);
						ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
			// Переход к следующему уровню
			УзлыТекущегоУровня = УзлыСледующегоУровня;
			НомерУровня = НомерУровня + 1;
			
		КонецЦикла;
		
		// ФИЛЬТРАЦИЯ и СОХРАНЕНИЕ (один раз в конце!)
		Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" 
			И Результат.Количество() > 0 Тогда
			
			// ФИЛЬТРАЦИЯ: удаляем строки "Усреднение стоимости" и "Изменение стоимости при хранении"
			КоличествоДоФильтрации = Результат.Количество();
			Индекс = Результат.Количество() - 1;
			Пока Индекс >= 0 Цикл
				СтрокаРезультата = Результат[Индекс];
				Если СтрокаРезультата.Номенклатура = "Усреднение стоимости в незавершенном производстве"
					ИЛИ СтрокаРезультата.Номенклатура = "Изменение стоимости при хранении" Тогда
					Результат.Удалить(Индекс);
				КонецЕсли;
				Индекс = Индекс - 1;
			КонецЦикла;
			
			КоличествоУдаленных = КоличествоДоФильтрации - Результат.Количество();
		
		// КРИТИЧНО: Сброс флага ТребуетсяРазузлованиеДопРасходов перед сохранением
		// Если строка дошла до финального сохранения с установленным флагом разузлования,
		// значит разузлование доп.расходов не было выполнено в процессе обработки.
		// Чтобы не потерять суммы ДопРасходов в итоговом отчете (схема компоновки
		// зануляет ДопРасходы при ТребуетсяРазузлованиеДопРасходов=Истина), 
		// принудительно сбрасываем флаг для всех оставшихся строк.
		Для Каждого СтрокаРезультата Из Результат Цикл
			Если СтрокаРезультата.ТребуетсяРазузлованиеДопРасходов = Истина Тогда
				СтрокаРезультата.ТребуетсяРазузлованиеДопРасходов = Ложь;
			КонецЕсли;
		КонецЦикла;
		
		// Сохраняем одной таблицей
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
				ПараметрыДерева.Результат,
				ИмяТекущейТаблицы,
				Результат,
				ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
			
			// КРИТИЧНО: Очищаем таблицу после сохранения, чтобы избежать дублирования
			// Данные уже сохранены во временную таблицу, и не должны сохраняться повторно
			Результат.Очистить();
		КонецЕсли;
	КонецЕсли;
	
	// ПРИМЕЧАНИЕ: При пакетной обработке данные сохраняются ПОСЛЕ КАЖДОГО УРОВНЯ (выше в цикле)
	// Этот блок нужен только для старого рекурсивного алгоритма или если остались несохраненные данные
	Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" Тогда
		
		// Сохраняем оставшиеся данные (если есть)
		Если Результат.Количество() > 0 Тогда
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
				ПараметрыДерева.Результат,
				ИмяТекущейТаблицы,
				Результат,
				ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
		КонецЕсли;
		
			// Объединяем все временные таблицы в итоговую
		Если НЕ ПустаяСтрока(ИменаТаблиц) Тогда
			РасчетСебестоимостиПрикладныеАлгоритмы.ОбъединитьВременныеТаблицы(
			ПараметрыДерева.Результат,
			ИменаТаблиц,
			"Результат",
			ПоляТаблицы, "", , Истина);
		Иначе
			// Если вообще нет данных, создаем пустую временную таблицу
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = ПараметрыДерева.Результат;
			Запрос.Текст =
			"ВЫБРАТЬ
			|	*
			|ПОМЕСТИТЬ Результат
			|ИЗ
			|	&Результат КАК Результат";
			
			Результат.Колонки.Удалить("Идентификатор");
			Запрос.УстановитьПараметр("Результат", Результат);
			// Структуру ВТ Результат см. в СтруктураСебестоимости.СтруктураПолейДереваСебестоимости.
			Запрос.Выполнить();
		КонецЕсли;
	КонецЕсли;
	
	// ДИАГНОСТИКА: итоговый результат
	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		КоличествоСтрокИтого = ПараметрыДерева.Результат.Строки.Количество();
	ИначеЕсли ПараметрыДерева.ТипРезультата = "ТаблицаЗначений" Тогда
		КоличествоСтрокИтого = ПараметрыДерева.Результат.Количество();
	Иначе
		// Для МенеджерВременныхТаблиц выполняем запрос подсчета строк
		Попытка
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = ПараметрыДерева.Результат;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Партия) КАК КоличествоУровень0
			|ИЗ
			|	Результат
			|ГДЕ
			|	Уровень = 0";
			РезультатПодсчета = Запрос.Выполнить().Выгрузить();
			КоличествоСтрокИтого = РезультатПодсчета[0].КоличествоУровень0;
		Исключение
			// Если временная таблица не существует или произошла ошибка
			КоличествоСтрокИтого = 0;
		КонецПопытки;
	КонецЕсли;
	

КонецПроцедуры   

// Разузлование дерева себестоимости с пакетной обработкой по уровням (оптимизация N+1)
//
// Параметры:
//  ПараметрыДерева - см. СтруктураСебестоимости.ПараметрыДереваСебестоимости
//  УзлыДляОбработки - Массив из Структура - Массив узлов для обработки:
//    * ПараметрыУзла - Структура - Параметры узла
//    * ТаблицаРезультата - ДеревоЗначений, ТаблицаЗначений - Куда помещать результат
//    * ОписаниеПродукции - Структура - Описание продукции
//    * СтрокаПартия - СтрокаДереваЗначений - Ссылка на строку в дереве
//
// Возвращаемое значение:
//  Массив из Структура - узлы следующего уровня для последующей обработки (итерация по уровням, без рекурсии)
//
Функция РазузловатьУзлыПакетом(ПараметрыДерева, УзлыДляОбработки)
		
	Если УзлыДляОбработки.Количество() = 0 Тогда
		Возврат Новый Массив; // Возвращаем пустой массив, если нет узлов
	КонецЕсли;
	
	// Инициализация структур для отслеживания циклов
	ПройденныйПуть = Неопределено;
	Если НЕ ПараметрыДерева.Свойство("ПройденныйПуть", ПройденныйПуть) Тогда
		ПройденныйПуть = Новый ТаблицаЗначений;
		ПройденныйПуть.Колонки.Добавить("Партия");
		ПройденныйПуть.Колонки.Добавить("АналитикаУчетаПартий");
		ПройденныйПуть.Индексы.Добавить("Партия, АналитикаУчетаПартий");
		ПараметрыДерева.Вставить("ПройденныйПуть", ПройденныйПуть);
		// Инициализируем параметры защиты от циклов и глубокой рекурсии
		ПараметрыДерева.Вставить("МаксимальнаяГлубинаРекурсии", 50);
		ПараметрыДерева.Вставить("ОбнаруженныеЦиклы", Новый Массив);
	КонецЕсли;
	
	// Обрабатываем результаты для каждого узла
	УзлыСледующегоУровня = Новый Массив;
	
	// === ПОЛНАЯ ГРУППИРОВКА С ПОСТ-РАСПРЕДЕЛЕНИЕМ ===
	// Группируем ВСЕ узлы по парам (Партия, Аналитика), выполняем ОДИН запрос,
	// затем применяем индивидуальные пропорции (Числитель/Знаменатель) для каждого узла.
	// Запрос возвращает 100% себестоимости, пост-распределение применяет доли.
	
	// Проверка максимальной глубины
	УзлыДляОбработкиПослеПроверки = Новый Массив;
	Для Каждого Узел Из УзлыДляОбработки Цикл
		УровеньУзла = Узел.ОписаниеПродукции.Уровень + 1;
		Если УровеньУзла > ПараметрыДерева.МаксимальнаяГлубинаРекурсии Тогда
			Продолжить;
		КонецЕсли;
		УзлыДляОбработкиПослеПроверки.Добавить(Узел);
	КонецЦикла;
	
	Если УзлыДляОбработкиПослеПроверки.Количество() = 0 Тогда
		Возврат УзлыСледующегоУровня;
	КонецЕсли;
	
	// === ГРУППИРОВКА УЗЛОВ: ДВУХПРОХОДНЫЙ АЛГОРИТМ ===
	// ПРОХОД 1: Собираем суммы |Числителей| для каждой уникальной пары (Партия, Аналитика)
	// ПРОХОД 2: Группируем узлы с вычисленным Знаменателем = сумма |Числителей| для пары
	
	СоответствиеУзлов = Новый Соответствие;
	СуммыЧислителейПоПарам = Новый Соответствие; // КлючПары -> СУММА(|Числитель|)
	
	// ПРОХОД 1: Вычисляем суммы числителей для каждой уникальной пары (Партия, Аналитика)
	// ВАЖНО: Накапливаем ВСЕГДА, независимо от Знаменателя - нужно для пост-распределения
	Для Каждого Узел Из УзлыДляОбработкиПослеПроверки Цикл
		Отборы = Узел.ПараметрыУзла.Отборы;
		КлючУзла = СоздатьКлючУзла(Узел.ПараметрыУзла);
		СоответствиеУзлов.Вставить(КлючУзла, Узел);
		
		ЧислительУзла = Отборы.Числитель;
		
		// Накапливаем сумму |Числителей| для пары
		Для Инд = 0 По Отборы.ПартииПродукции.ВГраница() Цикл
			Партия = Отборы.ПартииПродукции[Инд];
			Аналитика = Неопределено;
			Если Инд <= Отборы.АналитикиУчетаПартийПродукции.ВГраница() Тогда
				Аналитика = Отборы.АналитикиУчетаПартийПродукции[Инд];
			КонецЕсли;
			
			// Используем единый формат ключа через СоздатьКлючПары
			КлючПары = СоздатьКлючПары(Партия, Аналитика);
			СуммаТекущая = СуммыЧислителейПоПарам.Получить(КлючПары);
			Если СуммаТекущая = Неопределено Тогда
				СуммаТекущая = 0;
			КонецЕсли;
			СуммыЧислителейПоПарам.Вставить(КлючПары, СуммаТекущая + Макс(-ЧислительУзла, ЧислительУзла));
		КонецЦикла;
	КонецЦикла;
	
	// ПРОХОД 2: Группируем узлы с вычисленным Знаменателем
	ГруппыПоПарам = Новый Соответствие;
	
	Для Каждого Узел Из УзлыДляОбработкиПослеПроверки Цикл
		Отборы = Узел.ПараметрыУзла.Отборы;
		КлючУзла = СоздатьКлючУзла(Узел.ПараметрыУзла);
		
		ЧислительУзла = Отборы.Числитель;
		ЗнаменательУзла = Отборы.Знаменатель;
		
		Для Инд = 0 По Отборы.ПартииПродукции.ВГраница() Цикл
			Партия = Отборы.ПартииПродукции[Инд];
			Аналитика = Неопределено;
			Если Инд <= Отборы.АналитикиУчетаПартийПродукции.ВГраница() Тогда
				Аналитика = Отборы.АналитикиУчетаПартийПродукции[Инд];
			КонецЕсли;
			
			// КРИТИЧНО: Сохраняем ОРИГИНАЛЬНЫЙ Знаменатель из параметров узла!
			// Не вычисляем его как сумму числителей - это для пост-распределения.
			// SQL применит пропорцию Числитель/Знаменатель (или авторасчёт при Знам=0).
			ЗнаменательДляГруппы = ЗнаменательУзла;
			
			// КЛЮЧ ВКЛЮЧАЕТ Числитель И оригинальный Знаменатель
			КлючПолный = СоздатьКлючПолный(Партия, Аналитика, ЧислительУзла, ЗнаменательДляГруппы);
			Группа = ГруппыПоПарам.Получить(КлючПолный);
			
			Если Группа = Неопределено Тогда
				Группа = Новый Структура;
				Группа.Вставить("Партия", Партия);
				Группа.Вставить("Аналитика", Аналитика);
				Группа.Вставить("Числитель", ЧислительУзла);
				Группа.Вставить("Знаменатель", ЗнаменательДляГруппы);
				Группа.Вставить("КлючиУзлов", Новый Массив);
				ГруппыПоПарам.Вставить(КлючПолный, Группа);
			КонецЕсли;
			
			// Добавляем только ключ узла
			Если Группа.КлючиУзлов.Найти(КлючУзла) = Неопределено Тогда
				Группа.КлючиУзлов.Добавить(КлючУзла);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// === ВЫПОЛНЕНИЕ ОДНОГО ЗАПРОСА ДЛЯ ВСЕХ УЗЛОВ УРОВНЯ ===
	ПервыйУзел = УзлыДляОбработкиПослеПроверки[0];
	УровеньПервогоУзла = ПервыйУзел.ОписаниеПродукции.Уровень + 1;
	ВыводитьДопРасходы = ПервыйУзел.ПараметрыУзла.Отборы.РазворачиватьДопРасходы И НЕ (УровеньПервогоУзла = 1);
	
	РезультатПоУзлам = СебестоимостьУзловПакетомГруппировка(
		УзлыДляОбработкиПослеПроверки, ГруппыПоПарам, СоответствиеУзлов, ВыводитьДопРасходы, ПараметрыДерева, СуммыЧислителейПоПарам);
	
	// === ОБРАБОТКА РЕЗУЛЬТАТОВ ===
	Для Каждого КлючИЗначение Из РезультатПоУзлам Цикл
		КлючУзла = КлючИЗначение.Ключ;
		СебестоимостьУзла = КлючИЗначение.Значение;
		Узел = СоответствиеУзлов.Получить(КлючУзла);
		Если Узел = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ПараметрыДерева.КоличествоСтрок = ПараметрыДерева.КоличествоСтрок + СебестоимостьУзла.Количество();
		ОбработатьРезультатыУзла(ПараметрыДерева, Узел, СебестоимостьУзла, ПройденныйПуть, УзлыСледующегоУровня);
	КонецЦикла;
	
	
	// НЕ вызываем рекурсивно! Возвращаем узлы следующего уровня для обработки в цикле
	Возврат УзлыСледующегоУровня;
	
КонецФункции

// Обрабатывает результаты запроса себестоимости для одного узла: добавляет строки в результат узла
// и формирует список узлов следующего уровня (для дальнейшей итерации по уровням).
//
// Параметры:
//  ПараметрыДерева - см. СтруктураСебестоимости.ПараметрыДереваСебестоимости
//  Узел - Структура - описание обрабатываемого узла (ПараметрыУзла, ТаблицаРезультата, ОписаниеПродукции, СтрокаПартия и др.)
//  СебестоимостьУзла - ТаблицаЗначений - строки себестоимости, полученные запросом для узла
//  ПройденныйПуть - ТаблицаЗначений - таблица для отслеживания циклов по (Партия, АналитикаУчетаПартий)
//  УзлыСледующегоУровня - Массив - выходной массив, в который добавляются сформированные узлы следующего уровня
//
Процедура ОбработатьРезультатыУзла(ПараметрыДерева, Узел, СебестоимостьУзла, ПройденныйПуть, УзлыСледующегоУровня)
	
	ПараметрыУзла = Узел.ПараметрыУзла;
	ТаблицаРезультата = Узел.ТаблицаРезультата;
	ОписаниеПродукции = Узел.ОписаниеПродукции;
	
	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		Результат = ТаблицаРезультата.Строки;
	Иначе
		Результат = ТаблицаРезультата;
	КонецЕсли;
	
	// ДИАГНОСТИКА
	КоличествоДо = Результат.Количество();
	
	АналитикаУчетаПродукции = ОписаниеПродукции.АналитикаУчетаПродукции;
	ПартияПродукции = ОписаниеПродукции.ПартияПродукции;
	АналитикаУчетаПартийПродукции = ОписаниеПродукции.АналитикаУчетаПартийПродукции;
	УровеньУзла = ОписаниеПродукции.Уровень + 1;
	
	ЭтоРазузлованиеДопРасходов = Ложь;
	
	Для Каждого ТекПартия Из СебестоимостьУзла Цикл
		
		ИмяЗатраты = Строка(ТекПартия.Затрата);
		
		// Проверка на циклическую зависимость
		МассивСтрок = Новый Массив;
		Если ТекПартия.ТребуетсяРазузлование И ТекПартия.КоличествоЗатрата <> 0 Тогда
			ПараметрыОтбора = Новый Структура("Партия, АналитикаУчетаПартий",
				ТекПартия.ПартияЗатрата,
				ТекПартия.АналитикаУчетаПартийЗатрата);
			МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
			
		КонецЕсли;
		
		// Добавляем строку в результат
		УсловиеДобавления = ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			ИЛИ ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат
			ИЛИ Не ТекПартия.ТребуетсяРазузлование;
		
		Если УсловиеДобавления Тогда			
			СтрокаПартия = Результат.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаПартия, ТекПартия);
			
			СтрокаПартия.Идентификатор = Новый УникальныйИдентификатор();
			Если ТекПартия.ТребуетсяРазузлование
				И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
				И (ТекПартия.СуммаЗатрата <> 0 ИЛИ ТекПартия.СуммаЗатратаЗабалансовая <> 0)
				И МассивСтрок.Количество() = 0 Тогда
				
				СтрокаПартия.ВидСтроки = Перечисления.ВидыСтрокДереваСебестоимости.ПартияПолуфабриката;
				СтрокаПартия.Числитель = ТекПартия.КоличествоЗатрата;
			Иначе
				СтрокаПартия.ВидСтроки = Перечисления.ВидыСтрокДереваСебестоимости.ПартияЗатраты;
				// КРИТИЧНО: Обязательно устанавливаем ТребуетсяРазузлование = Ложь для материалов!
				// Отчёт игнорирует ДопРасходы если ТребуетсяРазузлование = Истина:
				// СУММА(ВЫБОР КОГДА Результат.ТребуетсяРазузлование... ТОГДА 0 ИНАЧЕ Результат.ДопРасходы)
				СтрокаПартия.ТребуетсяРазузлование = Ложь;
				// КРИТИЧНО: Сбрасываем ТребуетсяРазузлованиеДопРасходов ТОЛЬКО если дочерний узел НЕ будет создан!
				// Отчёт проверяет ОБА условия: ТребуетсяРазузлование ИЛИ ТребуетсяРазузлованиеДопРасходов
				// Условие создания дочернего узла: ТребуетсяРазузлованиеДопРасходов И КоличествоЗатрата <> 0 И ДопРасходы <> 0
				// Если условие ЛОЖНО, дочерний узел не создастся и можно сбросить флаг
				Если НЕ (ТекПартия.ТребуетсяРазузлованиеДопРасходов
					И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
					И ТекПартия.ДопРасходы <> 0) Тогда
					СтрокаПартия.ТребуетсяРазузлованиеДопРасходов = Ложь;
				КонецЕсли;
			КонецЕсли;
			
			// КРИТИЧНО: Заполняем поля партии продукции из ОписаниеПродукции (корневая продукция)!
			// ПартияПродукции - это партия КОРНЕВОЙ продукции, которая передаётся неизменной
			// через все уровни рекурсии. Это нужно для правильного соединения в отчёте:
			// ВТПродукция.ПартияПродукции = Затраты.ПартияПродукции
			// А поле ПартияВыходноеИзделие (партия непосредственного родителя-полуфабриката)
			// копируется через ЗаполнитьЗначенияСвойств выше!
			СтрокаПартия.ПартияПродукции = ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартийПродукции = АналитикаУчетаПартийПродукции;
			СтрокаПартия.АналитикаУчетаПродукции = АналитикаУчетаПродукции;
			
		// КРИТИЧНО: Заполняем аналитику выходного изделия из ОписаниеПродукции!
		// В СТАРОМ алгоритме (строки 585, 617): 
		//   НоваяСтрока.ПартияВыходноеИзделие = ОписаниеПродукции.ПартияПродукции;
		// ПартияВыходноеИзделие должна быть = партия КОРНЕВОЙ продукции, а не промежуточного полуфабриката!
		// Это нужно для правильного join в отчёте:
		//   ВТПродукция.ПартияПродукции = Затраты.ПартияПолуфабриката (= Результат.ПартияВыходноеИзделие)
		// ЗаполнитьЗначенияСвойств копирует из запроса партию промежуточного полуфабриката,
		// но нужна партия КОРНЕВОЙ продукции из ОписаниеПродукции!
			СтрокаПартия.ПартияВыходноеИзделие = ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартийВыходноеИзделие = АналитикаУчетаПартийПродукции;
			СтрокаПартия.АналитикаУчетаВыходноеИзделие = АналитикаУчетаПродукции;
			
			СтрокаПартия.Номенклатура = ТекПартия.Затрата;
			СтрокаПартия.Характеристика = ТекПартия.ХарактеристикаЗатрата;
			СтрокаПартия.Серия = ТекПартия.СерияЗатрата;
			СтрокаПартия.Назначение = ТекПартия.НазначениеЗатрата;
			СтрокаПартия.Партия = ТекПартия.ПартияЗатрата;
			СтрокаПартия.АналитикаУчетаПартий = ТекПартия.АналитикаУчетаПартийЗатрата;
			СтрокаПартия.ЕдиницаИзмерения = ТекПартия.ЕдиницаИзмеренияЗатрата;
			СтрокаПартия.Уровень = УровеньУзла;
			
			СтрокаПартия.Количество = ТекПартия.КоличествоЗатрата;
			СтрокаПартия.Сумма = Окр(ТекПартия.СуммаЗатрата, 2);
			СтрокаПартия.ДопРасходы = Окр(СтрокаПартия.ДопРасходы, 2);
			СтрокаПартия.НалоговыйУчет = Окр(СтрокаПартия.НалоговыйУчет, 2);
			СтрокаПартия.СуммаЗабалансовая = ТекПартия.СуммаЗатратаЗабалансовая;
			
			// Уменьшаем суммовые показатели в узле
			Если ПараметрыУзла.Сумма <> 0 ИЛИ ПараметрыУзла.СуммаЗабалансовая <> 0 Тогда
				ПараметрыУзла.Сумма = ПараметрыУзла.Сумма - СтрокаПартия.Сумма;
				ПараметрыУзла.Материальные = ПараметрыУзла.Материальные - СтрокаПартия.Материальные;
				ПараметрыУзла.ДопРасходы = ПараметрыУзла.ДопРасходы - СтрокаПартия.ДопРасходы;
				ПараметрыУзла.Трудозатраты = ПараметрыУзла.Трудозатраты - СтрокаПартия.Трудозатраты;
				ПараметрыУзла.ПостатейныеПеременные = ПараметрыУзла.ПостатейныеПеременные - СтрокаПартия.ПостатейныеПеременные;
				ПараметрыУзла.ПостатейныеПостоянные = ПараметрыУзла.ПостатейныеПостоянные - СтрокаПартия.ПостатейныеПостоянные;
				ПараметрыУзла.НалоговыйУчет = ПараметрыУзла.НалоговыйУчет - СтрокаПартия.НалоговыйУчет;
				ПараметрыУзла.ПостояннаяРазница = ПараметрыУзла.ПостояннаяРазница - СтрокаПартия.ПостояннаяРазница;
				ПараметрыУзла.ВременнаяРазница = ПараметрыУзла.ВременнаяРазница - СтрокаПартия.ВременнаяРазница;
				ПараметрыУзла.СуммаЗабалансовая = ПараметрыУзла.СуммаЗабалансовая - СтрокаПартия.СуммаЗабалансовая;
				
				ЭтоРазузлованиеДопРасходов = (ТекПартия.ТипЗатрат = "ДопРасходы");
			КонецЕсли;
		КонецЕсли;
		
		// Подготовка узла для следующего уровня
		Если (ТекПартия.ТребуетсяРазузлование
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И (ТекПартия.СуммаЗатрата <> 0 ИЛИ ТекПартия.СуммаЗатратаЗабалансовая <> 0)
			И МассивСтрок.Количество() = 0)
			ИЛИ (ТекПартия.ТребуетсяРазузлованиеДопРасходов
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И ТекПартия.ДопРасходы <> 0) Тогда
		
		ПараметрыУзлаПартии = ikon_cost_ПараметрыУзлаСКэшем(ПараметрыДерева);
		
		// Добавляем партию в пройденный путь (НЕ для дополнительных расходов)
			Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
				НовыйПуть = ПройденныйПуть.Добавить();
				НовыйПуть.Партия = ТекПартия.ПартияЗатрата;
				НовыйПуть.АналитикаУчетаПартий = ТекПартия.АналитикаУчетаПартийЗатрата;
			КонецЕсли;
			
			Отборы = ПараметрыУзлаПартии.Отборы;
			Отборы.ДанныеПоСебестоимости = ПараметрыУзла.Отборы.ДанныеПоСебестоимости;
			Отборы.Продукция.Добавить(ТекПартия.Затрата);
			Отборы.ХарактеристикиПродукции.Добавить(ТекПартия.ХарактеристикаЗатрата);
			Отборы.СерииПродукции.Добавить(ТекПартия.СерияЗатрата);
			Отборы.ПартииПродукции.Добавить(ТекПартия.ПартияЗатрата);
			Отборы.АналитикиУчетаПартийПродукции.Добавить(ТекПартия.АналитикаУчетаПартийЗатрата);
			Отборы.АналитикаУчетаЗатрата.Добавить(ТекПартия.АналитикаУчетаЗатрата);
			Отборы.Числитель = ТекПартия.КоличествоЗатрата;
			Отборы.КоличествоПродукции = Макс(-ТекПартия.КоличествоЗатрата, ТекПартия.КоличествоЗатрата);
			Отборы.РазворачиватьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы;
			Отборы.ДатаИсходнойПартии = ПараметрыУзла.Отборы.ДатаИсходнойПартии;
			Отборы.ДатаОкончания = ПараметрыУзла.Отборы.ДатаОкончания;
			Отборы.ВключитьНДСВСтоимость = ТекПартия.ВключитьНДСВСтоимость;
			Отборы.ИсключитьНДСИзСтоимости = ТекПартия.ИсключитьНДСИзСтоимости;
			Отборы.АналитикаУчетаВыходноеИзделие = ТекПартия.АналитикаУчетаЗатрата;
			Отборы.СтатьяКалькуляции = ТекПартия.СтатьяКалькуляции;
			
		Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
			ТаблицаРезультатаПартии = СтрокаПартия;
		Иначе
			ТаблицаРезультатаПартии = Результат;
		КонецЕсли;
		
		// КРИТИЧНО: Заполняем ПараметрыУзлаПартии из ТекПартия (а не СтрокаПартия),
		// т.к. СтрокаПартия может быть не создана, если ДобавлятьПолуфабрикатыВРезультат = Ложь
		// Также в старом алгоритме это делается только для обычных партий (НЕ для дополнительных расходов)
		Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
			ПараметрыУзлаПартии.Сумма = ТекПартия.СуммаЗатрата;
			ПараметрыУзлаПартии.Материальные = ТекПартия.Материальные;
			ПараметрыУзлаПартии.ДопРасходы = ТекПартия.ДопРасходы;
			ПараметрыУзлаПартии.Трудозатраты = ТекПартия.Трудозатраты;
			ПараметрыУзлаПартии.ПостатейныеПеременные = ТекПартия.ПостатейныеПеременные;
			ПараметрыУзлаПартии.ПостатейныеПостоянные = ТекПартия.ПостатейныеПостоянные;
			ПараметрыУзлаПартии.НалоговыйУчет = ТекПартия.НалоговыйУчет;
			ПараметрыУзлаПартии.ПостояннаяРазница = ТекПартия.ПостояннаяРазница;
			ПараметрыУзлаПартии.ВременнаяРазница = ТекПартия.ВременнаяРазница;
			ПараметрыУзлаПартии.СуммаЗабалансовая = ТекПартия.СуммаЗатратаЗабалансовая;
		КонецЕсли;
			
		// КРИТИЧНО: Передаём данные КОРНЕВОЙ продукции, как в старом алгоритме!
		// В старом алгоритме ОписаниеПродукции передаётся НЕИЗМЕННЫМ через все уровни рекурсии.
		// Только поле Уровень обновляется для каждого нового уровня.
		// Это нужно для правильного соединения в отчёте:
		// ВТПродукция.ПартияПродукции = Затраты.ПартияПродукции
		НовоеОписаниеПродукции = Новый Структура("АналитикаУчетаПродукции, ПартияПродукции, АналитикаУчетаПартийПродукции");
		НовоеОписаниеПродукции.АналитикаУчетаПродукции = АналитикаУчетаПродукции;
		НовоеОписаниеПродукции.ПартияПродукции = ПартияПродукции;
		НовоеОписаниеПродукции.АналитикаУчетаПартийПродукции = АналитикаУчетаПартийПродукции;
		НовоеОписаниеПродукции.Вставить("Уровень", УровеньУзла);
		
		// Определяем СтрокаПартия: она существует только если УсловиеДобавления было Истина
		// В противном случае (полуфабрикат с ДобавлятьПолуфабрикатыВРезультат = Ложь)
		// передаем Неопределено
		СтрокаДляУзла = Неопределено;
		Если УсловиеДобавления Тогда
			СтрокаДляУзла = СтрокаПартия;
		КонецЕсли;
		
		НовыйУзел = Новый Структура;
		НовыйУзел.Вставить("ПараметрыУзла", ПараметрыУзлаПартии);
		НовыйУзел.Вставить("ТаблицаРезультата", ТаблицаРезультатаПартии);
		НовыйУзел.Вставить("ОписаниеПродукции", НовоеОписаниеПродукции);
		НовыйУзел.Вставить("СтрокаПартия", СтрокаДляУзла);
		
		// КРИТИЧНО: Флаг для сброса ТребуетсяРазузлованиеДопРасходов после обработки
		// Если это узел для разузлования доп расходов и он не добавит строк,
		// нужно сбросить ТребуетсяРазузлованиеДопРасходов в родительской строке
		// (как в старом алгоритме, строки 533-538)
		ЭтоУзелДляДопРасходов = ТекПартия.ТребуетсяРазузлованиеДопРасходов
			И НЕ ТекПартия.ТребуетсяРазузлование;
		НовыйУзел.Вставить("ЭтоУзелДляДопРасходов", ЭтоУзелДляДопРасходов);
		НовыйУзел.Вставить("РодительскаяСтрока", СтрокаДляУзла);
		
		УзлыСледующегоУровня.Добавить(НовыйУзел);
		КонецЕсли;
		
	КонецЦикла;
	
	// ДИАГНОСТИКА
	КоличествоПосле = Результат.Количество();
	
	// КРИТИЧНО: Сброс ТребуетсяРазузлованиеДопРасходов в родительской строке
	// Аналог старого алгоритма (строки 533-538):
	// Если разузлование доп расходов не выполнено (не добавлено строк), снимем признак
	Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц"
		И Узел.Свойство("ЭтоУзелДляДопРасходов")
		И Узел.ЭтоУзелДляДопРасходов
		И КоличествоПосле = КоличествоДо
		И Узел.Свойство("РодительскаяСтрока")
		И Узел.РодительскаяСтрока <> Неопределено Тогда
		Узел.РодительскаяСтрока.ТребуетсяРазузлованиеДопРасходов = Ложь;
	КонецЕсли;
		
	// При наличии данных о разузловании добавим строку на суммы изменения стоимости
	Если СебестоимостьУзла.Количество() > 0 И НЕ ЭтоРазузлованиеДопРасходов Тогда
		УчестьИзменениеСтоимости(ПараметрыУзла, ОписаниеПродукции, Результат);
	КонецЕсли;
	
КонецПроцедуры   


// Создает уникальный ключ узла на основании параметров узла (в первую очередь списка пар:
// ПартииПродукции и АналитикиУчетаПартийПродукции).
//
// Параметры:
//  ПараметрыУзла - Структура - параметры узла дерева себестоимости (содержит Отборы)
//
// Возвращаемое значение:
//  Строка - ключ узла (используется как ключ соответствий при пакетной обработке)
//
Функция СоздатьКлючУзла(ПараметрыУзла)
	
	Отборы = ПараметрыУзла.Отборы;
	
	КлючПартии = "";
	Для Каждого Партия Из Отборы.ПартииПродукции Цикл
		КлючПартии = КлючПартии + Строка(Партия.УникальныйИдентификатор()) + ";";
	КонецЦикла;
	
	КлючАналитики = "";
	Для Каждого Аналитика Из Отборы.АналитикиУчетаПартийПродукции Цикл
		КлючАналитики = КлючАналитики + Строка(Аналитика.УникальныйИдентификатор()) + ";";
	КонецЦикла;
	
	Возврат КлючПартии + "|" + КлючАналитики;
	
КонецФункции

// Создает уникальный ключ для пары (Партия, Аналитика).
//
// Параметры:
//  Партия - Ссылка - партия (может быть Неопределено)
//  Аналитика - Ссылка - аналитика учета партий (может быть Неопределено)
//
// Возвращаемое значение:
//  Строка - ключ пары в формате "<УИДПартии>|<УИДАналитики>", используется для группировки/распределения в пакетном запросе
//
Функция СоздатьКлючПары(Партия, Аналитика)
	
	КлючПартии = "";
	Если Партия <> Неопределено Тогда
		КлючПартии = Строка(Партия.УникальныйИдентификатор());
	КонецЕсли;
	
	КлючАналитики = "";
	Если Аналитика <> Неопределено Тогда
		КлючАналитики = Строка(Аналитика.УникальныйИдентификатор());
	КонецЕсли;
	
	Возврат КлючПартии + "|" + КлючАналитики;
	
КонецФункции

// Создаёт уникальный ключ для полной комбинации (Партия, Аналитика, Числитель, Знаменатель)
// Используется для группировки узлов с абсолютно одинаковыми параметрами запроса
//
// Параметры:
//  Партия - СправочникСсылка.ПартииПроизводства - Партия продукции
//  Аналитика - СправочникСсылка.КлючиАналитикиУчетаПартий - Аналитика учёта партий
//  Числитель - Число - Числитель пропорции
//  Знаменатель - Число - Знаменатель пропорции
//
// Возвращаемое значение:
//  Строка - Уникальный ключ
//
Функция СоздатьКлючПолный(Партия, Аналитика, Числитель, Знаменатель)
	
	// Используем базовый ключ пары + добавляем коэффициенты
	КлючПары = СоздатьКлючПары(Партия, Аналитика);
	Возврат КлючПары + "|" + Формат(Числитель, "ЧДЦ=6; ЧРД=.; ЧН=0") + "|" + Формат(Знаменатель, "ЧДЦ=6; ЧРД=.; ЧН=0");
	
КонецФункции
// Пакетное получение себестоимости с группировкой узлов и пост-распределением
// Решает проблему декартова произведения при одинаковых парах (Партия, Аналитика)
// 
// Алгоритм:
// 1. Группируем узлы: СУММА(Числитель), МАКСИМУМ(Знаменатель) по ключу (Партия, Аналитика)
// 2. Выполняем один запрос для всех уникальных пар с групповыми коэффициентами
// 3. Пост-распределяем: РезультатУзла = РезультатГруппы × (ЧислительУзла / СуммаЧислителейГруппы)
//
// Параметры:
//  УзлыДляОбработки - Массив - Все узлы текущего уровня
//  ГруппыПоПарам - Соответствие - КлючПары -> {УзлыГруппы, СуммаЧислителей, Знаменатель}
//  СоответствиеУзлов - Соответствие - КлючУзла -> Узел
//  ВыводитьДопРасходы - Булево - Флаг вывода доп. расходов
//  ОбщиеПараметры - Структура - Общие параметры дерева
//  СуммыЧислителейПоПарам - Соответствие - КлючПары -> Сумма(|Числитель|) (используется для пост-распределения)
//
// Возвращаемое значение:
//  Соответствие - КлючУзла -> ТаблицаЗначений с распределёнными данными себестоимости
//
Функция СебестоимостьУзловПакетомГруппировка(УзлыДляОбработки, ГруппыПоПарам, СоответствиеУзлов, ВыводитьДопРасходы, ОбщиеПараметры, СуммыЧислителейПоПарам)
	
	Если УзлыДляОбработки.Количество() = 0 Тогда
		Возврат Новый Соответствие;
	КонецЕсли;
	
	// 1. Собираем типы партий и аналитик из всех узлов
	ПервыйУзел = УзлыДляОбработки[0];
	
	ТипыПартий = Новый Массив;
	ТипыАналитик = Новый Массив;
	
	Для Каждого Узел Из УзлыДляОбработки Цикл
		Отборы = Узел.ПараметрыУзла.Отборы;
		Для Каждого Партия Из Отборы.ПартииПродукции Цикл
			Если Партия <> Неопределено Тогда
				ТипПартии = ТипЗнч(Партия);
				Если ТипыПартий.Найти(ТипПартии) = Неопределено Тогда
					ТипыПартий.Добавить(ТипПартии);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		Для Каждого Аналитика Из Отборы.АналитикиУчетаПартийПродукции Цикл
			Если Аналитика <> Неопределено Тогда
				ТипАналитики = ТипЗнч(Аналитика);
				Если ТипыАналитик.Найти(ТипАналитики) = Неопределено Тогда
					ТипыАналитик.Добавить(ТипАналитики);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// 2. Создаём ВТ УНИКАЛЬНЫХ пар (без дубликатов) с Числитель = Знаменатель = 1
	// Это обеспечит, что SQL вернёт 100% себестоимости, а коэффициенты применятся в пост-обработке
	ТаблицаГруппПар = Новый ТаблицаЗначений;
	ТаблицаГруппПар.Колонки.Добавить("ПартияПродукции", Новый ОписаниеТипов(ТипыПартий));
	ТаблицаГруппПар.Колонки.Добавить("АналитикаУчетаПартийПродукции", Новый ОписаниеТипов(ТипыАналитик));
	КвалификаторыЧисла = Новый КвалификаторыЧисла(31, 10);
	ТаблицаГруппПар.Колонки.Добавить("Числитель", Новый ОписаниеТипов("Число", КвалификаторыЧисла));
	ТаблицаГруппПар.Колонки.Добавить("Знаменатель", Новый ОписаниеТипов("Число", КвалификаторыЧисла));
	
	// НОВЫЙ ПОДХОД: Знаменатель=0 (авторасчёт), Числитель=сумма всех групп
	// 1. Собираем суммы Числителей по парам
	СуммыЧислителейПоПарам = Новый Соответствие;
	Для Каждого КлючИЗначение Из ГруппыПоПарам Цикл
		Группа = КлючИЗначение.Значение;
		КлючПары = СоздатьКлючПары(Группа.Партия, Группа.Аналитика);
		ТекущаяСумма = СуммыЧислителейПоПарам.Получить(КлючПары);
		Если ТекущаяСумма = Неопределено Тогда
			ТекущаяСумма = 0;
		КонецЕсли;
		СуммыЧислителейПоПарам.Вставить(КлючПары, ТекущаяСумма + Макс(Группа.Числитель, -Группа.Числитель));
	КонецЦикла;
	
	// 2. Собираем количества продукции для каждой пары (Партия, Аналитика) из ГруппыПоПарам
	// Для каждой группы собираем количества продукции из всех узлов этой группы
	КоличестваПоПарам = Новый Соответствие;
	Для Каждого КлючИЗначение Из ГруппыПоПарам Цикл
		Группа = КлючИЗначение.Значение;
		КлючПары = СоздатьКлючПары(Группа.Партия, Группа.Аналитика);
		
		// Собираем количества продукции из всех узлов этой группы
		СуммаКоличеств = 0;
		Для Каждого КлючУзла Из Группа.КлючиУзлов Цикл
			Узел = СоответствиеУзлов.Получить(КлючУзла);
			Если Узел <> Неопределено Тогда
				Отборы = Узел.ПараметрыУзла.Отборы;
				КоличествоПродукцииУзла = 0;
				Если Отборы.Свойство("КоличествоПродукции") Тогда
					КоличествоПродукцииУзла = Отборы.КоличествоПродукции;
				КонецЕсли;
				СуммаКоличеств = СуммаКоличеств + Макс(-КоличествоПродукцииУзла, КоличествоПродукцииУзла);
			КонецЕсли;
		КонецЦикла;
		
		КоличестваПоПарам.Вставить(КлючПары, СуммаКоличеств);
	КонецЦикла;
	
	// 2. Формируем уникальные пары с суммой Числителей и Знаменатель=0
	УникальныеПары = Новый Соответствие;
	Для Каждого КлючИЗначение Из ГруппыПоПарам Цикл
		Группа = КлючИЗначение.Значение;
		КлючПары = СоздатьКлючПары(Группа.Партия, Группа.Аналитика);
		Если УникальныеПары.Получить(КлючПары) = Неопределено Тогда
			УникальныеПары.Вставить(КлючПары, Группа);
			НоваяСтрока = ТаблицаГруппПар.Добавить();
			НоваяСтрока.ПартияПродукции = Группа.Партия;
			НоваяСтрока.АналитикаУчетаПартийПродукции = Группа.Аналитика;
			// Числитель = сумма всех групп с этой парой, Знаменатель = 0 (авторасчёт)
			НоваяСтрока.Числитель = СуммыЧислителейПоПарам.Получить(КлючПары);
			НоваяСтрока.Знаменатель = 0;
		КонецЕсли;
	КонецЦикла;
	
	// 2.1. Создаём временную таблицу с количествами продукции по парам
	ТаблицаКоличествПоПарам = Новый ТаблицаЗначений;
	ТаблицаКоличествПоПарам.Колонки.Добавить("ПартияУИД", Новый ОписаниеТипов("УникальныйИдентификатор"));
	ТаблицаКоличествПоПарам.Колонки.Добавить("АналитикаУИД", Новый ОписаниеТипов("УникальныйИдентификатор"));
	ТаблицаКоличествПоПарам.Колонки.Добавить("КоличествоПродукции", Новый ОписаниеТипов("Число", КвалификаторыЧисла));
	
	Для Каждого СтрокаГруппы Из ТаблицаГруппПар Цикл
		КлючПары = СоздатьКлючПары(СтрокаГруппы.ПартияПродукции, СтрокаГруппы.АналитикаУчетаПартийПродукции);
		Количество = КоличестваПоПарам.Получить(КлючПары);
		Если Количество = Неопределено Тогда
			Количество = 0;
		КонецЕсли;
		
		НоваяСтрокаКоличества = ТаблицаКоличествПоПарам.Добавить();
		НоваяСтрокаКоличества.ПартияУИД = СтрокаГруппы.ПартияПродукции.УникальныйИдентификатор();
		НоваяСтрокаКоличества.АналитикаУИД = СтрокаГруппы.АналитикаУчетаПартийПродукции.УникальныйИдентификатор();
		НоваяСтрокаКоличества.КоличествоПродукции = Количество;
	КонецЦикла;
	
	// 3. Собираем объединённые параметры для запроса
	ВсеПродукция = Новый Массив;
	ВсеХарактеристики = Новый Массив;
	ВсеСерии = Новый Массив;
	ВсеНазначения = Новый Массив;
	
	Для Каждого Узел Из УзлыДляОбработки Цикл
		Отборы = Узел.ПараметрыУзла.Отборы;
		Для Каждого Продукция Из Отборы.Продукция Цикл
			Если ВсеПродукция.Найти(Продукция) = Неопределено Тогда
				ВсеПродукция.Добавить(Продукция);
			КонецЕсли;
		КонецЦикла;
		Для Каждого Характеристика Из Отборы.ХарактеристикиПродукции Цикл
			Если ВсеХарактеристики.Найти(Характеристика) = Неопределено Тогда
				ВсеХарактеристики.Добавить(Характеристика);
			КонецЕсли;
		КонецЦикла;
		Для Каждого Серия Из Отборы.СерииПродукции Цикл
			Если ВсеСерии.Найти(Серия) = Неопределено Тогда
				ВсеСерии.Добавить(Серия);
			КонецЕсли;
		КонецЦикла;
		Для Каждого Назначение Из Отборы.НазначенияПродукции Цикл
			Если ВсеНазначения.Найти(Назначение) = Неопределено Тогда
				ВсеНазначения.Добавить(Назначение);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// 4. Создаём объединённые параметры узла
	ПараметрыУзлаОбъединенные = ikon_cost_ПараметрыУзлаСКэшем(ОбщиеПараметры);
	ОтборыОбъединенные = ПараметрыУзлаОбъединенные.Отборы;
	
	ПервыеОтборы = ПервыйУзел.ПараметрыУзла.Отборы;
	ОтборыОбъединенные.ДанныеПоСебестоимости = ПервыеОтборы.ДанныеПоСебестоимости;
	ОтборыОбъединенные.РазворачиватьДопРасходы = ПервыеОтборы.РазворачиватьДопРасходы;
	ОтборыОбъединенные.ДатаОкончания = ПервыеОтборы.ДатаОкончания;
	ОтборыОбъединенные.ДатаИсходнойПартии = ПервыеОтборы.ДатаИсходнойПартии;
	ОтборыОбъединенные.Продукция = ВсеПродукция;
	ОтборыОбъединенные.ХарактеристикиПродукции = ВсеХарактеристики;
	ОтборыОбъединенные.СерииПродукции = ВсеСерии;
	ОтборыОбъединенные.НазначенияПродукции = ВсеНазначения;
	ОтборыОбъединенные.ПартииПродукции = Новый Массив;
	ОтборыОбъединенные.АналитикиУчетаПартийПродукции = Новый Массив;
	ОтборыОбъединенные.Вставить("ПоВсемПартиям", Истина);
	ОтборыОбъединенные.Вставить("ПоВсемАналитикамПартий", Истина);
	
	// КРИТИЧНО: Для доп.расходов используем реальные количества продукции!
	// Передаём таблицу количеств в SQL запрос через временную таблицу
	// Если ВыводитьДопРасходы, то устанавливаем КоличествоПродукции = 1 (базовая сумма),
	// а реальные количества будут использоваться через JOIN с ВТКоличествПоПарам
	ОтборыОбъединенные.КоличествоПродукции = 1;
	
	// КРИТИЧНО: НЕ устанавливаем Числитель и Знаменатель в параметрах!
	// Запрос ЗапросВыпущеннаяПродукцияГруппировка использует значения из ВТПарыУзлов
	// (СуммаЧислителей и Знаменатель группы), поэтому здесь ничего не нужно.
	// Пост-распределение применит индивидуальные доли: Числитель / СуммаЧислителей
	
	// 5. Выполняем запрос с группированными данными
	Запрос = ЗапросВыпущеннаяПродукцияГруппировка(ПараметрыУзлаОбъединенные, Истина, ТаблицаГруппПар);
	
	// Если ВыводитьДопРасходы, создаём ВТКоличествПоПарам через параметр и ПОМЕСТИТЬ
	Если ВыводитьДопРасходы Тогда
		// Устанавливаем параметр с таблицей количеств
		Запрос.УстановитьПараметр("ТаблицаКоличествПоПарам", ТаблицаКоличествПоПарам);
		
		// Добавляем создание ВТ перед основным запросом затрат
		ТекстВТКоличеств = 
		"ВЫБРАТЬ
		|	Таблица.ПартияУИД КАК ПартияУИД,
		|	Таблица.АналитикаУИД КАК АналитикаУИД,
		|	Таблица.КоличествоПродукции КАК КоличествоПродукции
		|ПОМЕСТИТЬ ВТКоличествПоПарам
		|ИЗ &ТаблицаКоличествПоПарам КАК Таблица;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|";
		
		Запрос.Текст = Запрос.Текст + ТекстВТКоличеств;
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст + ikon_cost_ТекстЗапросаЗатратыНаПродукцию(ВыводитьДопРасходы);
	
	ВсеДанные = Запрос.Выполнить().Выгрузить();
	
	// 6. ПОСТ-РАСПРЕДЕЛЕНИЕ С УМНОЖЕНИЕМ НА КОЭФФИЦИЕНТ
	// Запрос вернул 100% себестоимости (с &Числитель=0, &Знаменатель=0)
	// Применяем индивидуальный коэффициент Числитель/Знаменатель для каждой группы
	РезультатПоУзлам = Новый Соответствие;
	
	// Инициализируем пустые таблицы для всех узлов
	Для Каждого Узел Из УзлыДляОбработки Цикл
		КлючУзла = СоздатьКлючУзла(Узел.ПараметрыУзла);
		ТаблицаУзла = ВсеДанные.СкопироватьКолонки();
		РезультатПоУзлам.Вставить(КлючУзла, ТаблицаУзла);
	КонецЦикла;
	
	// Индексируем строки результата по паре (Партия, Аналитика)
	СтрокиПоКлючам = Новый Соответствие;
	Для Каждого СтрокаДанных Из ВсеДанные Цикл
		ПартияСтроки = СтрокаДанных.ПартияВыходноеИзделие;
		АналитикаСтроки = СтрокаДанных.АналитикаУчетаПартийВыходноеИзделие;
		КлючПары = СоздатьКлючПары(ПартияСтроки, АналитикаСтроки);
		
		СтрокиПары = СтрокиПоКлючам.Получить(КлючПары);
		Если СтрокиПары = Неопределено Тогда
			СтрокиПары = Новый Массив;
			СтрокиПоКлючам.Вставить(КлючПары, СтрокиПары);
		КонецЕсли;
		СтрокиПары.Добавить(СтрокаДанных);
	КонецЦикла;
	
	// Список полей для умножения на коэффициент
	// НОВЫЙ ПОДХОД: SQL возвращает 100% (Знаменатель=0), распределяем в пост-обработке
	// Включаем КоличествоЗатрата - оно тоже должно быть пропорциональным!
	ПоляСумм = "КоличествоЗатрата,Материальные,Трудозатраты,ПостатейныеПостоянные,ПостатейныеПеременные,ДопРасходы,"
		+ "СуммаЗатрата,СуммаЗатратаЗабалансовая,НДД,"
		+ "МатериальныеСНДС,ТрудозатратыСНДС,ПостатейныеПостоянныеСНДС,ПостатейныеПеременныеСНДС,ДопРасходыСНДС,"
		+ "МатериальныеБезНДС,ПостатейныеПостоянныеБезНДС,ПостатейныеПеременныеБезНДС,ДопРасходыБезНДС,"
		+ "МатериальныеУпр,ТрудозатратыУпр,ПостатейныеПостоянныеУпр,ПостатейныеПеременныеУпр,ДопРасходыУпр,СтоимостьЗабалансоваяУпр,"
		+ "МатериальныеРегл,ТрудозатратыРегл,ПостатейныеПостоянныеРегл,ПостатейныеПеременныеРегл,ДопРасходыРегл,СтоимостьЗабалансоваяРегл,"
		+ "НалоговыйУчет,ПостояннаяРазница,ВременнаяРазница";
	МассивПолейСумм = СтрРазделить(ПоляСумм, ",");
	
	// Распределяем строки по узлам С УМНОЖЕНИЕМ на коэффициент
	Для Каждого КлючИЗначение Из ГруппыПоПарам Цикл
		Группа = КлючИЗначение.Значение;
		КлючПары = СоздатьКлючПары(Группа.Партия, Группа.Аналитика);
		
		СтрокиПары = СтрокиПоКлючам.Получить(КлючПары);
		Если СтрокиПары = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		// НОВЫЙ ПОДХОД: SQL вернул 100% (Знаменатель=0 авторасчёт)
		// Распределяем по коэффициенту: Группа.Числитель / СуммаЧислителейПары
		СуммаЧислителейПары = СуммыЧислителейПоПарам.Получить(КлючПары);
		ЧислительАбс = Макс(-Группа.Числитель, Группа.Числитель);
		
		Если СуммаЧислителейПары > 0 Тогда
			Коэффициент = ЧислительАбс / СуммаЧислителейПары;
		Иначе
			Коэффициент = 1;
		КонецЕсли;
		
		// Копируем строки каждому узлу группы С ПРИМЕНЕНИЕМ КОЭФФИЦИЕНТА
		Для Каждого КлючУзла Из Группа.КлючиУзлов Цикл
			ТаблицаУзла = РезультатПоУзлам.Получить(КлючУзла);
			Если ТаблицаУзла = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			Для Каждого СтрокаДанных Из СтрокиПары Цикл
				НоваяСтрока = ТаблицаУзла.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаДанных);
				
				// Умножаем суммовые поля на коэффициент
				// ИСКЛЮЧЕНИЕ: доп.расходы уже учтены через пропорцию в SQL, НЕ умножаем повторно
				// ТипЗатратДопРасходы в типовой конфигурации задаётся как НСтр("ru = 'Доп. расходы';|en = 'Additional expenses'")
				ЭтоДопРасходы = (СтрокаДанных.ТипЗатрат = НСтр("ru = 'Доп. расходы';|en = 'Additional expenses'"));
				
				Для Каждого ИмяПоля Из МассивПолейСумм Цикл
					Если ВсеДанные.Колонки.Найти(ИмяПоля) <> Неопределено Тогда
						// Для доп.расходов НЕ применяем коэффициент (уже учтено в SQL)
						Если ЭтоДопРасходы И (СтрНайти(ИмяПоля, "ДопРасходы") > 0 ИЛИ ИмяПоля = "СуммаЗатрата") Тогда
							НоваяСтрока[ИмяПоля] = СтрокаДанных[ИмяПоля]; // Без коэффициента
						Иначе
							НоваяСтрока[ИмяПоля] = СтрокаДанных[ИмяПоля] * Коэффициент;
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	
	// === ОБРАБОТКА НЕРАСПРЕДЕЛЁННЫХ СТРОК ===
	// Строки которые не попали ни в одну группу по паре (Партия, Аналитика)
	// Распределяем по узлам где совпадает хотя бы Партия
	РаспределённыеКлючи = Новый Соответствие;
	Для Каждого КлючИЗначение Из ГруппыПоПарам Цикл
		Группа = КлючИЗначение.Значение;
		КлючПары = СоздатьКлючПары(Группа.Партия, Группа.Аналитика);
		РаспределённыеКлючи.Вставить(КлючПары, Истина);
	КонецЦикла;
	
	// Собираем узлы по партиям (только по партии, без аналитики)
	УзлыПоПартиям = Новый Соответствие;
	Для Каждого КлючИЗначение Из ГруппыПоПарам Цикл
		Группа = КлючИЗначение.Значение;
		КлючПартии = Строка(Группа.Партия);
		
		Запись = УзлыПоПартиям.Получить(КлючПартии);
		Если Запись = Неопределено Тогда
			Запись = Новый Структура;
			Запись.Вставить("КлючиУзлов", Новый Массив);
			Запись.Вставить("СуммаЧислителей", 0);
			УзлыПоПартиям.Вставить(КлючПартии, Запись);
		КонецЕсли;
		
		Для Каждого КлючУзла Из Группа.КлючиУзлов Цикл
			Запись.КлючиУзлов.Добавить(КлючУзла);
		КонецЦикла;
		Запись.СуммаЧислителей = Запись.СуммаЧислителей + Макс(-Группа.Числитель, Группа.Числитель);
	КонецЦикла;
	
	// Находим и распределяем нераспределённые строки
	КоличествоНераспределённых = 0;
	Для Каждого КлючИЗначение Из СтрокиПоКлючам Цикл
		КлючПары = КлючИЗначение.Ключ;
		Если РаспределённыеКлючи.Получить(КлючПары) <> Неопределено Тогда
			Продолжить; // Уже распределено
		КонецЕсли;
		
		СтрокиПары = КлючИЗначение.Значение;
		Если СтрокиПары.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		// Получаем партию из первой строки
		ПартияСтроки = СтрокиПары[0].ПартияВыходноеИзделие;
		КлючПартии = Строка(ПартияСтроки);
		
		// Ищем узлы по этой партии
		Запись = УзлыПоПартиям.Получить(КлючПартии);
		Если Запись = Неопределено ИЛИ Запись.КлючиУзлов.Количество() = 0 Тогда
			// Партия не найдена в группах - пропускаем (аномалия)
			Продолжить;
		КонецЕсли;
		
		// Распределяем по узлам этой партии
		КоличествоУзлов = Запись.КлючиУзлов.Количество();
		Коэффициент = 1 / КоличествоУзлов; // Равномерно по узлам партии
		
		КоличествоНераспределённых = КоличествоНераспределённых + СтрокиПары.Количество();
		
		Для Каждого КлючУзла Из Запись.КлючиУзлов Цикл
			ТаблицаУзла = РезультатПоУзлам.Получить(КлючУзла);
			Если ТаблицаУзла = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			Для Каждого СтрокаДанных Из СтрокиПары Цикл
				НоваяСтрока = ТаблицаУзла.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаДанных);
				
				// Умножаем суммовые поля на коэффициент
				// ИСКЛЮЧЕНИЕ: доп.расходы уже учтены через пропорцию в SQL, НЕ умножаем повторно
				// ТипЗатратДопРасходы в типовой конфигурации задаётся как НСтр("ru = 'Доп. расходы';|en = 'Additional expenses'")
				ЭтоДопРасходы = (СтрокаДанных.ТипЗатрат = НСтр("ru = 'Доп. расходы';|en = 'Additional expenses'"));
				
				Для Каждого ИмяПоля Из МассивПолейСумм Цикл
					Если ВсеДанные.Колонки.Найти(ИмяПоля) <> Неопределено Тогда
						// Для доп.расходов НЕ применяем коэффициент (уже учтено в SQL)
						Если ЭтоДопРасходы И (СтрНайти(ИмяПоля, "ДопРасходы") > 0 ИЛИ ИмяПоля = "СуммаЗатрата") Тогда
							НоваяСтрока[ИмяПоля] = СтрокаДанных[ИмяПоля]; // Без коэффициента
						Иначе
							НоваяСтрока[ИмяПоля] = СтрокаДанных[ИмяПоля] * Коэффициент;
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	
	Возврат РезультатПоУзлам;
	
КонецФункции

// Формирует запрос набора данных "ВыпущеннаяПродукция" для пакетной обработки:
// ограничивает выборку парами из временной таблицы и подменяет коэффициенты пропорции на значения из ВТ.
//
// Параметры:
//  ПараметрыУзла - Структура - параметры узла дерева себестоимости (СхемаКД, Отборы)
//  ПомещатьВВТ - Булево - признак формирования текста запроса с ПОМЕСТИТЬ (используется при конструировании пакета запросов)
//  ТаблицаГруппПар - ТаблицаЗначений - таблица пар и коэффициентов (ПартияПродукции, АналитикаУчетаПартийПродукции, Числитель, Знаменатель)
//
// Возвращаемое значение:
//  Запрос - объект Запрос с заполненным Текстом и МенеджеромВременныхТаблиц, содержащим ВТПарыУзлов
//
// Примечание по пропорциям:
//  В этом запросе ВТПарыУзлов создаётся из ТаблицаГруппПар и далее используется:
//   - для фильтра по парам (через условие "(Партия, Аналитика) В (ВЫБРАТЬ ... ИЗ ВТПарыУзлов)")
//   - для подстановки Числитель/Знаменатель (через МАКСИМУМ(ВТПарыУзлов.*)), чтобы вычислять пропорции в SQL.
Функция ЗапросВыпущеннаяПродукцияГруппировка(ПараметрыУзла, ПомещатьВВТ, ТаблицаГруппПар)
	
	НаборДанных = ПараметрыУзла.СхемаКД.НаборыДанных.Найти("ВыпущеннаяПродукция");
	Отборы = ПараметрыУзла.Отборы;
	
	Отборы.Вставить("ЗаВесьПериод", Не ЗначениеЗаполнено(Отборы.ДатаНачала) И Не ЗначениеЗаполнено(Отборы.ДатаОкончания));
	Отборы.Вставить("ПоВсемОрганизациям", Не ЗначениеЗаполнено(Отборы.Организации));
	Отборы.Вставить("ПоВсемПодразделениям", Не ЗначениеЗаполнено(Отборы.Подразделения));
	Отборы.Вставить("ПоВсейПродукции", Не ЗначениеЗаполнено(Отборы.Продукция));
	Отборы.Вставить("ПоВсемХарактеристикам", Не ЗначениеЗаполнено(Отборы.ХарактеристикиПродукции));
	Отборы.Вставить("ПоВсемСериям", Не ЗначениеЗаполнено(Отборы.СерииПродукции));
	Отборы.Вставить("ПоВсемНазначениям", Не ЗначениеЗаполнено(Отборы.НазначенияПродукции));
	Отборы.Вставить("РасшифровкаДвиженийДокумента", ЗначениеЗаполнено(Отборы.Регистраторы));
	
	ТекстЗапроса = НаборДанных.Запрос;
	ТекстЗапроса = Лев(ТекстЗапроса, СтрНайти(ТекстЗапроса, ";", НаправлениеПоиска.СКонца) - 1);
	
	// Заменяем условие на фильтр по ВТ групп с групповыми коэффициентами
	ТекстУсловия = 
	"И (&ЗаВесьПериод
	|		ИЛИ СебестоимостьТоваров.Период МЕЖДУ &ДатаНачала И &ДатаОкончания)
	|	И (&ПоВсемОрганизациям
	|		ИЛИ СебестоимостьТоваров.Организация В (&Организации))
	|	И (&ПоВсемПодразделениям
	|		ИЛИ СпрПодразделения.Ссылка В (&Подразделения))
	|	И (&ПоВсейПродукции
	|		ИЛИ КлючиАналитики.Номенклатура В (&Продукция))
	|	И (СебестоимостьТоваров.Партия, СебестоимостьТоваров.АналитикаУчетаПартий) В 
	|		(ВЫБРАТЬ ВТПарыУзлов.ПартияПродукции, ВТПарыУзлов.АналитикаУчетаПартийПродукции ИЗ ВТПарыУзлов КАК ВТПарыУзлов)
	|	И (&ПоВсемХарактеристикам
	|		ИЛИ КлючиАналитики.Характеристика В (&ХарактеристикиПродукции))
	|	И (&ПоВсемСериям
	|		ИЛИ КлючиАналитики.Серия В (&СерииПродукции))
	|	И (&ПоВсемНазначениям
	|		ИЛИ КлючиАналитики.Назначение В (&НазначенияПродукции))";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "И &ТекстУсловия", ТекстУсловия);
	
	// ========================================================================
	// ПАКЕТНАЯ ОБРАБОТКА: Замена параметров &Числитель/&Знаменатель на поля ВТ
	// ========================================================================
	
	// 1. Добавляем JOIN с ВТПарыУзлов для получения Числитель и Знаменатель из группы
	// ВАЖНО: В части ВтПродукция структура такая:
	//   ВЫБРАТЬ ... &Числитель ... ИЗ ... JOIN ... ГДЕ ...
	// Т.е. ГДЕ находится ПОСЛЕ &Числитель, а не перед.
	// Ищем ПЕРВОЕ ГДЕ ПОСЛЕ &Числитель и вставляем JOIN перед ним
	ТекстJoin = Символы.ПС + "	ЛЕВОЕ СОЕДИНЕНИЕ ВТПарыУзлов КАК ВТПарыУзлов" + Символы.ПС
		+ "		ПО СебестоимостьТоваров.Партия = ВТПарыУзлов.ПартияПродукции" + Символы.ПС
		+ "			И СебестоимостьТоваров.АналитикаУчетаПартий = ВТПарыУзлов.АналитикаУчетаПартийПродукции" + Символы.ПС;
	
	// Стратегия: 
	// 1. Найти позицию &Числитель в запросе
	// 2. Найти ПЕРВОЕ ГДЕ ПОСЛЕ этой позиции (это ГДЕ части ВтПродукция)
	// 3. Вставить JOIN перед этим ГДЕ
	ПозицияЧислитель = СтрНайти(ТекстЗапроса, "&Числитель");
	Если ПозицияЧислитель > 0 Тогда
		// Находим первое ГДЕ ПОСЛЕ &Числитель
		ПозицияГде = СтрНайти(ТекстЗапроса, Символы.ПС + "ГДЕ", , ПозицияЧислитель);
		
		Если ПозицияГде > 0 Тогда
			ТекстЗапроса = Лев(ТекстЗапроса, ПозицияГде - 1) + ТекстJoin + Сред(ТекстЗапроса, ПозицияГде);
		КонецЕсли;
	КонецЕсли;
	
	// 2. Заменяем параметры &Числитель и &Знаменатель на агрегатные функции из ВТПарыУзлов
	// ИСПОЛЬЗУЕМ МАКСИМУМ() для агрегации - поля НЕ добавляются в GROUP BY
	
	// Диагностика ДО замены
	ЕстьЧислительДо = СтрНайти(ТекстЗапроса, "&Числитель") > 0;
	ЕстьЗнаменательДо = СтрНайти(ТекстЗапроса, "&Знаменатель") > 0;
	
	// Заменяем условие &Числитель = 0 на проверку Числителя
	// ВАЖНО: используем МАКСИМУМ(Числитель) = 0, НЕ Знаменатель!
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Числитель = 0", "МАКСИМУМ(ВТПарыУзлов.Числитель) = 0");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ИНАЧЕ &Числитель", "ИНАЧЕ МАКСИМУМ(ВТПарыУзлов.Числитель)");
	
	// Заменяем &Знаменатель на МАКСИМУМ(ВТПарыУзлов.Знаменатель)
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Знаменатель = 0", "МАКСИМУМ(ВТПарыУзлов.Знаменатель) = 0");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ИНАЧЕ &Знаменатель", "ИНАЧЕ МАКСИМУМ(ВТПарыУзлов.Знаменатель)");
	
	// 3. НЕ добавляем поля ВТПарыУзлов в GROUP BY
	// Потому что мы используем МАКСИМУМ(ВТПарыУзлов.Числитель) - это агрегатная функция
	
	// Диагностика ПОСЛЕ замены
	ЕстьЧислительПосле = СтрНайти(ТекстЗапроса, "&Числитель") > 0;
	ЕстьЗнаменательПосле = СтрНайти(ТекстЗапроса, "&Знаменатель") > 0;
	ЕстьВТЧислитель = СтрНайти(ТекстЗапроса, "ВТПарыУзлов.Числитель") > 0;
	
	// Создаём запрос с менеджером ВТ
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	// Создаём временную таблицу с группированными парами и коэффициентами
	ЗапросВТ = Новый Запрос;
	ЗапросВТ.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросВТ.Текст = 
	"ВЫБРАТЬ
	|	Данные.ПартияПродукции КАК ПартияПродукции,
	|	Данные.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
	|	Данные.Числитель КАК Числитель,
	|	Данные.Знаменатель КАК Знаменатель
	|ПОМЕСТИТЬ ВТПарыУзлов
	|ИЗ
	|	&ТаблицаГруппПар КАК Данные
	|ИНДЕКСИРОВАТЬ ПО
	|	ПартияПродукции, АналитикаУчетаПартийПродукции";
	ЗапросВТ.УстановитьПараметр("ТаблицаГруппПар", ТаблицаГруппПар);
	ЗапросВТ.Выполнить();
	
	Если Не ПомещатьВВТ Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ПОМЕСТИТЬ ВыпущеннаяПродукция", "");
		ТекстСортировка = 
		"УПОРЯДОЧИТЬ ПО
		|	ВтПродукция.ПродукцияПредставление,
		|	ВтПродукция.ХарактеристикаПродукцииПредставление,
		|	ВтПродукция.СерияПродукцииПредставление,
		|	ВтПродукция.НазначениеПродукцииПредставление,
		|	ВтПродукция.ПартияПродукции
		|;
		|";
		ТекстЗапроса = ТекстЗапроса + ТекстСортировка;
	Иначе
		ТекстЗапроса = ТекстЗапроса + ";";
	КонецЕсли;
	
	Запрос.Текст = ТекстЗапроса;
	УстановитьПараметрыДереваСебестоимости(Запрос, ПараметрыУзла.Отборы, "Ключ");
	
	Возврат Запрос;
	
КонецФункции
// ============================================================================
// РЕФАКТОРИНГ: Вспомогательные функции для формирования SQL-запросов
// 
// Цель: Разбиение большой функции ikon_cost_ТекстЗапросаЗатратыНаПродукцию
//       на более мелкие и понятные части для упрощения поддержки и расширения
//
// Каждая функция возвращает текст SQL-запроса для формирования временной таблицы
// ============================================================================

// Формирует текст SQL-запроса для создания временной таблицы `ВыбывшиеЗатратыСводно`.
//
// Назначение запроса:
//  Сводит данные по выбывшим из НЗП затратам (в разрезе аналитики затрат и пары продукции)
//  и подготавливает базовый набор партий производства для дальнейших расчетов цепочки себестоимости.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ВыбывшиеЗатратыСводно`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется; коэффициенты (Числитель/Знаменатель) берутся из источника
//  `ВыбытиеИзНЗППоПродукции` и агрегируются по данным таблицы.
Функция ikon_cost_ТекстЗапроса_ВыбывшиеЗатратыСводно()
	
	Возврат
"ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	МАКСИМУМ(Т.Период) КАК Период,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	МАКСИМУМ(Т.Числитель) КАК Числитель,
|	МАКСИМУМ(Т.Знаменатель) КАК Знаменатель
|ПОМЕСТИТЬ ВыбывшиеЗатратыСводно
|ИЗ
|	ВыбытиеИзНЗППоПродукции КАК Т
|ГДЕ
|	Т.Количество <> 0
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.Партия,
|	Т.ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `ПартииПроизводства`.
//
// Назначение запроса:
//  Выделяет список партий производства, которые участвуют в расчёте (на основании `ВыбывшиеЗатратыСводно`),
//  чтобы далее ограничивать выборки оборотов регистра и уменьшать объём данных/время выполнения.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ПартииПроизводства`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется (это вспомогательная таблица-список партий без расчёта долей).
Функция ikon_cost_ТекстЗапроса_ПартииПроизводства()
	
	Возврат
"ВЫБРАТЬ РАЗЛИЧНЫЕ
|	Т.Партия КАК Партия
|ПОМЕСТИТЬ ПартииПроизводства
|ИЗ
|	ВыбывшиеЗатратыСводно КАК Т
|ИНДЕКСИРОВАТЬ ПО
|	Партия
|;";

КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `ВыбытиеИзНЗП`.
//
// Назначение запроса:
//  Рассчитывает выбытие из НЗП по месяцам для партий производства, отобранных через `ПартииПроизводства`,
//  и привязывает его к паре продукции (ПартияПродукции, АналитикаУчетаПартийПродукции) из `ВыбывшиеЗатратыСводно`.
//  Таблица используется как вход для дальнейшей детализации партий и построения цепочек распределения затрат.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ВыбытиеИзНЗП`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется; используется уже рассчитанная пара продукции и коэффициенты,
//  полученные через `ВыбывшиеЗатратыСводно`/`ВыбытиеИзНЗППоПродукции`.
Функция ikon_cost_ТекстЗапроса_ВыбытиеИзНЗП()
	
	Возврат
"ВЫБРАТЬ РАЗРЕШЕННЫЕ
|	Т.Организация КАК Организация,
|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК Период,
|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Т.Партия КАК Партия,
|	Выбытие.ПартияПродукции КАК ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	СУММА(Т.КоличествоРасход) КАК Количество,
|	МАКСИМУМ(Выбытие.Числитель) КАК Числитель,
|	МАКСИМУМ(Выбытие.Знаменатель) КАК Знаменатель
|ПОМЕСТИТЬ ВыбытиеИзНЗП
|ИЗ
|	РегистрНакопления.СебестоимостьТоваров.Обороты(,, МЕСЯЦ,
|		Партия В (
|			ВЫБРАТЬ
|				Т.Партия
|			ИЗ
|				ПартииПроизводства КАК Т)
|		И (АналитикаУчетаНоменклатуры, Организация) В (
|			ВЫБРАТЬ
|				Выбытие.АналитикаУчетаНоменклатуры,
|				Выбытие.Организация КАК Организация
|			ИЗ
|				ВыбывшиеЗатратыСводно КАК Выбытие)
|	) КАК Т
|
|	ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
|	ПО Т.АналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
|		И Т.Партия = Выбытие.Партия
|
|ГДЕ
|	Т.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ),
|	Т.АналитикаУчетаНоменклатуры,
|	Т.Партия,
|	Выбытие.ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `ПервичныеПартииВНЗП`.
//
// Назначение запроса:
//  Подготавливает набор «первичных партий» в НЗП (остатки/движения) с привязкой к паре продукции и коэффициентам,
//  чтобы корректно учитывать начальные остатки и перенос затрат в цепочке расчёта себестоимости.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ПервичныеПартииВНЗП`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется; коэффициенты (Числитель/Знаменатель) берутся из набора выбытия из НЗП
//  и используются далее при объединении/распределении затрат.
Функция ikon_cost_ТекстЗапроса_ПервичныеПартииВНЗП()
	
	Возврат
"ВЫБРАТЬ РАЗРЕШЕННЫЕ
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ) КАК Период,
|	СебестоимостьТоваров.Организация					КАК Организация,
|	СебестоимостьТоваров.ВидЗапасов						КАК ВидЗапасов,
// Аналитика первичной партии.
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий 			КАК АналитикаУчетаПартий,
|	СебестоимостьТоваров.Партия 						КАК Партия,
// Аналитка в НЗП.
|	СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры 	КАК КорАналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.КорПартия						КАК КорПартия,
|	Выбытие.ПартияПродукции								КАК ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции				КАК АналитикаУчетаПартийПродукции,
|	МАКСИМУМ(Выбытие.Числитель)							КАК Числитель,
|	МАКСИМУМ(Выбытие.Знаменатель)						КАК Знаменатель,
|	МАКСИМУМ(ВЫБОР
|		КОГДА СебестоимостьТоваров.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
|		 И СебестоимостьТоваров.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
|			ТОГДА ИСТИНА
|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ВключитьНДСВСтоимость,
|	МАКСИМУМ(ВЫБОР
|		КОГДА СебестоимостьТоваров.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
|		 И СебестоимостьТоваров.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
|			ТОГДА ИСТИНА
|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ИсключитьНДСИзСтоимости,

|	СУММА(СебестоимостьТоваров.Количество) 				КАК Количество,
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|		КОНЕЦ)												КАК Материальные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
|		КОНЕЦ)												КАК Трудозатраты,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		КОНЕЦ)												КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		КОНЕЦ)												КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК ДопРасходы,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|				+ СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|				+ СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|				+ СебестоимостьТоваров.ТрудозатратыУпр
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
|				+ СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|				+ СебестоимостьТоваров.ТрудозатратыРегл
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|				+ СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
|			ИНАЧЕ 0
|		КОНЕЦ)												КАК НДД,

|// Стоимости с НДС
|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,

|// Стоимости без НДС
|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,

|// Стоимости Упр
|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,

|// Стоимости Регл
|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,

|// Налоговый учет
|	СУММА(СебестоимостьТоваров.СтоимостьРегл
|		+ СебестоимостьТоваров.ТрудозатратыРегл
|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		+ СебестоимостьТоваров.ДопРасходыРегл
|		- СебестоимостьТоваров.ПостояннаяРазница
|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница

|ПОМЕСТИТЬ ПервичныеПартииВНЗП
|ИЗ
|	РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК ПП
|		ПО СебестоимостьТоваров.КорПартия = ПП.Партия
|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
|		ПО СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
|			И СебестоимостьТоваров.КорПартия = Выбытие.Партия
|			И СебестоимостьТоваров.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
|			И СебестоимостьТоваров.Организация = Выбытие.Организация
|ГДЕ
|	СебестоимостьТоваров.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
|	И НЕ Выбытие.АналитикаУчетаНоменклатуры ЕСТЬ NULL
|	И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))

|СГРУППИРОВАТЬ ПО
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
|	СебестоимостьТоваров.Организация,
|	СебестоимостьТоваров.ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий,
|	СебестоимостьТоваров.Партия,
|	СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.КорПартия,
|	Выбытие.ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции

|ИМЕЮЩИЕ СУММА(СебестоимостьТоваров.Количество) > 0

|ОБЪЕДИНИТЬ ВСЕ

// Фикс. стоимость
|ВЫБРАТЬ
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ)	КАК Период,
|	СебестоимостьТоваров.Организация					КАК Организация,
|	СебестоимостьТоваров.ВидЗапасов						КАК ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий 			КАК АналитикаУчетаПартий,
|	СебестоимостьТоваров.Регистратор					КАК Партия,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК КорАналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.Партия							КАК КорПартия,
|	Выбытие.ПартияПродукции								КАК ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции				КАК АналитикаУчетаПартийПродукции,
|	МАКСИМУМ(Выбытие.Числитель)							КАК Числитель,
|	МАКСИМУМ(Выбытие.Знаменатель)						КАК Знаменатель,
|	ЛОЖЬ												КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ												КАК ИсключитьНДСИзСтоимости,
|	СУММА(СебестоимостьТоваров.Количество),
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|		КОНЕЦ)												КАК Материальные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
|		КОНЕЦ)												КАК Трудозатраты,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		КОНЕЦ)												КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		КОНЕЦ)												КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК ДопРасходы,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|				+ СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|				+ СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|				+ СебестоимостьТоваров.ТрудозатратыУпр
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
|				+ СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|				+ СебестоимостьТоваров.ТрудозатратыРегл
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|				+ СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
|			ИНАЧЕ 0
|		КОНЕЦ)												КАК НДД,

|// Стоимости с НДС
|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,

|// Стоимости без НДС
|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,

|// Стоимости Упр
|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,

|// Стоимости Регл
|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,

|// Налоговый учет
|	СУММА(СебестоимостьТоваров.СтоимостьРегл
|		+ СебестоимостьТоваров.ТрудозатратыРегл
|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		+ СебестоимостьТоваров.ДопРасходыРегл
|		- СебестоимостьТоваров.ПостояннаяРазница
|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница

|ИЗ
|	РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК ПП
|		ПО СебестоимостьТоваров.Партия = ПП.Партия
|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
|		ПО СебестоимостьТоваров.АналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
|			И СебестоимостьТоваров.Партия = Выбытие.Партия
|			И СебестоимостьТоваров.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
|			И СебестоимостьТоваров.Организация = Выбытие.Организация
|ГДЕ
|	СебестоимостьТоваров.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость)
|	И СебестоимостьТоваров.Количество < 0
|	И НЕ Выбытие.АналитикаУчетаНоменклатуры ЕСТЬ NULL
|	И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))

|СГРУППИРОВАТЬ ПО
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
|	СебестоимостьТоваров.Организация,
|	СебестоимостьТоваров.ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий,
|	СебестоимостьТоваров.Регистратор,
|	СебестоимостьТоваров.Партия,
|	Выбытие.ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции

|ОБЪЕДИНИТЬ ВСЕ

// Услуги переработчика
|ВЫБРАТЬ
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ)	КАК Период,
|	СебестоимостьТоваров.Организация					КАК Организация,
|	СебестоимостьТоваров.ВидЗапасов						КАК ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий			КАК АналитикаУчетаПартий,
|	СебестоимостьТоваров.Регистратор					КАК Партия,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК КорАналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.Партия							КАК КорПартия,
|	Выбытие.ПартияПродукции								КАК ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции				КАК АналитикаУчетаПартийПродукции,
|	МАКСИМУМ(Выбытие.Числитель)							КАК Числитель,
|	МАКСИМУМ(Выбытие.Знаменатель)						КАК Знаменатель,
|	ЛОЖЬ												КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ												КАК ИсключитьНДСИзСтоимости,
|	СУММА(СебестоимостьТоваров.Количество),
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|		КОНЕЦ)												КАК Материальные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
|		КОНЕЦ)												КАК Трудозатраты,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		КОНЕЦ)												КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		КОНЕЦ)												КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК ДопРасходы,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|				+ СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|				+ СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|				+ СебестоимостьТоваров.ТрудозатратыУпр
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
|				+ СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|				+ СебестоимостьТоваров.ТрудозатратыРегл
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|				+ СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
|			ИНАЧЕ 0
|		КОНЕЦ)												КАК НДД,

|// Стоимости с НДС
|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,

|// Стоимости без НДС
|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,

|// Стоимости Упр
|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,

|// Стоимости Регл
|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,

|// Налоговый учет
|	СУММА(СебестоимостьТоваров.СтоимостьРегл
|		+ СебестоимостьТоваров.ТрудозатратыРегл
|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		+ СебестоимостьТоваров.ДопРасходыРегл
|		- СебестоимостьТоваров.ПостояннаяРазница
|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница

|ИЗ
|	РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров

|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК ПП
|		ПО СебестоимостьТоваров.Партия = ПП.Партия

|	ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
|	ПО СебестоимостьТоваров.АналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
|	И СебестоимостьТоваров.Партия = Выбытие.Партия
|	И СебестоимостьТоваров.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
|	И СебестоимостьТоваров.Организация = Выбытие.Организация
|ГДЕ
|	ТИПЗНАЧЕНИЯ(СебестоимостьТоваров.Регистратор) В(
|//++ Устарело_Переработка24
|		ТИП(Документ.ОтчетПереработчика),
|//-- Устарело_Переработка24
|		ТИП(Документ.ОтчетПереработчика2_5))
|	И СебестоимостьТоваров.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
|	И СебестоимостьТоваров.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
|	И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))

|СГРУППИРОВАТЬ ПО
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
|	СебестоимостьТоваров.Организация,
|	СебестоимостьТоваров.ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий,
|	СебестоимостьТоваров.Регистратор,
|	СебестоимостьТоваров.Партия,
|	Выбытие.ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции

|ОБЪЕДИНИТЬ ВСЕ

// Начальные остатки
|ВЫБРАТЬ
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ)	КАК Период,
|	СебестоимостьТоваров.Организация					КАК Организация,
|	СебестоимостьТоваров.ВидЗапасов						КАК ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий			КАК АналитикаУчетаПартий,
|	СебестоимостьТоваров.Регистратор					КАК Партия,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК КорАналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.Партия							КАК КорПартия,
|	Выбытие.ПартияПродукции								КАК ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции				КАК АналитикаУчетаПартийПродукции,
|	МАКСИМУМ(Выбытие.Числитель)							КАК Числитель,
|	МАКСИМУМ(Выбытие.Знаменатель)						КАК Знаменатель,
|	ЛОЖЬ												КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ												КАК ИсключитьНДСИзСтоимости,
|	СУММА(СебестоимостьТоваров.Количество),
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|		КОНЕЦ)												КАК Материальные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
|		КОНЕЦ)												КАК Трудозатраты,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		КОНЕЦ)												КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		КОНЕЦ)												КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК ДопРасходы,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|				+ СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|				+ СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|				+ СебестоимостьТоваров.ТрудозатратыУпр
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
|				+ СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|				+ СебестоимостьТоваров.ТрудозатратыРегл
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|				+ СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
|			ИНАЧЕ 0
|		КОНЕЦ)												КАК НДД,

|// Стоимости с НДС
|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,

|// Стоимости без НДС
|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,

|// Стоимости Упр
|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,

|// Стоимости Регл
|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,

|// Налоговый учет
|	СУММА(СебестоимостьТоваров.СтоимостьРегл
|		+ СебестоимостьТоваров.ТрудозатратыРегл
|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		+ СебестоимостьТоваров.ДопРасходыРегл
|		- СебестоимостьТоваров.ПостояннаяРазница
|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница

|ИЗ
|	РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК ПП
|		ПО СебестоимостьТоваров.Партия = ПП.Партия
|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
|		ПО СебестоимостьТоваров.АналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
|			И СебестоимостьТоваров.Партия = Выбытие.Партия
|			И СебестоимостьТоваров.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
|			И СебестоимостьТоваров.Организация = Выбытие.Организация
|ГДЕ
|	СебестоимостьТоваров.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковЗатратПартийПроизводства)
|	И НЕ Выбытие.АналитикаУчетаНоменклатуры ЕСТЬ NULL
|	И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))

|СГРУППИРОВАТЬ ПО
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
|	СебестоимостьТоваров.Организация,
|	СебестоимостьТоваров.ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий,
|	СебестоимостьТоваров.Регистратор,
|	СебестоимостьТоваров.Партия,
|	Выбытие.ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции

|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `ДетализацияПартий`.
//
// Назначение запроса:
//  Подтягивает детализацию НДС (упр./регл.) по партиям из регистров сведений детализации себестоимости,
//  чтобы корректировать суммы (в зависимости от ВключитьНДСВСтоимость/ИсключитьНДСИзСтоимости) при дальнейших
//  сводных расчётах партий (`ПартииСводно`, `РасходПартийСводно` и т.п.).
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ДетализацияПартий`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется; пропорции задаются на уровне набора данных/узла, а здесь рассчитывается детализация НДС.
Функция ikon_cost_ТекстЗапроса_ДетализацияПартий()
	
	Возврат
	"
	|ВЫБРАТЬ
	|	СебестоимостьТоваров.Организация					КАК Организация,
	|	СебестоимостьТоваров.Период							КАК Период,
	|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
	|	СебестоимостьТоваров.АналитикаУчетаПартий 			КАК АналитикаУчетаПартий,
	|	СебестоимостьТоваров.Партия 						КАК Партия,
	|	СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры 	КАК КорАналитикаУчетаНоменклатуры,
	|	СебестоимостьТоваров.КорПартия						КАК КорПартия,
	|	СебестоимостьТоваров.ПартияПродукции				КАК ПартияПродукции,
	|	СебестоимостьТоваров.АналитикаУчетаПартийПродукции	КАК АналитикаУчетаПартийПродукции,
	|	МАКСИМУМ(СебестоимостьТоваров.Числитель)			КАК Числитель,
	|	МАКСИМУМ(СебестоимостьТоваров.Знаменатель)			КАК Знаменатель,
	|	ВЫРАЗИТЬ(СУММА(ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости <> 3 ТОГДА 0
	|		КОГДА СебестоимостьТоваров.ВключитьНДСВСтоимость
	|			ТОГДА (ЕСТЬNULL(Детализация.НДСУпр, 0) + ЕСТЬNULL(ДетализацияПостатейные.НДСУпр, 0))
	|				* СебестоимостьТоваров.Количество
	|		КОГДА СебестоимостьТоваров.ИсключитьНДСИзСтоимости
	|			ТОГДА (ЕСТЬNULL(-Детализация.НДСУпр, 0) + ЕСТЬNULL(-ДетализацияПостатейные.НДСУпр, 0))
	|				* СебестоимостьТоваров.Количество
	|		ИНАЧЕ 0 КОНЕЦ) КАК ЧИСЛО(31,2)) КАК НДСУпр,
	|	ВЫРАЗИТЬ(СУММА(ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости <> 4 ТОГДА 0
	|		КОГДА СебестоимостьТоваров.ВключитьНДСВСтоимость
	|			ТОГДА (ЕСТЬNULL(Детализация.НДСРегл, 0) + ЕСТЬNULL(ДетализацияПостатейные.НДСРегл, 0))
	|				* СебестоимостьТоваров.Количество
	|		КОГДА СебестоимостьТоваров.ИсключитьНДСИзСтоимости
	|			ТОГДА (ЕСТЬNULL(-Детализация.НДСРегл, 0) + ЕСТЬNULL(-ДетализацияПостатейные.НДСРегл, 0))
	|				* СебестоимостьТоваров.Количество
	|		ИНАЧЕ 0 КОНЕЦ) КАК ЧИСЛО(31,2)) КАК НДСРегл
	|
	|ПОМЕСТИТЬ ДетализацияПартий
	|ИЗ
	|	ПервичныеПартииВНЗП КАК СебестоимостьТоваров
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|	ПО Аналитика.Ссылка = СебестоимостьТоваров.АналитикаУчетаНоменклатуры
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Детализация
	|	ПО Детализация.Партия = СебестоимостьТоваров.Партия
	|		И Детализация.АналитикаУчетаПартий = СебестоимостьТоваров.АналитикаУчетаПартий
	|		И Детализация.Организация = СебестоимостьТоваров.Организация
	|		И Детализация.ВидЗапасов = СебестоимостьТоваров.ВидЗапасов
	|		И Детализация.Номенклатура = Аналитика.Номенклатура
	|		И Детализация.Характеристика = Аналитика.Характеристика
	|		И НЕ Детализация.ЗатратыПредыдущихПеределов
	|		И (Детализация.ПериодРегистрации <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
	|		И СебестоимостьТоваров.Количество <> 0
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК ДетализацияПостатейные
	|	ПО ДетализацияПостатейные.Партия = СебестоимостьТоваров.Партия
	|		И ДетализацияПостатейные.АналитикаУчетаПартий = СебестоимостьТоваров.АналитикаУчетаПартий
	|		И ДетализацияПостатейные.Организация = СебестоимостьТоваров.Организация
	|		И ДетализацияПостатейные.ВидЗапасов = СебестоимостьТоваров.ВидЗапасов
	|		И ДетализацияПостатейные.Номенклатура = Аналитика.Номенклатура
	|		И ДетализацияПостатейные.Характеристика = Аналитика.Характеристика
	|		И НЕ ДетализацияПостатейные.ЗатратыПредыдущихПеределов
	|		И (ДетализацияПостатейные.ПериодРегистрации <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
	|		И СебестоимостьТоваров.Количество <> 0
	|ГДЕ
	|	СебестоимостьТоваров.ВключитьНДСВСтоимость ИЛИ СебестоимостьТоваров.ИсключитьНДСИзСтоимости
	|
	|СГРУППИРОВАТЬ ПО
	|	СебестоимостьТоваров.Организация,
	|	СебестоимостьТоваров.Период,
	|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
	|	СебестоимостьТоваров.АналитикаУчетаПартий,
	|	СебестоимостьТоваров.Партия,
	|	СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры,
	|	СебестоимостьТоваров.КорПартия,
	|	СебестоимостьТоваров.ПартияПродукции,
	|	СебестоимостьТоваров.АналитикаУчетаПартийПродукции
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	ПартияПродукции,
	|	АналитикаУчетаПартийПродукции
	|;";

КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `ПриходыНарастающимИтогом`.
//
// Назначение запроса:
//  Рассчитывает нарастающий итог количества «поступлений» (входящих количеств) по партиям/аналитике,
//  связанный с данными `ВыбытиеИзНЗП`. Используется далее для вычисления доли расхода/списания по периодам.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ПриходыНарастающимИтогом`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется.
Функция ikon_cost_ТекстЗапроса_ПриходыНарастающимИтогом()
	
	Возврат
"
|ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	Т.Период КАК Период,
|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	МАКСИМУМ(Т.Числитель) КАК Числитель,
|	МАКСИМУМ(Т.Знаменатель) КАК Знаменатель,
|	СУММА(Партии.Количество) КАК Количество
|ПОМЕСТИТЬ ПриходыНарастающимИтогом
|ИЗ
|	ВыбытиеИзНЗП КАК Т
|		ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеПартииВНЗП КАК Партии
|		ПО Т.АналитикаУчетаНоменклатуры = Партии.КорАналитикаУчетаНоменклатуры
|			И Т.Партия = Партии.КорПартия
|			И Т.Период >= Партии.Период
|			И Т.ПартияПродукции = Партии.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Партии.АналитикаУчетаПартийПродукции
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	Т.Период,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.Партия,
|	Т.ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `РасходыНарастающимИтогом`.
//
// Назначение запроса:
//  Рассчитывает нарастающий итог количества «расхода/выбытия» по партиям/аналитике для поиска периодов,
//  где остаток обнуляется, и для дальнейшего построения интервалов расхода партий.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ РасходыНарастающимИтогом`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется.
Функция ikon_cost_ТекстЗапроса_РасходыНарастающимИтогом()
	
	Возврат
"
|ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	Т.Период КАК Период,
|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	МАКСИМУМ(Т.Числитель) КАК Числитель,
|	МАКСИМУМ(Т.Знаменатель) КАК Знаменатель,
|	СУММА(НарастающийИтог.Количество) КАК Количество
|ПОМЕСТИТЬ РасходыНарастающимИтогом
|ИЗ
|	ВыбытиеИзНЗП КАК Т
|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбытиеИзНЗП КАК НарастающийИтог
|		ПО Т.АналитикаУчетаНоменклатуры = НарастающийИтог.АналитикаУчетаНоменклатуры
|			И Т.Организация = НарастающийИтог.Организация
|			И Т.Партия = НарастающийИтог.Партия
|			И Т.Период >= НарастающийИтог.Период
|			И Т.ПартияПродукции = НарастающийИтог.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = НарастающийИтог.АналитикаУчетаПартийПродукции
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	Т.Период,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.Партия,
|	Т.ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `НулевыеПериоды`.
//
// Назначение запроса:
//  Выделяет периоды, в которых «расходы нарастающим итогом» сравнялись с «приходами нарастающим итогом»
//  (т.е. остаток по связке партия/аналитика стал нулевым). Эти точки используются для построения интервалов расхода.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ НулевыеПериоды`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется.
Функция ikon_cost_ТекстЗапроса_НулевыеПериоды()
	
	Возврат
"
|ВЫБРАТЬ
|	Расходы.Организация КАК Организация,
|	Расходы.Период КАК Период,
|	Расходы.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Расходы.Партия КАК Партия,
|	Расходы.ПартияПродукции КАК ПартияПродукции,
|	Расходы.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции
|ПОМЕСТИТЬ НулевыеПериоды
|ИЗ
|	РасходыНарастающимИтогом КАК Расходы
|		ЛЕВОЕ СОЕДИНЕНИЕ ПриходыНарастающимИтогом КАК Приходы
|		ПО Расходы.АналитикаУчетаНоменклатуры = Приходы.АналитикаУчетаНоменклатуры
|			И Расходы.Партия = Приходы.Партия
|			И Расходы.Период = Приходы.Период
|			И Расходы.Организация = Приходы.Организация
|			И Расходы.ПартияПродукции = Приходы.ПартияПродукции
|			И Расходы.АналитикаУчетаПартийПродукции = Приходы.АналитикаУчетаПартийПродукции
|ГДЕ
|	Расходы.Количество - ЕСТЬNULL(Приходы.Количество, 0) = 0
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `ИнтервалыРасходаПартий`.
//
// Назначение запроса:
//  На основании `НулевыеПериоды` строит интервалы (НачалоПериода/КонецПериода), в пределах которых выполняется
//  распределение расхода/списания для конкретной связки партия/аналитика.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ИнтервалыРасходаПартий`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется.
Функция ikon_cost_ТекстЗапроса_ИнтервалыРасходаПартий()
	
	Возврат
"
|ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	Т.Период КАК КонецПериода,
|	МАКСИМУМ(ЕСТЬNULL(ДОБАВИТЬКДАТЕ(НулевыеПериоды.Период, МЕСЯЦ, 1), ДАТАВРЕМЯ(1, 1, 1))) КАК НачалоПериода,
|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции
|ПОМЕСТИТЬ ИнтервалыРасходаПартий
|ИЗ
|	НулевыеПериоды КАК Т
|		ЛЕВОЕ СОЕДИНЕНИЕ НулевыеПериоды КАК НулевыеПериоды
|		ПО Т.АналитикаУчетаНоменклатуры = НулевыеПериоды.АналитикаУчетаНоменклатуры
|			И Т.Партия = НулевыеПериоды.Партия
|			И Т.Период > НулевыеПериоды.Период
|			И Т.Организация = НулевыеПериоды.Организация
|			И Т.ПартияПродукции = НулевыеПериоды.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = НулевыеПериоды.АналитикаУчетаПартийПродукции
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	Т.Период,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.Партия,
|	Т.ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `ПриходыНарастающимИтогомПоИнтервалам`.
//
// Назначение запроса:
//  Рассчитывает количество поступлений по интервалам расхода (из `ИнтервалыРасходаПартий`), чтобы далее корректно
//  делить расход/списание в пределах интервала (в т.ч. при частичных списаниях).
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ПриходыНарастающимИтогомПоИнтервалам`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется.
Функция ikon_cost_ТекстЗапроса_ПриходыНарастающимИтогомПоИнтервалам()
	
	Возврат
"
|ВЫБРАТЬ
|	Выбытие.Организация,
|	Выбытие.Период,
|	Выбытие.АналитикаУчетаНоменклатуры,
|	Выбытие.Партия КАК Партия,
|	Выбытие.ПартияПродукции КАК ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	МАКСИМУМ(Выбытие.Числитель) КАК Числитель,
|	МАКСИМУМ(Выбытие.Знаменатель) КАК Знаменатель,
|	СУММА(ПП.Количество) КАК Количество
|ПОМЕСТИТЬ ПриходыНарастающимИтогомПоИнтервалам
|ИЗ
|	ВыбытиеИзНЗП КАК Выбытие
|	ЛЕВОЕ СОЕДИНЕНИЕ ИнтервалыРасходаПартий КАК Интервалы
|	ПО Выбытие.АналитикаУчетаНоменклатуры = Интервалы.АналитикаУчетаНоменклатуры
|		И Выбытие.Партия = Интервалы.Партия
|		И Выбытие.ПартияПродукции = Интервалы.ПартияПродукции
|		И Выбытие.АналитикаУчетаПартийПродукции = Интервалы.АналитикаУчетаПартийПродукции
|
|	ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеПартииВНЗП КАК ПП
|	ПО Выбытие.АналитикаУчетаНоменклатуры = ПП.КорАналитикаУчетаНоменклатуры
|		И Выбытие.Партия = ПП.КорПартия
|		И Выбытие.Период >= ПП.Период
|		И (ПП.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
|		И Выбытие.ПартияПродукции = ПП.ПартияПродукции
|		И Выбытие.АналитикаУчетаПартийПродукции = ПП.АналитикаУчетаПартийПродукции
|ГДЕ
|	(Интервалы.НачалоПериода ЕСТЬ NULL
|		ИЛИ Выбытие.Период МЕЖДУ Интервалы.НачалоПериода И Интервалы.КонецПериода)
|
|СГРУППИРОВАТЬ ПО
|	Выбытие.Организация,
|	Выбытие.Период,
|	Выбытие.АналитикаУчетаНоменклатуры,
|	Выбытие.Партия,
|	Выбытие.ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `ПредварительныйРасходПартий`.
//
// Назначение запроса:
//  Выполняет предварительное распределение количеств и сумм по партиям на основании отношения расхода к поступлению
//  (в т.ч. с учетом интервалов расхода), формируя базу для дальнейших сводных таблиц по приходам/расходам партий.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ПредварительныйРасходПартий`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется; расчёт долей здесь основан на количестве (Расход/Поступило) и коэффициентах из данных таблиц.
Функция ikon_cost_ТекстЗапроса_ПредварительныйРасходПартий()
	
	Возврат
"
|ВЫБРАТЬ
|	Выбытие.Организация КАК Организация,
|	Выбытие.Период КАК Период,
|	ПП.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	ПП.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
|	ПП.Партия КАК Партия,
|	ПП.ПартияПродукции КАК ПартияПродукции,
|	ПП.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	МАКСИМУМ(Выбытие.Числитель)			КАК Числитель,
|	МАКСИМУМ(Выбытие.Знаменатель)		КАК Знаменатель,
|	МАКСИМУМ(ПП.ВключитьНДСВСтоимость) КАК ВключитьНДСВСтоимость,
|	МАКСИМУМ(ПП.ИсключитьНДСИзСтоимости) КАК ИсключитьНДСИзСтоимости,
|	Выбытие.АналитикаУчетаНоменклатуры 	КАК КорАналитикаУчетаНоменклатуры,
|	Выбытие.Партия 						КАК КорПартия,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|			Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.Количество) КАК Количество,
|	МАКСИМУМ(Выбытие.Количество = Поступило.Количество - ЕСТЬNULL(Выбыло.Количество, 0) + Выбытие.Количество) КАК СписатьОстаток,
|
|	// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.Материальные) КАК Материальные,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.Трудозатраты) КАК Трудозатраты,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПостоянные) КАК ПостатейныеПостоянные,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПеременные) КАК ПостатейныеПеременные,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ДопРасходы) КАК ДопРасходы,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.СуммаЗатратаЗабалансовая) КАК СуммаЗатратаЗабалансовая,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.СуммаЗатрата) КАК СуммаЗатрата,
|	СУММА(ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.НДД) КАК НДД,
|
|	// Стоимости с НДС
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.МатериальныеСНДС) КАК МатериальныеСНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ТрудозатратыСНДС) КАК ТрудозатратыСНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПостоянныеСНДС) КАК ПостатейныеПостоянныеСНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПеременныеСНДС) КАК ПостатейныеПеременныеСНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ДопРасходыСНДС) КАК ДопРасходыСНДС,
|
|	// Стоимости без НДС
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.МатериальныеБезНДС) КАК МатериальныеБезНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПостоянныеБезНДС) КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПеременныеБезНДС) КАК ПостатейныеПеременныеБезНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
|
|	// Стоимости Упр
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.МатериальныеУпр) КАК МатериальныеУпр,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ТрудозатратыУпр) КАК ТрудозатратыУпр,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПостоянныеУпр) КАК ПостатейныеПостоянныеУпр,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПеременныеУпр) КАК ПостатейныеПеременныеУпр,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ДопРасходыУпр) КАК ДопРасходыУпр,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.СтоимостьЗабалансоваяУпр) КАК СтоимостьЗабалансоваяУпр,
|
|	// Стоимости Регл
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.МатериальныеРегл) КАК МатериальныеРегл,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ТрудозатратыРегл) КАК ТрудозатратыРегл,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПостоянныеРегл) КАК ПостатейныеПостоянныеРегл,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПеременныеРегл) КАК ПостатейныеПеременныеРегл,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ДопРасходыРегл) КАК ДопРасходыРегл,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.СтоимостьЗабалансоваяРегл) КАК СтоимостьЗабалансоваяРегл,
|
|	// Налоговый учет
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.НалоговыйУчет) КАК НалоговыйУчет,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостояннаяРазница) КАК ПостояннаяРазница,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ВременнаяРазница) КАК ВременнаяРазница
|
|ПОМЕСТИТЬ ПредварительныйРасходПартий
|ИЗ
|	ВыбытиеИзНЗП КАК Выбытие
|		ЛЕВОЕ СОЕДИНЕНИЕ ИнтервалыРасходаПартий КАК Интервалы
|		ПО Выбытие.АналитикаУчетаНоменклатуры = Интервалы.АналитикаУчетаНоменклатуры
|			И Выбытие.Партия = Интервалы.Партия
|			И Выбытие.Организация = Интервалы.Организация
|			И Выбытие.ПартияПродукции = Интервалы.ПартияПродукции
|			И Выбытие.АналитикаУчетаПартийПродукции = Интервалы.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеПартииВНЗП КАК ПП
|		ПО Выбытие.АналитикаУчетаНоменклатуры = ПП.КорАналитикаУчетаНоменклатуры
|			И Выбытие.Партия = ПП.КорПартия
|			И Выбытие.Период >= ПП.Период
|			И (ПП.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
|			И Выбытие.Организация = ПП.Организация
|			И Выбытие.ПартияПродукции = ПП.ПартияПродукции
|			И Выбытие.АналитикаУчетаПартийПродукции = ПП.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ РасходыНарастающимИтогом КАК Выбыло
|		ПО Выбытие.АналитикаУчетаНоменклатуры = Выбыло.АналитикаУчетаНоменклатуры
|			И Выбытие.Партия = Выбыло.Партия
|			И Выбытие.Период = Выбыло.Период
|			И Выбытие.Организация = Выбыло.Организация
|			И Выбытие.ПартияПродукции = Выбыло.ПартияПродукции
|			И Выбытие.АналитикаУчетаПартийПродукции = Выбыло.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ ПриходыНарастающимИтогомПоИнтервалам КАК Поступило
|		ПО Выбытие.АналитикаУчетаНоменклатуры = Поступило.АналитикаУчетаНоменклатуры
|			И Выбытие.Партия = Поступило.Партия
|			И Выбытие.Период = Поступило.Период
|			И Выбытие.Организация = Поступило.Организация
|			И Выбытие.ПартияПродукции = Поступило.ПартияПродукции
|			И Выбытие.АналитикаУчетаПартийПродукции = Поступило.АналитикаУчетаПартийПродукции
|ГДЕ
|	(Интервалы.НачалоПериода ЕСТЬ NULL
|		ИЛИ Выбытие.Период МЕЖДУ Интервалы.НачалоПериода И Интервалы.КонецПериода)
|	И НЕ Поступило.Количество ЕСТЬ NULL
|
|СГРУППИРОВАТЬ ПО
|	Выбытие.Организация,
|	Выбытие.Период,
|	Выбытие.АналитикаУчетаНоменклатуры,
|	Выбытие.Партия,
|	ПП.АналитикаУчетаНоменклатуры,
|	ПП.АналитикаУчетаПартий,
|	ПП.Партия,
|	ПП.ПартияПродукции,
|	ПП.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `ПартииСводно`.
//
// Назначение запроса:
//  Собирает свод по партиям (количество и суммы по видам затрат) на основе предварительного расхода (`ПредварительныйРасходПартий`),
//  с учетом интервалов расхода и детализации НДС (`ДетализацияПартий`). Таблица используется как база «прихода» при расчёте
//  первичных затрат по периодам и для построения итоговых объединений затрат в запросе себестоимости.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ПартииСводно`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется.
Функция ikon_cost_ТекстЗапроса_ПартииСводно()
	
	Возврат
"
|ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	Т.Период КАК Период,
|	Т.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
|	Т.КорПартия КАК КорПартия,
|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	МАКСИМУМ(Т.Числитель) КАК Числитель,
|	МАКСИМУМ(Т.Знаменатель) КАК Знаменатель,
|	СУММА(Партии.Количество) КАК Количество,
|	// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(Партии.Материальные
|		+ ЕСТЬNULL(Детализация.НДСУпр,0)
|		+ ЕСТЬNULL(Детализация.НДСРегл,0)) КАК Материальные,
|	СУММА(Партии.Трудозатраты) КАК Трудозатраты,
|	СУММА(Партии.ПостатейныеПостоянные) КАК ПостатейныеПостоянные,
|	СУММА(Партии.ПостатейныеПеременные) КАК ПостатейныеПеременные,
|	СУММА(Партии.ДопРасходы) КАК ДопРасходы,
|	СУММА(Партии.СуммаЗатратаЗабалансовая) КАК СуммаЗатратаЗабалансовая,
|	СУММА(Партии.СуммаЗатрата
|		+ ЕСТЬNULL(Детализация.НДСУпр,0)
|		+ ЕСТЬNULL(Детализация.НДСРегл,0)) КАК СуммаЗатрата,
|	СУММА(Партии.НДД) КАК НДД,
|
|	// Стоимости с НДС
|	СУММА(Партии.МатериальныеСНДС) КАК МатериальныеСНДС,
|	СУММА(Партии.ТрудозатратыСНДС) КАК ТрудозатратыСНДС,
|	СУММА(Партии.ПостатейныеПостоянныеСНДС) КАК ПостатейныеПостоянныеСНДС,
|	СУММА(Партии.ПостатейныеПеременныеСНДС) КАК ПостатейныеПеременныеСНДС,
|	СУММА(Партии.ДопРасходыСНДС) КАК ДопРасходыСНДС,
|
|	// Стоимости без НДС
|	СУММА(Партии.МатериальныеБезНДС) КАК МатериальныеБезНДС,
|	СУММА(Партии.ПостатейныеПостоянныеБезНДС) КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(Партии.ПостатейныеПеременныеБезНДС) КАК ПостатейныеПеременныеБезНДС,
|	СУММА(Партии.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
|
|	// Стоимости Упр
|	СУММА(Партии.МатериальныеУпр + ЕСТЬNULL(Детализация.НДСУпр,0)) КАК МатериальныеУпр,
|	СУММА(Партии.ТрудозатратыУпр) КАК ТрудозатратыУпр,
|	СУММА(Партии.ПостатейныеПостоянныеУпр) КАК ПостатейныеПостоянныеУпр,
|	СУММА(Партии.ПостатейныеПеременныеУпр) КАК ПостатейныеПеременныеУпр,
|	СУММА(Партии.ДопРасходыУпр) КАК ДопРасходыУпр,
|	СУММА(Партии.СтоимостьЗабалансоваяУпр) КАК СтоимостьЗабалансоваяУпр,
|
|	// Стоимости Регл
|	СУММА(Партии.МатериальныеРегл + ЕСТЬNULL(Детализация.НДСРегл,0)) КАК МатериальныеРегл,
|	СУММА(Партии.ТрудозатратыРегл) КАК ТрудозатратыРегл,
|	СУММА(Партии.ПостатейныеПостоянныеРегл) КАК ПостатейныеПостоянныеРегл,
|	СУММА(Партии.ПостатейныеПеременныеРегл) КАК ПостатейныеПеременныеРегл,
|	СУММА(Партии.ДопРасходыРегл) КАК ДопРасходыРегл,
|	СУММА(Партии.СтоимостьЗабалансоваяРегл) КАК СтоимостьЗабалансоваяРегл,
|
|	// Налоговый учет
|	СУММА(Партии.НалоговыйУчет + ЕСТЬNULL(Детализация.НДСРегл,0)) КАК НалоговыйУчет,
|	СУММА(Партии.ПостояннаяРазница) КАК ПостояннаяРазница,
|	СУММА(Партии.ВременнаяРазница) КАК ВременнаяРазница
|
|ПОМЕСТИТЬ ПартииСводно
|ИЗ
|	ПредварительныйРасходПартий КАК Т
|		ЛЕВОЕ СОЕДИНЕНИЕ ИнтервалыРасходаПартий КАК Интервалы
|		ПО Т.КорАналитикаУчетаНоменклатуры = Интервалы.АналитикаУчетаНоменклатуры
|			И Т.КорПартия = Интервалы.Партия
|			И Т.Организация = Интервалы.Организация
|			И Т.ПартияПродукции = Интервалы.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Интервалы.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеПартииВНЗП КАК Партии
|		ПО Т.КорАналитикаУчетаНоменклатуры = Партии.КорАналитикаУчетаНоменклатуры
|			И Т.КорПартия = Партии.КорПартия
|			И Т.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатуры
|			И Т.АналитикаУчетаПартий = Партии.АналитикаУчетаПартий
|			И Т.Партия = Партии.Партия
|			И Т.Период >= Партии.Период
|			И (Партии.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
|			И Т.Организация = Партии.Организация
|			И Т.ПартияПродукции = Партии.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Партии.АналитикаУчетаПартийПродукции
|
|		ЛЕВОЕ СОЕДИНЕНИЕ ДетализацияПартий КАК Детализация
|		ПО Т.КорАналитикаУчетаНоменклатуры = Детализация.КорАналитикаУчетаНоменклатуры
|			И Т.КорПартия = Детализация.КорПартия
|			И Т.АналитикаУчетаНоменклатуры = Детализация.АналитикаУчетаНоменклатуры
|			И Т.АналитикаУчетаПартий = Детализация.АналитикаУчетаПартий
|			И Т.Партия = Детализация.Партия
|			И Т.Период >= Детализация.Период
|			И (Детализация.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
|			И Т.Организация = Детализация.Организация
|			И Т.ПартияПродукции = Детализация.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Детализация.АналитикаУчетаПартийПродукции
|ГДЕ
|	Интервалы.НачалоПериода ЕСТЬ NULL
|		ИЛИ Т.Период МЕЖДУ Интервалы.НачалоПериода И Интервалы.КонецПериода
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	Т.Период,
|	Т.КорАналитикаУчетаНоменклатуры,
|	Т.КорПартия,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.АналитикаУчетаПартий,
|	Т.Партия,
|	Т.ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `РасходПартийСводно`.
//
// Назначение запроса:
//  Сводит расход партий по периодам (количество и суммы) на основании `ПредварительныйРасходПартий`, учитывая интервалы расхода.
//  Используется при вычислении «остатка/первичных затрат» (когда требуется списать остаток целиком) и для последующих сводных расчётов.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ РасходПартийСводно`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется.
Функция ikon_cost_ТекстЗапроса_РасходПартийСводно()
	
	Возврат
"
|ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	Т.Период КАК Период,
|	Т.КорАналитикаУчетаНоменклатуры,
|	Т.КорПартия,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.АналитикаУчетаПартий,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	МАКСИМУМ(Т.Числитель) КАК Числитель,
|	МАКСИМУМ(Т.Знаменатель) КАК Знаменатель,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.Количество
|		КОНЕЦ) КАК Количество,
|	// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.Материальные
|		КОНЕЦ) КАК Материальные,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.Трудозатраты
|		КОНЕЦ) КАК Трудозатраты,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПостоянные
|		КОНЕЦ) КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПеременные
|		КОНЕЦ) КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ДопРасходы
|		КОНЕЦ) КАК ДопРасходы,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.СуммаЗатратаЗабалансовая
|		КОНЕЦ) КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.СуммаЗатрата
|		КОНЕЦ) КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.НДД
|		КОНЕЦ) КАК НДД,
|
|	// Стоимости с НДС
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.МатериальныеСНДС
|		КОНЕЦ) КАК МатериальныеСНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ТрудозатратыСНДС
|		КОНЕЦ) КАК ТрудозатратыСНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПостоянныеСНДС
|		КОНЕЦ) КАК ПостатейныеПостоянныеСНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПеременныеСНДС
|		КОНЕЦ) КАК ПостатейныеПеременныеСНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ДопРасходыСНДС
|		КОНЕЦ) КАК ДопРасходыСНДС,
|	// Стоимости без НДС
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.МатериальныеБезНДС
|		КОНЕЦ) КАК МатериальныеБезНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПостоянныеБезНДС
|		КОНЕЦ) КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПеременныеБезНДС
|		КОНЕЦ) КАК ПостатейныеПеременныеБезНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ДопРасходыБезНДС
|		КОНЕЦ) КАК ДопРасходыБезНДС,
|	// Стоимости Упр
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.МатериальныеУпр
|		КОНЕЦ) КАК МатериальныеУпр,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ТрудозатратыУпр
|		КОНЕЦ) КАК ТрудозатратыУпр,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПостоянныеУпр
|		КОНЕЦ) КАК ПостатейныеПостоянныеУпр,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПеременныеУпр
|		КОНЕЦ) КАК ПостатейныеПеременныеУпр,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ДопРасходыУпр
|		КОНЕЦ) КАК ДопРасходыУпр,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.СтоимостьЗабалансоваяУпр
|		КОНЕЦ) КАК СтоимостьЗабалансоваяУпр,
|	// Стоимости Регл
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.МатериальныеРегл
|		КОНЕЦ) КАК МатериальныеРегл,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ТрудозатратыРегл
|		КОНЕЦ) КАК ТрудозатратыРегл,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПостоянныеРегл
|		КОНЕЦ) КАК ПостатейныеПостоянныеРегл,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПеременныеРегл
|		КОНЕЦ) КАК ПостатейныеПеременныеРегл,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ДопРасходыРегл
|		КОНЕЦ) КАК ДопРасходыРегл,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.СтоимостьЗабалансоваяРегл
|		КОНЕЦ) КАК СтоимостьЗабалансоваяРегл,
|
|	// Налоговый учет
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.НалоговыйУчет
|		КОНЕЦ) КАК НалоговыйУчет,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостояннаяРазница
|		КОНЕЦ) КАК ПостояннаяРазница,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ВременнаяРазница
|		КОНЕЦ) КАК ВременнаяРазница
|
|ПОМЕСТИТЬ РасходПартийСводно
|ИЗ
|	ПредварительныйРасходПартий КАК Т
|		ЛЕВОЕ СОЕДИНЕНИЕ ИнтервалыРасходаПартий КАК Интервалы
|		ПО Т.КорАналитикаУчетаНоменклатуры = Интервалы.АналитикаУчетаНоменклатуры
|			И Т.КорПартия = Интервалы.Партия
|			И Т.Организация = Интервалы.Организация
|			И Т.ПартияПродукции = Интервалы.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Интервалы.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ ПредварительныйРасходПартий КАК Расход
|		ПО Т.КорАналитикаУчетаНоменклатуры = Расход.КорАналитикаУчетаНоменклатуры
|			И Т.КорПартия = Расход.КорПартия
|			И Т.АналитикаУчетаНоменклатуры = Расход.АналитикаУчетаНоменклатуры
|			И Т.АналитикаУчетаПартий = Расход.АналитикаУчетаПартий
|			И Т.Партия = Расход.Партия
|			И Т.Период >= Расход.Период
|			И (Расход.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
|			И Т.Организация = Расход.Организация
|			И Т.ПартияПродукции = Расход.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Расход.АналитикаУчетаПартийПродукции
|ГДЕ
|	Т.Период МЕЖДУ Интервалы.НачалоПериода И Интервалы.КонецПериода
|		ИЛИ Интервалы.НачалоПериода ЕСТЬ NULL
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	Т.Период,
|	Т.КорАналитикаУчетаНоменклатуры,
|	Т.КорПартия,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.АналитикаУчетаПартий,
|	Т.Партия,
|	Т.ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `ПервичныеЗатратыПоПериодам`.
//
// Назначение запроса:
//  Рассчитывает первичные затраты по периодам (в т.ч. корректировки при списании остатка) на базе:
//  `ПредварительныйРасходПартий`, `ПартииСводно` (как приход) и `РасходПартийСводно` (как расход).
//  Таблица является источником для выбора первичных партий и дальнейшего построения перечня полуфабрикатов.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ПервичныеЗатратыПоПериодам`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется.
Функция ikon_cost_ТекстЗапроса_ПервичныеЗатратыПоПериодам()
	
	Возврат
"ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	Т.Период КАК Период,
|	Т.КорАналитикаУчетаНоменклатуры,
|	Т.КорПартия КАК КорПартия,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.АналитикаУчетаПартий,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	Т.Числитель								КАК Числитель,
|	Т.Знаменатель							КАК Знаменатель,
|	Т.ВключитьНДСВСтоимость КАК ВключитьНДСВСтоимость,
|	Т.ИсключитьНДСИзСтоимости КАК ИсключитьНДСИзСтоимости,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.Количество - Расход.Количество
|		ИНАЧЕ Т.Количество
|	КОНЕЦ КАК Количество,
|	// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.Материальные - Расход.Материальные
|		ИНАЧЕ Т.Материальные
|	КОНЕЦ КАК Материальные,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.Трудозатраты - Расход.Трудозатраты
|		ИНАЧЕ Т.Трудозатраты
|	КОНЕЦ КАК Трудозатраты,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПостоянные - Расход.ПостатейныеПостоянные
|		ИНАЧЕ Т.ПостатейныеПостоянные
|	КОНЕЦ КАК ПостатейныеПостоянные,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПеременные - Расход.ПостатейныеПеременные
|		ИНАЧЕ Т.ПостатейныеПеременные
|	КОНЕЦ КАК ПостатейныеПеременные,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ДопРасходы - Расход.ДопРасходы
|		ИНАЧЕ Т.ДопРасходы
|	КОНЕЦ КАК ДопРасходы,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.СуммаЗатратаЗабалансовая - Расход.СуммаЗатратаЗабалансовая
|		ИНАЧЕ Т.СуммаЗатратаЗабалансовая
|	КОНЕЦ КАК СуммаЗатратаЗабалансовая,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.СуммаЗатрата - Расход.СуммаЗатрата
|		ИНАЧЕ Т.СуммаЗатрата
|	КОНЕЦ КАК СуммаЗатрата,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.НДД - Расход.НДД
|		ИНАЧЕ Т.НДД
|	КОНЕЦ КАК НДД,
|
|	// Стоимости с НДС
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.МатериальныеСНДС - Расход.МатериальныеСНДС
|		ИНАЧЕ Т.МатериальныеСНДС
|	КОНЕЦ КАК МатериальныеСНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ТрудозатратыСНДС - Расход.ТрудозатратыСНДС
|		ИНАЧЕ Т.ТрудозатратыСНДС
|	КОНЕЦ КАК ТрудозатратыСНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПостоянныеСНДС - Расход.ПостатейныеПостоянныеСНДС
|		ИНАЧЕ Т.ПостатейныеПостоянныеСНДС
|	КОНЕЦ КАК ПостатейныеПостоянныеСНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПеременныеСНДС - Расход.ПостатейныеПеременныеСНДС
|		ИНАЧЕ Т.ПостатейныеПеременныеСНДС
|	КОНЕЦ КАК ПостатейныеПеременныеСНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ДопРасходыСНДС - Расход.ДопРасходыСНДС
|		ИНАЧЕ Т.ДопРасходыСНДС
|	КОНЕЦ КАК ДопРасходыСНДС,
|
|	// Стоимости без НДС
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.МатериальныеБезНДС - Расход.МатериальныеБезНДС
|		ИНАЧЕ Т.МатериальныеБезНДС
|	КОНЕЦ КАК МатериальныеБезНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПостоянныеБезНДС - Расход.ПостатейныеПостоянныеБезНДС
|		ИНАЧЕ Т.ПостатейныеПостоянныеБезНДС
|	КОНЕЦ КАК ПостатейныеПостоянныеБезНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПеременныеБезНДС - Расход.ПостатейныеПеременныеБезНДС
|		ИНАЧЕ Т.ПостатейныеПеременныеБезНДС
|	КОНЕЦ КАК ПостатейныеПеременныеБезНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ДопРасходыБезНДС - Расход.ДопРасходыБезНДС
|		ИНАЧЕ Т.ДопРасходыБезНДС
|	КОНЕЦ КАК ДопРасходыБезНДС,
|
|	// Стоимости Упр
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.МатериальныеУпр - Расход.МатериальныеУпр
|		ИНАЧЕ Т.МатериальныеУпр
|	КОНЕЦ КАК МатериальныеУпр,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ТрудозатратыУпр - Расход.ТрудозатратыУпр
|		ИНАЧЕ Т.ТрудозатратыУпр
|	КОНЕЦ КАК ТрудозатратыУпр,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПостоянныеУпр - Расход.ПостатейныеПостоянныеУпр
|		ИНАЧЕ Т.ПостатейныеПостоянныеУпр
|	КОНЕЦ КАК ПостатейныеПостоянныеУпр,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПеременныеУпр - Расход.ПостатейныеПеременныеУпр
|		ИНАЧЕ Т.ПостатейныеПеременныеУпр
|	КОНЕЦ КАК ПостатейныеПеременныеУпр,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ДопРасходыУпр - Расход.ДопРасходыУпр
|		ИНАЧЕ Т.ДопРасходыУпр
|	КОНЕЦ КАК ДопРасходыУпр,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.СтоимостьЗабалансоваяУпр - Расход.СтоимостьЗабалансоваяУпр
|		ИНАЧЕ Т.СтоимостьЗабалансоваяУпр
|	КОНЕЦ КАК СтоимостьЗабалансоваяУпр,
|
|	// Стоимости Регл
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.МатериальныеРегл - Расход.МатериальныеРегл
|		ИНАЧЕ Т.МатериальныеРегл
|	КОНЕЦ КАК МатериальныеРегл,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ТрудозатратыРегл - Расход.ТрудозатратыРегл
|		ИНАЧЕ Т.ТрудозатратыРегл
|	КОНЕЦ КАК ТрудозатратыРегл,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПостоянныеРегл - Расход.ПостатейныеПостоянныеРегл
|		ИНАЧЕ Т.ПостатейныеПостоянныеРегл
|	КОНЕЦ КАК ПостатейныеПостоянныеРегл,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПеременныеРегл - Расход.ПостатейныеПеременныеРегл
|		ИНАЧЕ Т.ПостатейныеПеременныеРегл
|	КОНЕЦ КАК ПостатейныеПеременныеРегл,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ДопРасходыРегл - Расход.ДопРасходыРегл
|		ИНАЧЕ Т.ДопРасходыРегл
|	КОНЕЦ КАК ДопРасходыРегл,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.СтоимостьЗабалансоваяРегл - Расход.СтоимостьЗабалансоваяРегл
|		ИНАЧЕ Т.СтоимостьЗабалансоваяРегл
|	КОНЕЦ КАК СтоимостьЗабалансоваяРегл,
|
|	// Налоговый учет
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.НалоговыйУчет - Расход.НалоговыйУчет
|		ИНАЧЕ Т.НалоговыйУчет
|	КОНЕЦ КАК НалоговыйУчет,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостояннаяРазница - Расход.ПостояннаяРазница
|		ИНАЧЕ Т.ПостояннаяРазница
|	КОНЕЦ КАК ПостояннаяРазница,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ВременнаяРазница - Расход.ВременнаяРазница
|		ИНАЧЕ Т.ВременнаяРазница
|	КОНЕЦ КАК ВременнаяРазница
|
|ПОМЕСТИТЬ ПервичныеЗатратыПоПериодам
|ИЗ
|	ПредварительныйРасходПартий КАК Т
|		ЛЕВОЕ СОЕДИНЕНИЕ РасходПартийСводно КАК Расход
|		ПО Т.КорАналитикаУчетаНоменклатуры = Расход.КорАналитикаУчетаНоменклатуры
|			И Т.КорПартия = Расход.КорПартия
|			И Т.АналитикаУчетаНоменклатуры = Расход.АналитикаУчетаНоменклатуры
|			И Т.АналитикаУчетаПартий = Расход.АналитикаУчетаПартий
|			И Т.Партия = Расход.Партия
|			И Т.Период = Расход.Период
|			И Т.Организация = Расход.Организация
|			И Т.ПартияПродукции = Расход.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Расход.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ ПартииСводно КАК Приход
|		ПО Т.КорАналитикаУчетаНоменклатуры = Приход.КорАналитикаУчетаНоменклатуры
|			И Т.КорПартия = Приход.КорПартия
|			И Т.АналитикаУчетаНоменклатуры = Приход.АналитикаУчетаНоменклатуры
|			И Т.АналитикаУчетаПартий = Приход.АналитикаУчетаПартий
|			И Т.Партия = Приход.Партия
|			И Т.Период = Приход.Период
|			И Т.Организация = Приход.Организация
|			И Т.ПартияПродукции = Приход.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Приход.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";
КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `ПервичныеПартииСводно`.
//
// Назначение запроса:
//  Выделяет уникальный перечень первичных партий (организация + аналитика номенклатуры/партий + партия),
//  участвующих в расчёте `ПервичныеЗатратыПоПериодам`. Используется далее для определения партий полуфабрикатов.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ПервичныеПартииСводно`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется.
Функция ikon_cost_ТекстЗапроса_ПервичныеПартииСводно()
	
	Возврат
"ВЫБРАТЬ РАЗЛИЧНЫЕ
|	Т.Организация КАК Организация,
|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
|	Т.Партия КАК Партия
|ПОМЕСТИТЬ ПервичныеПартииСводно
|ИЗ
|	ПервичныеЗатратыПоПериодам КАК Т
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия
|;";
КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `ПартииПолуфабрикатов`.
//
// Назначение запроса:
//  Определяет партии, которые являются полуфабрикатами (по данным регистра себестоимости и аналитики учёта партий),
//  чтобы далее корректно помечать строки как требующие разузлования и строить связи «материалы → полуфабрикаты → продукция».
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ПартииПолуфабрикатов`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется.
Функция ikon_cost_ТекстЗапроса_ПартииПолуфабрикатов()
	
	Возврат
"ВЫБРАТЬ РАЗЛИЧНЫЕ
|	ВЫБОР КОГДА &ДанныеПоСебестоимости < 3
|		ТОГДА НЕОПРЕДЕЛЕНО
|		ИНАЧЕ СебестоимостьТоваров.Организация
|	КОНЕЦ КАК Организация,
|	ПП.Партия КАК Партия,
|	ПП.АналитикаУчетаПартий,
|	ПП.АналитикаУчетаНоменклатуры
|ПОМЕСТИТЬ ПартииПолуфабрикатов
|ИЗ
|	ПервичныеПартииСводно КАК ПП
|
|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
|		ПО СебестоимостьТоваров.Регистратор = ПП.Партия
|		И СебестоимостьТоваров.АналитикаУчетаПартий = ПП.АналитикаУчетаПартий
|		И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
|		И СебестоимостьТоваров.Организация = ПП.Организация
|
|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартий КАК АналитикиУчетаПартий
|		ПО СебестоимостьТоваров.АналитикаУчетаПартий = АналитикиУчетаПартий.КлючАналитики
|
|ГДЕ
|	СебестоимостьТоваров.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
|	И СебестоимостьТоваров.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
|													ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
|													ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение),
|													ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемПередачаРаботМеждуФилиалами),
|													ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
|	И НЕ АналитикиУчетаПартий.КодСтроки = 0
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия
|;";
КонецФункции

// Формирует текст SQL-фрагмента для объединения материальных затрат (часть общего запроса затрат на продукцию).
//
// Назначение запроса:
//  Возвращает SELECT для материальных затрат, который затем объединяется (ОБЪЕДИНИТЬ ВСЕ) с другими видами затрат
//  (трудозатраты, прочие, доп. расходы) при формировании итоговой таблицы затрат узла.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса/фрагмента (используется как часть пакета запросов)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется напрямую; пропорции учитываются через поля Числитель/Знаменатель
//  в данных `НЗППоПродукции` (а при пакетной обработке эти поля подменяются на уровне набора данных через ВТПарыУзлов).
Функция ikon_cost_ТекстЗапроса_ТекстМатериальныеЗатратыОбъединение()
	
	Возврат
"ВЫБРАТЬ
|	НЗППоПродукции.Организация							КАК Организация,
|	НЗППоПродукции.ПартияПродукции						КАК ПартияВыходноеИзделие,
|	НЗППоПродукции.АналитикаУчетаПартийПродукции		КАК АналитикаУчетаПартийВыходноеИзделие,
|	НЗППоПродукции.АналитикаУчетаПродукции				КАК АналитикаУчетаВыходноеИзделие,
|	ПартииМатериалов.Партия								КАК ПартияЗатрата,
|	ПартииМатериалов.АналитикаУчетаПартий				КАК АналитикаУчетаПартийЗатрата,
|	ПартииМатериалов.ВключитьНДСВСтоимость				КАК ВключитьНДСВСтоимость,
|	ПартииМатериалов.ИсключитьНДСИзСтоимости			КАК ИсключитьНДСИзСтоимости,
|	ПартииМатериалов.АналитикаУчетаНоменклатуры			КАК АналитикаУчетаЗатрата,
|	АналитикаЗатрат.Номенклатура						КАК Затрата,
|	АналитикаЗатрат.Номенклатура.ЕдиницаИзмерения 		КАК ЕдиницаИзмеренияЗатрата,
|	АналитикаЗатрат.Характеристика						КАК ХарактеристикаЗатрата,
|	АналитикаЗатрат.Серия								КАК СерияЗатрата,
|	АналитикаЗатрат.Назначение							КАК НазначениеЗатрата,
|	АналитикаЗатрат.СтатьяКалькуляции					КАК СтатьяКалькуляции,
|	АналитикаЗатрат.МестоХранения                       КАК Подразделение,
|	(ВЫБОР
|		КОГДА НЗППоПродукции.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
|			ТОГДА ЛОЖЬ
|	// Для возвратных отходов разузлования не требуется. 
|		КОГДА АналитикаЗатрат.СтатьяКалькуляции.ТипЗатрат = ЗНАЧЕНИЕ(Перечисление.ТипыЗатрат.ВозвратныеОтходы)
|			ТОГДА ЛОЖЬ
|	//++ НЕ УТКА
|
|	// Разузловывать затраты переработчика, если отчет формируется в валюте регл./упр. учета, по давальцу, не нужно
|		КОГДА &ДанныеПоСебестоимости > 3
|			И НЗППоПродукции.Организация = ЕСТЬNULL(ОтчетДавальцуМеждуОрганизациями.Давалец, НЕОПРЕДЕЛЕНО)
|				ТОГДА ЛОЖЬ
|	//-- НЕ УТКА
|		КОГДА ПартииПолуфабрикатов.Партия ЕСТЬ НЕ NULL
|			ТОГДА ИСТИНА
|		ИНАЧЕ ЛОЖЬ КОНЕЦ) 								КАК ТребуетсяРазузлование,
|	(ВЫБОР
|		КОГДА НЗППоПродукции.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
|			ТОГДА ЛОЖЬ
|	//++ НЕ УТКА
|
|	// Разузловывать затраты переработчика, если отчет формируется в валюте регл./упр. учета, по давальцу, не нужно
|		КОГДА &ДанныеПоСебестоимости > 3
|			И НЗППоПродукции.Организация = ЕСТЬNULL(ОтчетДавальцуМеждуОрганизациями.Давалец, НЕОПРЕДЕЛЕНО)
|				ТОГДА ЛОЖЬ
|	//-- НЕ УТКА
|		КОГДА &РазворачиватьДопРасходы
|			ТОГДА ИСТИНА
|		ИНАЧЕ ЛОЖЬ КОНЕЦ) 								КАК ТребуетсяРазузлованиеДопРасходов,
|	&ТипЗатратМатериальные								КАК ТипЗатрат,
|	ПартииМатериалов.Количество
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК КоличествоЗатрата,
|
|	// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	ПартииМатериалов.Материальные
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК Материальные,
|	ПартииМатериалов.Трудозатраты
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК Трудозатраты,
|	ПартииМатериалов.ПостатейныеПостоянные
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянные,
|	ПартииМатериалов.ПостатейныеПеременные
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременные,
|	ПартииМатериалов.ДопРасходы
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДопРасходы,
|	ПартииМатериалов.СуммаЗатратаЗабалансовая
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК СуммаЗатратаЗабалансовая,
|	ПартииМатериалов.СуммаЗатрата
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК СуммаЗатрата,
|	ПартииМатериалов.НДД
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК НДД,
|
|	// Стоимости с НДС
|	ПартииМатериалов.МатериальныеСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК МатериальныеСНДС,
|	ПартииМатериалов.ТрудозатратыСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ТрудозатратыСНДС,
|	ПартииМатериалов.ПостатейныеПостоянныеСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеСНДС,
|	ПартииМатериалов.ПостатейныеПеременныеСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеСНДС,
|	ПартииМатериалов.ДопРасходыСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДопРасходыСНДС,
|
|	// Стоимости без НДС
|	ПартииМатериалов.МатериальныеБезНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК МатериальныеБезНДС,
|	ПартииМатериалов.ПостатейныеПостоянныеБезНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеБезНДС,
|	ПартииМатериалов.ПостатейныеПеременныеБезНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеБезНДС,
|	ПартииМатериалов.ДопРасходыБезНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДопРасходыБезНДС,
|
|	// Стоимости Упр
|	ПартииМатериалов.МатериальныеУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК МатериальныеУпр,
|	ПартииМатериалов.ТрудозатратыУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10))	КАК ТрудозатратыУпр,
|	ПартииМатериалов.ПостатейныеПостоянныеУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеУпр,
|	ПартииМатериалов.ПостатейныеПеременныеУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель	/ НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеУпр,
|	ПартииМатериалов.ДопРасходыУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДопРасходыУпр,
|	ПартииМатериалов.СтоимостьЗабалансоваяУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель  КАК ЧИСЛО(31,10)) КАК СтоимостьЗабалансоваяУпр,
|
|	// Стоимости Регл
|	ПартииМатериалов.МатериальныеРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК МатериальныеРегл,
|	ПартииМатериалов.ТрудозатратыРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ТрудозатратыРегл,
|	ПартииМатериалов.ПостатейныеПостоянныеРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеРегл,
|	ПартииМатериалов.ПостатейныеПеременныеРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеРегл,
|	ПартииМатериалов.ДопРасходыРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДопРасходыРегл,
|	ПартииМатериалов.СтоимостьЗабалансоваяРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК СтоимостьЗабалансоваяРегл,
|
|	// Налоговый учет
|	ПартииМатериалов.НалоговыйУчет
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК НалоговыйУчет,
|	ПартииМатериалов.ПостояннаяРазница
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостояннаяРазница,
|	ПартииМатериалов.ВременнаяРазница
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ВременнаяРазница
|
|ИЗ
|	ВыбытиеИзНЗППоПродукции КАК НЗППоПродукции
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПервичныеЗатратыПоПериодам КАК ПартииМатериалов
|		ПО НЗППоПродукции.Период = ПартииМатериалов.Период
|			И НЗППоПродукции.АналитикаУчетаНоменклатуры = ПартииМатериалов.КорАналитикаУчетаНоменклатуры
|			И НЗППоПродукции.Партия = ПартииМатериалов.КорПартия
|			И НЗППоПродукции.ПартияПродукции = ПартииМатериалов.ПартияПродукции
|			И НЗППоПродукции.АналитикаУчетаПартийПродукции = ПартииМатериалов.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаЗатрат
|		ПО НЗППоПродукции.АналитикаУчетаНоменклатуры = АналитикаЗатрат.КлючАналитики
|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбытиеИзНЗП КАК ВыбытиеСводно
|		ПО НЗППоПродукции.Период = ВыбытиеСводно.Период
|			И НЗППоПродукции.АналитикаУчетаНоменклатуры = ВыбытиеСводно.АналитикаУчетаНоменклатуры
|			И НЗППоПродукции.Партия = ВыбытиеСводно.Партия
|			И НЗППоПродукции.ПартияПродукции = ВыбытиеСводно.ПартияПродукции
|			И НЗППоПродукции.АналитикаУчетаПартийПродукции = ВыбытиеСводно.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ ПартииПолуфабрикатов КАК ПартииПолуфабрикатов
|	
|		ПО ПартииМатериалов.Партия = ПартииПолуфабрикатов.Партия
|			И ПартииМатериалов.АналитикаУчетаПартий = ПартииПолуфабрикатов.АналитикаУчетаПартий
|			И ПартииМатериалов.АналитикаУчетаНоменклатуры = ПартииПолуфабрикатов.АналитикаУчетаНоменклатуры
|			И (НЕ НЗППоПродукции.ПартияПродукции = ПартииПолуфабрикатов.Партия
|				ИЛИ НЕ НЗППоПродукции.АналитикаУчетаПартийПродукции = ПартииПолуфабрикатов.АналитикаУчетаПартий
|				ИЛИ НЕ НЗППоПродукции.АналитикаУчетаПродукции = ПартииПолуфабрикатов.АналитикаУчетаНоменклатуры)
|			И (ПартииПолуфабрикатов.Организация = НЗППоПродукции.Организация
|				ИЛИ &ДанныеПоСебестоимости < 3)
|	//++ НЕ УТКА
|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетДавальцуМеждуОрганизациями КАК ОтчетДавальцуМеждуОрганизациями
|		ПО (ОтчетДавальцуМеждуОрганизациями.Ссылка = ПартииМатериалов.Партия)
|	//-- НЕ УТКА
|";
КонецФункции

// Формирует текст SQL-фрагмента для объединения начальных остатков НЗП (часть общего запроса затрат на продукцию).
//
// Назначение запроса:
//  Возвращает SELECT, который добавляет в общий набор затрат «начальные остатки» по НЗП как материальные затраты,
//  чтобы итоговая себестоимость узла учитывала стартовую базу затрат (до движения в периоде).
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса/фрагмента
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется напрямую; пропорция учитывается через Числитель/Знаменатель в данных `НЗППоПродукции`
//  (при пакетной обработке подмена коэффициентов выполняется на уровне набора данных).
Функция ikon_cost_ТекстЗапроса_ТекстМатериалыНачальныеОстаткиНЗПОбъединение()
	
	Возврат
"ВЫБРАТЬ
|	НЗППоПродукции.Организация							КАК Организация,
|	НЗППоПродукции.ПартияПродукции						КАК ПартияВыходноеИзделие,
|	НЗППоПродукции.АналитикаУчетаПартийПродукции		КАК АналитикаУчетаПартийВыходноеИзделие,
|	НЗППоПродукции.АналитикаУчетаПродукции				КАК АналитикаУчетаВыходноеИзделие,
|	НЗППоПродукции.Партия								КАК ПартияЗатрата,
|	НЕОПРЕДЕЛЕНО										КАК АналитикаУчетаПартийЗатрата,
|	ЛОЖЬ												КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ												КАК ИсключитьНДСИзСтоимости,
|	НЗППоПродукции.АналитикаУчетаНоменклатуры			КАК АналитикаУчетаЗатрата,
|	АналитикаЗатрат.Номенклатура						КАК Затрата,
|	АналитикаЗатрат.Номенклатура.ЕдиницаИзмерения 		КАК ЕдиницаИзмеренияЗатрата,
|	АналитикаЗатрат.Характеристика						КАК ХарактеристикаЗатрата,
|	АналитикаЗатрат.Серия								КАК СерияЗатрата,
|	АналитикаЗатрат.Назначение							КАК НазначениеЗатрата,
|	АналитикаЗатрат.СтатьяКалькуляции					КАК СтатьяКалькуляции,
|	АналитикаЗатрат.МестоХранения                       КАК Подразделение,
|	ЛОЖЬ												КАК ТребуетсяРазузлование,
|	ЛОЖЬ												КАК ТребуетсяРазузлованиеДопРасходов,
|	&ТипЗатратМатериальные								КАК ТипЗатрат,
|	НЗППоПродукции.Количество
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК КоличествоЗатрата,
|
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	НЗППоПродукции.Материальные
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК Материальные,
|	НЗППоПродукции.Трудозатраты
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК Трудозатраты,
|	НЗППоПродукции.ПостатейныеПостоянные
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянные,
|	НЗППоПродукции.ПостатейныеПеременные
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременные,
|	НЗППоПродукции.ДопРасходы
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДопРасходы,
|	НЗППоПродукции.СуммаЗатратаЗабалансовая
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК СуммаЗатратаЗабалансовая,
|	НЗППоПродукции.СуммаЗатрата
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК СуммаЗатрата,
|	НЗППоПродукции.НДД
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК НДД,
|
|// Стоимости с НДС
|	НЗППоПродукции.МатериальныеСНДС
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК МатериальныеСНДС,
|	НЗППоПродукции.ТрудозатратыСНДС
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ТрудозатратыСНДС,
|	НЗППоПродукции.ПостатейныеПостоянныеСНДС
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеСНДС,
|	НЗППоПродукции.ПостатейныеПеременныеСНДС
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеСНДС,
|	НЗППоПродукции.ДопРасходыСНДС
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДопРасходыСНДС,
|
|// Стоимости без НДС
|	НЗППоПродукции.МатериальныеБезНДС
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК МатериальныеБезНДС,
|	НЗППоПродукции.ПостатейныеПостоянныеБезНДС
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеБезНДС,
|	НЗППоПродукции.ПостатейныеПеременныеБезНДС
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеБезНДС,
|	НЗППоПродукции.ДопРасходыБезНДС
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДопРасходыБезНДС,
|
|// Стоимости Упр
|	НЗППоПродукции.МатериальныеУпр
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК МатериальныеУпр,
|	НЗППоПродукции.ТрудозатратыУпр
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ТрудозатратыУпр,
|	НЗППоПродукции.ПостатейныеПостоянныеУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель	/ НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеУпр,
|	НЗППоПродукции.ПостатейныеПеременныеУпр
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеУпр,
|	НЗППоПродукции.ДопРасходыУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель	/ НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыУпр,
|	НЗППоПродукции.СтоимостьЗабалансоваяУпр
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК СтоимостьЗабалансоваяУпр,
|
|// Стоимости Регл
|	НЗППоПродукции.МатериальныеРегл
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК МатериальныеРегл,
|	НЗППоПродукции.ТрудозатратыРегл
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ТрудозатратыРегл,
|	НЗППоПродукции.ПостатейныеПостоянныеРегл
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеРегл,
|	НЗППоПродукции.ПостатейныеПеременныеРегл
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеРегл,
|	НЗППоПродукции.ДопРасходыРегл
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДопРасходыРегл,
|	НЗППоПродукции.СтоимостьЗабалансоваяРегл
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК СтоимостьЗабалансоваяРегл,
|
|// Налоговый учет
|	НЗППоПродукции.НалоговыйУчет
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК НалоговыйУчет,
|	НЗППоПродукции.ПостояннаяРазница
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ПостояннаяРазница,
|	НЗППоПродукции.ВременнаяРазница
|		* ВЫРАЗИТЬ(ВЫБОР КОГДА НЗППоПродукции.Знаменатель = 0 ТОГДА 1 ИНАЧЕ НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КОНЕЦ КАК ЧИСЛО(31,10)) КАК ВременнаяРазница
|
|ИЗ
|	ВыбытиеИзНЗППоПродукции КАК НЗППоПродукции
|// ПАКЕТНАЯ ОПТИМИЗАЦИЯ: добавляем фильтр по ПартияПродукции для предотвращения декартова произведения
|		ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеЗатратыПоПериодам КАК ПартииМатериалов
|	    ПО НЗППоПродукции.Период = ПартииМатериалов.Период
|			И НЗППоПродукции.АналитикаУчетаНоменклатуры = ПартииМатериалов.КорАналитикаУчетаНоменклатуры
|			И НЗППоПродукции.Партия = ПартииМатериалов.КорПартия
|			И НЗППоПродукции.ПартияПродукции = ПартииМатериалов.ПартияПродукции
|			И НЗППоПродукции.АналитикаУчетаПартийПродукции = ПартииМатериалов.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаЗатрат
|		ПО НЗППоПродукции.АналитикаУчетаНоменклатуры = АналитикаЗатрат.КлючАналитики
|ГДЕ
|	ПартииМатериалов.Партия ЕСТЬ NULL
|";
КонецФункции

// Формирует текст SQL-фрагмента для объединения трудозатрат (часть общего запроса затрат на продукцию).
//
// Назначение запроса:
//  Возвращает SELECT по регистру `ТрудозатратыНезавершенногоПроизводства`, который добавляется в общий набор затрат узла
//  и масштабируется на коэффициент `ВыпущеннаяПродукция.Числитель/Знаменатель`.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса/фрагмента
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется напрямую; пропорция берётся из `ВыпущеннаяПродукция` (в пакетном режиме коэффициенты
//  могут быть подменены через ВТПарыУзлов на уровне формирования набора данных).
Функция ikon_cost_ТекстЗапроса_ТекстТрудозатратыОбъединение()
	
	Возврат
"ВЫБРАТЬ
|	ТрудозатратыНЗП.Организация						КАК Организация,
|	ТрудозатратыНЗП.Регистратор						КАК ПартияВыходноеИзделие,
|	ТрудозатратыНЗП.КорАналитикаУчетаПартий			КАК АналитикаУчетаПартийВыходноеИзделие,
|	ТрудозатратыНЗП.КорАналитикаУчетаПродукции		КАК АналитикаУчетаВыходноеИзделие,
|	НЕОПРЕДЕЛЕНО									КАК ПартияЗатрата,
|	НЕОПРЕДЕЛЕНО									КАК АналитикаУчетаПартийЗатрата,
|	ЛОЖЬ											КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ											КАК ИсключитьНДСИзСтоимости,
|	ТрудозатратыНЗП.ВидРабот						КАК АналитикаЗатрата,
|	ТрудозатратыНЗП.ВидРабот						КАК Затрата,
|	СпрВидыРабот.ЕдиницаИзмерения					КАК ЕдиницаИзмеренияЗатрата,
|	НЕОПРЕДЕЛЕНО									КАК ХарактеристикаЗатрата,
|	НЕОПРЕДЕЛЕНО									КАК СерияЗатрата,
|	НЕОПРЕДЕЛЕНО									КАК НазначениеЗатрата,
|	ТрудозатратыНЗП.СтатьяКалькуляции				КАК СтатьяКалькуляции,
|	ТрудозатратыНЗП.Подразделение					КАК Подразделение,
|	ЛОЖЬ											КАК ТребуетсяРазузлование,
|	ЛОЖЬ											КАК ТребуетсяРазузлованиеДопРасходов,
|	&ТипЗатратТрудозатраты							КАК ТипЗатрат,
|	СУММА(ТрудозатратыНЗП.Количество
|		* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК КоличествоЗатрата,
|
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	0												КАК Материальные,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ТрудозатратыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ТрудозатратыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ТрудозатратыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ТрудозатратыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК Трудозатраты,
|	0												КАК ПостатейныеПостоянные,
|	0												КАК ПостатейныеПеременные,
|	0												КАК ДопРасходы,
|	0												КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ТрудозатратыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ТрудозатратыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ТрудозатратыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ТрудозатратыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА ТрудозатратыНЗП.СтоимостьНДД
|			ИНАЧЕ 0
|		КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК НДД,
|
|// Стоимости с НДС
|	0												КАК МатериальныеСНДС,
|	СУММА(ТрудозатратыНЗП.Стоимость
|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ТрудозатратыСНДС,
|	0												КАК ПостатейныеПостоянныеСНДС,
|	0												КАК ПостатейныеПеременныеСНДС,
|	0												КАК ДопРасходыСНДС,
|
|// Стоимости без НДС
|	0												КАК МатериальныеБезНДС,
|	0												КАК ПостатейныеПостоянныеБезНДС,
|	0												КАК ПостатейныеПеременныеБезНДС,
|	0												КАК ДопРасходыБезНДС,
|
|// Стоимости Упр
|	0												КАК МатериальныеУпр,
|	СУММА(ТрудозатратыНЗП.Стоимость
|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ТрудозатратыУпр,
|	0												КАК ПостатейныеПостоянныеУпр,
|	0												КАК ПостатейныеПеременныеУпр,
|	0												КАК ДопРасходыУпр,
|	0												КАК СтоимостьЗабалансоваяУпр,
|
|// Стоимости Регл
|	0												КАК МатериальныеРегл,
|	СУММА(ТрудозатратыНЗП.СтоимостьРегл
|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ТрудозатратыРегл,
|	0												КАК ПостатейныеПостоянныеРегл,
|	0												КАК ПостатейныеПеременныеРегл,
|	0												КАК ДопРасходыРегл,
|	0												КАК СтоимостьЗабалансоваяРегл,
|
|// Налоговый учет
|	СУММА((ТрудозатратыНЗП.СтоимостьРегл
|		- ТрудозатратыНЗП.ПостояннаяРазница
|		- ТрудозатратыНЗП.ВременнаяРазница)
|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК НалоговыйУчет,
|	СУММА(ТрудозатратыНЗП.ПостояннаяРазница
|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ПостояннаяРазница,
|	СУММА(ТрудозатратыНЗП.ВременнаяРазница
|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ВременнаяРазница
|
|ИЗ
|	ВыпущеннаяПродукция КАК ВыпущеннаяПродукция
|
|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ТрудозатратыНЗП
|		ПО ТрудозатратыНЗП.Организация = ВыпущеннаяПродукция.Организация
|		И ВыпущеннаяПродукция.ПартияПродукции = ТрудозатратыНЗП.Регистратор
|		И ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции = ТрудозатратыНЗП.КорАналитикаУчетаПартий
|		И ВыпущеннаяПродукция.АналитикаУчетаПродукции = ТрудозатратыНЗП.КорАналитикаУчетаПродукции
|
|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыРаботСотрудников КАК СпрВидыРабот
|		ПО СпрВидыРабот.Ссылка = ТрудозатратыНЗП.ВидРабот
|
|СГРУППИРОВАТЬ ПО
|	ТрудозатратыНЗП.Организация,
|	ТрудозатратыНЗП.ВидРабот,
|	ТрудозатратыНЗП.СтатьяКалькуляции,
|	СпрВидыРабот.ЕдиницаИзмерения,
|	ТрудозатратыНЗП.КорАналитикаУчетаПродукции,
|	ТрудозатратыНЗП.Регистратор,
|	ТрудозатратыНЗП.КорАналитикаУчетаПартий,
|	ТрудозатратыНЗП.Подразделение
|";
КонецФункции

// Формирует текст SQL-фрагмента для объединения прочих расходов (постатейных) (часть общего запроса затрат на продукцию).
//
// Назначение запроса:
//  Возвращает SELECT по регистру `ПрочиеРасходыНезавершенногоПроизводства`, раскладывая суммы на переменные/постоянные
//  и масштабируя их на коэффициент `ВыпущеннаяПродукция.Числитель/Знаменатель`. Фрагмент объединяется с другими видами затрат
//  в итоговом запросе себестоимости.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса/фрагмента
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется напрямую; пропорция учитывается через `ВыпущеннаяПродукция.Числитель/Знаменатель`.
Функция ikon_cost_ТекстЗапроса_ТекстПрочиеРасходыОбъединение()
	
	Возврат
"ВЫБРАТЬ
|	ПрочиеРасходыНЗП.Организация				КАК Организация,
|	ПрочиеРасходыНЗП.Регистратор				КАК ПартияВыходноеИзделие,
|	ПрочиеРасходыНЗП.КорАналитикаУчетаПартий	КАК АналитикаУчетаПартийВыходноеИзделие,
|	ПрочиеРасходыНЗП.АналитикаУчетаПродукции	КАК АналитикаУчетаВыходноеИзделие,
|	НЕОПРЕДЕЛЕНО								КАК ПартияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК АналитикаУчетаПартийЗатрата,
|	ЛОЖЬ										КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ										КАК ИсключитьНДСИзСтоимости,
|	ПрочиеРасходыНЗП.СтатьяРасходов				КАК АналитикаЗатрата,
|	ПрочиеРасходыНЗП.СтатьяРасходов				КАК Затрата,
|	НЕОПРЕДЕЛЕНО								КАК ЕдиницаИзмеренияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК ХарактеристикаЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК СерияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК НазначениеЗатрата,
|	ПрочиеРасходыНЗП.СтатьяКалькуляции			КАК СтатьяКалькуляции,
|	ПрочиеРасходыНЗП.Подразделение				КАК Подразделение,
|	ЛОЖЬ										КАК ТребуетсяРазузлование,
|	ЛОЖЬ										КАК ТребуетсяРазузлованиеДопРасходов,
|	&ТипЗатратПостатейные						КАК ТипЗатрат,
|	0											КАК КоличествоЗатрата,
|
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	0											КАК Материальные,
|	0											КАК Трудозатраты,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
|			ТОГДА 0
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ПрочиеРасходыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьУпр
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
|			ТОГДА 0
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ПрочиеРасходыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьУпр
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПеременные,
|	0											КАК ДопРасходы,
|	0											КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ПрочиеРасходыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьУпр
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьНДД
|		ИНАЧЕ 0
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК НДД,
|
|// Стоимости с НДС
|	0											КАК МатериальныеСНДС,
|	0											КАК ТрудозатратыСНДС,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.Стоимость
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ПостатейныеПостоянныеСНДС,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.Стоимость
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПеременныеСНДС,
|	0											КАК ДопРасходыСНДС,
|
|// Стоимости без НДС
|	0											КАК МатериальныеБезНДС,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьБезНДС
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьБезНДС
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПеременныеБезНДС,
|	0											КАК ДопРасходыБезНДС,
|
|// Стоимости Упр
|	0											КАК МатериальныеУпр,
|	0											КАК ТрудозатратыУпр,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьУпр
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПостоянныеУпр,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьУпр
|	КОНЕЦ * ВыпущеннаяПродукция.Числитель
|			/ ВыпущеннаяПродукция.Знаменатель)	КАК ПостатейныеПеременныеУпр,
|	0											КАК ДопРасходыУпр,
|	0											КАК СтоимостьЗабалансоваяУпр,
|
|// Стоимости Регл
|	0											КАК МатериальныеРегл,
|	0											КАК ТрудозатратыРегл,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПостоянныеРегл,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПеременныеРегл,
|	0											КАК ДопРасходыРегл,
|	0											КАК СтоимостьЗабалансоваяРегл,
|
|// Налоговый учет
|	СУММА((ПрочиеРасходыНЗП.СтоимостьРегл
|		- ПрочиеРасходыНЗП.ПостояннаяРазница
|		- ПрочиеРасходыНЗП.ВременнаяРазница)
|		* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК НалоговыйУчет,
|	СУММА(ПрочиеРасходыНЗП.ПостояннаяРазница
|		* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ПостояннаяРазница,
|	СУММА(ПрочиеРасходыНЗП.ВременнаяРазница
|		* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ВременнаяРазница
|
|ИЗ
|	ВыпущеннаяПродукция КАК ВыпущеннаяПродукция
|
|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ПрочиеРасходыНЗП
|		ПО ВыпущеннаяПродукция.Организация = ПрочиеРасходыНЗП.Организация
|		И ВыпущеннаяПродукция.ПартияПродукции = ПрочиеРасходыНЗП.Регистратор
|		И ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции = ПрочиеРасходыНЗП.КорАналитикаУчетаПартий
|		И ВыпущеннаяПродукция.АналитикаУчетаПродукции = ПрочиеРасходыНЗП.АналитикаУчетаПродукции
|
|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
|		ПО ПрочиеРасходыНЗП.СтатьяРасходов = СтатьиРасходов.Ссылка
|
|СГРУППИРОВАТЬ ПО
|	ПрочиеРасходыНЗП.Организация,
|	ПрочиеРасходыНЗП.СтатьяРасходов,
|	ПрочиеРасходыНЗП.СтатьяКалькуляции,
|	ПрочиеРасходыНЗП.АналитикаУчетаПродукции,
|	ПрочиеРасходыНЗП.Регистратор,
|	ПрочиеРасходыНЗП.КорАналитикаУчетаПартий,
|	ПрочиеРасходыНЗП.Подразделение
|";
КонецФункции

// Формирует текст SQL-запроса для создания временной таблицы `ВыбытиеИзНЗППоПродукции`.
//
// Назначение запроса:
//  Готовит базовую временную таблицу по выбытию затрат из НЗП в разрезе продукции (пара продукции + аналитика затрат),
//  которая далее используется как источник для сводных/объединяющих запросов по материальным затратам и начальным остаткам.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (с `ПОМЕСТИТЬ ВыбытиеИзНЗППоПродукции`)
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется; используются коэффициенты `ВыпущеннаяПродукция.Числитель/Знаменатель`,
//  которые при пакетной обработке могут быть получены через ВТПарыУзлов на уровне формирования набора данных `ВыпущеннаяПродукция`.
Функция ikon_cost_ТекстЗапроса_ВыбытиеИзНЗППоПродукции()
	
	Возврат
"ВЫБРАТЬ РАЗРЕШЕННЫЕ
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ) КАК Период,
|	ВыпущеннаяПродукция.Организация КАК Организация,
|	ВыпущеннаяПродукция.ПартияПродукции КАК ПартияПродукции,
|	ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	ВыпущеннаяПродукция.АналитикаУчетаПродукции КАК АналитикаУчетаПродукции,
|	ВыпущеннаяПродукция.Числитель КАК Числитель,
|	ВыпущеннаяПродукция.Знаменатель КАК Знаменатель,
|	СебестоимостьТоваров.Партия КАК Партия,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.ВидЗапасов КАК ВидЗапасов,
|	СУММА(СебестоимостьТоваров.Количество) КАК Количество,
|	// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|		КОНЕЦ)												КАК Материальные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
|		КОНЕЦ)												КАК Трудозатраты,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		КОНЕЦ)												КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		КОНЕЦ)												КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК ДопРасходы,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|				+ СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|				+ СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|				+ СебестоимостьТоваров.ТрудозатратыУпр
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
|				+ СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|				+ СебестоимостьТоваров.ТрудозатратыРегл
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|				+ СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
|			ИНАЧЕ 0
|		КОНЕЦ)												КАК НДД,
|
|	// Стоимости с НДС
|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,
|
|	// Стоимости без НДС
|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,
|
|	// Стоимости Упр
|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,
|
|	// Стоимости Регл
|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,
|
|	// Налоговый учет
|	СУММА(СебестоимостьТоваров.СтоимостьРегл
|		+ СебестоимостьТоваров.ТрудозатратыРегл
|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		+ СебестоимостьТоваров.ДопРасходыРегл
|		- СебестоимостьТоваров.ПостояннаяРазница
|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница
|ПОМЕСТИТЬ ВыбытиеИзНЗППоПродукции
|ИЗ
|	ВыпущеннаяПродукция КАК ВыпущеннаяПродукция
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
|		ПО СебестоимостьТоваров.Организация = ВыпущеннаяПродукция.Организация
|			И ВыпущеннаяПродукция.ПартияПродукции = СебестоимостьТоваров.Регистратор
|			И ВыпущеннаяПродукция.АналитикаУчетаПродукции = СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры
|			И ВыпущеннаяПродукция.ПартияПродукции = СебестоимостьТоваров.КорПартия
|			И ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции = СебестоимостьТоваров.КорАналитикаУчетаПартий
|			И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
|ГДЕ
|	СебестоимостьТоваров.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
|	И ТИПЗНАЧЕНИЯ(СебестоимостьТоваров.Партия) = ТИП(Справочник.ПартииПроизводства)
|	И НЕ СебестоимостьТоваров.Партия = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
|
|СГРУППИРОВАТЬ ПО
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
|	ВыпущеннаяПродукция.Организация,
|	ВыпущеннаяПродукция.ПартияПродукции,
|	ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции,
|	ВыпущеннаяПродукция.АналитикаУчетаПродукции,
|	ВыпущеннаяПродукция.Числитель,
|	ВыпущеннаяПродукция.Знаменатель,
|	СебестоимостьТоваров.Партия,
|	СебестоимостьТоваров.ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия
|;";
КонецФункции

// Формирует текст SQL-фрагмента для объединения дополнительных расходов (часть общего запроса затрат на продукцию).
//
// Назначение запроса:
//  Возвращает SELECT, который добавляет в общий набор затрат узла «доп. расходы» из детализации себестоимости,
//  чтобы они попадали в результат разузлования и далее корректно отображались/учитывались в отчёте.
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса/фрагмента
//
// Примечание по пропорциям:
//  ВТПарыУзлов в этот текст НЕ добавляется напрямую. Пропорция распределения применяется через множитель
//  `ВыпущеннаяПродукция.Числитель/Знаменатель` (а при пакетной обработке эти коэффициенты подменяются
//  на уровне формирования набора данных `ВыпущеннаяПродукция` через ВТПарыУзлов).
Функция ikon_cost_ТекстЗапроса_ТекстДопРасходыОбъединение()
	
	Возврат
"ВЫБРАТЬ
|	ДетализацияСебестоимости.Организация		КАК Организация,
|	ДетализацияСебестоимости.Партия				КАК ПартияВыходноеИзделие,
|	ДетализацияСебестоимости.АналитикаУчетаПартий	КАК АналитикаУчетаПартийВыходноеИзделие,
|	&АналитикаУчетаВыходноеИзделие				КАК АналитикаУчетаВыходноеИзделие,
|	ДетализацияСебестоимости.ДокументПоступления КАК ПартияЗатрата,
|	ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийЗатрата,
|	ЛОЖЬ										КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ										КАК ИсключитьНДСИзСтоимости,
|	ДетализацияСебестоимости.АналитикаРасходов	КАК АналитикаЗатрата,
|	ВЫБОР
|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
|			ТОГДА ЕСТЬNULL(ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления.ВидЦенности, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка))
|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов
|	КОНЕЦ КАК Затрата,
|	НЕОПРЕДЕЛЕНО								КАК ЕдиницаИзмеренияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК ХарактеристикаЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК СерияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК НазначениеЗатрата,
|	&СтатьяКалькуляции							КАК СтатьяКалькуляции,
|	НЕОПРЕДЕЛЕНО								КАК Подразделение,
|	ЛОЖЬ										КАК ТребуетсяРазузлование,
|	ЛОЖЬ										КАК ТребуетсяРазузлованиеДопРасходов,
|	&ТипЗатратДопРасходы						КАК ТипЗатрат,
|	0											КАК КоличествоЗатрата,
|
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	0											КАК Материальные,
|	0											КАК Трудозатраты,
|	0											КАК ПостатейныеПостоянные,
|	0											КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ)
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ)
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))				КАК ДопРасходы,
|	0											КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ)
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ)
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))				КАК СуммаЗатрата,
|	0											КАК НДД,
|
|// Стоимости с НДС
|	0											КАК МатериальныеСНДС,
|	0											КАК ТрудозатратыСНДС,
|	0											КАК ПостатейныеПостоянныеСНДС,
|	0											КАК ПостатейныеПеременныеСНДС,
|	СУММА(ДетализацияСебестоимости.СтоимостьСНДС
|			* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))				КАК ДопРасходыСНДС,
|
|// Стоимости без НДС
|	0											КАК МатериальныеБезНДС,
|	0											КАК ПостатейныеПостоянныеБезНДС,
|	0											КАК ПостатейныеПеременныеБезНДС,
|	СУММА(ДетализацияСебестоимости.СтоимостьБезНДС
|			* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))				КАК ДопРасходыБезНДС,
|
|// Стоимости Упр
|	0											КАК МатериальныеУпр,
|	0											КАК ТрудозатратыУпр,
|	0											КАК ПостатейныеПостоянныеУпр,
|	0											КАК ПостатейныеПеременныеУпр,
|	СУММА((ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ))
|			* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))				КАК ДопРасходыУпр,
|	0											КАК СтоимостьЗабалансоваяУпр,
|
|// Стоимости Регл
|	0											КАК МатериальныеРегл,
|	0											КАК ТрудозатратыРегл,
|	0											КАК ПостатейныеПостоянныеРегл,
|	0											КАК ПостатейныеПеременныеРегл,
|	СУММА((ДетализацияСебестоимости.СтоимостьБезНДСРегл 
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ))
|			* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))				КАК ДопРасходыРегл,
|	0											КАК СтоимостьЗабалансоваяРегл,
|
|// Налоговый учет
|	0 КАК НалоговыйУчет,
|	0 КАК ПостояннаяРазница,
|	0 КАК ВременнаяРазница
|
|ИЗ
|	ВыпущеннаяПродукция КАК ВыпущеннаяПродукция
|
|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК ДетализацияСебестоимости
|		ПО ВыпущеннаяПродукция.Организация = ДетализацияСебестоимости.Организация
|		И ВыпущеннаяПродукция.ПартияПродукции = ДетализацияСебестоимости.Партия
|		И ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции = ДетализацияСебестоимости.АналитикаУчетаПартий
|
|ГДЕ 
|	(&ПоВсемПартиям ИЛИ ДетализацияСебестоимости.Партия В (&ПартииПродукции))
|	И (&ПоВсемАналитикамПартий ИЛИ ДетализацияСебестоимости.АналитикаУчетаПартий В (&АналитикиУчетаПартийПродукции))
|	И ДетализацияСебестоимости.Номенклатура В (&Продукция)
|	И ДетализацияСебестоимости.Характеристика В (&ХарактеристикиПродукции)
|	И НЕ ДетализацияСебестоимости.ЗатратыПредыдущихПеределов
|	И НЕ ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
|		КОНЕЦ = 0
|	И ВЫБОР
|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
|			ТОГДА ИСТИНА	
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ДетализацияСебестоимости.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
|	КОНЕЦ 
|
|СГРУППИРОВАТЬ ПО
|	ДетализацияСебестоимости.Организация,
|	ДетализацияСебестоимости.Партия,
|	ДетализацияСебестоимости.АналитикаУчетаПартий,
|	ДетализацияСебестоимости.ДокументПоступления,
|	ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления,
|	ДетализацияСебестоимости.АналитикаРасходов,
|	ВЫБОР
|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
|			ТОГДА ЕСТЬNULL(ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления.ВидЦенности, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка))
|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов
|	КОНЕЦ
|
|ОБЪЕДИНИТЬ ВСЕ
|
|ВЫБРАТЬ
|	ДетализацияСебестоимости.Организация		КАК Организация,
|	ДетализацияСебестоимости.Партия				КАК ПартияВыходноеИзделие,
|	ДетализацияСебестоимости.АналитикаУчетаПартий	КАК АналитикаУчетаПартийВыходноеИзделие,
|	&АналитикаУчетаВыходноеИзделие				КАК АналитикаУчетаВыходноеИзделие,
|	ДетализацияСебестоимости.ДокументПоступления КАК ПартияЗатрата,
|	ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийЗатрата,
|	ЛОЖЬ										КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ										КАК ИсключитьНДСИзСтоимости,
|	ДетализацияСебестоимости.АналитикаРасходов	КАК АналитикаЗатрата,
|	ВЫБОР
|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
|			ТОГДА ЕСТЬNULL(ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления.ВидЦенности, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка))
|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов
|	КОНЕЦ КАК Затрата,
|	НЕОПРЕДЕЛЕНО								КАК ЕдиницаИзмеренияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК ХарактеристикаЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК СерияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК НазначениеЗатрата,
|	&СтатьяКалькуляции							КАК СтатьяКалькуляции,
|	НЕОПРЕДЕЛЕНО								КАК Подразделение,
|	ЛОЖЬ										КАК ТребуетсяРазузлование,
|	ЛОЖЬ										КАК ТребуетсяРазузлованиеДопРасходов,
|	&ТипЗатратДопРасходы						КАК ТипЗатрат,
|	0											КАК КоличествоЗатрата,
|
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	0											КАК Материальные,
|	0											КАК Трудозатраты,
|	0											КАК ПостатейныеПостоянные,
|	0											КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ)
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ)
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))				КАК ДопРасходы,
|	0											КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ)
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ)
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))				КАК СуммаЗатрата,
|	0											КАК НДД,
|
|// Стоимости с НДС
|	0											КАК МатериальныеСНДС,
|	0											КАК ТрудозатратыСНДС,
|	0											КАК ПостатейныеПостоянныеСНДС,
|	0											КАК ПостатейныеПеременныеСНДС,
|	СУММА(ДетализацияСебестоимости.СтоимостьСНДС
|			* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))				КАК ДопРасходыСНДС,
|
|// Стоимости без НДС
|	0											КАК МатериальныеБезНДС,
|	0											КАК ПостатейныеПостоянныеБезНДС,
|	0											КАК ПостатейныеПеременныеБезНДС,
|	СУММА(ДетализацияСебестоимости.СтоимостьБезНДС
|			* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))				КАК ДопРасходыБезНДС,
|
|// Стоимости Упр
|	0											КАК МатериальныеУпр,
|	0											КАК ТрудозатратыУпр,
|	0											КАК ПостатейныеПостоянныеУпр,
|	0											КАК ПостатейныеПеременныеУпр,
|	СУММА((ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ))
|			* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))				КАК ДопРасходыУпр,
|	0											КАК СтоимостьЗабалансоваяУпр,
|
|// Стоимости Регл
|	0											КАК МатериальныеРегл,
|	0											КАК ТрудозатратыРегл,
|	0											КАК ПостатейныеПостоянныеРегл,
|	0											КАК ПостатейныеПеременныеРегл,
|	СУММА((ДетализацияСебестоимости.СтоимостьБезНДСРегл
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ))
|			* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))				КАК ДопРасходыРегл,
|	0											КАК СтоимостьЗабалансоваяРегл,
|
|// Налоговый учет
|	0 КАК НалоговыйУчет,
|	0 КАК ПостояннаяРазница,
|	0 КАК ВременнаяРазница
|ИЗ
|	ВыпущеннаяПродукция КАК ВыпущеннаяПродукция
|
|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК ДетализацияСебестоимости
|		ПО ВыпущеннаяПродукция.Организация = ДетализацияСебестоимости.Организация
|		И ВыпущеннаяПродукция.ПартияПродукции = ДетализацияСебестоимости.Партия
|		И ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции = ДетализацияСебестоимости.АналитикаУчетаПартий
|
|ГДЕ 
|	ДетализацияСебестоимости.Период МЕЖДУ НАЧАЛОПЕРИОДА(&ДатаИсходнойПартии, МЕСЯЦ) И КОНЕЦПЕРИОДА(&ДатаИсходнойПартии, МЕСЯЦ)
|	И (&ПоВсемПартиям ИЛИ ДетализацияСебестоимости.Партия В (&ПартииПродукции))
|	И (&ПоВсемАналитикамПартий ИЛИ ДетализацияСебестоимости.АналитикаУчетаПартий В (&АналитикиУчетаПартийПродукции))
|	И ДетализацияСебестоимости.АналитикаУчетаНоменклатуры В (&АналитикаУчетаЗатрата)
|	И ДетализацияСебестоимости.РазделУчета В (
|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах),
|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты))
|	И НЕ ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
|		КОНЕЦ = 0
|	И ВЫБОР
|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
|			ТОГДА ИСТИНА	
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ДетализацияСебестоимости.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
|	КОНЕЦ 
|
|СГРУППИРОВАТЬ ПО
|	ДетализацияСебестоимости.Организация,
|	ДетализацияСебестоимости.Партия,
|	ДетализацияСебестоимости.АналитикаУчетаНоменклатуры,
|	ДетализацияСебестоимости.АналитикаУчетаПартий,
|	ДетализацияСебестоимости.ДокументПоступления,
|	ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления,
|	ДетализацияСебестоимости.АналитикаРасходов,
|	ВЫБОР
|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
|			ТОГДА ЕСТЬNULL(ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления.ВидЦенности, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка))
|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов
|	КОНЕЦ
|";
КонецФункции



// Диагностирует наличие полей пропорции (Числитель/Знаменатель) в тексте SQL-запроса.
//
// Параметры:
//  ИмяВТ - Строка - логическое имя временной таблицы/фрагмента (для удобства вывода)
//  ТекстЗапроса - Строка - текст SQL, в котором выполняется поиск
//
// Возвращаемое значение:
//  Структура - структура вида:
//   * ИмяВТ - Строка
//   * ЕстьЧислитель - Булево
//   * ЕстьЗнаменатель - Булево
//
Функция ikon_cost_ДиагностикаПропорцииВЗапросе(ИмяВТ, ТекстЗапроса)
	
	Результат = Новый Структура;
	Результат.Вставить("ИмяВТ", ИмяВТ);
	
	// Проверяем наличие поля Числитель в тексте запроса
	// Ищем паттерны: "Числитель", "Т.Числитель", "ВТ.Числитель", "НЗППоПродукции.Числитель" и т.д.
	ЕстьЧислитель = СтрНайти(ТекстЗапроса, "Числитель") > 0;
	Результат.Вставить("ЕстьЧислитель", ЕстьЧислитель);
	
	// Проверяем наличие поля Знаменатель
	ЕстьЗнаменатель = СтрНайти(ТекстЗапроса, "Знаменатель") > 0;
	Результат.Вставить("ЕстьЗнаменатель", ЕстьЗнаменатель);
	
	Возврат Результат;
	
КонецФункции

// Формирует текст запроса затрат на продукцию (блоки временных таблиц + объединение видов затрат),
// который затем используется при расчёте себестоимости узла дерева.
//
// Параметры:
//  ВыводитьДопРасходы - Булево - признак включения/разворачивания дополнительных расходов в итоговый набор затрат
//
// Возвращаемое значение:
//  Строка - текст SQL-запроса (используется как часть Запрос.Текст в СебестоимостьУзла)
//
// Изменения относительно базового модуля СтруктураСебестоимости:
//  - Большая функция разбита на набор вспомогательных `ikon_cost_ТекстЗапроса_*` для упрощения поддержки.
//  - Добавлена диагностическая трассировка наличия Числитель/Знаменатель в каждом фрагменте (для контроля корректности пропорций).
//
// Примечание по пропорциям:
//  ВТПарыУзлов напрямую в этот текст не добавляется. При пакетной обработке коэффициенты пропорции
//  подставляются на уровне формирования набора данных `ВыпущеннаяПродукция` (см. `ЗапросВыпущеннаяПродукцияГруппировка`),
//  и далее используются через поля `ВыпущеннаяПродукция.Числитель/Знаменатель` во всех объединяющих фрагментах.
&Вместо("ТекстЗапросаЗатратыНаПродукцию")
Функция ikon_cost_ТекстЗапросаЗатратыНаПродукцию(ВыводитьДопРасходы)

	ТекстыЗапроса = Новый Массив;
	
	
	// === ДИАГНОСТИКА ПОТОКА ДАННЫХ ЧИСЛИТЕЛЬ/ЗНАМЕНАТЕЛЬ ===
	// Собираем информацию о наличии полей в каждой временной таблице
	ДиагностикаВТ = Новый Массив;
	

	#Область ТекстМатериальныеЗатраты

	#Область ВыбытиеИзНЗППоПродукции
	ТекстМатериальныеЗатраты = ikon_cost_ТекстЗапроса_ВыбытиеИзНЗППоПродукции();
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ВыбытиеИзНЗППоПродукции", ТекстМатериальныеЗатраты));
	
	#КонецОбласти

	#Область ВыбывшиеЗатратыСводно
	ТекстВыбывшиеЗатратыСводно = ikon_cost_ТекстЗапроса_ВыбывшиеЗатратыСводно();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстВыбывшиеЗатратыСводно;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ВыбывшиеЗатратыСводно", ТекстВыбывшиеЗатратыСводно));
	
	#КонецОбласти

	#Область ПартииПроизводства
	ТекстПартииПроизводства = ikon_cost_ТекстЗапроса_ПартииПроизводства();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстПартииПроизводства;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ПартииПроизводства", ТекстПартииПроизводства));
	
	#КонецОбласти

	#Область ВыбытиеИзНЗП
	ТекстВыбытиеИзНЗП = ikon_cost_ТекстЗапроса_ВыбытиеИзНЗП();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстВыбытиеИзНЗП;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ВыбытиеИзНЗП", ТекстВыбытиеИзНЗП));
	
	#КонецОбласти

	#Область ПервичныеПартииВНЗП
	ТекстПервичныеПартииВНЗП = ikon_cost_ТекстЗапроса_ПервичныеПартииВНЗП();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстПервичныеПартииВНЗП;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ПервичныеПартииВНЗП", ТекстПервичныеПартииВНЗП));
	
	#КонецОбласти

	#Область ДетализацияПартий
	ТекстДетализацияПартий = ikon_cost_ТекстЗапроса_ДетализацияПартий();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстДетализацияПартий;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ДетализацияПартий", ТекстДетализацияПартий));
	
	#КонецОбласти

	#Область ПриходыНарастающимИтогом
	ТекстПриходыНарастающимИтогом = ikon_cost_ТекстЗапроса_ПриходыНарастающимИтогом();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстПриходыНарастающимИтогом;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ПриходыНарастающимИтогом", ТекстПриходыНарастающимИтогом));
	
	#КонецОбласти

	#Область РасходыНарастающимИтогом
	ТекстРасходыНарастающимИтогом = ikon_cost_ТекстЗапроса_РасходыНарастающимИтогом();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстРасходыНарастающимИтогом;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("РасходыНарастающимИтогом", ТекстРасходыНарастающимИтогом));
	
	#КонецОбласти

	#Область НулевыеПериоды
	ТекстНулевыеПериоды = ikon_cost_ТекстЗапроса_НулевыеПериоды();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстНулевыеПериоды;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("НулевыеПериоды", ТекстНулевыеПериоды));
	
	#КонецОбласти

	#Область ИнтервалыРасходаПартий
	ТекстИнтервалыРасходаПартий = ikon_cost_ТекстЗапроса_ИнтервалыРасходаПартий();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстИнтервалыРасходаПартий;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ИнтервалыРасходаПартий", ТекстИнтервалыРасходаПартий));
	
	#КонецОбласти

	#Область ПриходыНарастающимИтогомПоИнтервалам
	ТекстПриходыНарастающимИтогомПоИнтервалам = ikon_cost_ТекстЗапроса_ПриходыНарастающимИтогомПоИнтервалам();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстПриходыНарастающимИтогомПоИнтервалам;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ПриходыНарастающимИтогомПоИнтервалам", ТекстПриходыНарастающимИтогомПоИнтервалам));
	
	#КонецОбласти

	#Область ПредварительныйРасходПартий
	ТекстПредварительныйРасходПартий = ikon_cost_ТекстЗапроса_ПредварительныйРасходПартий();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстПредварительныйРасходПартий;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ПредварительныйРасходПартий", ТекстПредварительныйРасходПартий));
	
	#КонецОбласти

	#Область ПартииСводно
	ТекстПартииСводно = ikon_cost_ТекстЗапроса_ПартииСводно();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстПартииСводно;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ПартииСводно", ТекстПартииСводно));
	
	#КонецОбласти

	#Область РасходПартийСводно
	ТекстРасходПартийСводно = ikon_cost_ТекстЗапроса_РасходПартийСводно();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстРасходПартийСводно;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("РасходПартийСводно", ТекстРасходПартийСводно));
	
	#КонецОбласти

	#Область ПервичныеЗатратыПоПериодам
	ТекстПервичныеЗатратыПоПериодам = ikon_cost_ТекстЗапроса_ПервичныеЗатратыПоПериодам();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстПервичныеЗатратыПоПериодам;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ПервичныеЗатратыПоПериодам", ТекстПервичныеЗатратыПоПериодам));
	
	#КонецОбласти

	#Область ПервичныеПартииСводно
	ТекстПервичныеПартииСводно = ikon_cost_ТекстЗапроса_ПервичныеПартииСводно();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстПервичныеПартииСводно;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ПервичныеПартииСводно", ТекстПервичныеПартииСводно));
	
	#КонецОбласти

	#Область ПартииПолуфабрикатов
	ТекстПартииПолуфабрикатов = ikon_cost_ТекстЗапроса_ПартииПолуфабрикатов();
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ТекстПартииПолуфабрикатов;
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ПартииПолуфабрикатов", ТекстПартииПолуфабрикатов));
	
	#КонецОбласти

	#КонецОбласти

	#Область ТекстМатериальныеЗатратыОбъединение
	ТекстМатериальныеЗатратыОбъединение = ikon_cost_ТекстЗапроса_ТекстМатериальныеЗатратыОбъединение();
	ТекстыЗапроса.Добавить(ТекстМатериальныеЗатратыОбъединение);
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ТекстМатериальныеЗатратыОбъединение", ТекстМатериальныеЗатратыОбъединение));
	
	#КонецОбласти	

	#Область ТекстМатериалыНачальныеОстаткиНЗПОбъединение
	ТекстМатериалыНачальныеОстаткиНЗПОбъединение = ikon_cost_ТекстЗапроса_ТекстМатериалыНачальныеОстаткиНЗПОбъединение();
	ТекстыЗапроса.Добавить(ТекстМатериалыНачальныеОстаткиНЗПОбъединение);
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ТекстМатериалыНачальныеОстаткиНЗПОбъединение", ТекстМатериалыНачальныеОстаткиНЗПОбъединение));
	
	#КонецОбласти
	

	#Область ТекстТрудозатратыОбъединение
	ТекстТрудозатратыОбъединение = ikon_cost_ТекстЗапроса_ТекстТрудозатратыОбъединение();
	ТекстыЗапроса.Добавить(ТекстТрудозатратыОбъединение);
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ТекстТрудозатратыОбъединение", ТекстТрудозатратыОбъединение));
	
	#КонецОбласти

	#Область ТекстПрочиеРасходыОбъединение
	ТекстПрочиеРасходыОбъединение = ikon_cost_ТекстЗапроса_ТекстПрочиеРасходыОбъединение();
	ТекстыЗапроса.Добавить(ТекстПрочиеРасходыОбъединение);
	
	ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ТекстПрочиеРасходыОбъединение", ТекстПрочиеРасходыОбъединение));
	
	#КонецОбласти

	#Область ТекстДопРасходыОбъединение

	Если ВыводитьДопРасходы Тогда
		ТекстДопРасходыОбъединение = ikon_cost_ТекстЗапроса_ТекстДопРасходыОбъединение();
		ТекстыЗапроса.Добавить(ТекстДопРасходыОбъединение);
		
		ДиагностикаВТ.Добавить(ikon_cost_ДиагностикаПропорцииВЗапросе("ТекстДопРасходыОбъединение", ТекстДопРасходыОбъединение));
		
	КонецЕсли;

	#КонецОбласти
	
	Возврат ТекстМатериальныеЗатраты
	+ СтрСоединить(ТекстыЗапроса, " ОБЪЕДИНИТЬ ВСЕ ");

КонецФункции
