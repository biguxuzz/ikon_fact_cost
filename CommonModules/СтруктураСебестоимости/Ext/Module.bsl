&Вместо("ПараметрыДереваСебестоимости")
Функция ikon_cost_ПараметрыДереваСебестоимости()

	ТипыРезультата = Новый ОписаниеТипов("ДеревоЗначений,ТаблицаЗначений,МенеджерВременныхТаблиц");

	ПараметрыДерева = Новый Структура;

	ПараметрыДерева.Вставить("ДинамическоеСчитывание",	Истина);
	ПараметрыДерева.Вставить("ТипРезультата",			"ДеревоЗначений");
	ПараметрыДерева.Вставить("Результат",				ТипыРезультата.ПривестиЗначение(Неопределено));
	ПараметрыДерева.Вставить("ДобавлятьПолуфабрикатыВРезультат", Истина);
	//#Вставка
	// === НАСТРОЙКИ ОПТИМИЗАЦИИ И ДИАГНОСТИКИ ===
	
	// Использовать пакетную обработку узлов по уровням (оптимизация N+1)
	// При Истина - узлы обрабатываются пакетами по уровням (НОВЫЙ алгоритм)
	// При Ложь - классический рекурсивный алгоритм (СТАРЫЙ, эталонный)
	// ВАЖНО: По умолчанию Ложь для обратной совместимости типового отчёта.
	// Новый отчёт ikon_cost_ФактическаяСебестоимостьПродукции явно устанавливает Истина.
	ПараметрыДерева.Вставить("ИспользоватьПакетнуюОбработку", Ложь);
	
	// Включить диагностические сообщения в журнал регистрации
	// При Истина - выводятся подробные логи обработки (для отладки)
	// При Ложь - диагностика отключена (рекомендуется для продакшена)
	// ПРИМЕЧАНИЕ: Основные "тяжёлые" блоки диагностики (с запросами и циклами) 
	//             обёрнуты в проверку этого флага. Простые записи в журнал 
	//             можно обернуть дополнительно при необходимости.
	ПараметрыДерева.Вставить("ВыводитьДиагностику", Ложь);
	ПараметрыДерева.Вставить("СчётчикДиагностикиПартий", 0); // Счётчик для ограничения вывода
	
	// Тестовая запись в журнал для подтверждения работы расширения
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.ЗАМЕРЫ.ТЕСТ",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		"Расширение ikon_cost применено успешно. Версия 0.1.1.133. Алгоритм: " + ?(ПараметрыДерева.ИспользоватьПакетнуюОбработку, "НОВЫЙ", "СТАРЫЙ"));
	//#КонецВставки

	Возврат ПараметрыДерева;

КонецФункции

&Вместо("ПостроитьДеревоСебестоимости")
Процедура ikon_cost_ПостроитьДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла = Неопределено) Экспорт

	//#Вставка
	// КРИТИЧНО: Для отчётов (МенеджерВременныхТаблиц) полуфабрикаты НЕОБХОДИМЫ!
	// Они используются для построения связей между материалами и продукцией в запросе отчета.
	// Отчёт строит таблицу КоличествоВыпуска из продукции и полуфабрикатов,
	// затем соединяет материалы с полуфабрикатами по ПартияВыходноеИзделие.
	// Без полуфабрикатов материалы "висят в воздухе" без связи с продукцией.
	// Поэтому оставляем ДобавлятьПолуфабрикатыВРезультат = Истина (как в оригинале)
	//#КонецВставки
	
	// СтандартныеПодсистемы.ЗамерПроизводительности
	Замер = ОценкаПроизводительности.НачатьЗамерДлительнойОперации("ОбщийМодуль.СтруктураСебестоимости.ПостроитьДеревоСебестоимости");
	ПараметрыДерева.Вставить("КоличествоСтрок", 0);
	//#Вставка
	// === ЗАМЕРЫ ПРОИЗВОДИТЕЛЬНОСТИ ===
	ПараметрыДерева.Вставить("Замер_ВремяНачала", ТекущаяДатаСеанса());
	ПараметрыДерева.Вставить("Замер_ВремяЗапросов", 0);
	ПараметрыДерева.Вставить("Замер_ВремяОбработки", 0);
	ПараметрыДерева.Вставить("Замер_ВремяПроверкиЦиклов", 0);
	ПараметрыДерева.Вставить("Замер_КоличествоЗапросов", 0);
	ПараметрыДерева.Вставить("Замер_КоличествоПроверокЦиклов", 0);
	ПараметрыДерева.Вставить("Замер_СтатистикаУровней", Новый Массив);  // для нового алгоритма
	ПараметрыДерева.Вставить("Замер_МаксУровень", 0);                   // для старого алгоритма
	//#КонецВставки
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности
	
	Если ПараметрыУзла = Неопределено Тогда
		ПараметрыУзла = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();
	КонецЕсли;
	//#Вставка
	// ВАЖНО: Пакетная обработка несовместима с динамическим считыванием
	// Если включена пакетная обработка, автоматически отключаем динамическое считывание
	Если ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
		И ПараметрыДерева.ИспользоватьПакетнуюОбработку
		И ПараметрыДерева.ДинамическоеСчитывание Тогда
		
		ПараметрыДерева.ДинамическоеСчитывание = Ложь;
		
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.ПакетнаяОбработка",
			УровеньЖурналаРегистрации.Предупреждение,
			,
			,
			"Динамическое считывание автоматически отключено для использования пакетной обработки");
	КонецЕсли;
	//#КонецВставки
	
	Если ПараметрыДерева.Результат = Неопределено Тогда
		ПустоеДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла);
	КонецЕсли;

	ЗаполнитьДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла);
	//#Вставка
	// Вывод статистики по обнаруженным циклам
	Если ПараметрыДерева.Свойство("ОбнаруженныеЦиклы") 
		И ПараметрыДерева.ОбнаруженныеЦиклы.Количество() > 0 Тогда
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"При построении дерева себестоимости обнаружено циклических зависимостей: %1",
			Строка(ПараметрыДерева.ОбнаруженныеЦиклы.Количество()));
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.СтатистикаЦиклов",
			УровеньЖурналаРегистрации.Предупреждение,
			,
			,
			ТекстСообщения);
	КонецЕсли;
	//#КонецВставки
	
	//#Вставка
	// === ВЫВОД РЕЗУЛЬТАТОВ ЗАМЕРОВ ===
	Если ПараметрыДерева.Свойство("Замер_ВремяНачала") Тогда
		
		// Вычисляем общее время в секундах (ТекущаяДатаСеанса() возвращает дату, разница дат - в секундах)
		ВремяОбщее = ТекущаяДатаСеанса() - ПараметрыДерева.Замер_ВремяНачала;
		ВремяПрочее = ВремяОбщее - ПараметрыДерева.Замер_ВремяЗапросов 
			- ПараметрыДерева.Замер_ВремяОбработки;
		
		ПроцентЗапросов = ?(ВремяОбщее > 0, 
			Окр(ПараметрыДерева.Замер_ВремяЗапросов / ВремяОбщее * 100, 1), 0);
		ПроцентОбработки = ?(ВремяОбщее > 0, 
			Окр(ПараметрыДерева.Замер_ВремяОбработки / ВремяОбщее * 100, 1), 0);
		ПроцентЦиклов = ?(ВремяОбщее > 0, 
			Окр(ПараметрыДерева.Замер_ВремяПроверкиЦиклов / ВремяОбщее * 100, 1), 0);
		
		// Определяем тип алгоритма
		ИспользуетсяПакетныйАлгоритм = ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
			И ПараметрыДерева.ИспользоватьПакетнуюОбработку;
		ТипАлгоритма = ?(ИспользуетсяПакетныйАлгоритм, "НОВЫЙ (пакетный)", "СТАРЫЙ (рекурсивный)");
		
		ТекстЗамера = "
|=== ЗАМЕРЫ ПРОИЗВОДИТЕЛЬНОСТИ ===
|Алгоритм: " + ТипАлгоритма + "
|Общее время: " + Строка(Окр(ВремяОбщее, 3)) + " сек
|
|ВРЕМЯ ПО ОПЕРАЦИЯМ:
|  Запросы к БД:      " + Строка(Окр(ПараметрыДерева.Замер_ВремяЗапросов, 3)) + " сек (" + Строка(ПроцентЗапросов) + "%)
|  Обработка:         " + Строка(Окр(ПараметрыДерева.Замер_ВремяОбработки, 3)) + " сек (" + Строка(ПроцентОбработки) + "%)
|  Проверка циклов:   " + Строка(Окр(ПараметрыДерева.Замер_ВремяПроверкиЦиклов, 3)) + " сек (" + Строка(ПроцентЦиклов) + "%)
|  Прочее:            " + Строка(Окр(ВремяПрочее, 3)) + " сек
|
|СТАТИСТИКА:
|  Запросов к БД:     " + Строка(ПараметрыДерева.Замер_КоличествоЗапросов) + "
|  Проверок циклов:   " + Строка(ПараметрыДерева.Замер_КоличествоПроверокЦиклов);
		
		// Статистика по уровням (только для нового алгоритма)
		Если ПараметрыДерева.Свойство("Замер_СтатистикаУровней") 
			И ПараметрыДерева.Замер_СтатистикаУровней.Количество() > 0 Тогда
			
			ТекстЗамера = ТекстЗамера + "
|  Уровней дерева:    " + Строка(ПараметрыДерева.Замер_СтатистикаУровней.Количество());
			
			Для Каждого СтатУровня Из ПараметрыДерева.Замер_СтатистикаУровней Цикл
				ТекстЗамера = ТекстЗамера + "
|    Уровень " + Строка(СтатУровня.НомерУровня) + ": узлов=" + Строка(СтатУровня.КоличествоУзлов) 
					+ ", ПройденныйПуть=" + Строка(СтатУровня.РазмерПройденныйПуть);
			КонецЦикла;
		КонецЕсли;
		
		// Максимальный уровень (только для старого алгоритма)
		Если ПараметрыДерева.Свойство("Замер_МаксУровень") Тогда
			ТекстЗамера = ТекстЗамера + "
|  Макс. глубина:     " + Строка(ПараметрыДерева.Замер_МаксУровень);
		КонецЕсли;
		
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.ЗАМЕРЫ",
			УровеньЖурналаРегистрации.Предупреждение,
			,
			,
			ТекстЗамера);
			
	КонецЕсли;
	//#КонецВставки

	// СтандартныеПодсистемы.ЗамерПроизводительности
	ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(Замер, ПараметрыДерева.КоличествоСтрок / 1000);
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности

КонецПроцедуры

&Вместо("РазузловатьУзелДереваСебестоимости")
Процедура ikon_cost_РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзла, ТаблицаРезультата, ОписаниеПродукции)

	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		Результат = ТаблицаРезультата.Строки;
		Если ПараметрыДерева.ДинамическоеСчитывание Тогда
			Результат.Очистить();
		КонецЕсли;
	Иначе
		Результат = ТаблицаРезультата
	КонецЕсли;

	ПройденныйПуть = Неопределено;
	Если НЕ ПараметрыДерева.Свойство("ПройденныйПуть", ПройденныйПуть) Тогда
		ПройденныйПуть = Новый ТаблицаЗначений;
		ПройденныйПуть.Колонки.Добавить("Партия");
		ПройденныйПуть.Колонки.Добавить("АналитикаУчетаПартий");
		ПройденныйПуть.Индексы.Добавить("Партия, АналитикаУчетаПартий");
		ПараметрыДерева.Вставить("ПройденныйПуть", ПройденныйПуть);
		//#Вставка
		// Инициализируем параметры защиты от циклов и глубокой рекурсии
		ПараметрыДерева.Вставить("МаксимальнаяГлубинаРекурсии", 50);
		ПараметрыДерева.Вставить("ОбнаруженныеЦиклы", Новый Массив);
		//#КонецВставки
	КонецЕсли;

	АналитикаУчетаПродукции			= ОписаниеПродукции.АналитикаУчетаПродукции;
	ПартияПродукции					= ОписаниеПродукции.ПартияПродукции;
	АналитикаУчетаПартийПродукции	= ОписаниеПродукции.АналитикаУчетаПартийПродукции;
	УровеньУзла						= ОписаниеПродукции.Уровень + 1;
	//#Вставка
	// ЗАМЕР С3: максимальная глубина рекурсии
	Если ПараметрыДерева.Свойство("Замер_МаксУровень") Тогда
		Если УровеньУзла > ПараметрыДерева.Замер_МаксУровень Тогда
			ПараметрыДерева.Замер_МаксУровень = УровеньУзла;
		КонецЕсли;
	КонецЕсли;
	
	// Проверка максимальной глубины рекурсии
	Если УровеньУзла > ПараметрыДерева.МаксимальнаяГлубинаРекурсии Тогда
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"Достигнута максимальная глубина разузлования (%1 уровней). Партия: %2, Аналитика партий: %3",
			Строка(УровеньУзла),
			Строка(ПартияПродукции),
			Строка(АналитикаУчетаПартийПродукции));
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.МаксимальнаяГлубинаРекурсии",
			УровеньЖурналаРегистрации.Предупреждение,
			,
			,
			ТекстСообщения);
		Возврат;
	КонецЕсли;
	//#КонецВставки

	ВыводитьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы И НЕ (УровеньУзла = 1);
	//#Вставка
	// ЗАМЕР С1: время запроса
	ВремяДоЗапроса = ТекущаяДатаСеанса();
	//#КонецВставки
	СебестоимостьУзла = СебестоимостьУзла(ПараметрыДерева, ПараметрыУзла, ВыводитьДопРасходы);
	//#Вставка
	Если ПараметрыДерева.Свойство("Замер_ВремяЗапросов") Тогда
		ПараметрыДерева.Замер_ВремяЗапросов = ПараметрыДерева.Замер_ВремяЗапросов 
			+ (ТекущаяДатаСеанса() - ВремяДоЗапроса);
		ПараметрыДерева.Замер_КоличествоЗапросов = ПараметрыДерева.Замер_КоличествоЗапросов + 1;
	КонецЕсли;
	//#КонецВставки

	// СтандартныеПодсистемы.ЗамерПроизводительности
	ПараметрыДерева.КоличествоСтрок = ПараметрыДерева.КоличествоСтрок + СебестоимостьУзла.Количество();
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности

	ЭтоРазузлованиеДопРасходов = Ложь;
	Для Каждого ТекПартия Из СебестоимостьУзла Цикл

		Если ТекПартия.ТребуетсяРазузлование И ТекПартия.КоличествоЗатрата <> 0 Тогда
			ПараметрыОтбора = Новый Структура("Партия, АналитикаУчетаПартий",
			ТекПартия.ПартияЗатрата,
			ТекПартия.АналитикаУчетаПартийЗатрата);
			//#Вставка
			// ЗАМЕР С2: проверка циклов
			ВремяДоПроверки = ТекущаяДатаСеанса();
			//#КонецВставки
			МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
			//#Вставка
			Если ПараметрыДерева.Свойство("Замер_ВремяПроверкиЦиклов") Тогда
				ПараметрыДерева.Замер_ВремяПроверкиЦиклов = ПараметрыДерева.Замер_ВремяПроверкиЦиклов 
					+ (ТекущаяДатаСеанса() - ВремяДоПроверки);
				ПараметрыДерева.Замер_КоличествоПроверокЦиклов = ПараметрыДерева.Замер_КоличествоПроверокЦиклов + 1;
			КонецЕсли;
			//#КонецВставки
			//#Вставка
			// Логирование обнаруженного цикла
			Если МассивСтрок.Количество() > 0 Тогда
				ИнформацияОЦикле = Новый Структура;
				ИнформацияОЦикле.Вставить("Уровень", УровеньУзла);
				ИнформацияОЦикле.Вставить("ПартияЗатрата", ТекПартия.ПартияЗатрата);
				ИнформацияОЦикле.Вставить("АналитикаУчетаПартийЗатрата", ТекПартия.АналитикаУчетаПартийЗатрата);
				ИнформацияОЦикле.Вставить("Затрата", ТекПартия.Затрата);
				ИнформацияОЦикле.Вставить("ПартияПродукции", ПартияПродукции);
				ИнформацияОЦикле.Вставить("АналитикаУчетаПартийПродукции", АналитикаУчетаПартийПродукции);
				
				ПараметрыДерева.ОбнаруженныеЦиклы.Добавить(ИнформацияОЦикле);
				
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"Обнаружен циклический переход на уровне %1: Затрата '%2' (Партия: %3, Аналитика партий: %4) -> уже обрабатывалась в пути от Партии: %5, Аналитики партий: %6",
					Строка(УровеньУзла),
					Строка(ТекПартия.Затрата),
					Строка(ТекПартия.ПартияЗатрата),
					Строка(ТекПартия.АналитикаУчетаПартийЗатрата),
					Строка(ПартияПродукции),
					Строка(АналитикаУчетаПартийПродукции));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.ОбнаруженЦикл",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
			КонецЕсли;
			//#КонецВставки
		Иначе
			МассивСтрок = Новый Массив;
		КонецЕсли;

		Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			ИЛИ ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат
			ИЛИ Не ТекПартия.ТребуетсяРазузлование Тогда
			СтрокаПартия = Результат.Добавить(); // СтрокаДереваЗначений
			ЗаполнитьЗначенияСвойств(СтрокаПартия, ТекПартия);

			СтрокаПартия.Идентификатор	= Новый УникальныйИдентификатор();
			Если ТекПартия.ТребуетсяРазузлование
				И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
				И (ТекПартия.СуммаЗатрата <> 0 Или ТекПартия.СуммаЗатратаЗабалансовая <> 0)
				И МассивСтрок.Количество() = 0 Тогда

				СтрокаПартия.ВидСтроки		= Перечисления.ВидыСтрокДереваСебестоимости.ПартияПолуфабриката;
				СтрокаПартия.Числитель 		= ТекПартия.КоличествоЗатрата;

			Иначе
				СтрокаПартия.ВидСтроки		= Перечисления.ВидыСтрокДереваСебестоимости.ПартияЗатраты;
				СтрокаПартия.ТребуетсяРазузлование = Ложь;
			КонецЕсли;

			СтрокаПартия.АналитикаУчетаПродукции		= АналитикаУчетаПродукции;
			СтрокаПартия.ПартияПродукции				= ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартийПродукции	= АналитикаУчетаПартийПродукции;

			СтрокаПартия.Номенклатура			= ТекПартия.Затрата;
			СтрокаПартия.Характеристика			= ТекПартия.ХарактеристикаЗатрата;
			СтрокаПартия.Серия					= ТекПартия.СерияЗатрата;
			СтрокаПартия.Назначение				= ТекПартия.НазначениеЗатрата;
			СтрокаПартия.Партия					= ТекПартия.ПартияЗатрата;
			СтрокаПартия.АналитикаУчетаПартий	= ТекПартия.АналитикаУчетаПартийЗатрата;
			СтрокаПартия.ЕдиницаИзмерения		= ТекПартия.ЕдиницаИзмеренияЗатрата;
			СтрокаПартия.Уровень				= УровеньУзла;

			СтрокаПартия.Количество			= ТекПартия.КоличествоЗатрата;
			СтрокаПартия.Сумма				= Окр(ТекПартия.СуммаЗатрата, 2);
			СтрокаПартия.ДопРасходы			= Окр(СтрокаПартия.ДопРасходы, 2);
			СтрокаПартия.НалоговыйУчет		= Окр(СтрокаПартия.НалоговыйУчет, 2);
			СтрокаПартия.СуммаЗабалансовая	= ТекПартия.СуммаЗатратаЗабалансовая;

			// Уменьшаем суммовые показатели в узле на разузлованные суммы. 
			// На оставшиеся суммы будет сформирована отдельная строка для отражения расхождения стоимости с детализацией.
			Если ПараметрыУзла.Сумма <> 0 Или ПараметрыУзла.СуммаЗабалансовая <> 0 Тогда
				ПараметрыУзла.Сумма = ПараметрыУзла.Сумма - СтрокаПартия.Сумма;
				ПараметрыУзла.Материальные = ПараметрыУзла.Материальные - СтрокаПартия.Материальные;
				ПараметрыУзла.ДопРасходы = ПараметрыУзла.ДопРасходы - СтрокаПартия.ДопРасходы;
				ПараметрыУзла.Трудозатраты = ПараметрыУзла.Трудозатраты - СтрокаПартия.Трудозатраты;
				ПараметрыУзла.ПостатейныеПеременные = ПараметрыУзла.ПостатейныеПеременные - СтрокаПартия.ПостатейныеПеременные;
				ПараметрыУзла.ПостатейныеПостоянные = ПараметрыУзла.ПостатейныеПостоянные - СтрокаПартия.ПостатейныеПостоянные;
				ПараметрыУзла.НалоговыйУчет = ПараметрыУзла.НалоговыйУчет - СтрокаПартия.НалоговыйУчет;
				ПараметрыУзла.ПостояннаяРазница = ПараметрыУзла.ПостояннаяРазница - СтрокаПартия.ПостояннаяРазница;
				ПараметрыУзла.ВременнаяРазница = ПараметрыУзла.ВременнаяРазница - СтрокаПартия.ВременнаяРазница;
				ПараметрыУзла.СуммаЗабалансовая = ПараметрыУзла.СуммаЗабалансовая - СтрокаПартия.СуммаЗабалансовая;

				ЭтоРазузлованиеДопРасходов = (ТекПартия.ТипЗатрат = "ДопРасходы");
			КонецЕсли;
		КонецЕсли;

		Если ТекПартия.ТребуетсяРазузлование
			И ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			И ПараметрыДерева.ДинамическоеСчитывание Тогда
			СтрокаПартия.Строки.Добавить();
		ИначеЕсли ТекПартия.ТребуетсяРазузлование
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И (ТекПартия.СуммаЗатрата <> 0 Или ТекПартия.СуммаЗатратаЗабалансовая <> 0)
			И МассивСтрок.Количество() = 0
			ИЛИ ТекПартия.ТребуетсяРазузлованиеДопРасходов
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И ТекПартия.ДопРасходы <> 0 Тогда
			// общий подход к заполнению отбора параметров узла и условиям разузлования должен совпадать с:
			// - ЗаполнитьДеревоСебестоимости();
			// - Отчет.ДеревоСебестоимости.МодульОбъекта.ПолноеДеревоСебестоимостиПередРазворачиваниемСервер(). 
			ПараметрыУзлаПартии = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();

			Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
				НовыйПуть = ПройденныйПуть.Добавить();
				НовыйПуть.Партия = ТекПартия.ПартияЗатрата;
				НовыйПуть.АналитикаУчетаПартий = ТекПартия.АналитикаУчетаПартийЗатрата;
			КонецЕсли;

			Отборы = ПараметрыУзлаПартии.Отборы;
			Отборы.ДанныеПоСебестоимости = ПараметрыУзла.Отборы.ДанныеПоСебестоимости;
			Отборы.Продукция.Добавить(ТекПартия.Затрата);
			Отборы.ХарактеристикиПродукции.Добавить(ТекПартия.ХарактеристикаЗатрата);
			Отборы.СерииПродукции.Добавить(ТекПартия.СерияЗатрата);
			// При разузловании полуфабрикатов отбор по назначению не нужен, т.к. полуфабрикат может быть выпущен без назначения или
			// с указанием другого назначения.
			Отборы.ПартииПродукции.Добавить(ТекПартия.ПартияЗатрата);
			Отборы.АналитикиУчетаПартийПродукции.Добавить(ТекПартия.АналитикаУчетаПартийЗатрата);
			Отборы.АналитикаУчетаЗатрата.Добавить(ТекПартия.АналитикаУчетаЗатрата);
			// для знаменателя и количества продукции берем модуль значения, чтобы знак количества и сумм затрат определялся по числителю, который при выпуске будет > 0, а при сторно < 0
			Отборы.Числитель               = ТекПартия.КоличествоЗатрата;
			Отборы.КоличествоПродукции     = Макс(-ТекПартия.КоличествоЗатрата, ТекПартия.КоличествоЗатрата);
			Отборы.РазворачиватьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы;
			Отборы.ДатаИсходнойПартии      = ПараметрыУзла.Отборы.ДатаИсходнойПартии;
			Отборы.ДатаОкончания           = ПараметрыУзла.Отборы.ДатаОкончания;

			Отборы.ВключитьНДСВСтоимость   = ТекПартия.ВключитьНДСВСтоимость;
			Отборы.ИсключитьНДСИзСтоимости = ТекПартия.ИсключитьНДСИзСтоимости;
			Отборы.АналитикаУчетаВыходноеИзделие = ТекПартия.АналитикаУчетаЗатрата;
			Отборы.СтатьяКалькуляции       = ТекПартия.СтатьяКалькуляции;

			Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
				ТаблицаРезультатаПартии = СтрокаПартия;
			Иначе
				ТаблицаРезультатаПартии = Результат;
			КонецЕсли;

			Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
				ПараметрыУзлаПартии.Сумма = СтрокаПартия.Сумма;
				ПараметрыУзлаПартии.Материальные = СтрокаПартия.Материальные;
				ПараметрыУзлаПартии.ДопРасходы = СтрокаПартия.ДопРасходы;
				ПараметрыУзлаПартии.Трудозатраты = СтрокаПартия.Трудозатраты;
				ПараметрыУзлаПартии.ПостатейныеПеременные = СтрокаПартия.ПостатейныеПеременные;
				ПараметрыУзлаПартии.ПостатейныеПостоянные = СтрокаПартия.ПостатейныеПостоянные;
				ПараметрыУзлаПартии.НалоговыйУчет = СтрокаПартия.НалоговыйУчет;
				ПараметрыУзлаПартии.ПостояннаяРазница = СтрокаПартия.ПостояннаяРазница;
				ПараметрыУзлаПартии.ВременнаяРазница = СтрокаПартия.ВременнаяРазница;
				ПараметрыУзлаПартии.СуммаЗабалансовая = СтрокаПартия.СуммаЗабалансовая;
			КонецЕсли;

			ОписаниеПродукции.Вставить("Уровень", УровеньУзла);
			Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" Тогда
				КоличествоСтрокРезультата = ТаблицаРезультатаПартии.Количество();
			КонецЕсли;
			РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзлаПартии, ТаблицаРезультатаПартии, ОписаниеПродукции);

			// Если разозлование доп расходов не выполнено, снимем признак ТребуетсяРазузлованиеДопРасходов.
			Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц"
				И ТекПартия.ТребуетсяРазузлованиеДопРасходов
				И КоличествоСтрокРезультата = ТаблицаРезультатаПартии.Количество() Тогда
				СтрокаПартия.ТребуетсяРазузлованиеДопРасходов = Ложь;
			КонецЕсли;
		КонецЕсли;


	КонецЦикла;

	// При наличии данных о разузловании добавим строку на суммы изменения стоимости.
	Если СебестоимостьУзла.Количество() > 0 И НЕ ЭтоРазузлованиеДопРасходов Тогда
		УчестьИзменениеСтоимости(ПараметрыУзла, ОписаниеПродукции, Результат);
	КонецЕсли;

КонецПроцедуры

&Вместо("ЗаполнитьДеревоСебестоимости")
Процедура ikon_cost_ЗаполнитьДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла)

	Запрос = ЗапросВыпущеннаяПродукция(ПараметрыУзла, Ложь);
	ВыпущеннаяПродукция = Запрос.Выполнить().Выгрузить();
	// ДИАГНОСТИКА
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"ЗаполнитьДеревоСебестоимости: получено строк ВыпущеннаяПродукция=%1, ДинамическоеСчитывание=%2, ИспользоватьПакетнуюОбработку=%3",
		Строка(ВыпущеннаяПродукция.Количество()),
		Строка(ПараметрыДерева.ДинамическоеСчитывание),
		Строка(ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") И ПараметрыДерева.ИспользоватьПакетнуюОбработку));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ТекстСообщения);

	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		Результат = ПараметрыДерева.Результат.Строки;
	ИначеЕсли ПараметрыДерева.ТипРезультата = "ТаблицаЗначений" Тогда
		Результат = ПараметрыДерева.Результат;
	Иначе
		Результат = Новый ТаблицаЗначений;
		ИнициализироватьПоляДереваСебестоимости(Результат);
		ПоляТаблицы = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(Результат, "Идентификатор");
		СчетчикТаблиц = 0;
		ИменаТаблиц = "";
	КонецЕсли;

	// СтандартныеПодсистемы.ЗамерПроизводительности
	ПараметрыДерева.КоличествоСтрок = ПараметрыДерева.КоличествоСтрок + ВыпущеннаяПродукция.Количество();
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности

	Для Каждого ТекПартия Из ВыпущеннаяПродукция Цикл
		
		// КРИТИЧНО: Строка ПРОДУКЦИИ (уровень 0) всегда должна добавляться в результат!
		// ДобавлятьПолуфабрикатыВРезультат управляет только полуфабрикатами (уровни 1+)
		// Для МенеджерВременныхТаблиц строка продукции нужна для корректного формирования отчета
		Если Истина Тогда
			СтрокаПартия = Результат.Добавить(); // СтрокаДереваЗначений
			ЗаполнитьЗначенияСвойств(СтрокаПартия, ТекПартия);
			
			СтрокаПартия.Идентификатор	= Новый УникальныйИдентификатор();
			СтрокаПартия.ВидСтроки		= Перечисления.ВидыСтрокДереваСебестоимости.ПартияПродукции;
			
			СтрокаПартия.АналитикаУчетаВыходноеИзделие			= ТекПартия.АналитикаУчетаПродукции;
			СтрокаПартия.АналитикаУчетаПартийВыходноеИзделие	= ТекПартия.АналитикаУчетаПартийПродукции;
			СтрокаПартия.ПартияВыходноеИзделие					= ТекПартия.ПартияПродукции;
			
			СтрокаПартия.Номенклатура			= ТекПартия.Продукция;
			СтрокаПартия.Характеристика			= ТекПартия.ХарактеристикаПродукции;
			СтрокаПартия.Серия					= ТекПартия.СерияПродукции;
			СтрокаПартия.Назначение				= ТекПартия.НазначениеПродукции;
			СтрокаПартия.Валюта					= ТекПартия.Валюта;
			СтрокаПартия.Партия					= ТекПартия.ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартий	= ТекПартия.АналитикаУчетаПартийПродукции;
			СтрокаПартия.ЕдиницаИзмерения		= ТекПартия.ЕдиницаИзмеренияПродукция;
			
			СтрокаПартия.Количество	= ТекПартия.КоличествоПродукция;
			СтрокаПартия.Сумма		= ТекПартия.СуммаПродукция;
			СтрокаПартия.СуммаЗабалансовая = ТекПартия.СуммаПродукцияЗабалансовая;
		КонецЕсли;
		
		Если ТекПартия.ТребуетсяРазузлование
			И ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			И ПараметрыДерева.ДинамическоеСчитывание
			И ТекПартия.КоличествоПродукция <> 0 Тогда

			СтрокаПартия.Строки.Добавить();

		ИначеЕсли ТекПартия.ТребуетсяРазузлование
			И ТекПартия.КоличествоПродукция <> 0 Тогда //проверка на отсторнированный выпуск в выбранном периоде
			// общий подход к заполнению отбора параметров узла и условиям разузлования должен совпадать с:
			// - РазузловатьУзелДереваСебестоимости();
			// - Отчет.ДеревоСебестоимости.МодульОбъекта.ПолноеДеревоСебестоимостиПередРазворачиваниемСервер(). 
			ПараметрыУзлаПартии = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();

			Отборы = ПараметрыУзлаПартии.Отборы;
			Отборы.ДанныеПоСебестоимости = ПараметрыУзла.Отборы.ДанныеПоСебестоимости;
			Отборы.Продукция.Добавить(ТекПартия.Продукция);
			Отборы.ХарактеристикиПродукции.Добавить(ТекПартия.ХарактеристикаПродукции);
			Отборы.СерииПродукции.Добавить(ТекПартия.СерияПродукции);
			Отборы.НазначенияПродукции.Добавить(ТекПартия.НазначениеПродукции);
			Отборы.ПартииПродукции.Добавить(ТекПартия.ПартияПродукции);
			Отборы.АналитикиУчетаПартийПродукции.Добавить(ТекПартия.АналитикаУчетаПартийПродукции);
			// для знаменателя и количества продукции берем модуль значения, чтобы знак количества и сумм затрат определялся по числителю, который при выпуске будет > 0, а при сторно < 0
			Отборы.Числитель               = ТекПартия.Числитель;
			Отборы.Знаменатель             = Макс(-ТекПартия.Знаменатель, ТекПартия.Знаменатель);
			Отборы.КоличествоПродукции     = Макс(-ТекПартия.КоличествоПродукция,ТекПартия. КоличествоПродукция);
			Отборы.РазворачиватьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы;
			Отборы.ДатаИсходнойПартии = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ТекПартия.ПартияПродукции, "Дата");
			Отборы.ДатаОкончания           = ПараметрыУзла.Отборы.ДатаОкончания;

			ПараметрыУзлаПартии.Сумма = ТекПартия.СуммаПродукция;
			ПараметрыУзлаПартии.Материальные = ТекПартия.Материальные;
			ПараметрыУзлаПартии.ДопРасходы = ТекПартия.ДопРасходы;
			ПараметрыУзлаПартии.Трудозатраты = ТекПартия.Трудозатраты;
			ПараметрыУзлаПартии.ПостатейныеПеременные = ТекПартия.ПостатейныеПеременные;
			ПараметрыУзлаПартии.ПостатейныеПостоянные = ТекПартия.ПостатейныеПостоянные;
			ПараметрыУзлаПартии.НалоговыйУчет = ТекПартия.НалоговыйУчет;
			ПараметрыУзлаПартии.ПостояннаяРазница = ТекПартия.ПостояннаяРазница;
			ПараметрыУзлаПартии.ВременнаяРазница = ТекПартия.ВременнаяРазница;
			ПараметрыУзлаПартии.СуммаЗабалансовая = ТекПартия.СуммаПродукцияЗабалансовая;

			ОписаниеПродукции = Новый Структура("АналитикаУчетаПродукции, ПартияПродукции, АналитикаУчетаПартийПродукции");
			ЗаполнитьЗначенияСвойств(ОписаниеПродукции, ТекПартия);
			ОписаниеПродукции.Вставить("Уровень", 0);

			Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
				ТаблицаРезультата = СтрокаПартия;
			Иначе
				ТаблицаРезультата = Результат;
			КонецЕсли;

			// Выбор между пакетной обработкой и рекурсивной
			Если ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
				И ПараметрыДерева.ИспользоватьПакетнуюОбработку 
				И НЕ ПараметрыДерева.ДинамическоеСчитывание Тогда
				
				// Пакетная обработка: формируем узел для добавления в очередь
				Узел = Новый Структура;
				Узел.Вставить("ПараметрыУзла", ПараметрыУзлаПартии);
				Узел.Вставить("ТаблицаРезультата", ТаблицаРезультата);
				Узел.Вставить("ОписаниеПродукции", ОписаниеПродукции);
				Узел.Вставить("СтрокаПартия", СтрокаПартия);
				
				Если НЕ ПараметрыДерева.Свойство("УзлыДляПакетнойОбработки") Тогда
					ПараметрыДерева.Вставить("УзлыДляПакетнойОбработки", Новый Массив);
				КонецЕсли;
				
				ПараметрыДерева.УзлыДляПакетнойОбработки.Добавить(Узел);
				// ДИАГНОСТИКА
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"Узел добавлен в пакет для обработки. Всего узлов в пакете: %1",
					Строка(ПараметрыДерева.УзлыДляПакетнойОбработки.Количество()));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
			Иначе
				// Старая рекурсивная обработка (сохранена для обратной совместимости)
				РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзлаПартии, ТаблицаРезультата, ОписаниеПродукции);
			КонецЕсли;

		КонецЕсли;

		// ВАЖНО: При пакетной обработке НЕ сохраняем и НЕ очищаем Результат в цикле!
		// Узлы используют ссылку на эту таблицу, и она будет сохранена после пакетной обработки.
		ИспользуетсяПакетнаяОбработка = ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
			И ПараметрыДерева.ИспользоватьПакетнуюОбработку 
			И НЕ ПараметрыДерева.ДинамическоеСчитывание;
		
		Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" 
			И НЕ ИспользуетсяПакетнаяОбработка Тогда
			
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			
			// ДИАГНОСТИКА: сохранение в цикле
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				" СТАРЫЙ: создание ВТ '%1' в цикле, строк=%2",
				ИмяТекущейТаблицы,
				Строка(Результат.Количество()));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				ТекстСообщения);
			
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
				ПараметрыДерева.Результат,
				ИмяТекущейТаблицы,
				Результат,
				ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
			Результат.Очистить();
		КонецЕсли;

	КонецЦикла;

	// Обработка накопленных узлов для пакетной обработки (оптимизация N+1)
	// ВАЖНО: Обработка пакета ПО УРОВНЯМ с сохранением после каждого уровня!
	Если ПараметрыДерева.Свойство("УзлыДляПакетнойОбработки") 
		И ПараметрыДерева.УзлыДляПакетнойОбработки.Количество() > 0 Тогда
		
		УзлыТекущегоУровня = ПараметрыДерева.УзлыДляПакетнойОбработки;
		НомерУровня = 1;
		
		// Обрабатываем уровни по очереди (НЕ очищаем Результат - накапливаем в нём!)
		Пока УзлыТекущегоУровня.Количество() > 0 Цикл
			
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				" НОВЫЙ (ПАКЕТНЫЙ): начало обработки уровня %1, узлов=%2, накоплено строк=%3",
				Строка(НомерУровня),
				Строка(УзлыТекущегоУровня.Количество()),
				Строка(Результат.Количество()));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				ТекстСообщения);
			
			// Обработать текущий уровень
			УзлыСледующегоУровня = РазузловатьУзлыПакетом(ПараметрыДерева, УзлыТекущегоУровня);
			
			// ЗАМЕР Н3: статистика уровня
			Если ПараметрыДерева.Свойство("Замер_СтатистикаУровней") Тогда
				СтатистикаУровня = Новый Структура;
				СтатистикаУровня.Вставить("НомерУровня", НомерУровня);
				СтатистикаУровня.Вставить("КоличествоУзлов", УзлыТекущегоУровня.Количество());
				// Получаем размер ПройденныйПуть
				РазмерПройденныйПуть = 0;
				Если ПараметрыДерева.Свойство("ПройденныйПуть") И ПараметрыДерева.ПройденныйПуть <> Неопределено Тогда
					РазмерПройденныйПуть = ПараметрыДерева.ПройденныйПуть.Количество();
				КонецЕсли;
				СтатистикаУровня.Вставить("РазмерПройденныйПуть", РазмерПройденныйПуть);
				ПараметрыДерева.Замер_СтатистикаУровней.Добавить(СтатистикаУровня);
			КонецЕсли;
			
			// Переход к следующему уровню
			УзлыТекущегоУровня = УзлыСледующегоУровня;
			НомерУровня = НомерУровня + 1;
			
		КонецЦикла;
		
		// ФИЛЬТРАЦИЯ и СОХРАНЕНИЕ (один раз в конце!)
		Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" 
			И Результат.Количество() > 0 Тогда
			
			// ФИЛЬТРАЦИЯ: удаляем строки "Усреднение стоимости" и "Изменение стоимости при хранении"
			КоличествоДоФильтрации = Результат.Количество();
			Индекс = Результат.Количество() - 1;
			Пока Индекс >= 0 Цикл
				СтрокаРезультата = Результат[Индекс];
				Если СтрокаРезультата.Номенклатура = "Усреднение стоимости в незавершенном производстве"
					ИЛИ СтрокаРезультата.Номенклатура = "Изменение стоимости при хранении" Тогда
					Результат.Удалить(Индекс);
				КонецЕсли;
				Индекс = Индекс - 1;
			КонецЦикла;
			
			КоличествоУдаленных = КоличествоДоФильтрации - Результат.Количество();
			
			// ДИАГНОСТИКА: проверка строк Каучука перед сохранением
			СуммаДопРасходыКаучук = 0;
			КоличествоСтрокКаучук = 0;
			Для Каждого СтрокаДиаг Из Результат Цикл
				Если СтрНайти(Строка(СтрокаДиаг.Номенклатура), "Каучук натуральный") > 0 Тогда
					СуммаДопРасходыКаучук = СуммаДопРасходыКаучук + СтрокаДиаг.ДопРасходы;
					КоличествоСтрокКаучук = КоличествоСтрокКаучук + 1;
					ЗаписьЖурналаРегистрации(
						"СтруктураСебестоимости.ДиагностикаКаучук",
						УровеньЖурналаРегистрации.Предупреждение,
						,
						,
					СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"ПЕРЕД СОХРАНЕНИЕМ: Каучук, ДопРасходы=%1, ТребуетсяРазузлование=%2, ТребуетсяРазузлованиеДопРасходов=%3, ВидСтроки=%4",
						Строка(СтрокаДиаг.ДопРасходы),
						Строка(СтрокаДиаг.ТребуетсяРазузлование),
						Строка(СтрокаДиаг.ТребуетсяРазузлованиеДопРасходов),
						Строка(СтрокаДиаг.ВидСтроки)));
				КонецЕсли;
			КонецЦикла;
			Если КоличествоСтрокКаучук > 0 Тогда
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.ДиагностикаКаучук",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"ИТОГО перед сохранением: строк Каучука=%1, СУММА ДопРасходы=%2",
						Строка(КоличествоСтрокКаучук),
						Строка(СуммаДопРасходыКаучук)));
			КонецЕсли;
			
			// Сохраняем одной таблицей
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
				ПараметрыДерева.Результат,
				ИмяТекущейТаблицы,
				Результат,
				ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
			
			// КРИТИЧНО: Очищаем таблицу после сохранения, чтобы избежать дублирования
			// Данные уже сохранены во временную таблицу, и не должны сохраняться повторно
			Результат.Очистить();
		КонецЕсли;
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"Использована пакетная обработка: обработано узлов в первом уровне: %1, всего уровней: %2",
			Строка(ПараметрыДерева.УзлыДляПакетнойОбработки.Количество()),
			Строка(НомерУровня - 1));
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.ПакетнаяОбработка",
			УровеньЖурналаРегистрации.Предупреждение,
			,
			,
			ТекстСообщения);
	КонецЕсли;
	
	// ПРИМЕЧАНИЕ: При пакетной обработке данные сохраняются ПОСЛЕ КАЖДОГО УРОВНЯ (выше в цикле)
	// Этот блок нужен только для старого рекурсивного алгоритма или если остались несохраненные данные
	Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" Тогда
		
		// Сохраняем оставшиеся данные (если есть)
		Если Результат.Количество() > 0 Тогда
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
				ПараметрыДерева.Результат,
				ИмяТекущейТаблицы,
				Результат,
				ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
			
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				" Сохранены ОСТАВШИЕСЯ данные во ВТ '%1': строк=%2",
				ИмяТекущейТаблицы,
				Строка(Результат.Количество()));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				ТекстСообщения);
		КонецЕсли;
		
			// Объединяем все временные таблицы в итоговую
		Если НЕ ПустаяСтрока(ИменаТаблиц) Тогда
			РасчетСебестоимостиПрикладныеАлгоритмы.ОбъединитьВременныеТаблицы(
			ПараметрыДерева.Результат,
			ИменаТаблиц,
			"Результат",
			ПоляТаблицы, "", , Истина);
		Иначе
			// Если вообще нет данных, создаем пустую временную таблицу
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = ПараметрыДерева.Результат;
			Запрос.Текст =
			"ВЫБРАТЬ
			|	*
			|ПОМЕСТИТЬ Результат
			|ИЗ
			|	&Результат КАК Результат";
			
			Результат.Колонки.Удалить("Идентификатор");
			Запрос.УстановитьПараметр("Результат", Результат);
			// Структуру ВТ Результат см. в СтруктураСебестоимости.СтруктураПолейДереваСебестоимости.
			Запрос.Выполнить();
		КонецЕсли;
	КонецЕсли;
	
	// ДИАГНОСТИКА: итоговый результат
	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		КоличествоСтрокИтого = ПараметрыДерева.Результат.Строки.Количество();
	ИначеЕсли ПараметрыДерева.ТипРезультата = "ТаблицаЗначений" Тогда
		КоличествоСтрокИтого = ПараметрыДерева.Результат.Количество();
	Иначе
		// Для МенеджерВременныхТаблиц выполняем запрос подсчета строк
		Попытка
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = ПараметрыДерева.Результат;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Партия) КАК КоличествоУровень0
			|ИЗ
			|	Результат
			|ГДЕ
			|	Уровень = 0";
			РезультатПодсчета = Запрос.Выполнить().Выгрузить();
			КоличествоСтрокИтого = РезультатПодсчета[0].КоличествоУровень0;
		Исключение
			// Если временная таблица не существует или произошла ошибка
			КоличествоСтрокИтого = 0;
		КонецПопытки;
	КонецЕсли;
	
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"ЗаполнитьДеревоСебестоимости: ИТОГОВЫЙ результат содержит строк верхнего уровня=%1",
		Строка(КоличествоСтрокИтого));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ТекстСообщения);
	//#КонецВставки

КонецПроцедуры   

// Разузлование дерева себестоимости с пакетной обработкой по уровням (оптимизация N+1)
//
// Параметры:
//  ПараметрыДерева - см. СтруктураСебестоимости.ПараметрыДереваСебестоимости
//  УзлыДляОбработки - Массив из Структура - Массив узлов для обработки:
//    * ПараметрыУзла - Структура - Параметры узла
//    * ТаблицаРезультата - ДеревоЗначений, ТаблицаЗначений - Куда помещать результат
//    * ОписаниеПродукции - Структура - Описание продукции
//    * СтрокаПартия - СтрокаДереваЗначений - Ссылка на строку в дереве
//
Функция РазузловатьУзлыПакетом(ПараметрыДерева, УзлыДляОбработки)
	
	// ДИАГНОСТИКА
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"РазузловатьУзлыПакетом: начало обработки, узлов=%1",
		Строка(УзлыДляОбработки.Количество()));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ТекстСообщения);
		
	Если УзлыДляОбработки.Количество() = 0 Тогда
		Возврат Новый Массив; // Возвращаем пустой массив, если нет узлов
	КонецЕсли;
	
	// Инициализация структур для отслеживания циклов
	ПройденныйПуть = Неопределено;
	Если НЕ ПараметрыДерева.Свойство("ПройденныйПуть", ПройденныйПуть) Тогда
		ПройденныйПуть = Новый ТаблицаЗначений;
		ПройденныйПуть.Колонки.Добавить("Партия");
		ПройденныйПуть.Колонки.Добавить("АналитикаУчетаПартий");
		ПройденныйПуть.Индексы.Добавить("Партия, АналитикаУчетаПартий");
		ПараметрыДерева.Вставить("ПройденныйПуть", ПройденныйПуть);
		// Инициализируем параметры защиты от циклов и глубокой рекурсии
		ПараметрыДерева.Вставить("МаксимальнаяГлубинаРекурсии", 50);
		ПараметрыДерева.Вставить("ОбнаруженныеЦиклы", Новый Массив);
	КонецЕсли;
	
	// Обрабатываем результаты для каждого узла
	УзлыСледующегоУровня = Новый Массив;
	
	// === ПОЛНАЯ ГРУППИРОВКА С ПОСТ-РАСПРЕДЕЛЕНИЕМ ===
	// Группируем ВСЕ узлы по парам (Партия, Аналитика), выполняем ОДИН запрос,
	// затем применяем индивидуальные пропорции (Числитель/Знаменатель) для каждого узла.
	// Запрос возвращает 100% себестоимости, пост-распределение применяет доли.
	
	// Проверка максимальной глубины
	УзлыДляОбработкиПослеПроверки = Новый Массив;
	Для Каждого Узел Из УзлыДляОбработки Цикл
		УровеньУзла = Узел.ОписаниеПродукции.Уровень + 1;
		Если УровеньУзла > ПараметрыДерева.МаксимальнаяГлубинаРекурсии Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				"Достигнута максимальная глубина разузлования (%1 уровней). Партия: %2",
				Строка(УровеньУзла), Строка(Узел.ОписаниеПродукции.ПартияПродукции));
			ЗаписьЖурналаРегистрации("СтруктураСебестоимости.МаксимальнаяГлубинаРекурсии",
				УровеньЖурналаРегистрации.Предупреждение,,,ТекстСообщения);
			Продолжить;
		КонецЕсли;
		УзлыДляОбработкиПослеПроверки.Добавить(Узел);
	КонецЦикла;
	
	Если УзлыДляОбработкиПослеПроверки.Количество() = 0 Тогда
		Возврат УзлыСледующегоУровня;
	КонецЕсли;
	
	// === ГРУППИРОВКА УЗЛОВ ПО ПОЛНОМУ КЛЮЧУ (Партия, Аналитика, Числитель, Знаменатель) ===
	// КРИТИЧНО: Группируем не только по паре, но и по коэффициентам!
	// Разные узлы с одинаковой парой, но разными коэффициентами должны получить разные результаты
	// Структура группы: {Партия, Аналитика, Числитель, Знаменатель, КлючиУзлов}
	ГруппыПоПарам = Новый Соответствие;
	СоответствиеУзлов = Новый Соответствие;
	
	Для Каждого Узел Из УзлыДляОбработкиПослеПроверки Цикл
		Отборы = Узел.ПараметрыУзла.Отборы;
		КлючУзла = СоздатьКлючУзла(Узел.ПараметрыУзла);
		СоответствиеУзлов.Вставить(КлючУзла, Узел);
		
		ЧислительУзла = Отборы.Числитель;
		ЗнаменательУзла = Отборы.Знаменатель;
		
		Для Инд = 0 По Отборы.ПартииПродукции.ВГраница() Цикл
			Партия = Отборы.ПартииПродукции[Инд];
			Аналитика = Неопределено;
			Если Инд <= Отборы.АналитикиУчетаПартийПродукции.ВГраница() Тогда
				Аналитика = Отборы.АналитикиУчетаПартийПродукции[Инд];
			КонецЕсли;
			
			// КЛЮЧ ВКЛЮЧАЕТ Числитель И Знаменатель - для уникальности запроса
			КлючПолный = СоздатьКлючПолный(Партия, Аналитика, ЧислительУзла, ЗнаменательУзла);
			Группа = ГруппыПоПарам.Получить(КлючПолный);
			
			Если Группа = Неопределено Тогда
				Группа = Новый Структура;
				Группа.Вставить("Партия", Партия);
				Группа.Вставить("Аналитика", Аналитика);
				Группа.Вставить("Числитель", ЧислительУзла);
				Группа.Вставить("Знаменатель", ЗнаменательУзла);
				Группа.Вставить("КлючиУзлов", Новый Массив);
				ГруппыПоПарам.Вставить(КлючПолный, Группа);
			КонецЕсли;
			
			// Добавляем только ключ узла (все узлы в группе имеют одинаковые коэффициенты)
			Если Группа.КлючиУзлов.Найти(КлючУзла) = Неопределено Тогда
				Группа.КлючиУзлов.Добавить(КлючУзла);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// ДИАГНОСТИКА
	ЗаписьЖурналаРегистрации("СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,,,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"ГРУППИРОВКА: всего узлов=%1, уникальных пар=%2",
			Строка(УзлыДляОбработкиПослеПроверки.Количество()),
			Строка(ГруппыПоПарам.Количество())));
	
	// === ВЫПОЛНЕНИЕ ОДНОГО ЗАПРОСА ДЛЯ ВСЕХ УЗЛОВ УРОВНЯ ===
	ПервыйУзел = УзлыДляОбработкиПослеПроверки[0];
	УровеньПервогоУзла = ПервыйУзел.ОписаниеПродукции.Уровень + 1;
	ВыводитьДопРасходы = ПервыйУзел.ПараметрыУзла.Отборы.РазворачиватьДопРасходы И НЕ (УровеньПервогоУзла = 1);
	
	ВремяДоЗапроса = ТекущаяДатаСеанса();
	РезультатПоУзлам = СебестоимостьУзловПакетомГруппировка(
		УзлыДляОбработкиПослеПроверки, ГруппыПоПарам, СоответствиеУзлов, ВыводитьДопРасходы, ПараметрыДерева);
	ПараметрыДерева.Замер_ВремяЗапросов = ПараметрыДерева.Замер_ВремяЗапросов + (ТекущаяДатаСеанса() - ВремяДоЗапроса);
	ПараметрыДерева.Замер_КоличествоЗапросов = ПараметрыДерева.Замер_КоличествоЗапросов + 1;
	
	// === ОБРАБОТКА РЕЗУЛЬТАТОВ ===
	ВремяДоОбработки = ТекущаяДатаСеанса();
	Для Каждого КлючИЗначение Из РезультатПоУзлам Цикл
		КлючУзла = КлючИЗначение.Ключ;
		СебестоимостьУзла = КлючИЗначение.Значение;
		Узел = СоответствиеУзлов.Получить(КлючУзла);
		Если Узел = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ПараметрыДерева.КоличествоСтрок = ПараметрыДерева.КоличествоСтрок + СебестоимостьУзла.Количество();
		ОбработатьРезультатыУзла(ПараметрыДерева, Узел, СебестоимостьУзла, ПройденныйПуть, УзлыСледующегоУровня);
	КонецЦикла;
	ПараметрыДерева.Замер_ВремяОбработки = ПараметрыДерева.Замер_ВремяОбработки + (ТекущаяДатаСеанса() - ВремяДоОбработки);
	//#КонецВставки
	
	// НЕ вызываем рекурсивно! Возвращаем узлы следующего уровня для обработки в цикле
	Возврат УзлыСледующегоУровня;
	
КонецФункции

// Обрабатывает результаты запроса для одного узла
Процедура ОбработатьРезультатыУзла(ПараметрыДерева, Узел, СебестоимостьУзла, ПройденныйПуть, УзлыСледующегоУровня)
	
	ПараметрыУзла = Узел.ПараметрыУзла;
	ТаблицаРезультата = Узел.ТаблицаРезультата;
	ОписаниеПродукции = Узел.ОписаниеПродукции;
	
	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		Результат = ТаблицаРезультата.Строки;
	Иначе
		Результат = ТаблицаРезультата;
	КонецЕсли;
	
	// ДИАГНОСТИКА
	КоличествоДо = Результат.Количество();
	
	// ДИАГНОСТИКА: параметры обработки
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"ОбработатьРезультатыУзла начало: ТипРезультата='%1', ДобавлятьПолуфабрикаты=%2",
		ПараметрыДерева.ТипРезультата,
		Строка(ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ТекстСообщения);	
	
	АналитикаУчетаПродукции = ОписаниеПродукции.АналитикаУчетаПродукции;
	ПартияПродукции = ОписаниеПродукции.ПартияПродукции;
	АналитикаУчетаПартийПродукции = ОписаниеПродукции.АналитикаУчетаПартийПродукции;
	УровеньУзла = ОписаниеПродукции.Уровень + 1;
	
	ЭтоРазузлованиеДопРасходов = Ложь;
	
	Для Каждого ТекПартия Из СебестоимостьУзла Цикл
		
		// ДИАГНОСТИКА: проверка значения ДопРасходы для Каучука
		ИмяЗатраты = Строка(ТекПартия.Затрата);
		Если СтрНайти(ИмяЗатраты, "Каучук натуральный") > 0 Тогда
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.ДиагностикаКаучук",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"КАУЧУК из запроса: Затрата='%1', ДопРасходы=%2, Материальные=%3, СуммаЗатрата=%4, УровеньУзла=%5",
					ИмяЗатраты,
					Строка(ТекПартия.ДопРасходы),
					Строка(ТекПартия.Материальные),
					Строка(ТекПартия.СуммаЗатрата),
					Строка(УровеньУзла)));
		КонецЕсли;
		
		// Проверка на циклическую зависимость
		МассивСтрок = Новый Массив;
		Если ТекПартия.ТребуетсяРазузлование И ТекПартия.КоличествоЗатрата <> 0 Тогда
			ПараметрыОтбора = Новый Структура("Партия, АналитикаУчетаПартий",
				ТекПартия.ПартияЗатрата,
				ТекПартия.АналитикаУчетаПартийЗатрата);
			//#Вставка
			// ЗАМЕР Н2: проверка циклов
			ВремяДоПроверки = ТекущаяДатаСеанса();
			//#КонецВставки
			МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
			//#Вставка
			ПараметрыДерева.Замер_ВремяПроверкиЦиклов = ПараметрыДерева.Замер_ВремяПроверкиЦиклов 
				+ (ТекущаяДатаСеанса() - ВремяДоПроверки);
			ПараметрыДерева.Замер_КоличествоПроверокЦиклов = ПараметрыДерева.Замер_КоличествоПроверокЦиклов + 1;
			//#КонецВставки
			
			// Логирование обнаруженного цикла
			Если МассивСтрок.Количество() > 0 Тогда
				ИнформацияОЦикле = Новый Структура;
				ИнформацияОЦикле.Вставить("Уровень", УровеньУзла);
				ИнформацияОЦикле.Вставить("ПартияЗатрата", ТекПартия.ПартияЗатрата);
				ИнформацияОЦикле.Вставить("АналитикаУчетаПартийЗатрата", ТекПартия.АналитикаУчетаПартийЗатрата);
				ИнформацияОЦикле.Вставить("Затрата", ТекПартия.Затрата);
				ИнформацияОЦикле.Вставить("ПартияПродукции", ПартияПродукции);
				ИнформацияОЦикле.Вставить("АналитикаУчетаПартийПродукции", АналитикаУчетаПартийПродукции);
				
				ПараметрыДерева.ОбнаруженныеЦиклы.Добавить(ИнформацияОЦикле);
				
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"Обнаружен циклический переход на уровне %1: Затрата '%2' (Партия: %3, Аналитика партий: %4) -> уже обрабатывалась в пути от Партии: %5, Аналитики партий: %6",
					Строка(УровеньУзла),
					Строка(ТекПартия.Затрата),
					Строка(ТекПартия.ПартияЗатрата),
					Строка(ТекПартия.АналитикаУчетаПартийЗатрата),
					Строка(ПартияПродукции),
					Строка(АналитикаУчетаПартийПродукции));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.ОбнаруженЦикл",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
			КонецЕсли;
		КонецЕсли;
		
		// Добавляем строку в результат
		УсловиеДобавления = ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			ИЛИ ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат
			ИЛИ Не ТекПартия.ТребуетсяРазузлование;
		
		// ДИАГНОСТИКА: проверка, почему строка не добавляется
		Если НЕ УсловиеДобавления Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				"Строка НЕ добавлена: Затрата='%1', ТипРезультата='%2', ДобавлятьПолуфабрикаты=%3, ТребуетсяРазузлование=%4",
				Строка(ТекПартия.Затрата),
				ПараметрыДерева.ТипРезультата,
				Строка(ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат),
				Строка(ТекПартия.ТребуетсяРазузлование));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				ТекстСообщения);
		КонецЕсли;
		
		Если УсловиеДобавления Тогда			
			СтрокаПартия = Результат.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаПартия, ТекПартия);
			
			// ДИАГНОСТИКА: проверка ДопРасходы после ЗаполнитьЗначенияСвойств
			Если СтрНайти(ИмяЗатраты, "Каучук натуральный") > 0 Тогда
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.ДиагностикаКаучук",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"КАУЧУК после копирования: СтрокаПартия.ДопРасходы=%1, ТекПартия.ДопРасходы=%2",
						Строка(СтрокаПартия.ДопРасходы),
						Строка(ТекПартия.ДопРасходы)));
			КонецЕсли;
			
			СтрокаПартия.Идентификатор = Новый УникальныйИдентификатор();
			Если ТекПартия.ТребуетсяРазузлование
				И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
				И (ТекПартия.СуммаЗатрата <> 0 ИЛИ ТекПартия.СуммаЗатратаЗабалансовая <> 0)
				И МассивСтрок.Количество() = 0 Тогда
				
				СтрокаПартия.ВидСтроки = Перечисления.ВидыСтрокДереваСебестоимости.ПартияПолуфабриката;
				СтрокаПартия.Числитель = ТекПартия.КоличествоЗатрата;
			Иначе
				СтрокаПартия.ВидСтроки = Перечисления.ВидыСтрокДереваСебестоимости.ПартияЗатраты;
				// КРИТИЧНО: Обязательно устанавливаем ТребуетсяРазузлование = Ложь для материалов!
				// Отчёт игнорирует ДопРасходы если ТребуетсяРазузлование = Истина:
				// СУММА(ВЫБОР КОГДА Результат.ТребуетсяРазузлование... ТОГДА 0 ИНАЧЕ Результат.ДопРасходы)
				СтрокаПартия.ТребуетсяРазузлование = Ложь;
				// КРИТИЧНО: Сбрасываем ТребуетсяРазузлованиеДопРасходов ТОЛЬКО если дочерний узел НЕ будет создан!
				// Отчёт проверяет ОБА условия: ТребуетсяРазузлование ИЛИ ТребуетсяРазузлованиеДопРасходов
				// Условие создания дочернего узла: ТребуетсяРазузлованиеДопРасходов И КоличествоЗатрата <> 0 И ДопРасходы <> 0
				// Если условие ЛОЖНО, дочерний узел не создастся и можно сбросить флаг
				Если НЕ (ТекПартия.ТребуетсяРазузлованиеДопРасходов
					И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
					И ТекПартия.ДопРасходы <> 0) Тогда
					СтрокаПартия.ТребуетсяРазузлованиеДопРасходов = Ложь;
				КонецЕсли;
			КонецЕсли;
			
			// КРИТИЧНО: Заполняем поля партии продукции из ОписаниеПродукции (корневая продукция)!
			// ПартияПродукции - это партия КОРНЕВОЙ продукции, которая передаётся неизменной
			// через все уровни рекурсии. Это нужно для правильного соединения в отчёте:
			// ВТПродукция.ПартияПродукции = Затраты.ПартияПродукции
			// А поле ПартияВыходноеИзделие (партия непосредственного родителя-полуфабриката)
			// копируется через ЗаполнитьЗначенияСвойств выше!
			СтрокаПартия.ПартияПродукции = ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартийПродукции = АналитикаУчетаПартийПродукции;
			СтрокаПартия.АналитикаУчетаПродукции = АналитикаУчетаПродукции;
			
		// КРИТИЧНО: Заполняем аналитику выходного изделия из ОписаниеПродукции!
		// В СТАРОМ алгоритме (строки 585, 617): 
		//   НоваяСтрока.ПартияВыходноеИзделие = ОписаниеПродукции.ПартияПродукции;
		// ПартияВыходноеИзделие должна быть = партия КОРНЕВОЙ продукции, а не промежуточного полуфабриката!
		// Это нужно для правильного join в отчёте:
		//   ВТПродукция.ПартияПродукции = Затраты.ПартияПолуфабриката (= Результат.ПартияВыходноеИзделие)
		// ЗаполнитьЗначенияСвойств копирует из запроса партию промежуточного полуфабриката,
		// но нужна партия КОРНЕВОЙ продукции из ОписаниеПродукции!
			СтрокаПартия.ПартияВыходноеИзделие = ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартийВыходноеИзделие = АналитикаУчетаПартийПродукции;
			СтрокаПартия.АналитикаУчетаВыходноеИзделие = АналитикаУчетаПродукции;
			
			СтрокаПартия.Номенклатура = ТекПартия.Затрата;
			СтрокаПартия.Характеристика = ТекПартия.ХарактеристикаЗатрата;
			СтрокаПартия.Серия = ТекПартия.СерияЗатрата;
			СтрокаПартия.Назначение = ТекПартия.НазначениеЗатрата;
			СтрокаПартия.Партия = ТекПартия.ПартияЗатрата;
			СтрокаПартия.АналитикаУчетаПартий = ТекПартия.АналитикаУчетаПартийЗатрата;
			СтрокаПартия.ЕдиницаИзмерения = ТекПартия.ЕдиницаИзмеренияЗатрата;
			СтрокаПартия.Уровень = УровеньУзла;
			
			СтрокаПартия.Количество = ТекПартия.КоличествоЗатрата;
			СтрокаПартия.Сумма = Окр(ТекПартия.СуммаЗатрата, 2);
			СтрокаПартия.ДопРасходы = Окр(СтрокаПартия.ДопРасходы, 2);
			СтрокаПартия.НалоговыйУчет = Окр(СтрокаПартия.НалоговыйУчет, 2);
			СтрокаПартия.СуммаЗабалансовая = ТекПартия.СуммаЗатратаЗабалансовая;
			
			// Уменьшаем суммовые показатели в узле
			Если ПараметрыУзла.Сумма <> 0 ИЛИ ПараметрыУзла.СуммаЗабалансовая <> 0 Тогда
				ПараметрыУзла.Сумма = ПараметрыУзла.Сумма - СтрокаПартия.Сумма;
				ПараметрыУзла.Материальные = ПараметрыУзла.Материальные - СтрокаПартия.Материальные;
				ПараметрыУзла.ДопРасходы = ПараметрыУзла.ДопРасходы - СтрокаПартия.ДопРасходы;
				ПараметрыУзла.Трудозатраты = ПараметрыУзла.Трудозатраты - СтрокаПартия.Трудозатраты;
				ПараметрыУзла.ПостатейныеПеременные = ПараметрыУзла.ПостатейныеПеременные - СтрокаПартия.ПостатейныеПеременные;
				ПараметрыУзла.ПостатейныеПостоянные = ПараметрыУзла.ПостатейныеПостоянные - СтрокаПартия.ПостатейныеПостоянные;
				ПараметрыУзла.НалоговыйУчет = ПараметрыУзла.НалоговыйУчет - СтрокаПартия.НалоговыйУчет;
				ПараметрыУзла.ПостояннаяРазница = ПараметрыУзла.ПостояннаяРазница - СтрокаПартия.ПостояннаяРазница;
				ПараметрыУзла.ВременнаяРазница = ПараметрыУзла.ВременнаяРазница - СтрокаПартия.ВременнаяРазница;
				ПараметрыУзла.СуммаЗабалансовая = ПараметрыУзла.СуммаЗабалансовая - СтрокаПартия.СуммаЗабалансовая;
				
				ЭтоРазузлованиеДопРасходов = (ТекПартия.ТипЗатрат = "ДопРасходы");
			КонецЕсли;
		КонецЕсли;
		
		// Подготовка узла для следующего уровня
		Если (ТекПартия.ТребуетсяРазузлование
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И (ТекПартия.СуммаЗатрата <> 0 ИЛИ ТекПартия.СуммаЗатратаЗабалансовая <> 0)
			И МассивСтрок.Количество() = 0)
			ИЛИ (ТекПартия.ТребуетсяРазузлованиеДопРасходов
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И ТекПартия.ДопРасходы <> 0) Тогда
			
			ПараметрыУзлаПартии = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();
			
			// Добавляем партию в пройденный путь (НЕ для дополнительных расходов)
			Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
				НовыйПуть = ПройденныйПуть.Добавить();
				НовыйПуть.Партия = ТекПартия.ПартияЗатрата;
				НовыйПуть.АналитикаУчетаПартий = ТекПартия.АналитикаУчетаПартийЗатрата;
			КонецЕсли;
			
			Отборы = ПараметрыУзлаПартии.Отборы;
			Отборы.ДанныеПоСебестоимости = ПараметрыУзла.Отборы.ДанныеПоСебестоимости;
			Отборы.Продукция.Добавить(ТекПартия.Затрата);
			Отборы.ХарактеристикиПродукции.Добавить(ТекПартия.ХарактеристикаЗатрата);
			Отборы.СерииПродукции.Добавить(ТекПартия.СерияЗатрата);
			Отборы.ПартииПродукции.Добавить(ТекПартия.ПартияЗатрата);
			Отборы.АналитикиУчетаПартийПродукции.Добавить(ТекПартия.АналитикаУчетаПартийЗатрата);
			Отборы.АналитикаУчетаЗатрата.Добавить(ТекПартия.АналитикаУчетаЗатрата);
			Отборы.Числитель = ТекПартия.КоличествоЗатрата;
			Отборы.КоличествоПродукции = Макс(-ТекПартия.КоличествоЗатрата, ТекПартия.КоличествоЗатрата);
			Отборы.РазворачиватьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы;
			Отборы.ДатаИсходнойПартии = ПараметрыУзла.Отборы.ДатаИсходнойПартии;
			Отборы.ДатаОкончания = ПараметрыУзла.Отборы.ДатаОкончания;
			Отборы.ВключитьНДСВСтоимость = ТекПартия.ВключитьНДСВСтоимость;
			Отборы.ИсключитьНДСИзСтоимости = ТекПартия.ИсключитьНДСИзСтоимости;
			Отборы.АналитикаУчетаВыходноеИзделие = ТекПартия.АналитикаУчетаЗатрата;
			Отборы.СтатьяКалькуляции = ТекПартия.СтатьяКалькуляции;
			
		Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
			ТаблицаРезультатаПартии = СтрокаПартия;
		Иначе
			ТаблицаРезультатаПартии = Результат;
		КонецЕсли;
		
		// КРИТИЧНО: Заполняем ПараметрыУзлаПартии из ТекПартия (а не СтрокаПартия),
		// т.к. СтрокаПартия может быть не создана, если ДобавлятьПолуфабрикатыВРезультат = Ложь
		// Также в старом алгоритме это делается только для обычных партий (НЕ для дополнительных расходов)
		Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
			ПараметрыУзлаПартии.Сумма = ТекПартия.СуммаЗатрата;
			ПараметрыУзлаПартии.Материальные = ТекПартия.Материальные;
			ПараметрыУзлаПартии.ДопРасходы = ТекПартия.ДопРасходы;
			ПараметрыУзлаПартии.Трудозатраты = ТекПартия.Трудозатраты;
			ПараметрыУзлаПартии.ПостатейныеПеременные = ТекПартия.ПостатейныеПеременные;
			ПараметрыУзлаПартии.ПостатейныеПостоянные = ТекПартия.ПостатейныеПостоянные;
			ПараметрыУзлаПартии.НалоговыйУчет = ТекПартия.НалоговыйУчет;
			ПараметрыУзлаПартии.ПостояннаяРазница = ТекПартия.ПостояннаяРазница;
			ПараметрыУзлаПартии.ВременнаяРазница = ТекПартия.ВременнаяРазница;
			ПараметрыУзлаПартии.СуммаЗабалансовая = ТекПартия.СуммаЗатратаЗабалансовая;
		КонецЕсли;
			
		// КРИТИЧНО: Передаём данные КОРНЕВОЙ продукции, как в старом алгоритме!
		// В старом алгоритме ОписаниеПродукции передаётся НЕИЗМЕННЫМ через все уровни рекурсии.
		// Только поле Уровень обновляется для каждого нового уровня.
		// Это нужно для правильного соединения в отчёте:
		// ВТПродукция.ПартияПродукции = Затраты.ПартияПродукции
		НовоеОписаниеПродукции = Новый Структура("АналитикаУчетаПродукции, ПартияПродукции, АналитикаУчетаПартийПродукции");
		НовоеОписаниеПродукции.АналитикаУчетаПродукции = АналитикаУчетаПродукции;
		НовоеОписаниеПродукции.ПартияПродукции = ПартияПродукции;
		НовоеОписаниеПродукции.АналитикаУчетаПартийПродукции = АналитикаУчетаПартийПродукции;
		НовоеОписаниеПродукции.Вставить("Уровень", УровеньУзла);
		
		// Определяем СтрокаПартия: она существует только если УсловиеДобавления было Истина
		// В противном случае (полуфабрикат с ДобавлятьПолуфабрикатыВРезультат = Ложь)
		// передаем Неопределено
		СтрокаДляУзла = Неопределено;
		Если УсловиеДобавления Тогда
			СтрокаДляУзла = СтрокаПартия;
		КонецЕсли;
		
		НовыйУзел = Новый Структура;
		НовыйУзел.Вставить("ПараметрыУзла", ПараметрыУзлаПартии);
		НовыйУзел.Вставить("ТаблицаРезультата", ТаблицаРезультатаПартии);
		НовыйУзел.Вставить("ОписаниеПродукции", НовоеОписаниеПродукции);
		НовыйУзел.Вставить("СтрокаПартия", СтрокаДляУзла);
		
		// КРИТИЧНО: Флаг для сброса ТребуетсяРазузлованиеДопРасходов после обработки
		// Если это узел для разузлования доп расходов и он не добавит строк,
		// нужно сбросить ТребуетсяРазузлованиеДопРасходов в родительской строке
		// (как в старом алгоритме, строки 533-538)
		ЭтоУзелДляДопРасходов = ТекПартия.ТребуетсяРазузлованиеДопРасходов
			И НЕ ТекПартия.ТребуетсяРазузлование;
		НовыйУзел.Вставить("ЭтоУзелДляДопРасходов", ЭтоУзелДляДопРасходов);
		НовыйУзел.Вставить("РодительскаяСтрока", СтрокаДляУзла);
		
		УзлыСледующегоУровня.Добавить(НовыйУзел);
		КонецЕсли;
		
	КонецЦикла;
	
	// ДИАГНОСТИКА
	КоличествоПосле = Результат.Количество();
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"ОбработатьРезультатыУзла: добавлено строк=%1 (было=%2, стало=%3), следующий уровень узлов=%4",
		Строка(КоличествоПосле - КоличествоДо),
		Строка(КоличествоДо),
		Строка(КоличествоПосле),
		Строка(УзлыСледующегоУровня.Количество()));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ТекстСообщения);
	
	// КРИТИЧНО: Сброс ТребуетсяРазузлованиеДопРасходов в родительской строке
	// Аналог старого алгоритма (строки 533-538):
	// Если разузлование доп расходов не выполнено (не добавлено строк), снимем признак
	Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц"
		И Узел.Свойство("ЭтоУзелДляДопРасходов")
		И Узел.ЭтоУзелДляДопРасходов
		И КоличествоПосле = КоличествоДо
		И Узел.Свойство("РодительскаяСтрока")
		И Узел.РодительскаяСтрока <> Неопределено Тогда
		Узел.РодительскаяСтрока.ТребуетсяРазузлованиеДопРасходов = Ложь;
	КонецЕсли;
		
	// При наличии данных о разузловании добавим строку на суммы изменения стоимости
	Если СебестоимостьУзла.Количество() > 0 И НЕ ЭтоРазузлованиеДопРасходов Тогда
		УчестьИзменениеСтоимости(ПараметрыУзла, ОписаниеПродукции, Результат);
	КонецЕсли;
	
КонецПроцедуры   

// Пакетное получение себестоимости для нескольких узлов одним запросом (оптимизация N+1)
//
// Параметры:
//  МассивПараметровУзлов - Массив из Структура - Массив параметров узлов для обработки
//  ВыводитьДопРасходы - Булево - Выводить ли дополнительные расходы
//  ОбщиеПараметры - Структура - Общие параметры для всех узлов (ДанныеПоСебестоимости и т.д.)
//
// Возвращаемое значение:
//  Соответствие - Ключ: идентификатор узла (Партия+АналитикаПартий), Значение: ТаблицаЗначений с данными себестоимости
//
Функция СебестоимостьУзловПакетом(МассивПараметровУзлов, ВыводитьДопРасходы, ОбщиеПараметры)
	
	Если МассивПараметровУзлов.Количество() = 0 Тогда
		Возврат Новый Соответствие;
	КонецЕсли;
	
	// Собираем все партии и аналитики для пакетного запроса
	// + создаём индекс для быстрого распределения результатов
	ВсеПартииПродукции = Новый Массив;
	ВсеАналитикиУчетаПартийПродукции = Новый Массив;
	ВсеПродукция = Новый Массив;
	ВсеХарактеристики = Новый Массив;
	ВсеСерии = Новый Массив;
	ВсеНазначения = Новый Массив;
	
	// Индекс: ПАРА (Партия + Аналитика) -> МАССИВ КлючейУзлов (для распределения результатов)
	// КРИТИЧНО: одна пара может принадлежать нескольким узлам (повторное использование полуфабриката)!
	ИндексПарПоУзлам = Новый Соответствие;
	
	Для Каждого ПараметрыУзла Из МассивПараметровУзлов Цикл
		Отборы = ПараметрыУзла.Отборы;
		КлючУзла = СоздатьКлючУзла(ПараметрыУзла);
		
		// Создаём индекс по ПАРАМ (Партия, Аналитика) для правильного распределения
		// У узла обычно одна партия и одна аналитика, но обрабатываем как массивы
		Для Инд = 0 По Отборы.ПартииПродукции.ВГраница() Цикл
			Партия = Отборы.ПартииПродукции[Инд];
			Аналитика = Неопределено;
			Если Инд <= Отборы.АналитикиУчетаПартийПродукции.ВГраница() Тогда
				Аналитика = Отборы.АналитикиУчетаПартийПродукции[Инд];
			КонецЕсли;
			
			// Добавляем партию в общий массив
			Если ВсеПартииПродукции.Найти(Партия) = Неопределено Тогда
				ВсеПартииПродукции.Добавить(Партия);
			КонецЕсли;
			
			// Добавляем аналитику в общий массив
			Если Аналитика <> Неопределено И ВсеАналитикиУчетаПартийПродукции.Найти(Аналитика) = Неопределено Тогда
				ВсеАналитикиУчетаПартийПродукции.Добавить(Аналитика);
			КонецЕсли;
			
			// Создаём ключ пары для индекса
			// КРИТИЧНО: храним МАССИВ ключей, т.к. одна пара может принадлежать нескольким узлам!
			КлючПары = СоздатьКлючПары(Партия, Аналитика);
			МассивКлючейУзлов = ИндексПарПоУзлам.Получить(КлючПары);
			Если МассивКлючейУзлов = Неопределено Тогда
				МассивКлючейУзлов = Новый Массив;
				ИндексПарПоУзлам.Вставить(КлючПары, МассивКлючейУзлов);
			КонецЕсли;
			МассивКлючейУзлов.Добавить(КлючУзла);
		КонецЦикла;
		
		Для Каждого Продукция Из Отборы.Продукция Цикл
			Если ВсеПродукция.Найти(Продукция) = Неопределено Тогда
				ВсеПродукция.Добавить(Продукция);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Характеристика Из Отборы.ХарактеристикиПродукции Цикл
			Если ВсеХарактеристики.Найти(Характеристика) = Неопределено Тогда
				ВсеХарактеристики.Добавить(Характеристика);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Серия Из Отборы.СерииПродукции Цикл
			Если ВсеСерии.Найти(Серия) = Неопределено Тогда
				ВсеСерии.Добавить(Серия);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Назначение Из Отборы.НазначенияПродукции Цикл
			Если ВсеНазначения.Найти(Назначение) = Неопределено Тогда
				ВсеНазначения.Добавить(Назначение);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// Создаем объединенные параметры для пакетного запроса
	ПараметрыУзлаОбъединенные = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();
	ОтборыОбъединенные = ПараметрыУзлаОбъединенные.Отборы;
	
	// Копируем общие параметры из первого узла (они должны быть одинаковыми)
	ПервыйУзел = МассивПараметровУзлов[0];
	ОтборыОбъединенные.ДанныеПоСебестоимости = ПервыйУзел.Отборы.ДанныеПоСебестоимости;
	ОтборыОбъединенные.РазворачиватьДопРасходы = ПервыйУзел.Отборы.РазворачиватьДопРасходы;
	ОтборыОбъединенные.ДатаОкончания = ПервыйУзел.Отборы.ДатаОкончания;
	ОтборыОбъединенные.ДатаИсходнойПартии = ПервыйУзел.Отборы.ДатаИсходнойПартии;
	
	// Устанавливаем объединенные массивы
	ОтборыОбъединенные.ПартииПродукции = ВсеПартииПродукции;
	ОтборыОбъединенные.АналитикиУчетаПартийПродукции = ВсеАналитикиУчетаПартийПродукции;
	ОтборыОбъединенные.Продукция = ВсеПродукция;
	ОтборыОбъединенные.ХарактеристикиПродукции = ВсеХарактеристики;
	ОтборыОбъединенные.СерииПродукции = ВсеСерии;
	ОтборыОбъединенные.НазначенияПродукции = ВсеНазначения;
	
	// Выполняем ОДИН запрос для ВСЕХ узлов уровня
	Запрос = ЗапросВыпущеннаяПродукция(ПараметрыУзлаОбъединенные, Истина);
	Запрос.Текст = Запрос.Текст + ТекстЗапросаЗатратыНаПродукцию(ВыводитьДопРасходы);
	
	ВсеДанные = Запрос.Выполнить().Выгрузить();
	
	// ДИАГНОСТИКА: проверяем структуру результата
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"СебестоимостьУзловПакетом: получено строк=%1, колонок=%2",
		Строка(ВсеДанные.Количество()),
		Строка(ВсеДанные.Колонки.Количество()));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ТекстСообщения);
	
	// Проверяем наличие необходимых колонок
	Если ВсеДанные.Колонки.Найти("ПартияВыходноеИзделие") = Неопределено
		ИЛИ ВсеДанные.Колонки.Найти("АналитикаУчетаПартийВыходноеИзделие") = Неопределено Тогда
		ТекстСообщения = "ОШИБКА: В результате запроса отсутствуют колонки для распределения!";
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.ОШИБКА",
			УровеньЖурналаРегистрации.Ошибка,
			,
			,
			ТекстСообщения);
		// Возвращаем пустые таблицы для всех узлов
		РезультатПоУзлам = Новый Соответствие;
		Для Каждого ПараметрыУзла Из МассивПараметровУзлов Цикл
			КлючУзла = СоздатьКлючУзла(ПараметрыУзла);
			РезультатПоУзлам.Вставить(КлючУзла, Новый ТаблицаЗначений);
		КонецЦикла;
		Возврат РезультатПоУзлам;
	КонецЕсли;
	
	// Распределяем результаты по узлам на основе ПАРЫ (Партия + Аналитика)
	// КРИТИЧНО: используем пару, чтобы правильно распределить данные и избежать дублирования!
	РезультатПоУзлам = Новый Соответствие;
	
	// Инициализируем пустые таблицы для каждого узла
	Для Каждого ПараметрыУзла Из МассивПараметровУзлов Цикл
		КлючУзла = СоздатьКлючУзла(ПараметрыУзла);
		// Создаём пустую таблицу с такой же структурой
		ТаблицаУзла = ВсеДанные.СкопироватьКолонки();
		РезультатПоУзлам.Вставить(КлючУзла, ТаблицаУзла);
	КонецЦикла;
	
	// Распределяем строки по узлам на основе ПАРЫ (Партия, Аналитика)
	// КРИТИЧНО: одна пара может принадлежать нескольким узлам - копируем в каждый!
	Для Каждого СтрокаДанных Из ВсеДанные Цикл
		// Создаём ключ пары для поиска узлов
		КлючПары = СоздатьКлючПары(СтрокаДанных.ПартияВыходноеИзделие, 
			СтрокаДанных.АналитикаУчетаПартийВыходноеИзделие);
		
		// Находим МАССИВ ключей узлов по ПАРЕ (Партия + Аналитика)
		МассивКлючейУзлов = ИндексПарПоУзлам.Получить(КлючПары);
		
		Если МассивКлючейУзлов <> Неопределено Тогда
			// Копируем строку данных во ВСЕ узлы, которым принадлежит эта пара
			Для Каждого КлючУзла Из МассивКлючейУзлов Цикл
				ТаблицаУзла = РезультатПоУзлам.Получить(КлючУзла);
				Если ТаблицаУзла <> Неопределено Тогда
					НоваяСтрока = ТаблицаУзла.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаДанных);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	Возврат РезультатПоУзлам;
	
КонецФункции

// Создает уникальный ключ для узла на основе его параметров
Функция СоздатьКлючУзла(ПараметрыУзла)
	
	Отборы = ПараметрыУзла.Отборы;
	
	КлючПартии = "";
	Для Каждого Партия Из Отборы.ПартииПродукции Цикл
		КлючПартии = КлючПартии + Строка(Партия.УникальныйИдентификатор()) + ";";
	КонецЦикла;
	
	КлючАналитики = "";
	Для Каждого Аналитика Из Отборы.АналитикиУчетаПартийПродукции Цикл
		КлючАналитики = КлючАналитики + Строка(Аналитика.УникальныйИдентификатор()) + ";";
	КонецЦикла;
	
	Возврат КлючПартии + "|" + КлючАналитики;
	
КонецФункции

// Создает уникальный ключ для пары (Партия, Аналитика)
// Используется для правильного распределения результатов пакетного запроса
Функция СоздатьКлючПары(Партия, Аналитика)
	
	КлючПартии = "";
	Если Партия <> Неопределено Тогда
		КлючПартии = Строка(Партия.УникальныйИдентификатор());
	КонецЕсли;
	
	КлючАналитики = "";
	Если Аналитика <> Неопределено Тогда
		КлючАналитики = Строка(Аналитика.УникальныйИдентификатор());
	КонецЕсли;
	
	Возврат КлючПартии + "|" + КлючАналитики;
	
КонецФункции

// Создаёт уникальный ключ для полной комбинации (Партия, Аналитика, Числитель, Знаменатель)
// Используется для группировки узлов с абсолютно одинаковыми параметрами запроса
//
// Параметры:
//  Партия - СправочникСсылка.ПартииПроизводства - Партия продукции
//  Аналитика - СправочникСсылка.КлючиАналитикиУчетаПартий - Аналитика учёта партий
//  Числитель - Число - Числитель пропорции
//  Знаменатель - Число - Знаменатель пропорции
//
// Возвращаемое значение:
//  Строка - Уникальный ключ
//
Функция СоздатьКлючПолный(Партия, Аналитика, Числитель, Знаменатель)
	
	// Используем базовый ключ пары + добавляем коэффициенты
	КлючПары = СоздатьКлючПары(Партия, Аналитика);
	Возврат КлючПары + "|" + Формат(Числитель, "ЧДЦ=6; ЧРД=.; ЧН=0") + "|" + Формат(Знаменатель, "ЧДЦ=6; ЧРД=.; ЧН=0");
	
КонецФункции

// Пакетное получение себестоимости с использованием JOIN через временную таблицу пар
// Устраняет проблему декартова произведения при объединении партий и аналитик
//
// Параметры:
//  МассивПараметровУзлов - Массив из Структура - Массив параметров узлов для обработки
//  ВыводитьДопРасходы - Булево - Выводить ли дополнительные расходы
//  ОбщиеПараметры - Структура - Общие параметры дерева
//
// Возвращаемое значение:
//  Соответствие - Ключ: КлючУзла, Значение: ТаблицаЗначений с данными себестоимости
//
Функция СебестоимостьУзловПакетомJOIN(МассивПараметровУзлов, ВыводитьДопРасходы, ОбщиеПараметры)
	
	Если МассивПараметровУзлов.Количество() = 0 Тогда
		Возврат Новый Соответствие;
	КонецЕсли;
	
	// 1. Собираем пары (Партия, Аналитика) -> КлючУзла для каждого узла
	// Определяем типы на основе первого узла
	ПервыйУзел = МассивПараметровУзлов[0];
	
	// Тип партии - составной (разные документы могут быть партиями)
	ТипыПартий = Новый Массив;
	Для Каждого ТекПараметры Из МассивПараметровУзлов Цикл
		Для Каждого Партия Из ТекПараметры.Отборы.ПартииПродукции Цикл
			Если Партия <> Неопределено Тогда
				ТипПартии = ТипЗнч(Партия);
				Если ТипыПартий.Найти(ТипПартии) = Неопределено Тогда
					ТипыПартий.Добавить(ТипПартии);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// Тип аналитики
	ТипыАналитик = Новый Массив;
	Для Каждого ТекПараметры Из МассивПараметровУзлов Цикл
		Для Каждого Аналитика Из ТекПараметры.Отборы.АналитикиУчетаПартийПродукции Цикл
			Если Аналитика <> Неопределено Тогда
				ТипАналитики = ТипЗнч(Аналитика);
				Если ТипыАналитик.Найти(ТипАналитики) = Неопределено Тогда
					ТипыАналитик.Добавить(ТипАналитики);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// Создаём таблицу значений с явными типами
	ТаблицаПарУзлов = Новый ТаблицаЗначений;
	ТаблицаПарУзлов.Колонки.Добавить("КлючУзла", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(200)));
	ТаблицаПарУзлов.Колонки.Добавить("ПартияПродукции", Новый ОписаниеТипов(ТипыПартий));
	ТаблицаПарУзлов.Колонки.Добавить("АналитикаУчетаПартийПродукции", Новый ОписаниеТипов(ТипыАналитик));
	// Добавляем Числитель/Знаменатель для каждой пары - критично для расчёта доли!
	КвалификаторыЧисла = Новый КвалификаторыЧисла(15, 5);
	ТаблицаПарУзлов.Колонки.Добавить("Числитель", Новый ОписаниеТипов("Число", КвалификаторыЧисла));
	ТаблицаПарУзлов.Колонки.Добавить("Знаменатель", Новый ОписаниеТипов("Число", КвалификаторыЧисла));
	
	// Индекс для распределения результатов: КлючУзла -> КлючПары
	// Каждый узел имеет УНИКАЛЬНУЮ комбинацию (Партия, Аналитика, Числитель, Знаменатель)
	ИндексПарПоУзлам = Новый Соответствие;
	
	// Собираем прочие параметры
	ВсеПродукция = Новый Массив;
	ВсеХарактеристики = Новый Массив;
	ВсеСерии = Новый Массив;
	ВсеНазначения = Новый Массив;
	
	Для Каждого ПараметрыУзла Из МассивПараметровУзлов Цикл
		Отборы = ПараметрыУзла.Отборы;
		КлючУзла = СоздатьКлючУзла(ПараметрыУзла);
		
		// Получаем Числитель и Знаменатель для этого узла
		ЧислительУзла = 0;
		ЗнаменательУзла = 0;
		Если Отборы.Свойство("Числитель") Тогда
			ЧислительУзла = Отборы.Числитель;
		КонецЕсли;
		Если Отборы.Свойство("Знаменатель") Тогда
			ЗнаменательУзла = Отборы.Знаменатель;
		КонецЕсли;
		
		// Добавляем пары в таблицу для ВТ
		Для Инд = 0 По Отборы.ПартииПродукции.ВГраница() Цикл
			Партия = Отборы.ПартииПродукции[Инд];
			Аналитика = Неопределено;
			Если Инд <= Отборы.АналитикиУчетаПартийПродукции.ВГраница() Тогда
				Аналитика = Отборы.АналитикиУчетаПартийПродукции[Инд];
			КонецЕсли;
			
			// Добавляем пару в таблицу для ВТ с коэффициентами
			НоваяСтрока = ТаблицаПарУзлов.Добавить();
			НоваяСтрока.КлючУзла = КлючУзла;
			НоваяСтрока.ПартияПродукции = Партия;
			НоваяСтрока.АналитикаУчетаПартийПродукции = Аналитика;
			НоваяСтрока.Числитель = ЧислительУзла;
			НоваяСтрока.Знаменатель = ЗнаменательУзла;
			
			// Индекс: КлючПары -> МассивКлючейУзлов (для распределения результатов)
			// Одна пара может относиться к нескольким узлам
			КлючПары = СоздатьКлючПары(Партия, Аналитика);
			МассивКлючей = ИндексПарПоУзлам.Получить(КлючПары);
			Если МассивКлючей = Неопределено Тогда
				МассивКлючей = Новый Массив;
				ИндексПарПоУзлам.Вставить(КлючПары, МассивКлючей);
			КонецЕсли;
			Если МассивКлючей.Найти(КлючУзла) = Неопределено Тогда
				МассивКлючей.Добавить(КлючУзла);
			КонецЕсли;
		КонецЦикла;
		
		// Собираем прочие параметры
		Для Каждого Продукция Из Отборы.Продукция Цикл
			Если ВсеПродукция.Найти(Продукция) = Неопределено Тогда
				ВсеПродукция.Добавить(Продукция);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Характеристика Из Отборы.ХарактеристикиПродукции Цикл
			Если ВсеХарактеристики.Найти(Характеристика) = Неопределено Тогда
				ВсеХарактеристики.Добавить(Характеристика);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Серия Из Отборы.СерииПродукции Цикл
			Если ВсеСерии.Найти(Серия) = Неопределено Тогда
				ВсеСерии.Добавить(Серия);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Назначение Из Отборы.НазначенияПродукции Цикл
			Если ВсеНазначения.Найти(Назначение) = Неопределено Тогда
				ВсеНазначения.Добавить(Назначение);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// 2. Создаём объединённые параметры
	ПараметрыУзлаОбъединенные = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();
	ОтборыОбъединенные = ПараметрыУзлаОбъединенные.Отборы;
	
	// ПервыйУзел уже определён выше при сборе типов
	ОтборыОбъединенные.ДанныеПоСебестоимости = ПервыйУзел.Отборы.ДанныеПоСебестоимости;
	ОтборыОбъединенные.РазворачиватьДопРасходы = ПервыйУзел.Отборы.РазворачиватьДопРасходы;
	ОтборыОбъединенные.ДатаОкончания = ПервыйУзел.Отборы.ДатаОкончания;
	ОтборыОбъединенные.ДатаИсходнойПартии = ПервыйУзел.Отборы.ДатаИсходнойПартии;
	ОтборыОбъединенные.Продукция = ВсеПродукция;
	ОтборыОбъединенные.ХарактеристикиПродукции = ВсеХарактеристики;
	ОтборыОбъединенные.СерииПродукции = ВсеСерии;
	ОтборыОбъединенные.НазначенияПродукции = ВсеНазначения;
	
	// ВАЖНО: устанавливаем пустые массивы для партий/аналитик - они будут через ВТ
	ОтборыОбъединенные.ПартииПродукции = Новый Массив;
	ОтборыОбъединенные.АналитикиУчетаПартийПродукции = Новый Массив;
	
	// Устанавливаем флаги "по всем" для партий и аналитик
	// Это отключит стандартные условия IN(...) в запросе
	ОтборыОбъединенные.Вставить("ПоВсемПартиям", Истина);
	ОтборыОбъединенные.Вставить("ПоВсемАналитикамПартий", Истина);
	
	// 3. Получаем базовый запрос и модифицируем его
	Запрос = ЗапросВыпущеннаяПродукцияПакетный(ПараметрыУзлаОбъединенные, Истина, ТаблицаПарУзлов);
	Запрос.Текст = Запрос.Текст + ТекстЗапросаЗатратыНаПродукцию(ВыводитьДопРасходы);
	
	ВсеДанныеБезКлюча = Запрос.Выполнить().Выгрузить();
	
	// ДИАГНОСТИКА: после первого запроса
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,,,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"СебестоимостьУзловПакетомJOIN: узлов=%1, пар=%2, строк до JOIN=%3",
			Строка(МассивПараметровУзлов.Количество()),
			Строка(ТаблицаПарУзлов.Количество()),
			Строка(ВсеДанныеБезКлюча.Количество())));
	
	// 4. КЛЮЧЕВОЙ ЭТАП: добавляем КлючУзла через JOIN с ВТПарыУзлов
	// Это гарантирует однозначное соответствие строки данных узлу!
	
	// 4.1 Динамически строим список колонок на основе результата запроса
	МассивКолонок = Новый Массив;
	Для Каждого Колонка Из ВсеДанныеБезКлюча.Колонки Цикл
		МассивКолонок.Добавить("Данные." + Колонка.Имя + " КАК " + Колонка.Имя);
	КонецЦикла;
	СтрокаКолонок = СтрСоединить(МассивКолонок, ",
	|	");
	
	// 4.2 Помещаем данные во временную таблицу
	ЗапросВТДанные = Новый Запрос;
	ЗапросВТДанные.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросВТДанные.Текст = 
	"ВЫБРАТЬ
	|	" + СтрокаКолонок + "
	|ПОМЕСТИТЬ ВТДанныеБезКлюча
	|ИЗ
	|	&ТаблицаДанных КАК Данные";
	ЗапросВТДанные.УстановитьПараметр("ТаблицаДанных", ВсеДанныеБезКлюча);
	ЗапросВТДанные.Выполнить();
	
	// 4.3 Выполняем JOIN для добавления КлючУзла
	ЗапросСКлючом = Новый Запрос;
	ЗапросСКлючом.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросСКлючом.Текст = 
	"ВЫБРАТЬ
	|	" + СтрокаКолонок + ",
	|	ВТПарыУзлов.КлючУзла КАК КлючУзла
	|ИЗ
	|	ВТДанныеБезКлюча КАК Данные
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПарыУзлов КАК ВТПарыУзлов
	|		ПО Данные.ПартияВыходноеИзделие = ВТПарыУзлов.ПартияПродукции
	|			И Данные.АналитикаУчетаПартийВыходноеИзделие = ВТПарыУзлов.АналитикаУчетаПартийПродукции";
	
	ВсеДанные = ЗапросСКлючом.Выполнить().Выгрузить();
	
	// ДИАГНОСТИКА: после JOIN
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,,,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"СебестоимостьУзловПакетомJOIN: строк после JOIN=%1",
			Строка(ВсеДанные.Количество())));
	
	// 5. Распределяем результаты по узлам НАПРЯМУЮ по КлючУзла (без декартова произведения!)
	РезультатПоУзлам = Новый Соответствие;
	
	// Инициализируем пустые таблицы (без колонки КлючУзла)
	Для Каждого ПараметрыУзла Из МассивПараметровУзлов Цикл
		КлючУзла = СоздатьКлючУзла(ПараметрыУзла);
		ТаблицаУзла = ВсеДанныеБезКлюча.СкопироватьКолонки();
		РезультатПоУзлам.Вставить(КлючУзла, ТаблицаУзла);
	КонецЦикла;
	
	// Проверяем наличие колонки КлючУзла
	Если ВсеДанные.Колонки.Найти("КлючУзла") = Неопределено Тогда
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.Ошибка",
			УровеньЖурналаРегистрации.Ошибка,,,
			"Колонка КлючУзла не найдена в результате JOIN!");
		Возврат РезультатПоУзлам;
	КонецЕсли;
	
	// Распределяем строки по узлам НАПРЯМУЮ по КлючУзла
	Для Каждого СтрокаДанных Из ВсеДанные Цикл
		КлючУзла = СтрокаДанных.КлючУзла;
		ТаблицаУзла = РезультатПоУзлам.Получить(КлючУзла);
		Если ТаблицаУзла <> Неопределено Тогда
			НоваяСтрока = ТаблицаУзла.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаДанных);
		КонецЕсли;
	КонецЦикла;
	
	Возврат РезультатПоУзлам;
	
КонецФункции

// Пакетное получение себестоимости с группировкой узлов и пост-распределением
// Решает проблему декартова произведения при одинаковых парах (Партия, Аналитика)
// 
// Алгоритм:
// 1. Группируем узлы: СУММА(Числитель), МАКСИМУМ(Знаменатель) по ключу (Партия, Аналитика)
// 2. Выполняем один запрос для всех уникальных пар с групповыми коэффициентами
// 3. Пост-распределяем: РезультатУзла = РезультатГруппы × (ЧислительУзла / СуммаЧислителейГруппы)
//
// Параметры:
//  УзлыДляОбработки - Массив - Все узлы текущего уровня
//  ГруппыПоПарам - Соответствие - КлючПары -> {УзлыГруппы, СуммаЧислителей, Знаменатель}
//  СоответствиеУзлов - Соответствие - КлючУзла -> Узел
//  ВыводитьДопРасходы - Булево - Флаг вывода доп. расходов
//  ОбщиеПараметры - Структура - Общие параметры дерева
//
// Возвращаемое значение:
//  Соответствие - КлючУзла -> ТаблицаЗначений с распределёнными данными себестоимости
//
Функция СебестоимостьУзловПакетомГруппировка(УзлыДляОбработки, ГруппыПоПарам, СоответствиеУзлов, ВыводитьДопРасходы, ОбщиеПараметры)
	
	Если УзлыДляОбработки.Количество() = 0 Тогда
		Возврат Новый Соответствие;
	КонецЕсли;
	
	// 1. Собираем типы партий и аналитик из всех узлов
	ПервыйУзел = УзлыДляОбработки[0];
	
	ТипыПартий = Новый Массив;
	ТипыАналитик = Новый Массив;
	
	Для Каждого Узел Из УзлыДляОбработки Цикл
		Отборы = Узел.ПараметрыУзла.Отборы;
		Для Каждого Партия Из Отборы.ПартииПродукции Цикл
			Если Партия <> Неопределено Тогда
				ТипПартии = ТипЗнч(Партия);
				Если ТипыПартий.Найти(ТипПартии) = Неопределено Тогда
					ТипыПартий.Добавить(ТипПартии);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		Для Каждого Аналитика Из Отборы.АналитикиУчетаПартийПродукции Цикл
			Если Аналитика <> Неопределено Тогда
				ТипАналитики = ТипЗнч(Аналитика);
				Если ТипыАналитик.Найти(ТипАналитики) = Неопределено Тогда
					ТипыАналитик.Добавить(ТипАналитики);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// 2. Создаём ВТ СГРУППИРОВАННЫХ пар (уникальные пары с суммарными коэффициентами)
	ТаблицаГруппПар = Новый ТаблицаЗначений;
	ТаблицаГруппПар.Колонки.Добавить("ПартияПродукции", Новый ОписаниеТипов(ТипыПартий));
	ТаблицаГруппПар.Колонки.Добавить("АналитикаУчетаПартийПродукции", Новый ОписаниеТипов(ТипыАналитик));
	КвалификаторыЧисла = Новый КвалификаторыЧисла(31, 10);
	ТаблицаГруппПар.Колонки.Добавить("Числитель", Новый ОписаниеТипов("Число", КвалификаторыЧисла));
	ТаблицаГруппПар.Колонки.Добавить("Знаменатель", Новый ОписаниеТипов("Число", КвалификаторыЧисла));
	ТаблицаГруппПар.Колонки.Добавить("КлючПолный", Новый ОписаниеТипов("Строка"));
	
	Для Каждого КлючИЗначение Из ГруппыПоПарам Цикл
		Группа = КлючИЗначение.Значение;
		НоваяСтрока = ТаблицаГруппПар.Добавить();
		НоваяСтрока.ПартияПродукции = Группа.Партия;
		НоваяСтрока.АналитикаУчетаПартийПродукции = Группа.Аналитика;
		// Теперь используем индивидуальные Числитель и Знаменатель из группы
		НоваяСтрока.Числитель = Группа.Числитель;
		НоваяСтрока.Знаменатель = Группа.Знаменатель;
		НоваяСтрока.КлючПолный = КлючИЗначение.Ключ;
	КонецЦикла;
	
	// ДИАГНОСТИКА: теперь группируем по (Партия, Аналитика, Числитель, Знаменатель)
	// Проверяем, есть ли дубликаты пар с разными коэффициентами
	ПроверкаПар = Новый Соответствие;
	ДублирующиесяПары = 0;
	Для Каждого СтрокаТаблицы Из ТаблицаГруппПар Цикл
		КлючПары = СоздатьКлючПары(СтрокаТаблицы.ПартияПродукции, СтрокаТаблицы.АналитикаУчетаПартийПродукции);
		Если ПроверкаПар.Получить(КлючПары) <> Неопределено Тогда
			ДублирующиесяПары = ДублирующиесяПары + 1;
		КонецЕсли;
		ПроверкаПар.Вставить(КлючПары, Истина);
	КонецЦикла;
	
	ЗаписьЖурналаРегистрации("СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,,,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"СебестоимостьУзловПакетомГруппировка: узлов=%1, уникальных комбинаций=%2, дубликатов пар с разными коэфф.=%3",
			Строка(УзлыДляОбработки.Количество()),
			Строка(ТаблицаГруппПар.Количество()),
			Строка(ДублирующиесяПары)));
	
	// 3. Собираем объединённые параметры для запроса
	ВсеПродукция = Новый Массив;
	ВсеХарактеристики = Новый Массив;
	ВсеСерии = Новый Массив;
	ВсеНазначения = Новый Массив;
	
	Для Каждого Узел Из УзлыДляОбработки Цикл
		Отборы = Узел.ПараметрыУзла.Отборы;
		Для Каждого Продукция Из Отборы.Продукция Цикл
			Если ВсеПродукция.Найти(Продукция) = Неопределено Тогда
				ВсеПродукция.Добавить(Продукция);
			КонецЕсли;
		КонецЦикла;
		Для Каждого Характеристика Из Отборы.ХарактеристикиПродукции Цикл
			Если ВсеХарактеристики.Найти(Характеристика) = Неопределено Тогда
				ВсеХарактеристики.Добавить(Характеристика);
			КонецЕсли;
		КонецЦикла;
		Для Каждого Серия Из Отборы.СерииПродукции Цикл
			Если ВсеСерии.Найти(Серия) = Неопределено Тогда
				ВсеСерии.Добавить(Серия);
			КонецЕсли;
		КонецЦикла;
		Для Каждого Назначение Из Отборы.НазначенияПродукции Цикл
			Если ВсеНазначения.Найти(Назначение) = Неопределено Тогда
				ВсеНазначения.Добавить(Назначение);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// 4. Создаём объединённые параметры узла
	ПараметрыУзлаОбъединенные = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();
	ОтборыОбъединенные = ПараметрыУзлаОбъединенные.Отборы;
	
	ПервыеОтборы = ПервыйУзел.ПараметрыУзла.Отборы;
	ОтборыОбъединенные.ДанныеПоСебестоимости = ПервыеОтборы.ДанныеПоСебестоимости;
	ОтборыОбъединенные.РазворачиватьДопРасходы = ПервыеОтборы.РазворачиватьДопРасходы;
	ОтборыОбъединенные.ДатаОкончания = ПервыеОтборы.ДатаОкончания;
	ОтборыОбъединенные.ДатаИсходнойПартии = ПервыеОтборы.ДатаИсходнойПартии;
	ОтборыОбъединенные.Продукция = ВсеПродукция;
	ОтборыОбъединенные.ХарактеристикиПродукции = ВсеХарактеристики;
	ОтборыОбъединенные.СерииПродукции = ВсеСерии;
	ОтборыОбъединенные.НазначенияПродукции = ВсеНазначения;
	ОтборыОбъединенные.ПартииПродукции = Новый Массив;
	ОтборыОбъединенные.АналитикиУчетаПартийПродукции = Новый Массив;
	ОтборыОбъединенные.Вставить("ПоВсемПартиям", Истина);
	ОтборыОбъединенные.Вставить("ПоВсемАналитикамПартий", Истина);
	
	// КРИТИЧНО: НЕ устанавливаем Числитель и Знаменатель в параметрах!
	// Запрос ЗапросВыпущеннаяПродукцияГруппировка использует значения из ВТПарыУзлов
	// (СуммаЧислителей и Знаменатель группы), поэтому здесь ничего не нужно.
	// Пост-распределение применит индивидуальные доли: Числитель / СуммаЧислителей
	
	// 5. Выполняем запрос с группированными данными
	Запрос = ЗапросВыпущеннаяПродукцияГруппировка(ПараметрыУзлаОбъединенные, Истина, ТаблицаГруппПар);
	Запрос.Текст = Запрос.Текст + ТекстЗапросаЗатратыНаПродукцию(ВыводитьДопРасходы);
	
	ВсеДанные = Запрос.Выполнить().Выгрузить();
	
	// ДИАГНОСТИКА
	ЗаписьЖурналаРегистрации("СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,,,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"СебестоимостьУзловПакетомГруппировка: получено строк=%1",
			Строка(ВсеДанные.Количество())));
	
	// 6. ПОСТ-РАСПРЕДЕЛЕНИЕ С УМНОЖЕНИЕМ НА КОЭФФИЦИЕНТ
	// Запрос вернул 100% себестоимости (с &Числитель=0, &Знаменатель=0)
	// Применяем индивидуальный коэффициент Числитель/Знаменатель для каждой группы
	РезультатПоУзлам = Новый Соответствие;
	
	// Инициализируем пустые таблицы для всех узлов
	Для Каждого Узел Из УзлыДляОбработки Цикл
		КлючУзла = СоздатьКлючУзла(Узел.ПараметрыУзла);
		ТаблицаУзла = ВсеДанные.СкопироватьКолонки();
		РезультатПоУзлам.Вставить(КлючУзла, ТаблицаУзла);
	КонецЦикла;
	
	// Индексируем строки результата по паре (Партия, Аналитика)
	СтрокиПоКлючам = Новый Соответствие;
	Для Каждого СтрокаДанных Из ВсеДанные Цикл
		ПартияСтроки = СтрокаДанных.ПартияВыходноеИзделие;
		АналитикаСтроки = СтрокаДанных.АналитикаУчетаПартийВыходноеИзделие;
		КлючПары = СоздатьКлючПары(ПартияСтроки, АналитикаСтроки);
		
		СтрокиПары = СтрокиПоКлючам.Получить(КлючПары);
		Если СтрокиПары = Неопределено Тогда
			СтрокиПары = Новый Массив;
			СтрокиПоКлючам.Вставить(КлючПары, СтрокиПары);
		КонецЕсли;
		СтрокиПары.Добавить(СтрокаДанных);
	КонецЦикла;
	
	// Список полей для умножения на коэффициент
	ПоляСумм = "Материальные,Трудозатраты,ПостатейныеПостоянные,ПостатейныеПеременные,ДопРасходы,"
		+ "СуммаЗатрата,СуммаЗатратаЗабалансовая,НДД,"
		+ "МатериальныеСНДС,ТрудозатратыСНДС,ПостатейныеПостоянныеСНДС,ПостатейныеПеременныеСНДС,ДопРасходыСНДС,"
		+ "МатериальныеБезНДС,ПостатейныеПостоянныеБезНДС,ПостатейныеПеременныеБезНДС,ДопРасходыБезНДС,"
		+ "МатериальныеУпр,ТрудозатратыУпр,ПостатейныеПостоянныеУпр,ПостатейныеПеременныеУпр,ДопРасходыУпр,СтоимостьЗабалансоваяУпр,"
		+ "МатериальныеРегл,ТрудозатратыРегл,ПостатейныеПостоянныеРегл,ПостатейныеПеременныеРегл,ДопРасходыРегл,СтоимостьЗабалансоваяРегл,"
		+ "НалоговыйУчет,ПостояннаяРазница,ВременнаяРазница";
	МассивПолейСумм = СтрРазделить(ПоляСумм, ",");
	
	// Распределяем строки по узлам С УМНОЖЕНИЕМ на коэффициент
	Для Каждого КлючИЗначение Из ГруппыПоПарам Цикл
		Группа = КлючИЗначение.Значение;
		КлючПары = СоздатьКлючПары(Группа.Партия, Группа.Аналитика);
		
		СтрокиПары = СтрокиПоКлючам.Получить(КлючПары);
		Если СтрокиПары = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		// Вычисляем коэффициент для этой группы: Числитель / Знаменатель
		// Запрос вернул 100% стоимости, применяем пропорцию
		Если Группа.Знаменатель = 0 ИЛИ Группа.Числитель = 0 Тогда
			// Когда Числитель=0 или Знаменатель=0, запрос сам вычисляет пропорцию
			// В этом случае НЕ нужно применять коэффициент
			Коэффициент = 1;
		Иначе
			Коэффициент = Группа.Числитель / Группа.Знаменатель;
		КонецЕсли;
		
		// ДИАГНОСТИКА: Выводим информацию о применяемых коэффициентах
		ЗаписьЖурналаРегистрации("СтруктураСебестоимости.КОЭФФ",
			УровеньЖурналаРегистрации.Предупреждение,,,
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				"Группа: Числ=%1, Знам=%2, Коэфф=%3, СтрокПары=%4, Узлов=%5",
				Строка(Группа.Числитель), Строка(Группа.Знаменатель),
				Формат(Коэффициент, "ЧДЦ=6"), Строка(СтрокиПары.Количество()),
				Строка(Группа.КлючиУзлов.Количество())));
		
		// Копируем строки каждому узлу группы С ПРИМЕНЕНИЕМ КОЭФФИЦИЕНТА
		Для Каждого КлючУзла Из Группа.КлючиУзлов Цикл
			ТаблицаУзла = РезультатПоУзлам.Получить(КлючУзла);
			Если ТаблицаУзла = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			Для Каждого СтрокаДанных Из СтрокиПары Цикл
				НоваяСтрока = ТаблицаУзла.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаДанных);
				
				// Умножаем суммовые поля на коэффициент
				Для Каждого ИмяПоля Из МассивПолейСумм Цикл
					Если ВсеДанные.Колонки.Найти(ИмяПоля) <> Неопределено Тогда
						НоваяСтрока[ИмяПоля] = СтрокаДанных[ИмяПоля] * Коэффициент;
					КонецЕсли;
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	
	Возврат РезультатПоУзлам;
	
КонецФункции

// Запрос выпущенной продукции с группированными коэффициентами из ВТ
// Использует СУММА(Числитель) и МАКСИМУМ(Знаменатель) из временной таблицы ВТПарыУзлов
//
Функция ЗапросВыпущеннаяПродукцияГруппировка(ПараметрыУзла, ПомещатьВВТ, ТаблицаГруппПар)
	
	НаборДанных = ПараметрыУзла.СхемаКД.НаборыДанных.Найти("ВыпущеннаяПродукция");
	Отборы = ПараметрыУзла.Отборы;
	
	Отборы.Вставить("ЗаВесьПериод", Не ЗначениеЗаполнено(Отборы.ДатаНачала) И Не ЗначениеЗаполнено(Отборы.ДатаОкончания));
	Отборы.Вставить("ПоВсемОрганизациям", Не ЗначениеЗаполнено(Отборы.Организации));
	Отборы.Вставить("ПоВсемПодразделениям", Не ЗначениеЗаполнено(Отборы.Подразделения));
	Отборы.Вставить("ПоВсейПродукции", Не ЗначениеЗаполнено(Отборы.Продукция));
	Отборы.Вставить("ПоВсемХарактеристикам", Не ЗначениеЗаполнено(Отборы.ХарактеристикиПродукции));
	Отборы.Вставить("ПоВсемСериям", Не ЗначениеЗаполнено(Отборы.СерииПродукции));
	Отборы.Вставить("ПоВсемНазначениям", Не ЗначениеЗаполнено(Отборы.НазначенияПродукции));
	Отборы.Вставить("РасшифровкаДвиженийДокумента", ЗначениеЗаполнено(Отборы.Регистраторы));
	
	ТекстЗапроса = НаборДанных.Запрос;
	ТекстЗапроса = Лев(ТекстЗапроса, СтрНайти(ТекстЗапроса, ";", НаправлениеПоиска.СКонца) - 1);
	
	// Заменяем условие на фильтр по ВТ групп с групповыми коэффициентами
	ТекстУсловия = 
	"И (&ЗаВесьПериод
	|		ИЛИ СебестоимостьТоваров.Период МЕЖДУ &ДатаНачала И &ДатаОкончания)
	|	И (&ПоВсемОрганизациям
	|		ИЛИ СебестоимостьТоваров.Организация В (&Организации))
	|	И (&ПоВсемПодразделениям
	|		ИЛИ СпрПодразделения.Ссылка В (&Подразделения))
	|	И (&ПоВсейПродукции
	|		ИЛИ КлючиАналитики.Номенклатура В (&Продукция))
	|	И (СебестоимостьТоваров.Партия, СебестоимостьТоваров.АналитикаУчетаПартий) В 
	|		(ВЫБРАТЬ ВТПарыУзлов.ПартияПродукции, ВТПарыУзлов.АналитикаУчетаПартийПродукции ИЗ ВТПарыУзлов КАК ВТПарыУзлов)
	|	И (&ПоВсемХарактеристикам
	|		ИЛИ КлючиАналитики.Характеристика В (&ХарактеристикиПродукции))
	|	И (&ПоВсемСериям
	|		ИЛИ КлючиАналитики.Серия В (&СерииПродукции))
	|	И (&ПоВсемНазначениям
	|		ИЛИ КлючиАналитики.Назначение В (&НазначенияПродукции))";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "И &ТекстУсловия", ТекстУсловия);
	
	// ========================================================================
	// ПАКЕТНАЯ ОБРАБОТКА: Замена параметров &Числитель/&Знаменатель на поля ВТ
	// ========================================================================
	
	// 1. Добавляем JOIN с ВТПарыУзлов для получения Числитель и Знаменатель из группы
	// ВАЖНО: В части ВтПродукция структура такая:
	//   ВЫБРАТЬ ... &Числитель ... ИЗ ... JOIN ... ГДЕ ...
	// Т.е. ГДЕ находится ПОСЛЕ &Числитель, а не перед.
	// Ищем ПЕРВОЕ ГДЕ ПОСЛЕ &Числитель и вставляем JOIN перед ним
	ТекстJoin = Символы.ПС + "	ЛЕВОЕ СОЕДИНЕНИЕ ВТПарыУзлов КАК ВТПарыУзлов" + Символы.ПС
		+ "		ПО СебестоимостьТоваров.Партия = ВТПарыУзлов.ПартияПродукции" + Символы.ПС
		+ "			И СебестоимостьТоваров.АналитикаУчетаПартий = ВТПарыУзлов.АналитикаУчетаПартийПродукции" + Символы.ПС;
	
	// Стратегия: 
	// 1. Найти позицию &Числитель в запросе
	// 2. Найти ПЕРВОЕ ГДЕ ПОСЛЕ этой позиции (это ГДЕ части ВтПродукция)
	// 3. Вставить JOIN перед этим ГДЕ
	ПозицияЧислитель = СтрНайти(ТекстЗапроса, "&Числитель");
	Если ПозицияЧислитель > 0 Тогда
		// Находим первое ГДЕ ПОСЛЕ &Числитель
		ПозицияГде = СтрНайти(ТекстЗапроса, Символы.ПС + "ГДЕ", , ПозицияЧислитель);
		
		Если ПозицияГде > 0 Тогда
			ТекстЗапроса = Лев(ТекстЗапроса, ПозицияГде - 1) + ТекстJoin + Сред(ТекстЗапроса, ПозицияГде);
		КонецЕсли;
	КонецЕсли;
	
	// 2. Заменяем параметры &Числитель и &Знаменатель на поля из ВТПарыУзлов
	// Структура в запросе:
	//   КОГДА &Числитель = 0 ТОГДА СУММА(...) ИНАЧЕ &Числитель КОНЕЦ КАК Числитель
	//   КОГДА &Знаменатель = 0 ТОГДА СУММА(...) ИНАЧЕ &Знаменатель КОНЕЦ КАК Знаменатель
	// ВАЖНО: Если Знаменатель = 0, это означает "автоматический расчёт по количеству"
	// Поэтому условие &Числитель = 0 заменяем на МАКСИМУМ(ВТПарыУзлов.Знаменатель) = 0
	// Это обеспечивает правильную логику: если Знаменатель = 0 -> автоматический расчёт
	
	// Диагностика ДО замены
	ЕстьЧислительДо = СтрНайти(ТекстЗапроса, "&Числитель") > 0;
	ЕстьЗнаменательДо = СтрНайти(ТекстЗапроса, "&Знаменатель") > 0;
	
	// Заменяем условие &Числитель = 0 на проверку Знаменателя (если Знам=0 -> автоматический расчёт)
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Числитель = 0", "МАКСИМУМ(ВТПарыУзлов.Знаменатель) = 0");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ИНАЧЕ &Числитель", "ИНАЧЕ МАКСИМУМ(ВТПарыУзлов.Числитель)");
	
	// Заменяем &Знаменатель на МАКСИМУМ(ВТПарыУзлов.Знаменатель)
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Знаменатель = 0", "МАКСИМУМ(ВТПарыУзлов.Знаменатель) = 0");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ИНАЧЕ &Знаменатель", "ИНАЧЕ МАКСИМУМ(ВТПарыУзлов.Знаменатель)");
	
	// 3. НЕ добавляем поля ВТПарыУзлов в GROUP BY
	// Потому что мы используем МАКСИМУМ(ВТПарыУзлов.Числитель) — это агрегатная функция,
	// и поле не должно быть в GROUP BY одновременно с агрегатной функцией
	
	// Диагностика ПОСЛЕ замены
	ЕстьЧислительПосле = СтрНайти(ТекстЗапроса, "&Числитель") > 0;
	ЕстьЗнаменательПосле = СтрНайти(ТекстЗапроса, "&Знаменатель") > 0;
	ЕстьВТЧислитель = СтрНайти(ТекстЗапроса, "ВТПарыУзлов.Числитель") > 0;
	
	ЗаписьЖурналаРегистрации("СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Предупреждение,,,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"ЗапросВыпущеннаяПродукцияГруппировка: До[&Числ=%1,&Знам=%2] После[&Числ=%3,&Знам=%4] ВТ.Числ=%5",
			?(ЕстьЧислительДо, "ЕСТЬ", "НЕТ"),
			?(ЕстьЗнаменательДо, "ЕСТЬ", "НЕТ"),
			?(ЕстьЧислительПосле, "ОСТАЛОСЬ", "ЗАМЕНЕНО"),
			?(ЕстьЗнаменательПосле, "ОСТАЛОСЬ", "ЗАМЕНЕНО"),
			?(ЕстьВТЧислитель, "ДОБАВЛЕНО", "НЕТ")));
	
	// ДИАГНОСТИКА: Выводим часть запроса с &Числитель для отладки
	ЗаписьЖурналаРегистрации("СтруктураСебестоимости.DEBUG.Запрос",
		УровеньЖурналаРегистрации.Предупреждение,,,
		"МОДИФИЦИРОВАННЫЙ ЗАПРОС (симв. 4000-8000):" + Символы.ПС + Сред(ТекстЗапроса, 4000, 4000));
	
	// Создаём запрос с менеджером ВТ
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	// Создаём временную таблицу с группированными парами и коэффициентами
	ЗапросВТ = Новый Запрос;
	ЗапросВТ.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросВТ.Текст = 
	"ВЫБРАТЬ
	|	Данные.ПартияПродукции КАК ПартияПродукции,
	|	Данные.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
	|	Данные.Числитель КАК Числитель,
	|	Данные.Знаменатель КАК Знаменатель
	|ПОМЕСТИТЬ ВТПарыУзлов
	|ИЗ
	|	&ТаблицаГруппПар КАК Данные
	|ИНДЕКСИРОВАТЬ ПО
	|	ПартияПродукции, АналитикаУчетаПартийПродукции";
	ЗапросВТ.УстановитьПараметр("ТаблицаГруппПар", ТаблицаГруппПар);
	ЗапросВТ.Выполнить();
	
	Если Не ПомещатьВВТ Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ПОМЕСТИТЬ ВыпущеннаяПродукция", "");
		ТекстСортировка = 
		"УПОРЯДОЧИТЬ ПО
		|	ВтПродукция.ПродукцияПредставление,
		|	ВтПродукция.ХарактеристикаПродукцииПредставление,
		|	ВтПродукция.СерияПродукцииПредставление,
		|	ВтПродукция.НазначениеПродукцииПредставление,
		|	ВтПродукция.ПартияПродукции
		|;
		|";
		ТекстЗапроса = ТекстЗапроса + ТекстСортировка;
	Иначе
		ТекстЗапроса = ТекстЗапроса + ";";
	КонецЕсли;
	
	Запрос.Текст = ТекстЗапроса;
	УстановитьПараметрыДереваСебестоимости(Запрос, ПараметрыУзла.Отборы, "Ключ");
	
	Возврат Запрос;
	
КонецФункции

// Модифицированный запрос выпущенной продукции с JOIN по временной таблице пар
// Заменяет условия IN(...) на (Партия, Аналитика) В (ВЫБРАТЬ ... ИЗ ВТПарыУзлов)
//
Функция ЗапросВыпущеннаяПродукцияПакетный(ПараметрыУзла, ПомещатьВВТ, ТаблицаПарУзлов)
	
	НаборДанных = ПараметрыУзла.СхемаКД.НаборыДанных.Найти("ВыпущеннаяПродукция");
	Отборы = ПараметрыУзла.Отборы;
	
	Отборы.Вставить("ЗаВесьПериод", Не ЗначениеЗаполнено(Отборы.ДатаНачала) И Не ЗначениеЗаполнено(Отборы.ДатаОкончания));
	Отборы.Вставить("ПоВсемОрганизациям", Не ЗначениеЗаполнено(Отборы.Организации));
	Отборы.Вставить("ПоВсемПодразделениям", Не ЗначениеЗаполнено(Отборы.Подразделения));
	Отборы.Вставить("ПоВсейПродукции", Не ЗначениеЗаполнено(Отборы.Продукция));
	Отборы.Вставить("ПоВсемХарактеристикам", Не ЗначениеЗаполнено(Отборы.ХарактеристикиПродукции));
	Отборы.Вставить("ПоВсемСериям", Не ЗначениеЗаполнено(Отборы.СерииПродукции));
	Отборы.Вставить("ПоВсемНазначениям", Не ЗначениеЗаполнено(Отборы.НазначенияПродукции));
	Отборы.Вставить("РасшифровкаДвиженийДокумента", ЗначениеЗаполнено(Отборы.Регистраторы));
	
	ТекстЗапроса = НаборДанных.Запрос;
	ТекстЗапроса = Лев(ТекстЗапроса, СтрНайти(ТекстЗапроса, ";", НаправлениеПоиска.СКонца) - 1);
	
	// DEBUG: логируем первые 1000 символов запроса СКД
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.DEBUG",
		УровеньЖурналаРегистрации.Предупреждение,,,
		"ЗапросСКД (начало): " + Лев(ТекстЗапроса, 1000));
	
	// МОДИФИЦИРОВАННОЕ условие: заменяем два отдельных условия на одно с кортежем
	// Вместо: Партия В (&ПартииПродукции) И Аналитика В (&АналитикиУчетаПартийПродукции)
	// Используем: (Партия, Аналитика) В (ВЫБРАТЬ ... ИЗ ВТПарыУзлов)
	ТекстУсловия = 
	"И (&ЗаВесьПериод
	|		ИЛИ СебестоимостьТоваров.Период МЕЖДУ &ДатаНачала И &ДатаОкончания)
	|	И (&ПоВсемОрганизациям
	|		ИЛИ СебестоимостьТоваров.Организация В (&Организации))
	|	И (&ПоВсемПодразделениям
	|		ИЛИ СпрПодразделения.Ссылка В (&Подразделения))
	|	И (&ПоВсейПродукции
	|		ИЛИ КлючиАналитики.Номенклатура В (&Продукция))
	|	И (СебестоимостьТоваров.Партия, СебестоимостьТоваров.АналитикаУчетаПартий) В 
	|		(ВЫБРАТЬ ВТПарыУзлов.ПартияПродукции, ВТПарыУзлов.АналитикаУчетаПартийПродукции ИЗ ВТПарыУзлов КАК ВТПарыУзлов)
	|	И (&ПоВсемХарактеристикам
	|		ИЛИ КлючиАналитики.Характеристика В (&ХарактеристикиПродукции))
	|	И (&ПоВсемСериям
	|		ИЛИ КлючиАналитики.Серия В (&СерииПродукции))
	|	И (&ПоВсемНазначениям
	|		ИЛИ КлючиАналитики.Назначение В (&НазначенияПродукции))";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "И &ТекстУсловия", ТекстУсловия);
	
	// Создаём запрос с менеджером ВТ
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	// Создаём временную таблицу с парами и коэффициентами
	ЗапросВТ = Новый Запрос;
	ЗапросВТ.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросВТ.Текст = 
	"ВЫБРАТЬ
	|	Данные.КлючУзла КАК КлючУзла,
	|	Данные.ПартияПродукции КАК ПартияПродукции,
	|	Данные.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
	|	Данные.Числитель КАК Числитель,
	|	Данные.Знаменатель КАК Знаменатель
	|ПОМЕСТИТЬ ВТПарыУзлов
	|ИЗ
	|	&ТаблицаПарУзлов КАК Данные
	|ИНДЕКСИРОВАТЬ ПО
	|	ПартияПродукции, АналитикаУчетаПартийПродукции";
	ЗапросВТ.УстановитьПараметр("ТаблицаПарУзлов", ТаблицаПарУзлов);
	ЗапросВТ.Выполнить();
	
	Если Не ПомещатьВВТ Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ПОМЕСТИТЬ ВыпущеннаяПродукция", "");
		ТекстСортировка = 
		"УПОРЯДОЧИТЬ ПО
		|	ВтПродукция.ПродукцияПредставление,
		|	ВтПродукция.ХарактеристикаПродукцииПредставление,
		|	ВтПродукция.СерияПродукцииПредставление,
		|	ВтПродукция.НазначениеПродукцииПредставление,
		|	ВтПродукция.ПартияПродукции
		|;
		|";
		ТекстЗапроса = ТекстЗапроса + ТекстСортировка;
	Иначе
		ТекстЗапроса = ТекстЗапроса + ";";
	КонецЕсли;
	
	Запрос.Текст = ТекстЗапроса;
	УстановитьПараметрыДереваСебестоимости(Запрос, ПараметрыУзла.Отборы, "Ключ");
	
	Возврат Запрос;
	
КонецФункции

// ============================================================================
// РЕФАКТОРИНГ: Вспомогательные функции для формирования SQL-запросов
// 
// Цель: Разбиение большой функции ikon_cost_ТекстЗапросаЗатратыНаПродукцию
//       на более мелкие и понятные части для упрощения поддержки и расширения
//
// Каждая функция возвращает текст SQL-запроса для формирования временной таблицы
// ============================================================================

// Формирует SQL-запрос для временной таблицы ВыбывшиеЗатратыСводно
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ВыбывшиеЗатратыСводно()
	
	Возврат
"ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	МАКСИМУМ(Т.Период) КАК Период,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции
|ПОМЕСТИТЬ ВыбывшиеЗатратыСводно
|ИЗ
|	ВыбытиеИзНЗППоПродукции КАК Т
|ГДЕ
|	Т.Количество <> 0
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.Партия,
|	Т.ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует SQL-запрос для временной таблицы ПартииПроизводства
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ПартииПроизводства()
	
	Возврат
"ВЫБРАТЬ РАЗЛИЧНЫЕ
|	Т.Партия КАК Партия
|ПОМЕСТИТЬ ПартииПроизводства
|ИЗ
|	ВыбывшиеЗатратыСводно КАК Т
|ИНДЕКСИРОВАТЬ ПО
|	Партия
|;";

КонецФункции

// Формирует SQL-запрос для временной таблицы ВыбытиеИзНЗП
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ВыбытиеИзНЗП()
	
	Возврат
"ВЫБРАТЬ РАЗРЕШЕННЫЕ
|	Т.Организация КАК Организация,
|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК Период,
|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Т.Партия КАК Партия,
|	Выбытие.ПартияПродукции КАК ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	СУММА(Т.КоличествоРасход) КАК Количество
|ПОМЕСТИТЬ ВыбытиеИзНЗП
|ИЗ
|	РегистрНакопления.СебестоимостьТоваров.Обороты(,, МЕСЯЦ,
|		Партия В (
|			ВЫБРАТЬ
|				Т.Партия
|			ИЗ
|				ПартииПроизводства КАК Т)
|		И (АналитикаУчетаНоменклатуры, Организация) В (
|			ВЫБРАТЬ
|				Выбытие.АналитикаУчетаНоменклатуры,
|				Выбытие.Организация КАК Организация
|			ИЗ
|				ВыбывшиеЗатратыСводно КАК Выбытие)
|	) КАК Т
|
|	ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
|	ПО Т.АналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
|		И Т.Партия = Выбытие.Партия
|
|ГДЕ
|	Т.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ),
|	Т.АналитикаУчетаНоменклатуры,
|	Т.Партия,
|	Выбытие.ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует SQL-запрос для временной таблицы ПервичныеПартииВНЗП
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ПервичныеПартииВНЗП()
	
	Возврат
"ВЫБРАТЬ РАЗРЕШЕННЫЕ
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ) КАК Период,
|	СебестоимостьТоваров.Организация					КАК Организация,
|	СебестоимостьТоваров.ВидЗапасов						КАК ВидЗапасов,
// Аналитика первичной партии.
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий 			КАК АналитикаУчетаПартий,
|	СебестоимостьТоваров.Партия 						КАК Партия,
// Аналитка в НЗП.
|	СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры 	КАК КорАналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.КорПартия						КАК КорПартия,
|	Выбытие.ПартияПродукции								КАК ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции				КАК АналитикаУчетаПартийПродукции,
|	МАКСИМУМ(ВЫБОР
|		КОГДА СебестоимостьТоваров.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
|		 И СебестоимостьТоваров.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
|			ТОГДА ИСТИНА
|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ВключитьНДСВСтоимость,
|	МАКСИМУМ(ВЫБОР
|		КОГДА СебестоимостьТоваров.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
|		 И СебестоимостьТоваров.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
|			ТОГДА ИСТИНА
|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ИсключитьНДСИзСтоимости,

|	СУММА(СебестоимостьТоваров.Количество) 				КАК Количество,
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|		КОНЕЦ)												КАК Материальные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
|		КОНЕЦ)												КАК Трудозатраты,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		КОНЕЦ)												КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		КОНЕЦ)												КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК ДопРасходы,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|				+ СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|				+ СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|				+ СебестоимостьТоваров.ТрудозатратыУпр
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
|				+ СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|				+ СебестоимостьТоваров.ТрудозатратыРегл
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|				+ СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
|			ИНАЧЕ 0
|		КОНЕЦ)												КАК НДД,

|// Стоимости с НДС
|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,

|// Стоимости без НДС
|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,

|// Стоимости Упр
|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,

|// Стоимости Регл
|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,

|// Налоговый учет
|	СУММА(СебестоимостьТоваров.СтоимостьРегл
|		+ СебестоимостьТоваров.ТрудозатратыРегл
|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		+ СебестоимостьТоваров.ДопРасходыРегл
|		- СебестоимостьТоваров.ПостояннаяРазница
|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница

|ПОМЕСТИТЬ ПервичныеПартииВНЗП
|ИЗ
|	РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК ПП
|		ПО СебестоимостьТоваров.КорПартия = ПП.Партия
|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
|		ПО СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
|			И СебестоимостьТоваров.КорПартия = Выбытие.Партия
|			И СебестоимостьТоваров.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
|			И СебестоимостьТоваров.Организация = Выбытие.Организация
|ГДЕ
|	СебестоимостьТоваров.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
|	И НЕ Выбытие.АналитикаУчетаНоменклатуры ЕСТЬ NULL
|	И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))

|СГРУППИРОВАТЬ ПО
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
|	СебестоимостьТоваров.Организация,
|	СебестоимостьТоваров.ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий,
|	СебестоимостьТоваров.Партия,
|	СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.КорПартия,
|	Выбытие.ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции

|ИМЕЮЩИЕ СУММА(СебестоимостьТоваров.Количество) > 0

|ОБЪЕДИНИТЬ ВСЕ

// Фикс. стоимость
|ВЫБРАТЬ
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ)	КАК Период,
|	СебестоимостьТоваров.Организация					КАК Организация,
|	СебестоимостьТоваров.ВидЗапасов						КАК ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий 			КАК АналитикаУчетаПартий,
|	СебестоимостьТоваров.Регистратор					КАК Партия,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК КорАналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.Партия							КАК КорПартия,
|	Выбытие.ПартияПродукции								КАК ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции				КАК АналитикаУчетаПартийПродукции,
|	ЛОЖЬ												КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ												КАК ИсключитьНДСИзСтоимости,
|	СУММА(СебестоимостьТоваров.Количество),
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|		КОНЕЦ)												КАК Материальные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
|		КОНЕЦ)												КАК Трудозатраты,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		КОНЕЦ)												КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		КОНЕЦ)												КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК ДопРасходы,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|				+ СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|				+ СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|				+ СебестоимостьТоваров.ТрудозатратыУпр
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
|				+ СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|				+ СебестоимостьТоваров.ТрудозатратыРегл
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|				+ СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
|			ИНАЧЕ 0
|		КОНЕЦ)												КАК НДД,

|// Стоимости с НДС
|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,

|// Стоимости без НДС
|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,

|// Стоимости Упр
|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,

|// Стоимости Регл
|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,

|// Налоговый учет
|	СУММА(СебестоимостьТоваров.СтоимостьРегл
|		+ СебестоимостьТоваров.ТрудозатратыРегл
|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		+ СебестоимостьТоваров.ДопРасходыРегл
|		- СебестоимостьТоваров.ПостояннаяРазница
|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница

|ИЗ
|	РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК ПП
|		ПО СебестоимостьТоваров.Партия = ПП.Партия
|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
|		ПО СебестоимостьТоваров.АналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
|			И СебестоимостьТоваров.Партия = Выбытие.Партия
|			И СебестоимостьТоваров.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
|			И СебестоимостьТоваров.Организация = Выбытие.Организация
|ГДЕ
|	СебестоимостьТоваров.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость)
|	И СебестоимостьТоваров.Количество < 0
|	И НЕ Выбытие.АналитикаУчетаНоменклатуры ЕСТЬ NULL
|	И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))

|СГРУППИРОВАТЬ ПО
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
|	СебестоимостьТоваров.Организация,
|	СебестоимостьТоваров.ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий,
|	СебестоимостьТоваров.Регистратор,
|	СебестоимостьТоваров.Партия,
|	Выбытие.ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции

|ОБЪЕДИНИТЬ ВСЕ

// Услуги переработчика
|ВЫБРАТЬ
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ)	КАК Период,
|	СебестоимостьТоваров.Организация					КАК Организация,
|	СебестоимостьТоваров.ВидЗапасов						КАК ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий			КАК АналитикаУчетаПартий,
|	СебестоимостьТоваров.Регистратор					КАК Партия,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК КорАналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.Партия							КАК КорПартия,
|	Выбытие.ПартияПродукции								КАК ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции				КАК АналитикаУчетаПартийПродукции,
|	ЛОЖЬ												КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ												КАК ИсключитьНДСИзСтоимости,
|	СУММА(СебестоимостьТоваров.Количество),
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|		КОНЕЦ)												КАК Материальные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
|		КОНЕЦ)												КАК Трудозатраты,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		КОНЕЦ)												КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		КОНЕЦ)												КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК ДопРасходы,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|				+ СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|				+ СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|				+ СебестоимостьТоваров.ТрудозатратыУпр
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
|				+ СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|				+ СебестоимостьТоваров.ТрудозатратыРегл
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|				+ СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
|			ИНАЧЕ 0
|		КОНЕЦ)												КАК НДД,

|// Стоимости с НДС
|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,

|// Стоимости без НДС
|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,

|// Стоимости Упр
|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,

|// Стоимости Регл
|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,

|// Налоговый учет
|	СУММА(СебестоимостьТоваров.СтоимостьРегл
|		+ СебестоимостьТоваров.ТрудозатратыРегл
|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		+ СебестоимостьТоваров.ДопРасходыРегл
|		- СебестоимостьТоваров.ПостояннаяРазница
|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница

|ИЗ
|	РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров

|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК ПП
|		ПО СебестоимостьТоваров.Партия = ПП.Партия

|	ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
|	ПО СебестоимостьТоваров.АналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
|	И СебестоимостьТоваров.Партия = Выбытие.Партия
|	И СебестоимостьТоваров.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
|	И СебестоимостьТоваров.Организация = Выбытие.Организация
|ГДЕ
|	ТИПЗНАЧЕНИЯ(СебестоимостьТоваров.Регистратор) В(
|//++ Устарело_Переработка24
|		ТИП(Документ.ОтчетПереработчика),
|//-- Устарело_Переработка24
|		ТИП(Документ.ОтчетПереработчика2_5))
|	И СебестоимостьТоваров.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
|	И СебестоимостьТоваров.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
|	И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))

|СГРУППИРОВАТЬ ПО
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
|	СебестоимостьТоваров.Организация,
|	СебестоимостьТоваров.ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий,
|	СебестоимостьТоваров.Регистратор,
|	СебестоимостьТоваров.Партия,
|	Выбытие.ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции

|ОБЪЕДИНИТЬ ВСЕ

// Начальные остатки
|ВЫБРАТЬ
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ)	КАК Период,
|	СебестоимостьТоваров.Организация					КАК Организация,
|	СебестоимостьТоваров.ВидЗапасов						КАК ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий			КАК АналитикаУчетаПартий,
|	СебестоимостьТоваров.Регистратор					КАК Партия,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры		КАК КорАналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.Партия							КАК КорПартия,
|	Выбытие.ПартияПродукции								КАК ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции				КАК АналитикаУчетаПартийПродукции,
|	ЛОЖЬ												КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ												КАК ИсключитьНДСИзСтоимости,
|	СУММА(СебестоимостьТоваров.Количество),
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|		КОНЕЦ)												КАК Материальные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
|		КОНЕЦ)												КАК Трудозатраты,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		КОНЕЦ)												КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		КОНЕЦ)												КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК ДопРасходы,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|				+ СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|				+ СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|				+ СебестоимостьТоваров.ТрудозатратыУпр
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
|				+ СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|				+ СебестоимостьТоваров.ТрудозатратыРегл
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|				+ СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
|			ИНАЧЕ 0
|		КОНЕЦ)												КАК НДД,

|// Стоимости с НДС
|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,

|// Стоимости без НДС
|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,

|// Стоимости Упр
|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,

|// Стоимости Регл
|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,

|// Налоговый учет
|	СУММА(СебестоимостьТоваров.СтоимостьРегл
|		+ СебестоимостьТоваров.ТрудозатратыРегл
|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		+ СебестоимостьТоваров.ДопРасходыРегл
|		- СебестоимостьТоваров.ПостояннаяРазница
|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница

|ИЗ
|	РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК ПП
|		ПО СебестоимостьТоваров.Партия = ПП.Партия
|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбывшиеЗатратыСводно КАК Выбытие
|		ПО СебестоимостьТоваров.АналитикаУчетаНоменклатуры = Выбытие.АналитикаУчетаНоменклатуры
|			И СебестоимостьТоваров.Партия = Выбытие.Партия
|			И СебестоимостьТоваров.Период <= КОНЕЦПЕРИОДА(Выбытие.Период, МЕСЯЦ)
|			И СебестоимостьТоваров.Организация = Выбытие.Организация
|ГДЕ
|	СебестоимостьТоваров.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковЗатратПартийПроизводства)
|	И НЕ Выбытие.АналитикаУчетаНоменклатуры ЕСТЬ NULL
|	И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))

|СГРУППИРОВАТЬ ПО
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
|	СебестоимостьТоваров.Организация,
|	СебестоимостьТоваров.ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.АналитикаУчетаПартий,
|	СебестоимостьТоваров.Регистратор,
|	СебестоимостьТоваров.Партия,
|	Выбытие.ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции

|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует SQL-запрос для временной таблицы ДетализацияПартий
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ДетализацияПартий()
	
	Возврат
	"
	|ВЫБРАТЬ
	|	СебестоимостьТоваров.Организация					КАК Организация,
	|	СебестоимостьТоваров.Период							КАК Период,
	|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
	|	СебестоимостьТоваров.АналитикаУчетаПартий 			КАК АналитикаУчетаПартий,
	|	СебестоимостьТоваров.Партия 						КАК Партия,
	|	СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры 	КАК КорАналитикаУчетаНоменклатуры,
	|	СебестоимостьТоваров.КорПартия						КАК КорПартия,
	|	СебестоимостьТоваров.ПартияПродукции				КАК ПартияПродукции,
	|	СебестоимостьТоваров.АналитикаУчетаПартийПродукции	КАК АналитикаУчетаПартийПродукции,
	|	ВЫРАЗИТЬ(СУММА(ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости <> 3 ТОГДА 0
	|		КОГДА СебестоимостьТоваров.ВключитьНДСВСтоимость
	|			ТОГДА (ЕСТЬNULL(Детализация.НДСУпр, 0) + ЕСТЬNULL(ДетализацияПостатейные.НДСУпр, 0))
	|				* СебестоимостьТоваров.Количество
	|		КОГДА СебестоимостьТоваров.ИсключитьНДСИзСтоимости
	|			ТОГДА (ЕСТЬNULL(-Детализация.НДСУпр, 0) + ЕСТЬNULL(-ДетализацияПостатейные.НДСУпр, 0))
	|				* СебестоимостьТоваров.Количество
	|		ИНАЧЕ 0 КОНЕЦ) КАК ЧИСЛО(31,2)) КАК НДСУпр,
	|	ВЫРАЗИТЬ(СУММА(ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости <> 4 ТОГДА 0
	|		КОГДА СебестоимостьТоваров.ВключитьНДСВСтоимость
	|			ТОГДА (ЕСТЬNULL(Детализация.НДСРегл, 0) + ЕСТЬNULL(ДетализацияПостатейные.НДСРегл, 0))
	|				* СебестоимостьТоваров.Количество
	|		КОГДА СебестоимостьТоваров.ИсключитьНДСИзСтоимости
	|			ТОГДА (ЕСТЬNULL(-Детализация.НДСРегл, 0) + ЕСТЬNULL(-ДетализацияПостатейные.НДСРегл, 0))
	|				* СебестоимостьТоваров.Количество
	|		ИНАЧЕ 0 КОНЕЦ) КАК ЧИСЛО(31,2)) КАК НДСРегл
	|
	|ПОМЕСТИТЬ ДетализацияПартий
	|ИЗ
	|	ПервичныеПартииВНЗП КАК СебестоимостьТоваров
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|	ПО Аналитика.Ссылка = СебестоимостьТоваров.АналитикаУчетаНоменклатуры
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Детализация
	|	ПО Детализация.Партия = СебестоимостьТоваров.Партия
	|		И Детализация.АналитикаУчетаПартий = СебестоимостьТоваров.АналитикаУчетаПартий
	|		И Детализация.Организация = СебестоимостьТоваров.Организация
	|		И Детализация.ВидЗапасов = СебестоимостьТоваров.ВидЗапасов
	|		И Детализация.Номенклатура = Аналитика.Номенклатура
	|		И Детализация.Характеристика = Аналитика.Характеристика
	|		И НЕ Детализация.ЗатратыПредыдущихПеределов
	|		И (Детализация.ПериодРегистрации <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
	|		И СебестоимостьТоваров.Количество <> 0
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК ДетализацияПостатейные
	|	ПО ДетализацияПостатейные.Партия = СебестоимостьТоваров.Партия
	|		И ДетализацияПостатейные.АналитикаУчетаПартий = СебестоимостьТоваров.АналитикаУчетаПартий
	|		И ДетализацияПостатейные.Организация = СебестоимостьТоваров.Организация
	|		И ДетализацияПостатейные.ВидЗапасов = СебестоимостьТоваров.ВидЗапасов
	|		И ДетализацияПостатейные.Номенклатура = Аналитика.Номенклатура
	|		И ДетализацияПостатейные.Характеристика = Аналитика.Характеристика
	|		И НЕ ДетализацияПостатейные.ЗатратыПредыдущихПеределов
	|		И (ДетализацияПостатейные.ПериодРегистрации <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
	|		И СебестоимостьТоваров.Количество <> 0
	|ГДЕ
	|	СебестоимостьТоваров.ВключитьНДСВСтоимость ИЛИ СебестоимостьТоваров.ИсключитьНДСИзСтоимости
	|
	|СГРУППИРОВАТЬ ПО
	|	СебестоимостьТоваров.Организация,
	|	СебестоимостьТоваров.Период,
	|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры,
	|	СебестоимостьТоваров.АналитикаУчетаПартий,
	|	СебестоимостьТоваров.Партия,
	|	СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры,
	|	СебестоимостьТоваров.КорПартия,
	|	СебестоимостьТоваров.ПартияПродукции,
	|	СебестоимостьТоваров.АналитикаУчетаПартийПродукции
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	ПартияПродукции,
	|	АналитикаУчетаПартийПродукции
	|;";

КонецФункции

// Формирует SQL-запрос для временной таблицы ПриходыНарастающимИтогом
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ПриходыНарастающимИтогом()
	
	Возврат
"
|ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	Т.Период КАК Период,
|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	СУММА(Партии.Количество) КАК Количество
|ПОМЕСТИТЬ ПриходыНарастающимИтогом
|ИЗ
|	ВыбытиеИзНЗП КАК Т
|		ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеПартииВНЗП КАК Партии
|		ПО Т.АналитикаУчетаНоменклатуры = Партии.КорАналитикаУчетаНоменклатуры
|			И Т.Партия = Партии.КорПартия
|			И Т.Период >= Партии.Период
|			И Т.ПартияПродукции = Партии.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Партии.АналитикаУчетаПартийПродукции
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	Т.Период,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.Партия,
|	Т.ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует SQL-запрос для временной таблицы РасходыНарастающимИтогом
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_РасходыНарастающимИтогом()
	
	Возврат
"
|ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	Т.Период КАК Период,
|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	СУММА(НарастающийИтог.Количество) КАК Количество
|ПОМЕСТИТЬ РасходыНарастающимИтогом
|ИЗ
|	ВыбытиеИзНЗП КАК Т
|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбытиеИзНЗП КАК НарастающийИтог
|		ПО Т.АналитикаУчетаНоменклатуры = НарастающийИтог.АналитикаУчетаНоменклатуры
|			И Т.Организация = НарастающийИтог.Организация
|			И Т.Партия = НарастающийИтог.Партия
|			И Т.Период >= НарастающийИтог.Период
|			И Т.ПартияПродукции = НарастающийИтог.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = НарастающийИтог.АналитикаУчетаПартийПродукции
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	Т.Период,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.Партия,
|	Т.ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует SQL-запрос для временной таблицы НулевыеПериоды
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_НулевыеПериоды()
	
	Возврат
"
|ВЫБРАТЬ
|	Расходы.Организация КАК Организация,
|	Расходы.Период КАК Период,
|	Расходы.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Расходы.Партия КАК Партия,
|	Расходы.ПартияПродукции КАК ПартияПродукции,
|	Расходы.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции
|ПОМЕСТИТЬ НулевыеПериоды
|ИЗ
|	РасходыНарастающимИтогом КАК Расходы
|		ЛЕВОЕ СОЕДИНЕНИЕ ПриходыНарастающимИтогом КАК Приходы
|		ПО Расходы.АналитикаУчетаНоменклатуры = Приходы.АналитикаУчетаНоменклатуры
|			И Расходы.Партия = Приходы.Партия
|			И Расходы.Период = Приходы.Период
|			И Расходы.Организация = Приходы.Организация
|			И Расходы.ПартияПродукции = Приходы.ПартияПродукции
|			И Расходы.АналитикаУчетаПартийПродукции = Приходы.АналитикаУчетаПартийПродукции
|ГДЕ
|	Расходы.Количество - ЕСТЬNULL(Приходы.Количество, 0) = 0
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует SQL-запрос для временной таблицы ИнтервалыРасходаПартий
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ИнтервалыРасходаПартий()
	
	Возврат
"
|ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	Т.Период КАК КонецПериода,
|	МАКСИМУМ(ЕСТЬNULL(ДОБАВИТЬКДАТЕ(НулевыеПериоды.Период, МЕСЯЦ, 1), ДАТАВРЕМЯ(1, 1, 1))) КАК НачалоПериода,
|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции
|ПОМЕСТИТЬ ИнтервалыРасходаПартий
|ИЗ
|	НулевыеПериоды КАК Т
|		ЛЕВОЕ СОЕДИНЕНИЕ НулевыеПериоды КАК НулевыеПериоды
|		ПО Т.АналитикаУчетаНоменклатуры = НулевыеПериоды.АналитикаУчетаНоменклатуры
|			И Т.Партия = НулевыеПериоды.Партия
|			И Т.Период > НулевыеПериоды.Период
|			И Т.Организация = НулевыеПериоды.Организация
|			И Т.ПартияПродукции = НулевыеПериоды.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = НулевыеПериоды.АналитикаУчетаПартийПродукции
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	Т.Период,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.Партия,
|	Т.ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует SQL-запрос для временной таблицы ПриходыНарастающимИтогомПоИнтервалам
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ПриходыНарастающимИтогомПоИнтервалам()
	
	Возврат
"
|ВЫБРАТЬ
|	Выбытие.Организация,
|	Выбытие.Период,
|	Выбытие.АналитикаУчетаНоменклатуры,
|	Выбытие.Партия КАК Партия,
|	Выбытие.ПартияПродукции КАК ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	СУММА(ПП.Количество) КАК Количество
|ПОМЕСТИТЬ ПриходыНарастающимИтогомПоИнтервалам
|ИЗ
|	ВыбытиеИзНЗП КАК Выбытие
|	ЛЕВОЕ СОЕДИНЕНИЕ ИнтервалыРасходаПартий КАК Интервалы
|	ПО Выбытие.АналитикаУчетаНоменклатуры = Интервалы.АналитикаУчетаНоменклатуры
|		И Выбытие.Партия = Интервалы.Партия
|		И Выбытие.ПартияПродукции = Интервалы.ПартияПродукции
|		И Выбытие.АналитикаУчетаПартийПродукции = Интервалы.АналитикаУчетаПартийПродукции
|
|	ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеПартииВНЗП КАК ПП
|	ПО Выбытие.АналитикаУчетаНоменклатуры = ПП.КорАналитикаУчетаНоменклатуры
|		И Выбытие.Партия = ПП.КорПартия
|		И Выбытие.Период >= ПП.Период
|		И (ПП.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
|		И Выбытие.ПартияПродукции = ПП.ПартияПродукции
|		И Выбытие.АналитикаУчетаПартийПродукции = ПП.АналитикаУчетаПартийПродукции
|ГДЕ
|	(Интервалы.НачалоПериода ЕСТЬ NULL
|		ИЛИ Выбытие.Период МЕЖДУ Интервалы.НачалоПериода И Интервалы.КонецПериода)
|
|СГРУППИРОВАТЬ ПО
|	Выбытие.Организация,
|	Выбытие.Период,
|	Выбытие.АналитикаУчетаНоменклатуры,
|	Выбытие.Партия,
|	Выбытие.ПартияПродукции,
|	Выбытие.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует SQL-запрос для временной таблицы ПредварительныйРасходПартий
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ПредварительныйРасходПартий()
	
	Возврат
"
|ВЫБРАТЬ
|	Выбытие.Организация КАК Организация,
|	Выбытие.Период КАК Период,
|	ПП.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	ПП.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
|	ПП.Партия КАК Партия,
|	ПП.ПартияПродукции КАК ПартияПродукции,
|	ПП.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	МАКСИМУМ(ПП.ВключитьНДСВСтоимость) КАК ВключитьНДСВСтоимость,
|	МАКСИМУМ(ПП.ИсключитьНДСИзСтоимости) КАК ИсключитьНДСИзСтоимости,
|	Выбытие.АналитикаУчетаНоменклатуры 	КАК КорАналитикаУчетаНоменклатуры,
|	Выбытие.Партия 						КАК КорПартия,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|			Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.Количество) КАК Количество,
|	МАКСИМУМ(Выбытие.Количество = Поступило.Количество - ЕСТЬNULL(Выбыло.Количество, 0) + Выбытие.Количество) КАК СписатьОстаток,
|
|	// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.Материальные) КАК Материальные,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.Трудозатраты) КАК Трудозатраты,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПостоянные) КАК ПостатейныеПостоянные,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПеременные) КАК ПостатейныеПеременные,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ДопРасходы) КАК ДопРасходы,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.СуммаЗатратаЗабалансовая) КАК СуммаЗатратаЗабалансовая,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.СуммаЗатрата) КАК СуммаЗатрата,
|	СУММА(ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.НДД) КАК НДД,
|
|	// Стоимости с НДС
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.МатериальныеСНДС) КАК МатериальныеСНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ТрудозатратыСНДС) КАК ТрудозатратыСНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПостоянныеСНДС) КАК ПостатейныеПостоянныеСНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПеременныеСНДС) КАК ПостатейныеПеременныеСНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ДопРасходыСНДС) КАК ДопРасходыСНДС,
|
|	// Стоимости без НДС
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.МатериальныеБезНДС) КАК МатериальныеБезНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПостоянныеБезНДС) КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПеременныеБезНДС) КАК ПостатейныеПеременныеБезНДС,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
|
|	// Стоимости Упр
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.МатериальныеУпр) КАК МатериальныеУпр,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ТрудозатратыУпр) КАК ТрудозатратыУпр,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПостоянныеУпр) КАК ПостатейныеПостоянныеУпр,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПеременныеУпр) КАК ПостатейныеПеременныеУпр,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ДопРасходыУпр) КАК ДопРасходыУпр,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.СтоимостьЗабалансоваяУпр) КАК СтоимостьЗабалансоваяУпр,
|
|	// Стоимости Регл
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.МатериальныеРегл) КАК МатериальныеРегл,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ТрудозатратыРегл) КАК ТрудозатратыРегл,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПостоянныеРегл) КАК ПостатейныеПостоянныеРегл,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостатейныеПеременныеРегл) КАК ПостатейныеПеременныеРегл,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ДопРасходыРегл) КАК ДопРасходыРегл,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.СтоимостьЗабалансоваяРегл) КАК СтоимостьЗабалансоваяРегл,
|
|	// Налоговый учет
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.НалоговыйУчет) КАК НалоговыйУчет,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ПостояннаяРазница) КАК ПостояннаяРазница,
|	СУММА(
|		ВЫРАЗИТЬ(Выбытие.Количество /
|		Поступило.Количество КАК ЧИСЛО(23, 10))
|			* ПП.ВременнаяРазница) КАК ВременнаяРазница
|
|ПОМЕСТИТЬ ПредварительныйРасходПартий
|ИЗ
|	ВыбытиеИзНЗП КАК Выбытие
|		ЛЕВОЕ СОЕДИНЕНИЕ ИнтервалыРасходаПартий КАК Интервалы
|		ПО Выбытие.АналитикаУчетаНоменклатуры = Интервалы.АналитикаУчетаНоменклатуры
|			И Выбытие.Партия = Интервалы.Партия
|			И Выбытие.Организация = Интервалы.Организация
|			И Выбытие.ПартияПродукции = Интервалы.ПартияПродукции
|			И Выбытие.АналитикаУчетаПартийПродукции = Интервалы.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеПартииВНЗП КАК ПП
|		ПО Выбытие.АналитикаУчетаНоменклатуры = ПП.КорАналитикаУчетаНоменклатуры
|			И Выбытие.Партия = ПП.КорПартия
|			И Выбытие.Период >= ПП.Период
|			И (ПП.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
|			И Выбытие.Организация = ПП.Организация
|			И Выбытие.ПартияПродукции = ПП.ПартияПродукции
|			И Выбытие.АналитикаУчетаПартийПродукции = ПП.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ РасходыНарастающимИтогом КАК Выбыло
|		ПО Выбытие.АналитикаУчетаНоменклатуры = Выбыло.АналитикаУчетаНоменклатуры
|			И Выбытие.Партия = Выбыло.Партия
|			И Выбытие.Период = Выбыло.Период
|			И Выбытие.Организация = Выбыло.Организация
|			И Выбытие.ПартияПродукции = Выбыло.ПартияПродукции
|			И Выбытие.АналитикаУчетаПартийПродукции = Выбыло.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ ПриходыНарастающимИтогомПоИнтервалам КАК Поступило
|		ПО Выбытие.АналитикаУчетаНоменклатуры = Поступило.АналитикаУчетаНоменклатуры
|			И Выбытие.Партия = Поступило.Партия
|			И Выбытие.Период = Поступило.Период
|			И Выбытие.Организация = Поступило.Организация
|			И Выбытие.ПартияПродукции = Поступило.ПартияПродукции
|			И Выбытие.АналитикаУчетаПартийПродукции = Поступило.АналитикаУчетаПартийПродукции
|ГДЕ
|	(Интервалы.НачалоПериода ЕСТЬ NULL
|		ИЛИ Выбытие.Период МЕЖДУ Интервалы.НачалоПериода И Интервалы.КонецПериода)
|	И НЕ Поступило.Количество ЕСТЬ NULL
|
|СГРУППИРОВАТЬ ПО
|	Выбытие.Организация,
|	Выбытие.Период,
|	Выбытие.АналитикаУчетаНоменклатуры,
|	Выбытие.Партия,
|	ПП.АналитикаУчетаНоменклатуры,
|	ПП.АналитикаУчетаПартий,
|	ПП.Партия,
|	ПП.ПартияПродукции,
|	ПП.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует SQL-запрос для временной таблицы ПартииСводно
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ПартииСводно()
	
	Возврат
"
|ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	Т.Период КАК Период,
|	Т.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
|	Т.КорПартия КАК КорПартия,
|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	СУММА(Партии.Количество) КАК Количество,
|	// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(Партии.Материальные
|		+ ЕСТЬNULL(Детализация.НДСУпр,0)
|		+ ЕСТЬNULL(Детализация.НДСРегл,0)) КАК Материальные,
|	СУММА(Партии.Трудозатраты) КАК Трудозатраты,
|	СУММА(Партии.ПостатейныеПостоянные) КАК ПостатейныеПостоянные,
|	СУММА(Партии.ПостатейныеПеременные) КАК ПостатейныеПеременные,
|	СУММА(Партии.ДопРасходы) КАК ДопРасходы,
|	СУММА(Партии.СуммаЗатратаЗабалансовая) КАК СуммаЗатратаЗабалансовая,
|	СУММА(Партии.СуммаЗатрата
|		+ ЕСТЬNULL(Детализация.НДСУпр,0)
|		+ ЕСТЬNULL(Детализация.НДСРегл,0)) КАК СуммаЗатрата,
|	СУММА(Партии.НДД) КАК НДД,
|
|	// Стоимости с НДС
|	СУММА(Партии.МатериальныеСНДС) КАК МатериальныеСНДС,
|	СУММА(Партии.ТрудозатратыСНДС) КАК ТрудозатратыСНДС,
|	СУММА(Партии.ПостатейныеПостоянныеСНДС) КАК ПостатейныеПостоянныеСНДС,
|	СУММА(Партии.ПостатейныеПеременныеСНДС) КАК ПостатейныеПеременныеСНДС,
|	СУММА(Партии.ДопРасходыСНДС) КАК ДопРасходыСНДС,
|
|	// Стоимости без НДС
|	СУММА(Партии.МатериальныеБезНДС) КАК МатериальныеБезНДС,
|	СУММА(Партии.ПостатейныеПостоянныеБезНДС) КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(Партии.ПостатейныеПеременныеБезНДС) КАК ПостатейныеПеременныеБезНДС,
|	СУММА(Партии.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
|
|	// Стоимости Упр
|	СУММА(Партии.МатериальныеУпр + ЕСТЬNULL(Детализация.НДСУпр,0)) КАК МатериальныеУпр,
|	СУММА(Партии.ТрудозатратыУпр) КАК ТрудозатратыУпр,
|	СУММА(Партии.ПостатейныеПостоянныеУпр) КАК ПостатейныеПостоянныеУпр,
|	СУММА(Партии.ПостатейныеПеременныеУпр) КАК ПостатейныеПеременныеУпр,
|	СУММА(Партии.ДопРасходыУпр) КАК ДопРасходыУпр,
|	СУММА(Партии.СтоимостьЗабалансоваяУпр) КАК СтоимостьЗабалансоваяУпр,
|
|	// Стоимости Регл
|	СУММА(Партии.МатериальныеРегл + ЕСТЬNULL(Детализация.НДСРегл,0)) КАК МатериальныеРегл,
|	СУММА(Партии.ТрудозатратыРегл) КАК ТрудозатратыРегл,
|	СУММА(Партии.ПостатейныеПостоянныеРегл) КАК ПостатейныеПостоянныеРегл,
|	СУММА(Партии.ПостатейныеПеременныеРегл) КАК ПостатейныеПеременныеРегл,
|	СУММА(Партии.ДопРасходыРегл) КАК ДопРасходыРегл,
|	СУММА(Партии.СтоимостьЗабалансоваяРегл) КАК СтоимостьЗабалансоваяРегл,
|
|	// Налоговый учет
|	СУММА(Партии.НалоговыйУчет + ЕСТЬNULL(Детализация.НДСРегл,0)) КАК НалоговыйУчет,
|	СУММА(Партии.ПостояннаяРазница) КАК ПостояннаяРазница,
|	СУММА(Партии.ВременнаяРазница) КАК ВременнаяРазница
|
|ПОМЕСТИТЬ ПартииСводно
|ИЗ
|	ПредварительныйРасходПартий КАК Т
|		ЛЕВОЕ СОЕДИНЕНИЕ ИнтервалыРасходаПартий КАК Интервалы
|		ПО Т.КорАналитикаУчетаНоменклатуры = Интервалы.АналитикаУчетаНоменклатуры
|			И Т.КорПартия = Интервалы.Партия
|			И Т.Организация = Интервалы.Организация
|			И Т.ПартияПродукции = Интервалы.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Интервалы.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеПартииВНЗП КАК Партии
|		ПО Т.КорАналитикаУчетаНоменклатуры = Партии.КорАналитикаУчетаНоменклатуры
|			И Т.КорПартия = Партии.КорПартия
|			И Т.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатуры
|			И Т.АналитикаУчетаПартий = Партии.АналитикаУчетаПартий
|			И Т.Партия = Партии.Партия
|			И Т.Период >= Партии.Период
|			И (Партии.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
|			И Т.Организация = Партии.Организация
|			И Т.ПартияПродукции = Партии.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Партии.АналитикаУчетаПартийПродукции
|
|		ЛЕВОЕ СОЕДИНЕНИЕ ДетализацияПартий КАК Детализация
|		ПО Т.КорАналитикаУчетаНоменклатуры = Детализация.КорАналитикаУчетаНоменклатуры
|			И Т.КорПартия = Детализация.КорПартия
|			И Т.АналитикаУчетаНоменклатуры = Детализация.АналитикаУчетаНоменклатуры
|			И Т.АналитикаУчетаПартий = Детализация.АналитикаУчетаПартий
|			И Т.Партия = Детализация.Партия
|			И Т.Период >= Детализация.Период
|			И (Детализация.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
|			И Т.Организация = Детализация.Организация
|			И Т.ПартияПродукции = Детализация.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Детализация.АналитикаУчетаПартийПродукции
|ГДЕ
|	Интервалы.НачалоПериода ЕСТЬ NULL
|		ИЛИ Т.Период МЕЖДУ Интервалы.НачалоПериода И Интервалы.КонецПериода
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	Т.Период,
|	Т.КорАналитикаУчетаНоменклатуры,
|	Т.КорПартия,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.АналитикаУчетаПартий,
|	Т.Партия,
|	Т.ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует SQL-запрос для временной таблицы РасходПартийСводно
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_РасходПартийСводно()
	
	Возврат
"
|ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	Т.Период КАК Период,
|	Т.КорАналитикаУчетаНоменклатуры,
|	Т.КорПартия,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.АналитикаУчетаПартий,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.Количество
|		КОНЕЦ) КАК Количество,
|	// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.Материальные
|		КОНЕЦ) КАК Материальные,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.Трудозатраты
|		КОНЕЦ) КАК Трудозатраты,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПостоянные
|		КОНЕЦ) КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПеременные
|		КОНЕЦ) КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ДопРасходы
|		КОНЕЦ) КАК ДопРасходы,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.СуммаЗатратаЗабалансовая
|		КОНЕЦ) КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.СуммаЗатрата
|		КОНЕЦ) КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.НДД
|		КОНЕЦ) КАК НДД,
|
|	// Стоимости с НДС
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.МатериальныеСНДС
|		КОНЕЦ) КАК МатериальныеСНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ТрудозатратыСНДС
|		КОНЕЦ) КАК ТрудозатратыСНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПостоянныеСНДС
|		КОНЕЦ) КАК ПостатейныеПостоянныеСНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПеременныеСНДС
|		КОНЕЦ) КАК ПостатейныеПеременныеСНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ДопРасходыСНДС
|		КОНЕЦ) КАК ДопРасходыСНДС,
|	// Стоимости без НДС
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.МатериальныеБезНДС
|		КОНЕЦ) КАК МатериальныеБезНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПостоянныеБезНДС
|		КОНЕЦ) КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПеременныеБезНДС
|		КОНЕЦ) КАК ПостатейныеПеременныеБезНДС,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ДопРасходыБезНДС
|		КОНЕЦ) КАК ДопРасходыБезНДС,
|	// Стоимости Упр
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.МатериальныеУпр
|		КОНЕЦ) КАК МатериальныеУпр,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ТрудозатратыУпр
|		КОНЕЦ) КАК ТрудозатратыУпр,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПостоянныеУпр
|		КОНЕЦ) КАК ПостатейныеПостоянныеУпр,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПеременныеУпр
|		КОНЕЦ) КАК ПостатейныеПеременныеУпр,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ДопРасходыУпр
|		КОНЕЦ) КАК ДопРасходыУпр,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.СтоимостьЗабалансоваяУпр
|		КОНЕЦ) КАК СтоимостьЗабалансоваяУпр,
|	// Стоимости Регл
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.МатериальныеРегл
|		КОНЕЦ) КАК МатериальныеРегл,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ТрудозатратыРегл
|		КОНЕЦ) КАК ТрудозатратыРегл,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПостоянныеРегл
|		КОНЕЦ) КАК ПостатейныеПостоянныеРегл,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостатейныеПеременныеРегл
|		КОНЕЦ) КАК ПостатейныеПеременныеРегл,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ДопРасходыРегл
|		КОНЕЦ) КАК ДопРасходыРегл,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.СтоимостьЗабалансоваяРегл
|		КОНЕЦ) КАК СтоимостьЗабалансоваяРегл,
|
|	// Налоговый учет
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.НалоговыйУчет
|		КОНЕЦ) КАК НалоговыйУчет,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ПостояннаяРазница
|		КОНЕЦ) КАК ПостояннаяРазница,
|	СУММА(ВЫБОР
|			КОГДА Расход.СписатьОстаток
|				ТОГДА 0
|			ИНАЧЕ Расход.ВременнаяРазница
|		КОНЕЦ) КАК ВременнаяРазница
|
|ПОМЕСТИТЬ РасходПартийСводно
|ИЗ
|	ПредварительныйРасходПартий КАК Т
|		ЛЕВОЕ СОЕДИНЕНИЕ ИнтервалыРасходаПартий КАК Интервалы
|		ПО Т.КорАналитикаУчетаНоменклатуры = Интервалы.АналитикаУчетаНоменклатуры
|			И Т.КорПартия = Интервалы.Партия
|			И Т.Организация = Интервалы.Организация
|			И Т.ПартияПродукции = Интервалы.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Интервалы.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ ПредварительныйРасходПартий КАК Расход
|		ПО Т.КорАналитикаУчетаНоменклатуры = Расход.КорАналитикаУчетаНоменклатуры
|			И Т.КорПартия = Расход.КорПартия
|			И Т.АналитикаУчетаНоменклатуры = Расход.АналитикаУчетаНоменклатуры
|			И Т.АналитикаУчетаПартий = Расход.АналитикаУчетаПартий
|			И Т.Партия = Расход.Партия
|			И Т.Период >= Расход.Период
|			И (Расход.Период >= ЕСТЬNULL(Интервалы.НачалоПериода, ДАТАВРЕМЯ(1,1,1)))
|			И Т.Организация = Расход.Организация
|			И Т.ПартияПродукции = Расход.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Расход.АналитикаУчетаПартийПродукции
|ГДЕ
|	Т.Период МЕЖДУ Интервалы.НачалоПериода И Интервалы.КонецПериода
|		ИЛИ Интервалы.НачалоПериода ЕСТЬ NULL
|
|СГРУППИРОВАТЬ ПО
|	Т.Организация,
|	Т.Период,
|	Т.КорАналитикаУчетаНоменклатуры,
|	Т.КорПартия,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.АналитикаУчетаПартий,
|	Т.Партия,
|	Т.ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";

КонецФункции

// Формирует SQL-запрос для временной таблицы ПервичныеЗатратыПоПериодам
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ПервичныеЗатратыПоПериодам()
	
	Возврат
"ВЫБРАТЬ
|	Т.Организация КАК Организация,
|	Т.Период КАК Период,
|	Т.КорАналитикаУчетаНоменклатуры,
|	Т.КорПартия КАК КорПартия,
|	Т.АналитикаУчетаНоменклатуры,
|	Т.АналитикаУчетаПартий,
|	Т.Партия КАК Партия,
|	Т.ПартияПродукции КАК ПартияПродукции,
|	Т.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	Т.ВключитьНДСВСтоимость КАК ВключитьНДСВСтоимость,
|	Т.ИсключитьНДСИзСтоимости КАК ИсключитьНДСИзСтоимости,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.Количество - Расход.Количество
|		ИНАЧЕ Т.Количество
|	КОНЕЦ КАК Количество,
|	// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.Материальные - Расход.Материальные
|		ИНАЧЕ Т.Материальные
|	КОНЕЦ КАК Материальные,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.Трудозатраты - Расход.Трудозатраты
|		ИНАЧЕ Т.Трудозатраты
|	КОНЕЦ КАК Трудозатраты,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПостоянные - Расход.ПостатейныеПостоянные
|		ИНАЧЕ Т.ПостатейныеПостоянные
|	КОНЕЦ КАК ПостатейныеПостоянные,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПеременные - Расход.ПостатейныеПеременные
|		ИНАЧЕ Т.ПостатейныеПеременные
|	КОНЕЦ КАК ПостатейныеПеременные,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ДопРасходы - Расход.ДопРасходы
|		ИНАЧЕ Т.ДопРасходы
|	КОНЕЦ КАК ДопРасходы,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.СуммаЗатратаЗабалансовая - Расход.СуммаЗатратаЗабалансовая
|		ИНАЧЕ Т.СуммаЗатратаЗабалансовая
|	КОНЕЦ КАК СуммаЗатратаЗабалансовая,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.СуммаЗатрата - Расход.СуммаЗатрата
|		ИНАЧЕ Т.СуммаЗатрата
|	КОНЕЦ КАК СуммаЗатрата,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.НДД - Расход.НДД
|		ИНАЧЕ Т.НДД
|	КОНЕЦ КАК НДД,
|
|	// Стоимости с НДС
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.МатериальныеСНДС - Расход.МатериальныеСНДС
|		ИНАЧЕ Т.МатериальныеСНДС
|	КОНЕЦ КАК МатериальныеСНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ТрудозатратыСНДС - Расход.ТрудозатратыСНДС
|		ИНАЧЕ Т.ТрудозатратыСНДС
|	КОНЕЦ КАК ТрудозатратыСНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПостоянныеСНДС - Расход.ПостатейныеПостоянныеСНДС
|		ИНАЧЕ Т.ПостатейныеПостоянныеСНДС
|	КОНЕЦ КАК ПостатейныеПостоянныеСНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПеременныеСНДС - Расход.ПостатейныеПеременныеСНДС
|		ИНАЧЕ Т.ПостатейныеПеременныеСНДС
|	КОНЕЦ КАК ПостатейныеПеременныеСНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ДопРасходыСНДС - Расход.ДопРасходыСНДС
|		ИНАЧЕ Т.ДопРасходыСНДС
|	КОНЕЦ КАК ДопРасходыСНДС,
|
|	// Стоимости без НДС
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.МатериальныеБезНДС - Расход.МатериальныеБезНДС
|		ИНАЧЕ Т.МатериальныеБезНДС
|	КОНЕЦ КАК МатериальныеБезНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПостоянныеБезНДС - Расход.ПостатейныеПостоянныеБезНДС
|		ИНАЧЕ Т.ПостатейныеПостоянныеБезНДС
|	КОНЕЦ КАК ПостатейныеПостоянныеБезНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПеременныеБезНДС - Расход.ПостатейныеПеременныеБезНДС
|		ИНАЧЕ Т.ПостатейныеПеременныеБезНДС
|	КОНЕЦ КАК ПостатейныеПеременныеБезНДС,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ДопРасходыБезНДС - Расход.ДопРасходыБезНДС
|		ИНАЧЕ Т.ДопРасходыБезНДС
|	КОНЕЦ КАК ДопРасходыБезНДС,
|
|	// Стоимости Упр
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.МатериальныеУпр - Расход.МатериальныеУпр
|		ИНАЧЕ Т.МатериальныеУпр
|	КОНЕЦ КАК МатериальныеУпр,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ТрудозатратыУпр - Расход.ТрудозатратыУпр
|		ИНАЧЕ Т.ТрудозатратыУпр
|	КОНЕЦ КАК ТрудозатратыУпр,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПостоянныеУпр - Расход.ПостатейныеПостоянныеУпр
|		ИНАЧЕ Т.ПостатейныеПостоянныеУпр
|	КОНЕЦ КАК ПостатейныеПостоянныеУпр,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПеременныеУпр - Расход.ПостатейныеПеременныеУпр
|		ИНАЧЕ Т.ПостатейныеПеременныеУпр
|	КОНЕЦ КАК ПостатейныеПеременныеУпр,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ДопРасходыУпр - Расход.ДопРасходыУпр
|		ИНАЧЕ Т.ДопРасходыУпр
|	КОНЕЦ КАК ДопРасходыУпр,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.СтоимостьЗабалансоваяУпр - Расход.СтоимостьЗабалансоваяУпр
|		ИНАЧЕ Т.СтоимостьЗабалансоваяУпр
|	КОНЕЦ КАК СтоимостьЗабалансоваяУпр,
|
|	// Стоимости Регл
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.МатериальныеРегл - Расход.МатериальныеРегл
|		ИНАЧЕ Т.МатериальныеРегл
|	КОНЕЦ КАК МатериальныеРегл,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ТрудозатратыРегл - Расход.ТрудозатратыРегл
|		ИНАЧЕ Т.ТрудозатратыРегл
|	КОНЕЦ КАК ТрудозатратыРегл,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПостоянныеРегл - Расход.ПостатейныеПостоянныеРегл
|		ИНАЧЕ Т.ПостатейныеПостоянныеРегл
|	КОНЕЦ КАК ПостатейныеПостоянныеРегл,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостатейныеПеременныеРегл - Расход.ПостатейныеПеременныеРегл
|		ИНАЧЕ Т.ПостатейныеПеременныеРегл
|	КОНЕЦ КАК ПостатейныеПеременныеРегл,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ДопРасходыРегл - Расход.ДопРасходыРегл
|		ИНАЧЕ Т.ДопРасходыРегл
|	КОНЕЦ КАК ДопРасходыРегл,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.СтоимостьЗабалансоваяРегл - Расход.СтоимостьЗабалансоваяРегл
|		ИНАЧЕ Т.СтоимостьЗабалансоваяРегл
|	КОНЕЦ КАК СтоимостьЗабалансоваяРегл,
|
|	// Налоговый учет
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.НалоговыйУчет - Расход.НалоговыйУчет
|		ИНАЧЕ Т.НалоговыйУчет
|	КОНЕЦ КАК НалоговыйУчет,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ПостояннаяРазница - Расход.ПостояннаяРазница
|		ИНАЧЕ Т.ПостояннаяРазница
|	КОНЕЦ КАК ПостояннаяРазница,
|	ВЫБОР
|		КОГДА Т.СписатьОстаток
|			ТОГДА Приход.ВременнаяРазница - Расход.ВременнаяРазница
|		ИНАЧЕ Т.ВременнаяРазница
|	КОНЕЦ КАК ВременнаяРазница
|
|ПОМЕСТИТЬ ПервичныеЗатратыПоПериодам
|ИЗ
|	ПредварительныйРасходПартий КАК Т
|		ЛЕВОЕ СОЕДИНЕНИЕ РасходПартийСводно КАК Расход
|		ПО Т.КорАналитикаУчетаНоменклатуры = Расход.КорАналитикаУчетаНоменклатуры
|			И Т.КорПартия = Расход.КорПартия
|			И Т.АналитикаУчетаНоменклатуры = Расход.АналитикаУчетаНоменклатуры
|			И Т.АналитикаУчетаПартий = Расход.АналитикаУчетаПартий
|			И Т.Партия = Расход.Партия
|			И Т.Период = Расход.Период
|			И Т.Организация = Расход.Организация
|			И Т.ПартияПродукции = Расход.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Расход.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ ПартииСводно КАК Приход
|		ПО Т.КорАналитикаУчетаНоменклатуры = Приход.КорАналитикаУчетаНоменклатуры
|			И Т.КорПартия = Приход.КорПартия
|			И Т.АналитикаУчетаНоменклатуры = Приход.АналитикаУчетаНоменклатуры
|			И Т.АналитикаУчетаПартий = Приход.АналитикаУчетаПартий
|			И Т.Партия = Приход.Партия
|			И Т.Период = Приход.Период
|			И Т.Организация = Приход.Организация
|			И Т.ПартияПродукции = Приход.ПартияПродукции
|			И Т.АналитикаУчетаПартийПродукции = Приход.АналитикаУчетаПартийПродукции
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия,
|	ПартияПродукции,
|	АналитикаУчетаПартийПродукции
|;";
КонецФункции

// Формирует SQL-запрос для временной таблицы ПервичныеПартииСводно
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ПервичныеПартииСводно()
	
	Возврат
"ВЫБРАТЬ РАЗЛИЧНЫЕ
|	Т.Организация КАК Организация,
|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
|	Т.Партия КАК Партия
|ПОМЕСТИТЬ ПервичныеПартииСводно
|ИЗ
|	ПервичныеЗатратыПоПериодам КАК Т
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия
|;";
КонецФункции

// Формирует SQL-запрос для временной таблицы ПартииПолуфабрикатов
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ПартииПолуфабрикатов()
	
	Возврат
"ВЫБРАТЬ РАЗЛИЧНЫЕ
|	ВЫБОР КОГДА &ДанныеПоСебестоимости < 3
|		ТОГДА НЕОПРЕДЕЛЕНО
|		ИНАЧЕ СебестоимостьТоваров.Организация
|	КОНЕЦ КАК Организация,
|	ПП.Партия КАК Партия,
|	ПП.АналитикаУчетаПартий,
|	ПП.АналитикаУчетаНоменклатуры
|ПОМЕСТИТЬ ПартииПолуфабрикатов
|ИЗ
|	ПервичныеПартииСводно КАК ПП
|
|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
|		ПО СебестоимостьТоваров.Регистратор = ПП.Партия
|		И СебестоимостьТоваров.АналитикаУчетаПартий = ПП.АналитикаУчетаПартий
|		И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
|		И СебестоимостьТоваров.Организация = ПП.Организация
|
|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартий КАК АналитикиУчетаПартий
|		ПО СебестоимостьТоваров.АналитикаУчетаПартий = АналитикиУчетаПартий.КлючАналитики
|
|ГДЕ
|	СебестоимостьТоваров.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
|	И СебестоимостьТоваров.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
|													ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
|													ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение),
|													ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемПередачаРаботМеждуФилиалами),
|													ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
|	И НЕ АналитикиУчетаПартий.КодСтроки = 0
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия
|;";
КонецФункции

// Формирует SQL-запрос для объединения материальных затрат
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ТекстМатериальныеЗатратыОбъединение()
	
	Возврат
"ВЫБРАТЬ
|	НЗППоПродукции.Организация							КАК Организация,
|	НЗППоПродукции.ПартияПродукции						КАК ПартияВыходноеИзделие,
|	НЗППоПродукции.АналитикаУчетаПартийПродукции		КАК АналитикаУчетаПартийВыходноеИзделие,
|	НЗППоПродукции.АналитикаУчетаПродукции				КАК АналитикаУчетаВыходноеИзделие,
|	ПартииМатериалов.Партия								КАК ПартияЗатрата,
|	ПартииМатериалов.АналитикаУчетаПартий				КАК АналитикаУчетаПартийЗатрата,
|	ПартииМатериалов.ВключитьНДСВСтоимость				КАК ВключитьНДСВСтоимость,
|	ПартииМатериалов.ИсключитьНДСИзСтоимости			КАК ИсключитьНДСИзСтоимости,
|	ПартииМатериалов.АналитикаУчетаНоменклатуры			КАК АналитикаУчетаЗатрата,
|	АналитикаЗатрат.Номенклатура						КАК Затрата,
|	АналитикаЗатрат.Номенклатура.ЕдиницаИзмерения 		КАК ЕдиницаИзмеренияЗатрата,
|	АналитикаЗатрат.Характеристика						КАК ХарактеристикаЗатрата,
|	АналитикаЗатрат.Серия								КАК СерияЗатрата,
|	АналитикаЗатрат.Назначение							КАК НазначениеЗатрата,
|	АналитикаЗатрат.СтатьяКалькуляции					КАК СтатьяКалькуляции,
|	АналитикаЗатрат.МестоХранения                       КАК Подразделение,
|	(ВЫБОР
|		КОГДА НЗППоПродукции.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
|			ТОГДА ЛОЖЬ
|	// Для возвратных отходов разузлования не требуется. 
|		КОГДА АналитикаЗатрат.СтатьяКалькуляции.ТипЗатрат = ЗНАЧЕНИЕ(Перечисление.ТипыЗатрат.ВозвратныеОтходы)
|			ТОГДА ЛОЖЬ
|	//++ НЕ УТКА
|
|	// Разузловывать затраты переработчика, если отчет формируется в валюте регл./упр. учета, по давальцу, не нужно
|		КОГДА &ДанныеПоСебестоимости > 3
|			И НЗППоПродукции.Организация = ЕСТЬNULL(ОтчетДавальцуМеждуОрганизациями.Давалец, НЕОПРЕДЕЛЕНО)
|				ТОГДА ЛОЖЬ
|	//-- НЕ УТКА
|		КОГДА ПартииПолуфабрикатов.Партия ЕСТЬ НЕ NULL
|			ТОГДА ИСТИНА
|		ИНАЧЕ ЛОЖЬ КОНЕЦ) 								КАК ТребуетсяРазузлование,
|	(ВЫБОР
|		КОГДА НЗППоПродукции.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
|			ТОГДА ЛОЖЬ
|	//++ НЕ УТКА
|
|	// Разузловывать затраты переработчика, если отчет формируется в валюте регл./упр. учета, по давальцу, не нужно
|		КОГДА &ДанныеПоСебестоимости > 3
|			И НЗППоПродукции.Организация = ЕСТЬNULL(ОтчетДавальцуМеждуОрганизациями.Давалец, НЕОПРЕДЕЛЕНО)
|				ТОГДА ЛОЖЬ
|	//-- НЕ УТКА
|		КОГДА &РазворачиватьДопРасходы
|			ТОГДА ИСТИНА
|		ИНАЧЕ ЛОЖЬ КОНЕЦ) 								КАК ТребуетсяРазузлованиеДопРасходов,
|	&ТипЗатратМатериальные								КАК ТипЗатрат,
|	ПартииМатериалов.Количество
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК КоличествоЗатрата,
|
|	// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	ПартииМатериалов.Материальные
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК Материальные,
|	ПартииМатериалов.Трудозатраты
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК Трудозатраты,
|	ПартииМатериалов.ПостатейныеПостоянные
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянные,
|	ПартииМатериалов.ПостатейныеПеременные
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременные,
|	ПартииМатериалов.ДопРасходы
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходы,
|	ПартииМатериалов.СуммаЗатратаЗабалансовая
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СуммаЗатратаЗабалансовая,
|	ПартииМатериалов.СуммаЗатрата
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СуммаЗатрата,
|	ПартииМатериалов.НДД
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК НДД,
|
|	// Стоимости с НДС
|	ПартииМатериалов.МатериальныеСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеСНДС,
|	ПартииМатериалов.ТрудозатратыСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ТрудозатратыСНДС,
|	ПартииМатериалов.ПостатейныеПостоянныеСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеСНДС,
|	ПартииМатериалов.ПостатейныеПеременныеСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеСНДС,
|	ПартииМатериалов.ДопРасходыСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыСНДС,
|
|	// Стоимости без НДС
|	ПартииМатериалов.МатериальныеБезНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеБезНДС,
|	ПартииМатериалов.ПостатейныеПостоянныеБезНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеБезНДС,
|	ПартииМатериалов.ПостатейныеПеременныеБезНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеБезНДС,
|	ПартииМатериалов.ДопРасходыБезНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыБезНДС,
|
|	// Стоимости Упр
|	ПартииМатериалов.МатериальныеУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеУпр,
|	ПартииМатериалов.ТрудозатратыУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10))	КАК ТрудозатратыУпр,
|	ПартииМатериалов.ПостатейныеПостоянныеУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеУпр,
|	ПартииМатериалов.ПостатейныеПеременныеУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель	/ НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеУпр,
|	ПартииМатериалов.ДопРасходыУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыУпр,
|	ПартииМатериалов.СтоимостьЗабалансоваяУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель  КАК ЧИСЛО(31,10)) КАК СтоимостьЗабалансоваяУпр,
|
|	// Стоимости Регл
|	ПартииМатериалов.МатериальныеРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеРегл,
|	ПартииМатериалов.ТрудозатратыРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ТрудозатратыРегл,
|	ПартииМатериалов.ПостатейныеПостоянныеРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеРегл,
|	ПартииМатериалов.ПостатейныеПеременныеРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеРегл,
|	ПартииМатериалов.ДопРасходыРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыРегл,
|	ПартииМатериалов.СтоимостьЗабалансоваяРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СтоимостьЗабалансоваяРегл,
|
|	// Налоговый учет
|	ПартииМатериалов.НалоговыйУчет
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК НалоговыйУчет,
|	ПартииМатериалов.ПостояннаяРазница
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостояннаяРазница,
|	ПартииМатериалов.ВременнаяРазница
|		* ВЫРАЗИТЬ(НЗППоПродукции.Количество / ВыбытиеСводно.Количество КАК ЧИСЛО(31,10))
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ВременнаяРазница
|
|ИЗ
|	ВыбытиеИзНЗППоПродукции КАК НЗППоПродукции
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПервичныеЗатратыПоПериодам КАК ПартииМатериалов
|		ПО НЗППоПродукции.Период = ПартииМатериалов.Период
|			И НЗППоПродукции.АналитикаУчетаНоменклатуры = ПартииМатериалов.КорАналитикаУчетаНоменклатуры
|			И НЗППоПродукции.Партия = ПартииМатериалов.КорПартия
|			И НЗППоПродукции.ПартияПродукции = ПартииМатериалов.ПартияПродукции
|			И НЗППоПродукции.АналитикаУчетаПартийПродукции = ПартииМатериалов.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаЗатрат
|		ПО НЗППоПродукции.АналитикаУчетаНоменклатуры = АналитикаЗатрат.КлючАналитики
|		ЛЕВОЕ СОЕДИНЕНИЕ ВыбытиеИзНЗП КАК ВыбытиеСводно
|		ПО НЗППоПродукции.Период = ВыбытиеСводно.Период
|			И НЗППоПродукции.АналитикаУчетаНоменклатуры = ВыбытиеСводно.АналитикаУчетаНоменклатуры
|			И НЗППоПродукции.Партия = ВыбытиеСводно.Партия
|			И НЗППоПродукции.ПартияПродукции = ВыбытиеСводно.ПартияПродукции
|			И НЗППоПродукции.АналитикаУчетаПартийПродукции = ВыбытиеСводно.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ ПартииПолуфабрикатов КАК ПартииПолуфабрикатов
|	//#КонецВставки
|		ПО ПартииМатериалов.Партия = ПартииПолуфабрикатов.Партия
|			И ПартииМатериалов.АналитикаУчетаПартий = ПартииПолуфабрикатов.АналитикаУчетаПартий
|			И ПартииМатериалов.АналитикаУчетаНоменклатуры = ПартииПолуфабрикатов.АналитикаУчетаНоменклатуры
|			И (НЕ НЗППоПродукции.ПартияПродукции = ПартииПолуфабрикатов.Партия
|				ИЛИ НЕ НЗППоПродукции.АналитикаУчетаПартийПродукции = ПартииПолуфабрикатов.АналитикаУчетаПартий
|				ИЛИ НЕ НЗППоПродукции.АналитикаУчетаПродукции = ПартииПолуфабрикатов.АналитикаУчетаНоменклатуры)
|			И (ПартииПолуфабрикатов.Организация = НЗППоПродукции.Организация
|				ИЛИ &ДанныеПоСебестоимости < 3)
|	//++ НЕ УТКА
|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетДавальцуМеждуОрганизациями КАК ОтчетДавальцуМеждуОрганизациями
|		ПО (ОтчетДавальцуМеждуОрганизациями.Ссылка = ПартииМатериалов.Партия)
|	//-- НЕ УТКА
|";
КонецФункции

// Формирует SQL-запрос для объединения начальных остатков НЗП
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ТекстМатериалыНачальныеОстаткиНЗПОбъединение()
	
	Возврат
"ВЫБРАТЬ
|	НЗППоПродукции.Организация							КАК Организация,
|	НЗППоПродукции.ПартияПродукции						КАК ПартияВыходноеИзделие,
|	НЗППоПродукции.АналитикаУчетаПартийПродукции		КАК АналитикаУчетаПартийВыходноеИзделие,
|	НЗППоПродукции.АналитикаУчетаПродукции				КАК АналитикаУчетаВыходноеИзделие,
|	НЗППоПродукции.Партия								КАК ПартияЗатрата,
|	НЕОПРЕДЕЛЕНО										КАК АналитикаУчетаПартийЗатрата,
|	ЛОЖЬ												КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ												КАК ИсключитьНДСИзСтоимости,
|	НЗППоПродукции.АналитикаУчетаНоменклатуры			КАК АналитикаУчетаЗатрата,
|	АналитикаЗатрат.Номенклатура						КАК Затрата,
|	АналитикаЗатрат.Номенклатура.ЕдиницаИзмерения 		КАК ЕдиницаИзмеренияЗатрата,
|	АналитикаЗатрат.Характеристика						КАК ХарактеристикаЗатрата,
|	АналитикаЗатрат.Серия								КАК СерияЗатрата,
|	АналитикаЗатрат.Назначение							КАК НазначениеЗатрата,
|	АналитикаЗатрат.СтатьяКалькуляции					КАК СтатьяКалькуляции,
|	АналитикаЗатрат.МестоХранения                       КАК Подразделение,
|	ЛОЖЬ												КАК ТребуетсяРазузлование,
|	ЛОЖЬ												КАК ТребуетсяРазузлованиеДопРасходов,
|	&ТипЗатратМатериальные								КАК ТипЗатрат,
|	НЗППоПродукции.Количество
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК КоличествоЗатрата,
|
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	НЗППоПродукции.Материальные
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК Материальные,
|	НЗППоПродукции.Трудозатраты
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК Трудозатраты,
|	НЗППоПродукции.ПостатейныеПостоянные
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянные,
|	НЗППоПродукции.ПостатейныеПеременные
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременные,
|	НЗППоПродукции.ДопРасходы
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходы,
|	НЗППоПродукции.СуммаЗатратаЗабалансовая
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СуммаЗатратаЗабалансовая,
|	НЗППоПродукции.СуммаЗатрата
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СуммаЗатрата,
|	НЗППоПродукции.НДД
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК НДД,
|
|// Стоимости с НДС
|	НЗППоПродукции.МатериальныеСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеСНДС,
|	НЗППоПродукции.ТрудозатратыСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ТрудозатратыСНДС,
|	НЗППоПродукции.ПостатейныеПостоянныеСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеСНДС,
|	НЗППоПродукции.ПостатейныеПеременныеСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеСНДС,
|	НЗППоПродукции.ДопРасходыСНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыСНДС,
|
|// Стоимости без НДС
|	НЗППоПродукции.МатериальныеБезНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеБезНДС,
|	НЗППоПродукции.ПостатейныеПостоянныеБезНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеБезНДС,
|	НЗППоПродукции.ПостатейныеПеременныеБезНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеБезНДС,
|	НЗППоПродукции.ДопРасходыБезНДС
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыБезНДС,
|
|// Стоимости Упр
|	НЗППоПродукции.МатериальныеУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеУпр,
|	НЗППоПродукции.ТрудозатратыУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ТрудозатратыУпр,
|	НЗППоПродукции.ПостатейныеПостоянныеУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель	/ НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеУпр,
|	НЗППоПродукции.ПостатейныеПеременныеУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеУпр,
|	НЗППоПродукции.ДопРасходыУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель	/ НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыУпр,
|	НЗППоПродукции.СтоимостьЗабалансоваяУпр
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СтоимостьЗабалансоваяУпр,
|
|// Стоимости Регл
|	НЗППоПродукции.МатериальныеРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК МатериальныеРегл,
|	НЗППоПродукции.ТрудозатратыРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ТрудозатратыРегл,
|	НЗППоПродукции.ПостатейныеПостоянныеРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПостоянныеРегл,
|	НЗППоПродукции.ПостатейныеПеременныеРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостатейныеПеременныеРегл,
|	НЗППоПродукции.ДопРасходыРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ДопРасходыРегл,
|	НЗППоПродукции.СтоимостьЗабалансоваяРегл
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК СтоимостьЗабалансоваяРегл,
|
|// Налоговый учет
|	НЗППоПродукции.НалоговыйУчет
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК НалоговыйУчет,
|	НЗППоПродукции.ПостояннаяРазница
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ПостояннаяРазница,
|	НЗППоПродукции.ВременнаяРазница
|		* ВЫРАЗИТЬ(НЗППоПродукции.Числитель / НЗППоПродукции.Знаменатель КАК ЧИСЛО(31,10)) КАК ВременнаяРазница
|
|ИЗ
|	ВыбытиеИзНЗППоПродукции КАК НЗППоПродукции
|// ПАКЕТНАЯ ОПТИМИЗАЦИЯ: добавляем фильтр по ПартияПродукции для предотвращения декартова произведения
|		ЛЕВОЕ СОЕДИНЕНИЕ ПервичныеЗатратыПоПериодам КАК ПартииМатериалов
|	    ПО НЗППоПродукции.Период = ПартииМатериалов.Период
|			И НЗППоПродукции.АналитикаУчетаНоменклатуры = ПартииМатериалов.КорАналитикаУчетаНоменклатуры
|			И НЗППоПродукции.Партия = ПартииМатериалов.КорПартия
|			И НЗППоПродукции.ПартияПродукции = ПартииМатериалов.ПартияПродукции
|			И НЗППоПродукции.АналитикаУчетаПартийПродукции = ПартииМатериалов.АналитикаУчетаПартийПродукции
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаЗатрат
|		ПО НЗППоПродукции.АналитикаУчетаНоменклатуры = АналитикаЗатрат.КлючАналитики
|ГДЕ
|	ПартииМатериалов.Партия ЕСТЬ NULL
|";
КонецФункции

// Формирует SQL-запрос для объединения трудозатрат
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ТекстТрудозатратыОбъединение()
	
	Возврат
"ВЫБРАТЬ
|	ТрудозатратыНЗП.Организация						КАК Организация,
|	ТрудозатратыНЗП.Регистратор						КАК ПартияВыходноеИзделие,
|	ТрудозатратыНЗП.КорАналитикаУчетаПартий			КАК АналитикаУчетаПартийВыходноеИзделие,
|	ТрудозатратыНЗП.КорАналитикаУчетаПродукции		КАК АналитикаУчетаВыходноеИзделие,
|	НЕОПРЕДЕЛЕНО									КАК ПартияЗатрата,
|	НЕОПРЕДЕЛЕНО									КАК АналитикаУчетаПартийЗатрата,
|	ЛОЖЬ											КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ											КАК ИсключитьНДСИзСтоимости,
|	ТрудозатратыНЗП.ВидРабот						КАК АналитикаЗатрата,
|	ТрудозатратыНЗП.ВидРабот						КАК Затрата,
|	СпрВидыРабот.ЕдиницаИзмерения					КАК ЕдиницаИзмеренияЗатрата,
|	НЕОПРЕДЕЛЕНО									КАК ХарактеристикаЗатрата,
|	НЕОПРЕДЕЛЕНО									КАК СерияЗатрата,
|	НЕОПРЕДЕЛЕНО									КАК НазначениеЗатрата,
|	ТрудозатратыНЗП.СтатьяКалькуляции				КАК СтатьяКалькуляции,
|	ТрудозатратыНЗП.Подразделение					КАК Подразделение,
|	ЛОЖЬ											КАК ТребуетсяРазузлование,
|	ЛОЖЬ											КАК ТребуетсяРазузлованиеДопРасходов,
|	&ТипЗатратТрудозатраты							КАК ТипЗатрат,
|	СУММА(ТрудозатратыНЗП.Количество
|		* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК КоличествоЗатрата,
|
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	0												КАК Материальные,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ТрудозатратыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ТрудозатратыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ТрудозатратыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ТрудозатратыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК Трудозатраты,
|	0												КАК ПостатейныеПостоянные,
|	0												КАК ПостатейныеПеременные,
|	0												КАК ДопРасходы,
|	0												КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ТрудозатратыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ТрудозатратыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ТрудозатратыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ТрудозатратыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА ТрудозатратыНЗП.СтоимостьНДД
|			ИНАЧЕ 0
|		КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК НДД,
|
|// Стоимости с НДС
|	0												КАК МатериальныеСНДС,
|	СУММА(ТрудозатратыНЗП.Стоимость
|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ТрудозатратыСНДС,
|	0												КАК ПостатейныеПостоянныеСНДС,
|	0												КАК ПостатейныеПеременныеСНДС,
|	0												КАК ДопРасходыСНДС,
|
|// Стоимости без НДС
|	0												КАК МатериальныеБезНДС,
|	0												КАК ПостатейныеПостоянныеБезНДС,
|	0												КАК ПостатейныеПеременныеБезНДС,
|	0												КАК ДопРасходыБезНДС,
|
|// Стоимости Упр
|	0												КАК МатериальныеУпр,
|	СУММА(ТрудозатратыНЗП.Стоимость
|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ТрудозатратыУпр,
|	0												КАК ПостатейныеПостоянныеУпр,
|	0												КАК ПостатейныеПеременныеУпр,
|	0												КАК ДопРасходыУпр,
|	0												КАК СтоимостьЗабалансоваяУпр,
|
|// Стоимости Регл
|	0												КАК МатериальныеРегл,
|	СУММА(ТрудозатратыНЗП.СтоимостьРегл
|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ТрудозатратыРегл,
|	0												КАК ПостатейныеПостоянныеРегл,
|	0												КАК ПостатейныеПеременныеРегл,
|	0												КАК ДопРасходыРегл,
|	0												КАК СтоимостьЗабалансоваяРегл,
|
|// Налоговый учет
|	СУММА((ТрудозатратыНЗП.СтоимостьРегл
|		- ТрудозатратыНЗП.ПостояннаяРазница
|		- ТрудозатратыНЗП.ВременнаяРазница)
|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК НалоговыйУчет,
|	СУММА(ТрудозатратыНЗП.ПостояннаяРазница
|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ПостояннаяРазница,
|	СУММА(ТрудозатратыНЗП.ВременнаяРазница
|	* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ВременнаяРазница
|
|ИЗ
|	ВыпущеннаяПродукция КАК ВыпущеннаяПродукция
|
|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ТрудозатратыНЗП
|		ПО ТрудозатратыНЗП.Организация = ВыпущеннаяПродукция.Организация
|		И ВыпущеннаяПродукция.ПартияПродукции = ТрудозатратыНЗП.Регистратор
|		И ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции = ТрудозатратыНЗП.КорАналитикаУчетаПартий
|		И ВыпущеннаяПродукция.АналитикаУчетаПродукции = ТрудозатратыНЗП.КорАналитикаУчетаПродукции
|
|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыРаботСотрудников КАК СпрВидыРабот
|		ПО СпрВидыРабот.Ссылка = ТрудозатратыНЗП.ВидРабот
|
|СГРУППИРОВАТЬ ПО
|	ТрудозатратыНЗП.Организация,
|	ТрудозатратыНЗП.ВидРабот,
|	ТрудозатратыНЗП.СтатьяКалькуляции,
|	СпрВидыРабот.ЕдиницаИзмерения,
|	ТрудозатратыНЗП.КорАналитикаУчетаПродукции,
|	ТрудозатратыНЗП.Регистратор,
|	ТрудозатратыНЗП.КорАналитикаУчетаПартий,
|	ТрудозатратыНЗП.Подразделение
|";
КонецФункции

// Формирует SQL-запрос для объединения прочих расходов
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ТекстПрочиеРасходыОбъединение()
	
	Возврат
"ВЫБРАТЬ
|	ПрочиеРасходыНЗП.Организация				КАК Организация,
|	ПрочиеРасходыНЗП.Регистратор				КАК ПартияВыходноеИзделие,
|	ПрочиеРасходыНЗП.КорАналитикаУчетаПартий	КАК АналитикаУчетаПартийВыходноеИзделие,
|	ПрочиеРасходыНЗП.АналитикаУчетаПродукции	КАК АналитикаУчетаВыходноеИзделие,
|	НЕОПРЕДЕЛЕНО								КАК ПартияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК АналитикаУчетаПартийЗатрата,
|	ЛОЖЬ										КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ										КАК ИсключитьНДСИзСтоимости,
|	ПрочиеРасходыНЗП.СтатьяРасходов				КАК АналитикаЗатрата,
|	ПрочиеРасходыНЗП.СтатьяРасходов				КАК Затрата,
|	НЕОПРЕДЕЛЕНО								КАК ЕдиницаИзмеренияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК ХарактеристикаЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК СерияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК НазначениеЗатрата,
|	ПрочиеРасходыНЗП.СтатьяКалькуляции			КАК СтатьяКалькуляции,
|	ПрочиеРасходыНЗП.Подразделение				КАК Подразделение,
|	ЛОЖЬ										КАК ТребуетсяРазузлование,
|	ЛОЖЬ										КАК ТребуетсяРазузлованиеДопРасходов,
|	&ТипЗатратПостатейные						КАК ТипЗатрат,
|	0											КАК КоличествоЗатрата,
|
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	0											КАК Материальные,
|	0											КАК Трудозатраты,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
|			ТОГДА 0
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ПрочиеРасходыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьУпр
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
|			ТОГДА 0
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ПрочиеРасходыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьУпр
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПеременные,
|	0											КАК ДопРасходы,
|	0											КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ПрочиеРасходыНЗП.Стоимость
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьУпр
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ПрочиеРасходыНЗП.СтоимостьНДД
|		ИНАЧЕ 0
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК НДД,
|
|// Стоимости с НДС
|	0											КАК МатериальныеСНДС,
|	0											КАК ТрудозатратыСНДС,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.Стоимость
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ПостатейныеПостоянныеСНДС,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.Стоимость
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПеременныеСНДС,
|	0											КАК ДопРасходыСНДС,
|
|// Стоимости без НДС
|	0											КАК МатериальныеБезНДС,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьБезНДС
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьБезНДС
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПеременныеБезНДС,
|	0											КАК ДопРасходыБезНДС,
|
|// Стоимости Упр
|	0											КАК МатериальныеУпр,
|	0											КАК ТрудозатратыУпр,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьУпр
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПостоянныеУпр,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьУпр
|	КОНЕЦ * ВыпущеннаяПродукция.Числитель
|			/ ВыпущеннаяПродукция.Знаменатель)	КАК ПостатейныеПеременныеУпр,
|	0											КАК ДопРасходыУпр,
|	0											КАК СтоимостьЗабалансоваяУпр,
|
|// Стоимости Регл
|	0											КАК МатериальныеРегл,
|	0											КАК ТрудозатратыРегл,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПостоянныеРегл,
|	СУММА(ВЫБОР
|		КОГДА СтатьиРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
|			ТОГДА 0
|		ИНАЧЕ ПрочиеРасходыНЗП.СтоимостьРегл
|	КОНЕЦ * ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10)))	КАК ПостатейныеПеременныеРегл,
|	0											КАК ДопРасходыРегл,
|	0											КАК СтоимостьЗабалансоваяРегл,
|
|// Налоговый учет
|	СУММА((ПрочиеРасходыНЗП.СтоимостьРегл
|		- ПрочиеРасходыНЗП.ПостояннаяРазница
|		- ПрочиеРасходыНЗП.ВременнаяРазница)
|		* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК НалоговыйУчет,
|	СУММА(ПрочиеРасходыНЗП.ПостояннаяРазница
|		* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ПостояннаяРазница,
|	СУММА(ПрочиеРасходыНЗП.ВременнаяРазница
|		* ВЫРАЗИТЬ(ВыпущеннаяПродукция.Числитель / ВыпущеннаяПродукция.Знаменатель КАК ЧИСЛО(31,10))) КАК ВременнаяРазница
|
|ИЗ
|	ВыпущеннаяПродукция КАК ВыпущеннаяПродукция
|
|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ПрочиеРасходыНЗП
|		ПО ВыпущеннаяПродукция.Организация = ПрочиеРасходыНЗП.Организация
|		И ВыпущеннаяПродукция.ПартияПродукции = ПрочиеРасходыНЗП.Регистратор
|		И ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции = ПрочиеРасходыНЗП.КорАналитикаУчетаПартий
|		И ВыпущеннаяПродукция.АналитикаУчетаПродукции = ПрочиеРасходыНЗП.АналитикаУчетаПродукции
|
|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
|		ПО ПрочиеРасходыНЗП.СтатьяРасходов = СтатьиРасходов.Ссылка
|
|СГРУППИРОВАТЬ ПО
|	ПрочиеРасходыНЗП.Организация,
|	ПрочиеРасходыНЗП.СтатьяРасходов,
|	ПрочиеРасходыНЗП.СтатьяКалькуляции,
|	ПрочиеРасходыНЗП.АналитикаУчетаПродукции,
|	ПрочиеРасходыНЗП.Регистратор,
|	ПрочиеРасходыНЗП.КорАналитикаУчетаПартий,
|	ПрочиеРасходыНЗП.Подразделение
|";
КонецФункции

// Формирует SQL-запрос для создания временной таблицы ВыбытиеИзНЗППоПродукции
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ВыбытиеИзНЗППоПродукции()
	
	Возврат
"ВЫБРАТЬ РАЗРЕШЕННЫЕ
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ) КАК Период,
|	ВыпущеннаяПродукция.Организация КАК Организация,
|	ВыпущеннаяПродукция.ПартияПродукции КАК ПартияПродукции,
|	ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции КАК АналитикаУчетаПартийПродукции,
|	ВыпущеннаяПродукция.АналитикаУчетаПродукции КАК АналитикаУчетаПродукции,
|	МАКСИМУМ(ВыпущеннаяПродукция.Числитель) КАК Числитель,
|	МАКСИМУМ(ВыпущеннаяПродукция.Знаменатель) КАК Знаменатель,
|	СебестоимостьТоваров.Партия КАК Партия,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
|	СебестоимостьТоваров.ВидЗапасов КАК ВидЗапасов,
|	СУММА(СебестоимостьТоваров.Количество) КАК Количество,
|	// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|		КОНЕЦ)												КАК Материальные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.Трудозатраты
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ТрудозатратыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ТрудозатратыРегл
|		КОНЕЦ)												КАК Трудозатраты,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		КОНЕЦ)												КАК ПостатейныеПостоянные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		КОНЕЦ)												КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК ДопРасходы,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансовая
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьЗабалансоваяРегл
|		КОНЕЦ)												КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА СебестоимостьТоваров.Стоимость
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеСНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеСНДС
|				+ СебестоимостьТоваров.ДопРасходы
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА СебестоимостьТоваров.СтоимостьБезНДС
|				+ СебестоимостьТоваров.Трудозатраты
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС
|				+ СебестоимостьТоваров.ПостатейныеПеременныеБезНДС
|				+ СебестоимостьТоваров.ДопРасходыБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА СебестоимостьТоваров.СтоимостьУпр
|				+ СебестоимостьТоваров.ТрудозатратыУпр
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеУпр
|				+ СебестоимостьТоваров.ПостатейныеПеременныеУпр
|				+ СебестоимостьТоваров.ДопРасходыУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьРегл
|				+ СебестоимостьТоваров.ТрудозатратыРегл
|				+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|				+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|				+ СебестоимостьТоваров.ДопРасходыРегл
|		КОНЕЦ)												КАК СуммаЗатрата,
|	СУММА(ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА СебестоимостьТоваров.СтоимостьНДД
|			ИНАЧЕ 0
|		КОНЕЦ)												КАК НДД,
|
|	// Стоимости с НДС
|	СУММА(СебестоимостьТоваров.Стоимость)					КАК МатериальныеСНДС,
|	СУММА(СебестоимостьТоваров.Трудозатраты)				КАК ТрудозатратыСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходы)					КАК ДопРасходыСНДС,
|
|	// Стоимости без НДС
|	СУММА(СебестоимостьТоваров.СтоимостьБезНДС)				КАК МатериальныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
|	СУММА(СебестоимостьТоваров.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,
|
|	// Стоимости Упр
|	СУММА(СебестоимостьТоваров.СтоимостьУпр)				КАК МатериальныеУпр,
|	СУММА(СебестоимостьТоваров.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
|	СУММА(СебестоимостьТоваров.ДопРасходыУпр)				КАК ДопРасходыУпр,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансоваяУпр,
|
|	// Стоимости Регл
|	СУММА(СебестоимостьТоваров.СтоимостьРегл)				КАК МатериальныеРегл,
|	СУММА(СебестоимостьТоваров.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
|	СУММА(СебестоимостьТоваров.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
|	СУММА(СебестоимостьТоваров.ДопРасходыРегл)				КАК ДопРасходыРегл,
|	СУММА(СебестоимостьТоваров.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,
|
|	// Налоговый учет
|	СУММА(СебестоимостьТоваров.СтоимостьРегл
|		+ СебестоимостьТоваров.ТрудозатратыРегл
|		+ СебестоимостьТоваров.ПостатейныеПостоянныеРегл
|		+ СебестоимостьТоваров.ПостатейныеПеременныеРегл
|		+ СебестоимостьТоваров.ДопРасходыРегл
|		- СебестоимостьТоваров.ПостояннаяРазница
|		- СебестоимостьТоваров.ВременнаяРазница)			КАК НалоговыйУчет,
|	СУММА(СебестоимостьТоваров.ПостояннаяРазница)			КАК ПостояннаяРазница,
|	СУММА(СебестоимостьТоваров.ВременнаяРазница)			КАК ВременнаяРазница
|ПОМЕСТИТЬ ВыбытиеИзНЗППоПродукции
|ИЗ
|	ВыпущеннаяПродукция КАК ВыпущеннаяПродукция
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
|		ПО СебестоимостьТоваров.Организация = ВыпущеннаяПродукция.Организация
|			И ВыпущеннаяПродукция.ПартияПродукции = СебестоимостьТоваров.Регистратор
|			И ВыпущеннаяПродукция.АналитикаУчетаПродукции = СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры
|			И ВыпущеннаяПродукция.ПартияПродукции = СебестоимостьТоваров.КорПартия
|			И ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции = СебестоимостьТоваров.КорАналитикаУчетаПартий
|			И (СебестоимостьТоваров.Период <= &ДатаОкончания ИЛИ &ДатаОкончания = ДАТАВРЕМЯ(1,1,1))
|ГДЕ
|	СебестоимостьТоваров.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
|	И ТИПЗНАЧЕНИЯ(СебестоимостьТоваров.Партия) = ТИП(Справочник.ПартииПроизводства)
|	И НЕ СебестоимостьТоваров.Партия = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
|
|СГРУППИРОВАТЬ ПО
|	НАЧАЛОПЕРИОДА(СебестоимостьТоваров.Период, МЕСЯЦ),
|	ВыпущеннаяПродукция.Организация,
|	ВыпущеннаяПродукция.ПартияПродукции,
|	ВыпущеннаяПродукция.АналитикаУчетаПартийПродукции,
|	ВыпущеннаяПродукция.АналитикаУчетаПродукции,
|	СебестоимостьТоваров.Партия,
|	СебестоимостьТоваров.ВидЗапасов,
|	СебестоимостьТоваров.АналитикаУчетаНоменклатуры
|
|ИНДЕКСИРОВАТЬ ПО
|	Партия
|;";
КонецФункции

// Формирует SQL-запрос для объединения дополнительных расходов
// Возвращает: Текст SQL-запроса
Функция ikon_cost_ТекстЗапроса_ТекстДопРасходыОбъединение()
	
	Возврат
"ВЫБРАТЬ
|	ДетализацияСебестоимости.Организация		КАК Организация,
|	ДетализацияСебестоимости.Партия				КАК ПартияВыходноеИзделие,
|	ДетализацияСебестоимости.АналитикаУчетаПартий	КАК АналитикаУчетаПартийВыходноеИзделие,
|	&АналитикаУчетаВыходноеИзделие				КАК АналитикаУчетаВыходноеИзделие,
|	ДетализацияСебестоимости.ДокументПоступления КАК ПартияЗатрата,
|	ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийЗатрата,
|	ЛОЖЬ										КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ										КАК ИсключитьНДСИзСтоимости,
|	ДетализацияСебестоимости.АналитикаРасходов	КАК АналитикаЗатрата,
|	ВЫБОР
|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
|			ТОГДА ЕСТЬNULL(ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления.ВидЦенности, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка))
|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов
|	КОНЕЦ КАК Затрата,
|	НЕОПРЕДЕЛЕНО								КАК ЕдиницаИзмеренияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК ХарактеристикаЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК СерияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК НазначениеЗатрата,
|	&СтатьяКалькуляции							КАК СтатьяКалькуляции,
|	НЕОПРЕДЕЛЕНО								КАК Подразделение,
|	ЛОЖЬ										КАК ТребуетсяРазузлование,
|	ЛОЖЬ										КАК ТребуетсяРазузлованиеДопРасходов,
|	&ТипЗатратДопРасходы						КАК ТипЗатрат,
|	0											КАК КоличествоЗатрата,
|
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	0											КАК Материальные,
|	0											КАК Трудозатраты,
|	0											КАК ПостатейныеПостоянные,
|	0											КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ)
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ)
|	КОНЕЦ * &КоличествоПродукции)				КАК ДопРасходы,
|	0											КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ)
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ)
|	КОНЕЦ * &КоличествоПродукции)				КАК СуммаЗатрата,
|	0											КАК НДД,
|
|// Стоимости с НДС
|	0											КАК МатериальныеСНДС,
|	0											КАК ТрудозатратыСНДС,
|	0											КАК ПостатейныеПостоянныеСНДС,
|	0											КАК ПостатейныеПеременныеСНДС,
|	СУММА(ДетализацияСебестоимости.СтоимостьСНДС
|			* &КоличествоПродукции)				КАК ДопРасходыСНДС,
|
|// Стоимости без НДС
|	0											КАК МатериальныеБезНДС,
|	0											КАК ПостатейныеПостоянныеБезНДС,
|	0											КАК ПостатейныеПеременныеБезНДС,
|	СУММА(ДетализацияСебестоимости.СтоимостьБезНДС
|			* &КоличествоПродукции)				КАК ДопРасходыБезНДС,
|
|// Стоимости Упр
|	0											КАК МатериальныеУпр,
|	0											КАК ТрудозатратыУпр,
|	0											КАК ПостатейныеПостоянныеУпр,
|	0											КАК ПостатейныеПеременныеУпр,
|	СУММА((ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ))
|			* &КоличествоПродукции)				КАК ДопРасходыУпр,
|	0											КАК СтоимостьЗабалансоваяУпр,
|
|// Стоимости Регл
|	0											КАК МатериальныеРегл,
|	0											КАК ТрудозатратыРегл,
|	0											КАК ПостатейныеПостоянныеРегл,
|	0											КАК ПостатейныеПеременныеРегл,
|	СУММА((ДетализацияСебестоимости.СтоимостьБезНДСРегл 
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ))
|			* &КоличествоПродукции)				КАК ДопРасходыРегл,
|	0											КАК СтоимостьЗабалансоваяРегл,
|
|// Налоговый учет
|	0 КАК НалоговыйУчет,
|	0 КАК ПостояннаяРазница,
|	0 КАК ВременнаяРазница
|
|ИЗ
|	РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК ДетализацияСебестоимости
|		
|ГДЕ 
|	ДетализацияСебестоимости.Партия В (&ПартииПродукции)
|	И ДетализацияСебестоимости.АналитикаУчетаПартий В (&АналитикиУчетаПартийПродукции)
|	И ДетализацияСебестоимости.Номенклатура В (&Продукция)
|	И ДетализацияСебестоимости.Характеристика В (&ХарактеристикиПродукции)
|	И НЕ ДетализацияСебестоимости.ЗатратыПредыдущихПеределов
|	И НЕ ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
|		КОНЕЦ = 0
|	И ВЫБОР
|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
|			ТОГДА ИСТИНА	
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ДетализацияСебестоимости.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
|	КОНЕЦ 
|
|СГРУППИРОВАТЬ ПО
|	ДетализацияСебестоимости.Организация,
|	ДетализацияСебестоимости.Партия,
|	ДетализацияСебестоимости.АналитикаУчетаПартий,
|	ДетализацияСебестоимости.ДокументПоступления,
|	ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления,
|	ДетализацияСебестоимости.АналитикаРасходов,
|	ВЫБОР
|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
|			ТОГДА ЕСТЬNULL(ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления.ВидЦенности, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка))
|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов
|	КОНЕЦ
|
|ОБЪЕДИНИТЬ ВСЕ
|
|ВЫБРАТЬ
|	ДетализацияСебестоимости.Организация		КАК Организация,
|	ДетализацияСебестоимости.Партия				КАК ПартияВыходноеИзделие,
|	ДетализацияСебестоимости.АналитикаУчетаПартий	КАК АналитикаУчетаПартийВыходноеИзделие,
|	&АналитикаУчетаВыходноеИзделие				КАК АналитикаУчетаВыходноеИзделие,
|	ДетализацияСебестоимости.ДокументПоступления КАК ПартияЗатрата,
|	ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийЗатрата,
|	ЛОЖЬ										КАК ВключитьНДСВСтоимость,
|	ЛОЖЬ										КАК ИсключитьНДСИзСтоимости,
|	ДетализацияСебестоимости.АналитикаРасходов	КАК АналитикаЗатрата,
|	ВЫБОР
|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
|			ТОГДА ЕСТЬNULL(ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления.ВидЦенности, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка))
|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов
|	КОНЕЦ КАК Затрата,
|	НЕОПРЕДЕЛЕНО								КАК ЕдиницаИзмеренияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК ХарактеристикаЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК СерияЗатрата,
|	НЕОПРЕДЕЛЕНО								КАК НазначениеЗатрата,
|	&СтатьяКалькуляции							КАК СтатьяКалькуляции,
|	НЕОПРЕДЕЛЕНО								КАК Подразделение,
|	ЛОЖЬ										КАК ТребуетсяРазузлование,
|	ЛОЖЬ										КАК ТребуетсяРазузлованиеДопРасходов,
|	&ТипЗатратДопРасходы						КАК ТипЗатрат,
|	0											КАК КоличествоЗатрата,
|
|// Стоимости согласно параметру ""ДанныеПоСебестоимости""
|	0											КАК Материальные,
|	0											КАК Трудозатраты,
|	0											КАК ПостатейныеПостоянные,
|	0											КАК ПостатейныеПеременные,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ)
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ)
|	КОНЕЦ * &КоличествоПродукции)				КАК ДопРасходы,
|	0											КАК СуммаЗатратаЗабалансовая,
|	СУММА(ВЫБОР
|		КОГДА &ДанныеПоСебестоимости = 1
|			ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
|		КОГДА &ДанныеПоСебестоимости = 2
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
|		КОГДА &ДанныеПоСебестоимости = 3
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ)
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ)
|	КОНЕЦ * &КоличествоПродукции)				КАК СуммаЗатрата,
|	0											КАК НДД,
|
|// Стоимости с НДС
|	0											КАК МатериальныеСНДС,
|	0											КАК ТрудозатратыСНДС,
|	0											КАК ПостатейныеПостоянныеСНДС,
|	0											КАК ПостатейныеПеременныеСНДС,
|	СУММА(ДетализацияСебестоимости.СтоимостьСНДС
|			* &КоличествоПродукции)				КАК ДопРасходыСНДС,
|
|// Стоимости без НДС
|	0											КАК МатериальныеБезНДС,
|	0											КАК ПостатейныеПостоянныеБезНДС,
|	0											КАК ПостатейныеПеременныеБезНДС,
|	СУММА(ДетализацияСебестоимости.СтоимостьБезНДС
|			* &КоличествоПродукции)				КАК ДопРасходыБезНДС,
|
|// Стоимости Упр
|	0											КАК МатериальныеУпр,
|	0											КАК ТрудозатратыУпр,
|	0											КАК ПостатейныеПостоянныеУпр,
|	0											КАК ПостатейныеПеременныеУпр,
|	СУММА((ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСУпр ИНАЧЕ 0 КОНЕЦ))
|			* &КоличествоПродукции)				КАК ДопРасходыУпр,
|	0											КАК СтоимостьЗабалансоваяУпр,
|
|// Стоимости Регл
|	0											КАК МатериальныеРегл,
|	0											КАК ТрудозатратыРегл,
|	0											КАК ПостатейныеПостоянныеРегл,
|	0											КАК ПостатейныеПеременныеРегл,
|	СУММА((ДетализацияСебестоимости.СтоимостьБезНДСРегл
|			+ (ВЫБОР КОГДА &ВключитьНДСВСтоимость ТОГДА ДетализацияСебестоимости.НДСРегл ИНАЧЕ 0 КОНЕЦ))
|			* &КоличествоПродукции)				КАК ДопРасходыРегл,
|	0											КАК СтоимостьЗабалансоваяРегл,
|
|// Налоговый учет
|	0 КАК НалоговыйУчет,
|	0 КАК ПостояннаяРазница,
|	0 КАК ВременнаяРазница
|ИЗ
|	РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК ДетализацияСебестоимости
|		
|ГДЕ 
|	ДетализацияСебестоимости.Период МЕЖДУ НАЧАЛОПЕРИОДА(&ДатаИсходнойПартии, МЕСЯЦ) И КОНЕЦПЕРИОДА(&ДатаИсходнойПартии, МЕСЯЦ)
|	И ДетализацияСебестоимости.Партия В (&ПартииПродукции)
|	И ДетализацияСебестоимости.АналитикаУчетаПартий В (&АналитикиУчетаПартийПродукции)
|	И ДетализацияСебестоимости.АналитикаУчетаНоменклатуры В (&АналитикаУчетаЗатрата)
|	И ДетализацияСебестоимости.РазделУчета В (
|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах),
|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты))
|	И НЕ ВЫБОР
|			КОГДА &ДанныеПоСебестоимости = 1
|				ТОГДА ДетализацияСебестоимости.СтоимостьСНДС
|			КОГДА &ДанныеПоСебестоимости = 2
|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДС
|			КОГДА &ДанныеПоСебестоимости = 3
|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСУпр
|			КОГДА &ДанныеПоСебестоимости = 4
|				ТОГДА ДетализацияСебестоимости.СтоимостьБезНДСРегл
|		КОНЕЦ = 0
|	И ВЫБОР
|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
|			ТОГДА ИСТИНА	
|		КОГДА &ДанныеПоСебестоимости = 4
|			ТОГДА ДетализацияСебестоимости.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
|	КОНЕЦ 
|
|СГРУППИРОВАТЬ ПО
|	ДетализацияСебестоимости.Организация,
|	ДетализацияСебестоимости.Партия,
|	ДетализацияСебестоимости.АналитикаУчетаНоменклатуры,
|	ДетализацияСебестоимости.АналитикаУчетаПартий,
|	ДетализацияСебестоимости.ДокументПоступления,
|	ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления,
|	ДетализацияСебестоимости.АналитикаРасходов,
|	ВЫБОР
|		КОГДА ДетализацияСебестоимости.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
|			ТОГДА ЕСТЬNULL(ДетализацияСебестоимости.АналитикаУчетаПартийДокументаПоступления.ВидЦенности, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка))
|		ИНАЧЕ ДетализацияСебестоимости.СтатьяРасходов
|	КОНЕЦ
|";
КонецФункции

&Вместо("ТекстЗапросаЗатратыНаПродукцию")
Функция ikon_cost_ТекстЗапросаЗатратыНаПродукцию(ВыводитьДопРасходы)

	ТекстыЗапроса = Новый Массив;

	#Область ТекстМатериальныеЗатраты

	#Область ВыбытиеИзНЗППоПродукции
	ТекстМатериальныеЗатраты = ikon_cost_ТекстЗапроса_ВыбытиеИзНЗППоПродукции();
	#КонецОбласти

	#Область ВыбывшиеЗатратыСводно
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_ВыбывшиеЗатратыСводно();
	#КонецОбласти

	#Область ПартииПроизводства
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_ПартииПроизводства();
	#КонецОбласти

	#Область ВыбытиеИзНЗП
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_ВыбытиеИзНЗП();
	#КонецОбласти

	#Область ПервичныеПартииВНЗП
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_ПервичныеПартииВНЗП();
	#КонецОбласти

	#Область ДетализацияПартий
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_ДетализацияПартий();
	#КонецОбласти

	#Область ПриходыНарастающимИтогом
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_ПриходыНарастающимИтогом();
	#КонецОбласти

	#Область РасходыНарастающимИтогом
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_РасходыНарастающимИтогом();
	#КонецОбласти

	#Область НулевыеПериоды
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_НулевыеПериоды();
	#КонецОбласти

	#Область ИнтервалыРасходаПартий
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_ИнтервалыРасходаПартий();
	#КонецОбласти

	#Область ПриходыНарастающимИтогомПоИнтервалам
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_ПриходыНарастающимИтогомПоИнтервалам();
	#КонецОбласти

	#Область ПредварительныйРасходПартий
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_ПредварительныйРасходПартий();
	#КонецОбласти

	#Область ПартииСводно
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_ПартииСводно();
	#КонецОбласти

	#Область РасходПартийСводно
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_РасходПартийСводно();
	#КонецОбласти

	#Область ПервичныеЗатратыПоПериодам
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_ПервичныеЗатратыПоПериодам();
	#КонецОбласти

	#Область ПервичныеПартииСводно
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_ПервичныеПартииСводно();
	#КонецОбласти

	#Область ПартииПолуфабрикатов
	ТекстМатериальныеЗатраты = ТекстМатериальныеЗатраты + ikon_cost_ТекстЗапроса_ПартииПолуфабрикатов();
	#КонецОбласти

	#КонецОбласти

	#Область ТекстМатериальныеЗатратыОбъединение
	ТекстМатериальныеЗатратыОбъединение = ikon_cost_ТекстЗапроса_ТекстМатериальныеЗатратыОбъединение();
	ТекстыЗапроса.Добавить(ТекстМатериальныеЗатратыОбъединение);
	#КонецОбласти	

	#Область ТекстМатериалыНачальныеОстаткиНЗПОбъединение
	ТекстМатериалыНачальныеОстаткиНЗПОбъединение = ikon_cost_ТекстЗапроса_ТекстМатериалыНачальныеОстаткиНЗПОбъединение();
	ТекстыЗапроса.Добавить(ТекстМатериалыНачальныеОстаткиНЗПОбъединение);
	#КонецОбласти
	

	#Область ТекстТрудозатратыОбъединение
	ТекстТрудозатратыОбъединение = ikon_cost_ТекстЗапроса_ТекстТрудозатратыОбъединение();
	ТекстыЗапроса.Добавить(ТекстТрудозатратыОбъединение);
	#КонецОбласти

	#Область ТекстПрочиеРасходыОбъединение
	ТекстПрочиеРасходыОбъединение = ikon_cost_ТекстЗапроса_ТекстПрочиеРасходыОбъединение();
	ТекстыЗапроса.Добавить(ТекстПрочиеРасходыОбъединение);
	#КонецОбласти

	#Область ТекстДопРасходыОбъединение

	Если ВыводитьДопРасходы Тогда
		ТекстДопРасходыОбъединение = ikon_cost_ТекстЗапроса_ТекстДопРасходыОбъединение();
		ТекстыЗапроса.Добавить(ТекстДопРасходыОбъединение);
	КонецЕсли;

	#КонецОбласти

	Возврат ТекстМатериальныеЗатраты
	+ СтрСоединить(ТекстыЗапроса, " ОБЪЕДИНИТЬ ВСЕ ");

КонецФункции


//	#Удаление
//	#КонецУдаления
//	#Вставка
// 	#КонецВставки