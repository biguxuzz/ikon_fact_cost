&ИзменениеИКонтроль("ПараметрыДереваСебестоимости")
Функция ikon_cost_ПараметрыДереваСебестоимости() Экспорт
	
	ТипыРезультата = Новый ОписаниеТипов("ДеревоЗначений,ТаблицаЗначений,МенеджерВременныхТаблиц");
	
	ПараметрыДерева = Новый Структура;
	
	ПараметрыДерева.Вставить("ДинамическоеСчитывание",	Истина);
	ПараметрыДерева.Вставить("ТипРезультата",			"ДеревоЗначений");
	ПараметрыДерева.Вставить("Результат",				ТипыРезультата.ПривестиЗначение(Неопределено));
	ПараметрыДерева.Вставить("ДобавлятьПолуфабрикатыВРезультат", Истина);
	
	#Вставка
	// === НАСТРОЙКИ ОПТИМИЗАЦИИ И ДИАГНОСТИКИ ===
	
	// Использовать пакетную обработку узлов по уровням (оптимизация N+1)
	// При Истина - узлы обрабатываются пакетами по уровням (быстрее, меньше запросов)
	// При Ложь - классический рекурсивный алгоритм (совместимость)
	ПараметрыДерева.Вставить("ИспользоватьПакетнуюОбработку", Истина);
	
	// Включить диагностические сообщения в журнал регистрации
	// При Истина - выводятся подробные логи обработки (для отладки)
	// При Ложь - диагностика отключена (рекомендуется для продакшена)
	// ПРИМЕЧАНИЕ: Основные "тяжёлые" блоки диагностики (с запросами и циклами) 
	//             обёрнуты в проверку этого флага. Простые записи в журнал 
	//             можно обернуть дополнительно при необходимости.
	ПараметрыДерева.Вставить("ВыводитьДиагностику", Истина);
	ПараметрыДерева.Вставить("СчётчикДиагностикиПартий", 0); // Счётчик для ограничения вывода
 	#КонецВставки

	Возврат ПараметрыДерева;

КонецФункции

&ИзменениеИКонтроль("ПостроитьДеревоСебестоимости")
Процедура ikon_cost_ПостроитьДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла = Неопределено) Экспорт

	#Вставка
	// КРИТИЧНО: Для отчётов (МенеджерВременныхТаблиц) полуфабрикаты НЕОБХОДИМЫ!
	// Они используются для построения связей между материалами и продукцией в запросе отчета.
	// Отчёт строит таблицу КоличествоВыпуска из продукции и полуфабрикатов,
	// затем соединяет материалы с полуфабрикатами по ПартияВыходноеИзделие.
	// Без полуфабрикатов материалы "висят в воздухе" без связи с продукцией.
	// Поэтому оставляем ДобавлятьПолуфабрикатыВРезультат = Истина (как в оригинале)
	
	// ДИАГНОСТИКА: какой тип результата используется
	Если ПараметрыДерева.ВыводитьДиагностику Тогда
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"ПостроитьДеревоСебестоимости: ТипРезультата='%1', ДинамическоеСчитывание=%2, ДобавлятьПолуфабрикатыВРезультат=%3",
			ПараметрыДерева.ТипРезультата,
			Строка(ПараметрыДерева.ДинамическоеСчитывание),
			Строка(ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат));
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.Диагностика",
			УровеньЖурналаРегистрации.Предупреждение,
			,
			,
			ТекстСообщения);
	КонецЕсли;
	#КонецВставки
	
	// СтандартныеПодсистемы.ЗамерПроизводительности
	Замер = ОценкаПроизводительности.НачатьЗамерДлительнойОперации("ОбщийМодуль.СтруктураСебестоимости.ПостроитьДеревоСебестоимости");
	ПараметрыДерева.Вставить("КоличествоСтрок", 0);
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности
	
	Если ПараметрыУзла = Неопределено Тогда
		ПараметрыУзла = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();
	КонецЕсли;
	#Вставка
	// ВАЖНО: Пакетная обработка несовместима с динамическим считыванием
	// Если включена пакетная обработка, автоматически отключаем динамическое считывание
	Если ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
		И ПараметрыДерева.ИспользоватьПакетнуюОбработку
		И ПараметрыДерева.ДинамическоеСчитывание Тогда
		
		ПараметрыДерева.ДинамическоеСчитывание = Ложь;
		
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.ПакетнаяОбработка",
			УровеньЖурналаРегистрации.Информация,
			,
			,
			"Динамическое считывание автоматически отключено для использования пакетной обработки");
	КонецЕсли;
	#КонецВставки
	
	Если ПараметрыДерева.Результат = Неопределено Тогда
		ПустоеДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла);
	КонецЕсли;

	ЗаполнитьДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла);
	#Вставка
	// Вывод статистики по обнаруженным циклам
	Если ПараметрыДерева.Свойство("ОбнаруженныеЦиклы") 
		И ПараметрыДерева.ОбнаруженныеЦиклы.Количество() > 0 Тогда
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"При построении дерева себестоимости обнаружено циклических зависимостей: %1",
			Строка(ПараметрыДерева.ОбнаруженныеЦиклы.Количество()));
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.СтатистикаЦиклов",
			УровеньЖурналаРегистрации.Предупреждение,
			,
			,
			ТекстСообщения);
	КонецЕсли;
	#КонецВставки

	// СтандартныеПодсистемы.ЗамерПроизводительности
	ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(Замер, ПараметрыДерева.КоличествоСтрок / 1000);
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности

КонецПроцедуры

&ИзменениеИКонтроль("РазузловатьУзелДереваСебестоимости")
Процедура ikon_cost_РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзла, ТаблицаРезультата, ОписаниеПродукции)

	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		Результат = ТаблицаРезультата.Строки;
		Если ПараметрыДерева.ДинамическоеСчитывание Тогда
			Результат.Очистить();
		КонецЕсли;
	Иначе
		Результат = ТаблицаРезультата
	КонецЕсли;

	ПройденныйПуть = Неопределено;
	Если НЕ ПараметрыДерева.Свойство("ПройденныйПуть", ПройденныйПуть) Тогда
		ПройденныйПуть = Новый ТаблицаЗначений;
		ПройденныйПуть.Колонки.Добавить("Партия");
		ПройденныйПуть.Колонки.Добавить("АналитикаУчетаПартий");
		ПройденныйПуть.Индексы.Добавить("Партия, АналитикаУчетаПартий");
		ПараметрыДерева.Вставить("ПройденныйПуть", ПройденныйПуть);
		#Вставка
		// Инициализируем параметры защиты от циклов и глубокой рекурсии
		ПараметрыДерева.Вставить("МаксимальнаяГлубинаРекурсии", 50);
		ПараметрыДерева.Вставить("ОбнаруженныеЦиклы", Новый Массив);
		#КонецВставки
	КонецЕсли;

	АналитикаУчетаПродукции			= ОписаниеПродукции.АналитикаУчетаПродукции;
	ПартияПродукции					= ОписаниеПродукции.ПартияПродукции;
	АналитикаУчетаПартийПродукции	= ОписаниеПродукции.АналитикаУчетаПартийПродукции;
	УровеньУзла						= ОписаниеПродукции.Уровень + 1;
	#Вставка
	// Проверка максимальной глубины рекурсии
	Если УровеньУзла > ПараметрыДерева.МаксимальнаяГлубинаРекурсии Тогда
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"Достигнута максимальная глубина разузлования (%1 уровней). Партия: %2, Аналитика партий: %3",
			Строка(УровеньУзла),
			Строка(ПартияПродукции),
			Строка(АналитикаУчетаПартийПродукции));
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.МаксимальнаяГлубинаРекурсии",
			УровеньЖурналаРегистрации.Предупреждение,
			,
			,
			ТекстСообщения);
		Возврат;
	КонецЕсли;
	#КонецВставки

	ВыводитьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы И НЕ (УровеньУзла = 1);
	СебестоимостьУзла = СебестоимостьУзла(ПараметрыДерева, ПараметрыУзла, ВыводитьДопРасходы);

	// СтандартныеПодсистемы.ЗамерПроизводительности
	ПараметрыДерева.КоличествоСтрок = ПараметрыДерева.КоличествоСтрок + СебестоимостьУзла.Количество();
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности

	ЭтоРазузлованиеДопРасходов = Ложь;
	Для Каждого ТекПартия Из СебестоимостьУзла Цикл

		Если ТекПартия.ТребуетсяРазузлование И ТекПартия.КоличествоЗатрата <> 0 Тогда
			ПараметрыОтбора = Новый Структура("Партия, АналитикаУчетаПартий",
			ТекПартия.ПартияЗатрата,
			ТекПартия.АналитикаУчетаПартийЗатрата);
			МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
			#Вставка
			// Логирование обнаруженного цикла
			Если МассивСтрок.Количество() > 0 Тогда
				ИнформацияОЦикле = Новый Структура;
				ИнформацияОЦикле.Вставить("Уровень", УровеньУзла);
				ИнформацияОЦикле.Вставить("ПартияЗатрата", ТекПартия.ПартияЗатрата);
				ИнформацияОЦикле.Вставить("АналитикаУчетаПартийЗатрата", ТекПартия.АналитикаУчетаПартийЗатрата);
				ИнформацияОЦикле.Вставить("Затрата", ТекПартия.Затрата);
				ИнформацияОЦикле.Вставить("ПартияПродукции", ПартияПродукции);
				ИнформацияОЦикле.Вставить("АналитикаУчетаПартийПродукции", АналитикаУчетаПартийПродукции);
				
				ПараметрыДерева.ОбнаруженныеЦиклы.Добавить(ИнформацияОЦикле);
				
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"Обнаружен циклический переход на уровне %1: Затрата '%2' (Партия: %3, Аналитика партий: %4) -> уже обрабатывалась в пути от Партии: %5, Аналитики партий: %6",
					Строка(УровеньУзла),
					Строка(ТекПартия.Затрата),
					Строка(ТекПартия.ПартияЗатрата),
					Строка(ТекПартия.АналитикаУчетаПартийЗатрата),
					Строка(ПартияПродукции),
					Строка(АналитикаУчетаПартийПродукции));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.ОбнаруженЦикл",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
			КонецЕсли;
			#КонецВставки
		Иначе
			МассивСтрок = Новый Массив;
		КонецЕсли;

		Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			ИЛИ ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат
			ИЛИ Не ТекПартия.ТребуетсяРазузлование Тогда
			СтрокаПартия = Результат.Добавить(); // СтрокаДереваЗначений
			ЗаполнитьЗначенияСвойств(СтрокаПартия, ТекПартия);

			СтрокаПартия.Идентификатор	= Новый УникальныйИдентификатор();
			Если ТекПартия.ТребуетсяРазузлование
				И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
				И (ТекПартия.СуммаЗатрата <> 0 Или ТекПартия.СуммаЗатратаЗабалансовая <> 0)
				И МассивСтрок.Количество() = 0 Тогда

				СтрокаПартия.ВидСтроки		= Перечисления.ВидыСтрокДереваСебестоимости.ПартияПолуфабриката;
				СтрокаПартия.Числитель 		= ТекПартия.КоличествоЗатрата;

			Иначе
				СтрокаПартия.ВидСтроки		= Перечисления.ВидыСтрокДереваСебестоимости.ПартияЗатраты;
				СтрокаПартия.ТребуетсяРазузлование = Ложь;
			КонецЕсли;

			СтрокаПартия.АналитикаУчетаПродукции		= АналитикаУчетаПродукции;
			СтрокаПартия.ПартияПродукции				= ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартийПродукции	= АналитикаУчетаПартийПродукции;

			СтрокаПартия.Номенклатура			= ТекПартия.Затрата;
			СтрокаПартия.Характеристика			= ТекПартия.ХарактеристикаЗатрата;
			СтрокаПартия.Серия					= ТекПартия.СерияЗатрата;
			СтрокаПартия.Назначение				= ТекПартия.НазначениеЗатрата;
			СтрокаПартия.Партия					= ТекПартия.ПартияЗатрата;
			СтрокаПартия.АналитикаУчетаПартий	= ТекПартия.АналитикаУчетаПартийЗатрата;
			СтрокаПартия.ЕдиницаИзмерения		= ТекПартия.ЕдиницаИзмеренияЗатрата;
			СтрокаПартия.Уровень				= УровеньУзла;

			СтрокаПартия.Количество			= ТекПартия.КоличествоЗатрата;
			СтрокаПартия.Сумма				= Окр(ТекПартия.СуммаЗатрата, 2);
			СтрокаПартия.ДопРасходы			= Окр(СтрокаПартия.ДопРасходы, 2);
			СтрокаПартия.НалоговыйУчет		= Окр(СтрокаПартия.НалоговыйУчет, 2);
			СтрокаПартия.СуммаЗабалансовая	= ТекПартия.СуммаЗатратаЗабалансовая;

			// Уменьшаем суммовые показатели в узле на разузлованные суммы. 
			// На оставшиеся суммы будет сформирована отдельная строка для отражения расхождения стоимости с детализацией.
			Если ПараметрыУзла.Сумма <> 0 Или ПараметрыУзла.СуммаЗабалансовая <> 0 Тогда
				ПараметрыУзла.Сумма = ПараметрыУзла.Сумма - СтрокаПартия.Сумма;
				ПараметрыУзла.Материальные = ПараметрыУзла.Материальные - СтрокаПартия.Материальные;
				ПараметрыУзла.ДопРасходы = ПараметрыУзла.ДопРасходы - СтрокаПартия.ДопРасходы;
				ПараметрыУзла.Трудозатраты = ПараметрыУзла.Трудозатраты - СтрокаПартия.Трудозатраты;
				ПараметрыУзла.ПостатейныеПеременные = ПараметрыУзла.ПостатейныеПеременные - СтрокаПартия.ПостатейныеПеременные;
				ПараметрыУзла.ПостатейныеПостоянные = ПараметрыУзла.ПостатейныеПостоянные - СтрокаПартия.ПостатейныеПостоянные;
				ПараметрыУзла.НалоговыйУчет = ПараметрыУзла.НалоговыйУчет - СтрокаПартия.НалоговыйУчет;
				ПараметрыУзла.ПостояннаяРазница = ПараметрыУзла.ПостояннаяРазница - СтрокаПартия.ПостояннаяРазница;
				ПараметрыУзла.ВременнаяРазница = ПараметрыУзла.ВременнаяРазница - СтрокаПартия.ВременнаяРазница;
				ПараметрыУзла.СуммаЗабалансовая = ПараметрыУзла.СуммаЗабалансовая - СтрокаПартия.СуммаЗабалансовая;

				ЭтоРазузлованиеДопРасходов = (ТекПартия.ТипЗатрат = "ДопРасходы");
			КонецЕсли;
		КонецЕсли;

		Если ТекПартия.ТребуетсяРазузлование
			И ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			И ПараметрыДерева.ДинамическоеСчитывание Тогда
			СтрокаПартия.Строки.Добавить();
		ИначеЕсли ТекПартия.ТребуетсяРазузлование
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И (ТекПартия.СуммаЗатрата <> 0 Или ТекПартия.СуммаЗатратаЗабалансовая <> 0)
			И МассивСтрок.Количество() = 0
			ИЛИ ТекПартия.ТребуетсяРазузлованиеДопРасходов
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И ТекПартия.ДопРасходы <> 0 Тогда
			// общий подход к заполнению отбора параметров узла и условиям разузлования должен совпадать с:
			// - ЗаполнитьДеревоСебестоимости();
			// - Отчет.ДеревоСебестоимости.МодульОбъекта.ПолноеДеревоСебестоимостиПередРазворачиваниемСервер(). 
			ПараметрыУзлаПартии = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();

			Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
				НовыйПуть = ПройденныйПуть.Добавить();
				НовыйПуть.Партия = ТекПартия.ПартияЗатрата;
				НовыйПуть.АналитикаУчетаПартий = ТекПартия.АналитикаУчетаПартийЗатрата;
			КонецЕсли;

			Отборы = ПараметрыУзлаПартии.Отборы;
			Отборы.ДанныеПоСебестоимости = ПараметрыУзла.Отборы.ДанныеПоСебестоимости;
			Отборы.Продукция.Добавить(ТекПартия.Затрата);
			Отборы.ХарактеристикиПродукции.Добавить(ТекПартия.ХарактеристикаЗатрата);
			Отборы.СерииПродукции.Добавить(ТекПартия.СерияЗатрата);
			// При разузловании полуфабрикатов отбор по назначению не нужен, т.к. полуфабрикат может быть выпущен без назначения или
			// с указанием другого назначения.
			Отборы.ПартииПродукции.Добавить(ТекПартия.ПартияЗатрата);
			Отборы.АналитикиУчетаПартийПродукции.Добавить(ТекПартия.АналитикаУчетаПартийЗатрата);
			Отборы.АналитикаУчетаЗатрата.Добавить(ТекПартия.АналитикаУчетаЗатрата);
			// для знаменателя и количества продукции берем модуль значения, чтобы знак количества и сумм затрат определялся по числителю, который при выпуске будет > 0, а при сторно < 0
			Отборы.Числитель               = ТекПартия.КоличествоЗатрата;
			Отборы.КоличествоПродукции     = Макс(-ТекПартия.КоличествоЗатрата, ТекПартия.КоличествоЗатрата);
			Отборы.РазворачиватьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы;
			Отборы.ДатаИсходнойПартии      = ПараметрыУзла.Отборы.ДатаИсходнойПартии;
			Отборы.ДатаОкончания           = ПараметрыУзла.Отборы.ДатаОкончания;

			Отборы.ВключитьНДСВСтоимость   = ТекПартия.ВключитьНДСВСтоимость;
			Отборы.ИсключитьНДСИзСтоимости = ТекПартия.ИсключитьНДСИзСтоимости;
			Отборы.АналитикаУчетаВыходноеИзделие = ТекПартия.АналитикаУчетаЗатрата;
			Отборы.СтатьяКалькуляции       = ТекПартия.СтатьяКалькуляции;

			Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
				ТаблицаРезультатаПартии = СтрокаПартия;
			Иначе
				ТаблицаРезультатаПартии = Результат;
			КонецЕсли;

			Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
				ПараметрыУзлаПартии.Сумма = СтрокаПартия.Сумма;
				ПараметрыУзлаПартии.Материальные = СтрокаПартия.Материальные;
				ПараметрыУзлаПартии.ДопРасходы = СтрокаПартия.ДопРасходы;
				ПараметрыУзлаПартии.Трудозатраты = СтрокаПартия.Трудозатраты;
				ПараметрыУзлаПартии.ПостатейныеПеременные = СтрокаПартия.ПостатейныеПеременные;
				ПараметрыУзлаПартии.ПостатейныеПостоянные = СтрокаПартия.ПостатейныеПостоянные;
				ПараметрыУзлаПартии.НалоговыйУчет = СтрокаПартия.НалоговыйУчет;
				ПараметрыУзлаПартии.ПостояннаяРазница = СтрокаПартия.ПостояннаяРазница;
				ПараметрыУзлаПартии.ВременнаяРазница = СтрокаПартия.ВременнаяРазница;
				ПараметрыУзлаПартии.СуммаЗабалансовая = СтрокаПартия.СуммаЗабалансовая;
			КонецЕсли;

			ОписаниеПродукции.Вставить("Уровень", УровеньУзла);
			Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" Тогда
				КоличествоСтрокРезультата = ТаблицаРезультатаПартии.Количество();
			КонецЕсли;
			РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзлаПартии, ТаблицаРезультатаПартии, ОписаниеПродукции);

			// Если разозлование доп расходов не выполнено, снимем признак ТребуетсяРазузлованиеДопРасходов.
			Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц"
				И ТекПартия.ТребуетсяРазузлованиеДопРасходов
				И КоличествоСтрокРезультата = ТаблицаРезультатаПартии.Количество() Тогда
				СтрокаПартия.ТребуетсяРазузлованиеДопРасходов = Ложь;
			КонецЕсли;
		КонецЕсли;

		#Вставка
		// УБРАНА логика удаления из ПройденныйПуть для предотвращения встречных циклов.
		// Партии остаются в ПройденныйПуть на протяжении всего процесса построения дерева,
		// что обеспечивает корректное обнаружение циклических зависимостей любой сложности.
		#КонецВставки
		#Удаление
		// Удалим строку, по которой уже выполнено разузлование.
		Если ТекПартия.ТребуетсяРазузлование
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И ТекПартия.СуммаЗатрата <> 0 Тогда
			ПараметрыОтбора = Новый Структура("Партия, АналитикаУчетаПартий",
			ТекПартия.ПартияЗатрата,
			ТекПартия.АналитикаУчетаПартийЗатрата);
			МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
			Для Каждого СтрокаКУдалению Из МассивСтрок Цикл
				ПройденныйПуть.Удалить(СтрокаКУдалению);
			КонецЦикла;
		КонецЕсли;
		#КонецУдаления

	КонецЦикла;

	// При наличии данных о разузловании добавим строку на суммы изменения стоимости.
	Если СебестоимостьУзла.Количество() > 0 И НЕ ЭтоРазузлованиеДопРасходов Тогда
		УчестьИзменениеСтоимости(ПараметрыУзла, ОписаниеПродукции, Результат);
	КонецЕсли;

КонецПроцедуры

&ИзменениеИКонтроль("ЗаполнитьДеревоСебестоимости")
Процедура ikon_cost_ЗаполнитьДеревоСебестоимости(ПараметрыДерева, ПараметрыУзла)

	Запрос = ЗапросВыпущеннаяПродукция(ПараметрыУзла, Ложь);
	ВыпущеннаяПродукция = Запрос.Выполнить().Выгрузить();
	#Вставка
	// ДИАГНОСТИКА
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"ЗаполнитьДеревоСебестоимости: получено строк ВыпущеннаяПродукция=%1, ДинамическоеСчитывание=%2, ИспользоватьПакетнуюОбработку=%3",
		Строка(ВыпущеннаяПродукция.Количество()),
		Строка(ПараметрыДерева.ДинамическоеСчитывание),
		Строка(ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") И ПараметрыДерева.ИспользоватьПакетнуюОбработку));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		ТекстСообщения);
	#КонецВставки

	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		Результат = ПараметрыДерева.Результат.Строки;
	ИначеЕсли ПараметрыДерева.ТипРезультата = "ТаблицаЗначений" Тогда
		Результат = ПараметрыДерева.Результат;
	Иначе
		Результат = Новый ТаблицаЗначений;
		ИнициализироватьПоляДереваСебестоимости(Результат);
		ПоляТаблицы = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(Результат, "Идентификатор");
		СчетчикТаблиц = 0;
		ИменаТаблиц = "";
	КонецЕсли;

	// СтандартныеПодсистемы.ЗамерПроизводительности
	ПараметрыДерева.КоличествоСтрок = ПараметрыДерева.КоличествоСтрок + ВыпущеннаяПродукция.Количество();
	// Конец СтандартныеПодсистемы.ЗамерПроизводительности

	Для Каждого ТекПартия Из ВыпущеннаяПродукция Цикл
		
		#Удаление
		Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			ИЛИ ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат
			ИЛИ Не ТекПартия.ТребуетсяРазузлование Тогда
		#КонецУдаления
		#Вставка
		// КРИТИЧНО: Строка ПРОДУКЦИИ (уровень 0) всегда должна добавляться в результат!
		// ДобавлятьПолуфабрикатыВРезультат управляет только полуфабрикатами (уровни 1+)
		// Для МенеджерВременныхТаблиц строка продукции нужна для корректного формирования отчета
		Если Истина Тогда
		#КонецВставки
			СтрокаПартия = Результат.Добавить(); // СтрокаДереваЗначений
			ЗаполнитьЗначенияСвойств(СтрокаПартия, ТекПартия);
			
			СтрокаПартия.Идентификатор	= Новый УникальныйИдентификатор();
			СтрокаПартия.ВидСтроки		= Перечисления.ВидыСтрокДереваСебестоимости.ПартияПродукции;
			
			СтрокаПартия.АналитикаУчетаВыходноеИзделие			= ТекПартия.АналитикаУчетаПродукции;
			СтрокаПартия.АналитикаУчетаПартийВыходноеИзделие	= ТекПартия.АналитикаУчетаПартийПродукции;
			СтрокаПартия.ПартияВыходноеИзделие					= ТекПартия.ПартияПродукции;
			
			СтрокаПартия.Номенклатура			= ТекПартия.Продукция;
			СтрокаПартия.Характеристика			= ТекПартия.ХарактеристикаПродукции;
			СтрокаПартия.Серия					= ТекПартия.СерияПродукции;
			СтрокаПартия.Назначение				= ТекПартия.НазначениеПродукции;
			СтрокаПартия.Валюта					= ТекПартия.Валюта;
			СтрокаПартия.Партия					= ТекПартия.ПартияПродукции;
			СтрокаПартия.АналитикаУчетаПартий	= ТекПартия.АналитикаУчетаПартийПродукции;
			СтрокаПартия.ЕдиницаИзмерения		= ТекПартия.ЕдиницаИзмеренияПродукция;
			
			СтрокаПартия.Количество	= ТекПартия.КоличествоПродукция;
			СтрокаПартия.Сумма		= ТекПартия.СуммаПродукция;
			СтрокаПартия.СуммаЗабалансовая = ТекПартия.СуммаПродукцияЗабалансовая;
		КонецЕсли;
		
		Если ТекПартия.ТребуетсяРазузлование
			И ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			И ПараметрыДерева.ДинамическоеСчитывание
			И ТекПартия.КоличествоПродукция <> 0 Тогда

			СтрокаПартия.Строки.Добавить();

		ИначеЕсли ТекПартия.ТребуетсяРазузлование
			И ТекПартия.КоличествоПродукция <> 0 Тогда //проверка на отсторнированный выпуск в выбранном периоде
			// общий подход к заполнению отбора параметров узла и условиям разузлования должен совпадать с:
			// - РазузловатьУзелДереваСебестоимости();
			// - Отчет.ДеревоСебестоимости.МодульОбъекта.ПолноеДеревоСебестоимостиПередРазворачиваниемСервер(). 
			ПараметрыУзлаПартии = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();

			Отборы = ПараметрыУзлаПартии.Отборы;
			Отборы.ДанныеПоСебестоимости = ПараметрыУзла.Отборы.ДанныеПоСебестоимости;
			Отборы.Продукция.Добавить(ТекПартия.Продукция);
			Отборы.ХарактеристикиПродукции.Добавить(ТекПартия.ХарактеристикаПродукции);
			Отборы.СерииПродукции.Добавить(ТекПартия.СерияПродукции);
			Отборы.НазначенияПродукции.Добавить(ТекПартия.НазначениеПродукции);
			Отборы.ПартииПродукции.Добавить(ТекПартия.ПартияПродукции);
			Отборы.АналитикиУчетаПартийПродукции.Добавить(ТекПартия.АналитикаУчетаПартийПродукции);
			// для знаменателя и количества продукции берем модуль значения, чтобы знак количества и сумм затрат определялся по числителю, который при выпуске будет > 0, а при сторно < 0
			Отборы.Числитель               = ТекПартия.Числитель;
			Отборы.Знаменатель             = Макс(-ТекПартия.Знаменатель, ТекПартия.Знаменатель);
			Отборы.КоличествоПродукции     = Макс(-ТекПартия.КоличествоПродукция,ТекПартия. КоличествоПродукция);
			Отборы.РазворачиватьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы;
			Отборы.ДатаИсходнойПартии = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ТекПартия.ПартияПродукции, "Дата");
			Отборы.ДатаОкончания           = ПараметрыУзла.Отборы.ДатаОкончания;

			ПараметрыУзлаПартии.Сумма = ТекПартия.СуммаПродукция;
			ПараметрыУзлаПартии.Материальные = ТекПартия.Материальные;
			ПараметрыУзлаПартии.ДопРасходы = ТекПартия.ДопРасходы;
			ПараметрыУзлаПартии.Трудозатраты = ТекПартия.Трудозатраты;
			ПараметрыУзлаПартии.ПостатейныеПеременные = ТекПартия.ПостатейныеПеременные;
			ПараметрыУзлаПартии.ПостатейныеПостоянные = ТекПартия.ПостатейныеПостоянные;
			ПараметрыУзлаПартии.НалоговыйУчет = ТекПартия.НалоговыйУчет;
			ПараметрыУзлаПартии.ПостояннаяРазница = ТекПартия.ПостояннаяРазница;
			ПараметрыУзлаПартии.ВременнаяРазница = ТекПартия.ВременнаяРазница;
			ПараметрыУзлаПартии.СуммаЗабалансовая = ТекПартия.СуммаПродукцияЗабалансовая;

			ОписаниеПродукции = Новый Структура("АналитикаУчетаПродукции, ПартияПродукции, АналитикаУчетаПартийПродукции");
			ЗаполнитьЗначенияСвойств(ОписаниеПродукции, ТекПартия);
			ОписаниеПродукции.Вставить("Уровень", 0);

			Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
				ТаблицаРезультата = СтрокаПартия;
			Иначе
				ТаблицаРезультата = Результат;
			КонецЕсли;

			#Удаление
			РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзлаПартии, ТаблицаРезультата, ОписаниеПродукции);
			#КонецУдаления
			#Вставка
			// Выбор между пакетной обработкой и рекурсивной
			Если ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
				И ПараметрыДерева.ИспользоватьПакетнуюОбработку 
				И НЕ ПараметрыДерева.ДинамическоеСчитывание Тогда
				
				// Пакетная обработка: формируем узел для добавления в очередь
				Узел = Новый Структура;
				Узел.Вставить("ПараметрыУзла", ПараметрыУзлаПартии);
				Узел.Вставить("ТаблицаРезультата", ТаблицаРезультата);
				Узел.Вставить("ОписаниеПродукции", ОписаниеПродукции);
				Узел.Вставить("СтрокаПартия", СтрокаПартия);
				
				Если НЕ ПараметрыДерева.Свойство("УзлыДляПакетнойОбработки") Тогда
					ПараметрыДерева.Вставить("УзлыДляПакетнойОбработки", Новый Массив);
				КонецЕсли;
				
				ПараметрыДерева.УзлыДляПакетнойОбработки.Добавить(Узел);
				// ДИАГНОСТИКА
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"Узел добавлен в пакет для обработки. Всего узлов в пакете: %1",
					Строка(ПараметрыДерева.УзлыДляПакетнойОбработки.Количество()));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Информация,
					,
					,
					ТекстСообщения);
			Иначе
				// Старая рекурсивная обработка (сохранена для обратной совместимости)
				РазузловатьУзелДереваСебестоимости(ПараметрыДерева, ПараметрыУзлаПартии, ТаблицаРезультата, ОписаниеПродукции);
			КонецЕсли;
			#КонецВставки

		КонецЕсли;

		#Удаление
		Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" Тогда
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
			ПараметрыДерева.Результат,
			ИмяТекущейТаблицы,
			Результат,
			ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
			Результат.Очистить();
		КонецЕсли;
		#КонецУдаления
		#Вставка
		// ВАЖНО: При пакетной обработке НЕ сохраняем и НЕ очищаем Результат в цикле!
		// Узлы используют ссылку на эту таблицу, и она будет сохранена после пакетной обработки.
		ИспользуетсяПакетнаяОбработка = ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
			И ПараметрыДерева.ИспользоватьПакетнуюОбработку 
			И НЕ ПараметрыДерева.ДинамическоеСчитывание;
		
		Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" 
			И НЕ ИспользуетсяПакетнаяОбработка Тогда
			
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			
			// ДИАГНОСТИКА: сохранение в цикле
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				" СТАРЫЙ: создание ВТ '%1' в цикле, строк=%2",
				ИмяТекущейТаблицы,
				Строка(Результат.Количество()));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Информация,
				,
				,
				ТекстСообщения);
			
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
				ПараметрыДерева.Результат,
				ИмяТекущейТаблицы,
				Результат,
				ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
			Результат.Очистить();
		КонецЕсли;
		#КонецВставки

	КонецЦикла;

	#Удаление
	Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" Тогда
		Если НЕ ПустаяСтрока(ИменаТаблиц) Тогда
			РасчетСебестоимостиПрикладныеАлгоритмы.ОбъединитьВременныеТаблицы(
			ПараметрыДерева.Результат,
			ИменаТаблиц,
			"Результат",
			ПоляТаблицы, "", , Истина);
		Иначе
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = ПараметрыДерева.Результат;
			Запрос.Текст =
			"ВЫБРАТЬ
			|	*
			|ПОМЕСТИТЬ Результат
			|ИЗ
			|	&Результат КАК Результат";

			Результат.Колонки.Удалить("Идентификатор");
			Запрос.УстановитьПараметр("Результат", Результат);
			// Структуру ВТ Результат см. в СтруктураСебестоимости.СтруктураПолейДереваСебестоимости.
			Запрос.Выполнить();
		КонецЕсли;
	КонецЕсли;
	#КонецУдаления
	#Вставка
	// Обработка накопленных узлов для пакетной обработки (оптимизация N+1)
	// ВАЖНО: Обработка пакета ПО УРОВНЯМ с сохранением после каждого уровня!
	Если ПараметрыДерева.Свойство("УзлыДляПакетнойОбработки") 
		И ПараметрыДерева.УзлыДляПакетнойОбработки.Количество() > 0 Тогда
		
		УзлыТекущегоУровня = ПараметрыДерева.УзлыДляПакетнойОбработки;
		НомерУровня = 1;
		
		// Обрабатываем уровни по очереди (НЕ очищаем Результат - накапливаем в нём!)
		Пока УзлыТекущегоУровня.Количество() > 0 Цикл
			
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				" НОВЫЙ (ПАКЕТНЫЙ): начало обработки уровня %1, узлов=%2, накоплено строк=%3",
				Строка(НомерУровня),
				Строка(УзлыТекущегоУровня.Количество()),
				Строка(Результат.Количество()));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Информация,
				,
				,
				ТекстСообщения);
			
			// Обработать текущий уровень
			УзлыСледующегоУровня = РазузловатьУзлыПакетом(ПараметрыДерева, УзлыТекущегоУровня);
			
			// Переход к следующему уровню
			УзлыТекущегоУровня = УзлыСледующегоУровня;
			НомерУровня = НомерУровня + 1;
			
		КонецЦикла;
		
		// ФИЛЬТРАЦИЯ и СОХРАНЕНИЕ (один раз в конце!)
		Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" 
			И Результат.Количество() > 0 Тогда
			
			// ФИЛЬТРАЦИЯ: удаляем строки "Усреднение стоимости" и "Изменение стоимости при хранении"
			КоличествоДоФильтрации = Результат.Количество();
			Индекс = Результат.Количество() - 1;
			Пока Индекс >= 0 Цикл
				СтрокаРезультата = Результат[Индекс];
				Если СтрокаРезультата.Номенклатура = "Усреднение стоимости в незавершенном производстве"
					ИЛИ СтрокаРезультата.Номенклатура = "Изменение стоимости при хранении" Тогда
					Результат.Удалить(Индекс);
				КонецЕсли;
				Индекс = Индекс - 1;
			КонецЦикла;
			
			КоличествоУдаленных = КоличествоДоФильтрации - Результат.Количество();
			
			// Сохраняем одной таблицей
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
				ПараметрыДерева.Результат,
				ИмяТекущейТаблицы,
				Результат,
				ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
			
			// ДИАГНОСТИКА: Подсчитаем типы строк перед сохранением
			Если ПараметрыДерева.ВыводитьДиагностику Тогда
				КоличествоПродукции = 0;
				КоличествоПолуфабрикатов = 0;
				КоличествоЗатрат = 0;
				Для Каждого СтрокаДанных Из Результат Цикл
					Если СтрокаДанных.ВидСтроки = Перечисления.ВидыСтрокДереваСебестоимости.ПартияПродукции Тогда
						КоличествоПродукции = КоличествоПродукции + 1;
					ИначеЕсли СтрокаДанных.ВидСтроки = Перечисления.ВидыСтрокДереваСебестоимости.ПартияПолуфабриката Тогда
						КоличествоПолуфабрикатов = КоличествоПолуфабрикатов + 1;
					ИначеЕсли СтрокаДанных.ВидСтроки = Перечисления.ВидыСтрокДереваСебестоимости.ПартияЗатраты Тогда
						КоличествоЗатрат = КоличествоЗатрат + 1;
					КонецЕсли;
				КонецЦикла;
				
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					" НОВЫЙ (ПАКЕТНЫЙ): ФИНАЛЬНОЕ СОХРАНЕНИЕ в ВТ '%1', строк=%2 (удалено 'Усреднение'=%3), уровней=%4, Продукция=%5, Полуфабрикаты=%6, Затраты=%7",
					ИмяТекущейТаблицы,
					Строка(Результат.Количество()),
					Строка(КоличествоУдаленных),
					Строка(НомерУровня - 1),
					Строка(КоличествоПродукции),
					Строка(КоличествоПолуфабрикатов),
					Строка(КоличествоЗатрат));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Информация,
					,
					,
					ТекстСообщения);
			КонецЕсли;
			
			// КРИТИЧНО: Очищаем таблицу после сохранения, чтобы избежать дублирования
			// Данные уже сохранены во временную таблицу, и не должны сохраняться повторно
			Результат.Очистить();
		КонецЕсли;
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"Использована пакетная обработка: обработано узлов в первом уровне: %1, всего уровней: %2",
			Строка(ПараметрыДерева.УзлыДляПакетнойОбработки.Количество()),
			Строка(НомерУровня - 1));
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.ПакетнаяОбработка",
			УровеньЖурналаРегистрации.Информация,
			,
			,
			ТекстСообщения);
	КонецЕсли;
	
	// ПРИМЕЧАНИЕ: При пакетной обработке данные сохраняются ПОСЛЕ КАЖДОГО УРОВНЯ (выше в цикле)
	// Этот блок нужен только для старого рекурсивного алгоритма или если остались несохраненные данные
	Если ПараметрыДерева.ТипРезультата = "МенеджерВременныхТаблиц" Тогда
		
		// Сохраняем оставшиеся данные (если есть)
		Если Результат.Количество() > 0 Тогда
			СчетчикТаблиц = СчетчикТаблиц + 1;
			ИмяТекущейТаблицы = "Результат" + Формат(СчетчикТаблиц, "ЧГ=0;");
			РасчетСебестоимостиПрикладныеАлгоритмы.ПоместитьТаблицуЗначенийВоВременнуюТаблицу(
				ПараметрыДерева.Результат,
				ИмяТекущейТаблицы,
				Результат,
				ПоляТаблицы);
			ИменаТаблиц = ИменаТаблиц + ?(ПустаяСтрока(ИменаТаблиц), "", ",") + ИмяТекущейТаблицы;
			
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				" Сохранены ОСТАВШИЕСЯ данные во ВТ '%1': строк=%2",
				ИмяТекущейТаблицы,
				Строка(Результат.Количество()));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Информация,
				,
				,
				ТекстСообщения);
		КонецЕсли;
		
			// Объединяем все временные таблицы в итоговую
		Если НЕ ПустаяСтрока(ИменаТаблиц) Тогда
			// ДИАГНОСТИКА: количество временных таблиц
			КоличествоТаблиц = СтрРазделить(ИменаТаблиц, ",").Количество();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				" СТАРЫЙ АЛГОРИТМ: создано временных таблиц = %1 (список: %2)",
				Строка(КоличествоТаблиц),
				ИменаТаблиц);
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				ТекстСообщения);
			
			РасчетСебестоимостиПрикладныеАлгоритмы.ОбъединитьВременныеТаблицы(
			ПараметрыДерева.Результат,
			ИменаТаблиц,
			"Результат",
			ПоляТаблицы, "", , Истина);
			
			// ДИАГНОСТИКА: Проверяем итоговую ВТ "Результат" и выводим примеры строк
			Если ПараметрыДерева.ВыводитьДиагностику Тогда
				Запрос = Новый Запрос;
				Запрос.МенеджерВременныхТаблиц = ПараметрыДерева.Результат;
				Запрос.Текст = 
				"ВЫБРАТЬ
				|	КОЛИЧЕСТВО(*) КАК Количество,
				|	СУММА(ВЫБОР КОГДА ВидСтроки = ЗНАЧЕНИЕ(Перечисление.ВидыСтрокДереваСебестоимости.ПартияПродукции) ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК Продукция,
				|	СУММА(ВЫБОР КОГДА ВидСтроки = ЗНАЧЕНИЕ(Перечисление.ВидыСтрокДереваСебестоимости.ПартияПолуфабриката) ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК Полуфабрикаты,
				|	СУММА(ВЫБОР КОГДА ВидСтроки = ЗНАЧЕНИЕ(Перечисление.ВидыСтрокДереваСебестоимости.ПартияЗатраты) ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК Затраты
				|ИЗ
				|	Результат";
				РезультатПроверки = Запрос.Выполнить().Выгрузить();
				
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"✅ ИТОГОВАЯ ВТ 'Результат': строк=%1, Продукция=%2, Полуфабрикаты=%3, Затраты=%4",
					Строка(РезультатПроверки[0].Количество),
					Строка(РезультатПроверки[0].Продукция),
					Строка(РезультатПроверки[0].Полуфабрикаты),
					Строка(РезультатПроверки[0].Затраты));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
				
				// Выводим примеры строк с ключевыми полями
				Запрос.Текст = 
				"ВЫБРАТЬ ПЕРВЫЕ 5
				|	Уровень,
				|	ВидСтроки,
				|	Номенклатура,
				|	Сумма,
				|	Материальные,
				|	ТребуетсяРазузлование,
				|	Партия,
				|	ПартияПродукции,
				|	АналитикаУчетаПродукции,
				|	АналитикаУчетаВыходноеИзделие
				|ИЗ
				|	Результат
				|ГДЕ
				|	Уровень <= 2
				|
				|УПОРЯДОЧИТЬ ПО
				|	Уровень,
				|	Номенклатура";
				ПримерыСтрок = Запрос.Выполнить().Выгрузить();
				
				ТекстСообщения = " ПРИМЕРЫ СТРОК ИЗ ВТ 'Результат' (уровни 0-2):";
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
				
				Для Каждого СтрокаПример Из ПримерыСтрок Цикл
					ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"  Ур%1 | %2 | '%3' | Сум=%4 | Мат=%5 | Разузл=%6 | Партия=%7 | ПартПрод=%8",
						Строка(СтрокаПример.Уровень),
						Строка(СтрокаПример.ВидСтроки),
						Строка(СтрокаПример.Номенклатура),
						Формат(СтрокаПример.Сумма, "ЧЦ=12; ЧДЦ=2"),
						Формат(СтрокаПример.Материальные, "ЧЦ=12; ЧДЦ=2"),
						Строка(СтрокаПример.ТребуетсяРазузлование),
						?(ЗначениеЗаполнено(СтрокаПример.Партия), "ДА", "НЕТ"),
						?(ЗначениеЗаполнено(СтрокаПример.ПартияПродукции), "ДА", "НЕТ"));
					ЗаписьЖурналаРегистрации(
						"СтруктураСебестоимости.Диагностика",
						УровеньЖурналаРегистрации.Информация,
						,
						,
						ТекстСообщения);
					
					// Дополнительно выведем АналитикиУчета
					ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"    АналПрод=%1 | АналВыхИзд=%2",
						?(ЗначениеЗаполнено(СтрокаПример.АналитикаУчетаПродукции), "ДА", "НЕТ"),
						?(ЗначениеЗаполнено(СтрокаПример.АналитикаУчетаВыходноеИзделие), "ДА", "НЕТ"));
					ЗаписьЖурналаРегистрации(
						"СтруктураСебестоимости.Диагностика",
						УровеньЖурналаРегистрации.Информация,
						,
						,
						ТекстСообщения);
				КонецЦикла;
			КонецЕсли;
			
			// ДИАГНОСТИКА: проверяем итоговую ВТ после объединения
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = ПараметрыДерева.Результат;
			// Запрос 1: Общая статистика
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	КОЛИЧЕСТВО(*) КАК Количество,
			|	СУММА(ВЫБОР КОГДА Уровень = 0 ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК Уровень0,
			|	СУММА(ВЫБОР КОГДА Уровень = 1 ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК Уровень1,
			|	СУММА(ВЫБОР КОГДА Уровень > 1 ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК УровеньБольше1,
			|	СУММА(ВЫБОР КОГДА ПартияПродукции ЕСТЬ NULL ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК ПартияПродукцииNULL,
			|	СУММА(ВЫБОР КОГДА Партия ЕСТЬ NULL ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК ПартияЗатратыNULL,
			|	СУММА(ВЫБОР КОГДА ВидСтроки = ЗНАЧЕНИЕ(Перечисление.ВидыСтрокДереваСебестоимости.ПартияПродукции) ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК ВидПродукция,
			|	СУММА(ВЫБОР КОГДА ВидСтроки = ЗНАЧЕНИЕ(Перечисление.ВидыСтрокДереваСебестоимости.ПартияПолуфабриката) ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК ВидПолуфабрикат,
			|	СУММА(ВЫБОР КОГДА ВидСтроки = ЗНАЧЕНИЕ(Перечисление.ВидыСтрокДереваСебестоимости.ПартияЗатраты) ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК ВидЗатраты
			|ИЗ
			|	Результат";
			РезультатПроверки = Запрос.Выполнить().Выгрузить();
			
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				"После объединения ВТ '%1': строк=%2, Уровни (0:%3, 1:%4, >1:%5)",
				ИменаТаблиц,
				Строка(РезультатПроверки[0].Количество),
				Строка(РезультатПроверки[0].Уровень0),
				Строка(РезультатПроверки[0].Уровень1),
				Строка(РезультатПроверки[0].УровеньБольше1));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Информация,
				,
				,
				ТекстСообщения);
			
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				"Виды строк: Продукция=%1, Полуфабрикат=%2, Затраты=%3 | Связи NULL: ПартияПродукции=%4, ПартияЗатраты=%5",
				Строка(РезультатПроверки[0].ВидПродукция),
				Строка(РезультатПроверки[0].ВидПолуфабрикат),
				Строка(РезультатПроверки[0].ВидЗатраты),
				Строка(РезультатПроверки[0].ПартияПродукцииNULL),
				Строка(РезультатПроверки[0].ПартияЗатратыNULL));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Информация,
				,
				,
				ТекстСообщения);
			
			// Запрос 2: Примеры строк уровня 1 С АНАЛИТИКОЙ
			Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 5
			|	Номенклатура,
			|	Партия,
			|	ПартияПродукции,
			|	АналитикаУчетаПартий,
			|	АналитикаУчетаПартийПродукции,
			|	ВидСтроки,
			|	Уровень
			|ИЗ
			|	Результат
			|ГДЕ
			|	Уровень = 1";
			РезультатПримеров = Запрос.Выполнить().Выгрузить();
			
			ПартияПолуфабриката = Неопределено;
			АналитикаПолуфабриката = Неопределено;
			Для Каждого Строка Из РезультатПримеров Цикл
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"Пример строки Ур1: Номенклатура='%1', ВидСтроки='%2', Партия=%3, ПартияПродукции=%4",
					Строка(Строка.Номенклатура),
					Строка(Строка.ВидСтроки),
					?(ЗначениеЗаполнено(Строка.Партия), "ЗАПОЛНЕНА", "НЕ ЗАПОЛНЕНА"),
					?(ЗначениеЗаполнено(Строка.ПартияПродукции), "ЗАПОЛНЕНА", "НЕ ЗАПОЛНЕНА"));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Информация,
					,
					,
					ТекстСообщения);
				
				// Запоминаем партию И АНАЛИТИКУ полуфабриката для проверки связей
				Если Строка.ВидСтроки = Перечисления.ВидыСтрокДереваСебестоимости.ПартияПолуфабриката Тогда
					ПартияПолуфабриката = Строка.Партия;
					АналитикаПолуфабриката = Строка.АналитикаУчетаПартий;
				КонецЕсли;
			КонецЦикла;
			
			// Запрос 3: ДЕТАЛЬНЫЙ АНАЛИЗ строк уровня 2 (ВСЕ, не только связанные)
			Если ПартияПолуфабриката <> Неопределено Тогда
				// Сначала проверим связь через ПартияПродукции
				Запрос.Текст = 
				"ВЫБРАТЬ
				|	КОЛИЧЕСТВО(*) КАК Количество
				|ИЗ
				|	Результат
				|ГДЕ
				|	Уровень = 2
				|	И ПартияПродукции = &ПартияПолуфабриката";
				Запрос.УстановитьПараметр("ПартияПолуфабриката", ПартияПолуфабриката);
				РезультатПроверкиСвязей = Запрос.Выполнить().Выгрузить();
				
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"ПРОВЕРКА СВЯЗЕЙ: строк уровня 2, связанных с полуфабрикатом уровня 1: %1 (ожидается ~8-10)",
					Строка(РезультатПроверкиСвязей[0].Количество));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
				
				// НОВОЕ: Посмотрим ВСЕ строки уровня 2 с АНАЛИТИКОЙ
				Запрос.Текст = 
				"ВЫБРАТЬ ПЕРВЫЕ 3
				|	Номенклатура,
				|	Партия,
				|	ПартияПродукции,
				|	АналитикаУчетаПартий,
				|	АналитикаУчетаПартийПродукции,
				|	ВидСтроки,
				|	Уровень,
				|	Сумма,
				|	Материальные
				|ИЗ
				|	Результат
				|ГДЕ
				|	Уровень = 2";
				РезультатВсеУр2 = Запрос.Выполнить().Выгрузить();
				
				// Определяем, какой алгоритм использовался
				ИспользуетсяПакетнаяОбработка = ПараметрыДерева.Свойство("ИспользоватьПакетнуюОбработку") 
					И ПараметрыДерева.ИспользоватьПакетнуюОбработку;
				
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					" %1 АЛГОРИТМ: всего строк уровня 2 = %2",
					?(ИспользуетсяПакетнаяОбработка, "НОВЫЙ (ПАКЕТНЫЙ)", "СТАРЫЙ (РЕКУРСИВНЫЙ)"),
					Строка(РезультатВсеУр2.Количество()));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
				
				Для Каждого СтрокаУр2 Из РезультатВсеУр2 Цикл
					// Сравниваем партии И аналитики
					СовпадаетПартия = (СтрокаУр2.ПартияПродукции = ПартияПолуфабриката);
					СовпадаетАналитика = (СтрокаУр2.АналитикаУчетаПартийПродукции = АналитикаПолуфабриката);
					
					ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"  Ур2: '%1', Вид=%2, Мат=%3",
						Строка(СтрокаУр2.Номенклатура),
						Строка(СтрокаУр2.ВидСтроки),
						Формат(СтрокаУр2.Материальные, "ЧЦ=10; ЧДЦ=2"));
					ЗаписьЖурналаРегистрации(
						"СтруктураСебестоимости.Диагностика",
						УровеньЖурналаРегистрации.Предупреждение,
						,
						,
						ТекстСообщения);
					
					ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"       ПАРТИЯ: Ур1='%1' vs Ур2='%2' (совпадает: %3)",
						Строка(ПартияПолуфабриката),
						Строка(СтрокаУр2.ПартияПродукции),
						?(СовпадаетПартия, "ДА ✓", "НЕТ ✗"));
					ЗаписьЖурналаРегистрации(
						"СтруктураСебестоимости.Диагностика",
						УровеньЖурналаРегистрации.Предупреждение,
						,
						,
						ТекстСообщения);
					
					ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"       АНАЛИТИКА: Ур1='%1' vs Ур2='%2' (совпадает: %3)",
						Строка(АналитикаПолуфабриката),
						Строка(СтрокаУр2.АналитикаУчетаПартийПродукции),
						?(СовпадаетАналитика, "ДА ✓", "НЕТ ✗"));
					ЗаписьЖурналаРегистрации(
						"СтруктураСебестоимости.Диагностика",
						УровеньЖурналаРегистрации.Предупреждение,
						,
						,
						ТекстСообщения);
				КонецЦикла;
				
				// ДЕТАЛЬНОЕ СРАВНЕНИЕ: пример строки уровня 2
				Запрос.Текст = 
				"ВЫБРАТЬ ПЕРВЫЕ 1
				|	Номенклатура,
				|	Партия,
				|	ПартияПродукции,
				|	АналитикаУчетаПартий,
				|	АналитикаУчетаПартийПродукции,
				|	ВидСтроки,
				|	Уровень,
				|	ТребуетсяРазузлование,
				|	Сумма,
				|	Материальные
				|ИЗ
				|	Результат
				|ГДЕ
				|	Уровень = 2
				|	И ПартияПродукции = &ПартияПолуфабриката";
				РезультатДетально = Запрос.Выполнить().Выгрузить();
				
				Если РезультатДетально.Количество() > 0 Тогда
					Строка = РезультатДетально[0];
					ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"ДЕТАЛЬНО Ур2: Ном='%1', Вид='%2', Разузловать=%3, Сумма=%4, Мат=%5",
						Строка(Строка.Номенклатура),
						Строка(Строка.ВидСтроки),
						Строка(Строка.ТребуетсяРазузлование),
						Формат(Строка.Сумма, "ЧЦ=10; ЧДЦ=2"),
						Формат(Строка.Материальные, "ЧЦ=10; ЧДЦ=2"));
					ЗаписьЖурналаРегистрации(
						"СтруктураСебестоимости.Диагностика",
						УровеньЖурналаРегистрации.Предупреждение,
						,
						,
						ТекстСообщения);
				КонецЕсли;
			КонецЕсли;
			
			// Запрос 4: Сравнение полей уровня 1
			Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 3
			|	Номенклатура КАК Номенклатура,
			|	ВидСтроки КАК ВидСтроки,
			|	Сумма КАК Сумма,
			|	Материальные КАК Материальные,
			|	ДопРасходы КАК ДопРасходы,
			|	ТребуетсяРазузлование КАК ТребуетсяРазузлование
			|ИЗ
			|	Результат
			|ГДЕ
			|	Уровень = 1
			|
			|УПОРЯДОЧИТЬ ПО
			|	ВидСтроки";
			РезультатСравнения = Запрос.Выполнить().Выгрузить();
			
			Для Каждого Строка Из РезультатСравнения Цикл
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"			СРАВНЕНИЕ Ур1: '%1' | Вид=%2 | Сумма=%3, Материальные=%4, ДопРасходы=%5, Разузловать=%6",
					Строка(Строка.Номенклатура),
					Строка(Строка.ВидСтроки),
					Формат(Строка.Сумма, "ЧЦ=15; ЧДЦ=2"),
					Формат(Строка.Материальные, "ЧЦ=15; ЧДЦ=2"),
					Формат(Строка.ДопРасходы, "ЧЦ=15; ЧДЦ=2"),
					Строка(Строка.ТребуетсяРазузлование));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Информация,
					,
					,
					ТекстСообщения);
			КонецЦикла;
			
	// ВЫГРУЗКА ПЕРВЫХ 30 СТРОК для проверки (с полями ТребуетсяРазузлование и ТребуетсяРазузлованиеДопРасходов!)
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 30
	|	Уровень,
	|	ВидСтроки,
	|	Номенклатура,
	|	Сумма,
	|	Материальные,
	|	ДопРасходы,
	|	ТребуетсяРазузлование,
	|	ТребуетсяРазузлованиеДопРасходов,
	|	ПартияВыходноеИзделие,
	|	ПартияПродукции,
	|	Партия
	|ИЗ
	|	Результат
	|ГДЕ
	|	Уровень >= 1
	|	И ВидСтроки = ЗНАЧЕНИЕ(Перечисление.ВидыСтрокДереваСебестоимости.ПартияЗатраты)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Уровень,
	|	Номенклатура";
	РезультатВыгрузки = Запрос.Выполнить().Выгрузить();
	
	ТекстВыгрузки = " ДЕТАЛЬНАЯ ПРОВЕРКА МАТЕРИАЛОВ (Ур2+):";
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.ВЫГРУЗКА",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ТекстВыгрузки);
	
	Для Каждого СтрокаВыгрузки Из РезультатВыгрузки Цикл
		// Вывод: название, суммы, партии и ОБА поля разузлования (КЛЮЧЕВЫЕ для отчёта!)
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"Ур%1 | %2 | '%3' | Сум=%4 | Доп=%5 | ТребРаз=%6 | ТребДоп=%7",
			Строка(СтрокаВыгрузки.Уровень),
			Строка(СтрокаВыгрузки.ВидСтроки),
			Строка(СтрокаВыгрузки.Номенклатура),
			Формат(СтрокаВыгрузки.Сумма, "ЧЦ=15; ЧДЦ=2"),
			Формат(СтрокаВыгрузки.ДопРасходы, "ЧЦ=15; ЧДЦ=2"),
			?(СтрокаВыгрузки.ТребуетсяРазузлование, "ДА", "НЕТ"),
			?(СтрокаВыгрузки.ТребуетсяРазузлованиеДопРасходов, "ДА", "НЕТ"));
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.ВЫГРУЗКА",
			УровеньЖурналаРегистрации.Информация,
			,
			,
			ТекстСообщения);
	КонецЦикла;
		Иначе
			// Если вообще нет данных, создаем пустую временную таблицу
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = ПараметрыДерева.Результат;
			Запрос.Текст =
			"ВЫБРАТЬ
			|	*
			|ПОМЕСТИТЬ Результат
			|ИЗ
			|	&Результат КАК Результат";
			
			Результат.Колонки.Удалить("Идентификатор");
			Запрос.УстановитьПараметр("Результат", Результат);
			// Структуру ВТ Результат см. в СтруктураСебестоимости.СтруктураПолейДереваСебестоимости.
			Запрос.Выполнить();
		КонецЕсли;
	КонецЕсли;
	
	// ДИАГНОСТИКА: итоговый результат
	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		КоличествоСтрокИтого = ПараметрыДерева.Результат.Строки.Количество();
	ИначеЕсли ПараметрыДерева.ТипРезультата = "ТаблицаЗначений" Тогда
		КоличествоСтрокИтого = ПараметрыДерева.Результат.Количество();
	Иначе
		// Для МенеджерВременныхТаблиц выполняем запрос подсчета строк
		Попытка
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = ПараметрыДерева.Результат;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Партия) КАК КоличествоУровень0
			|ИЗ
			|	Результат
			|ГДЕ
			|	Уровень = 0";
			РезультатПодсчета = Запрос.Выполнить().Выгрузить();
			КоличествоСтрокИтого = РезультатПодсчета[0].КоличествоУровень0;
		Исключение
			// Если временная таблица не существует или произошла ошибка
			КоличествоСтрокИтого = 0;
		КонецПопытки;
	КонецЕсли;
	
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"ЗаполнитьДеревоСебестоимости: ИТОГОВЫЙ результат содержит строк верхнего уровня=%1",
		Строка(КоличествоСтрокИтого));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		ТекстСообщения);
	#КонецВставки

КонецПроцедуры   

// Разузлование дерева себестоимости с пакетной обработкой по уровням (оптимизация N+1)
//
// Параметры:
//  ПараметрыДерева - см. СтруктураСебестоимости.ПараметрыДереваСебестоимости
//  УзлыДляОбработки - Массив из Структура - Массив узлов для обработки:
//    * ПараметрыУзла - Структура - Параметры узла
//    * ТаблицаРезультата - ДеревоЗначений, ТаблицаЗначений - Куда помещать результат
//    * ОписаниеПродукции - Структура - Описание продукции
//    * СтрокаПартия - СтрокаДереваЗначений - Ссылка на строку в дереве
//
Функция РазузловатьУзлыПакетом(ПараметрыДерева, УзлыДляОбработки)
	
	// ДИАГНОСТИКА
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"РазузловатьУзлыПакетом: начало обработки, узлов=%1",
		Строка(УзлыДляОбработки.Количество()));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		ТекстСообщения);
		
	Если УзлыДляОбработки.Количество() = 0 Тогда
		Возврат Новый Массив; // Возвращаем пустой массив, если нет узлов
	КонецЕсли;
	
	// Инициализация структур для отслеживания циклов
	ПройденныйПуть = Неопределено;
	Если НЕ ПараметрыДерева.Свойство("ПройденныйПуть", ПройденныйПуть) Тогда
		ПройденныйПуть = Новый ТаблицаЗначений;
		ПройденныйПуть.Колонки.Добавить("Партия");
		ПройденныйПуть.Колонки.Добавить("АналитикаУчетаПартий");
		ПройденныйПуть.Индексы.Добавить("Партия, АналитикаУчетаПартий");
		ПараметрыДерева.Вставить("ПройденныйПуть", ПройденныйПуть);
		// Инициализируем параметры защиты от циклов и глубокой рекурсии
		ПараметрыДерева.Вставить("МаксимальнаяГлубинаРекурсии", 50);
		ПараметрыДерева.Вставить("ОбнаруженныеЦиклы", Новый Массив);
	КонецЕсли;
	
	// Обрабатываем результаты для каждого узла
	УзлыСледующегоУровня = Новый Массив;
	
	// Обработка каждого узла с отдельным запросом
	// (упрощенный вариант без объединения запросов, но с обработкой по уровням)
	Для Каждого Узел Из УзлыДляОбработки Цикл
		
		// Определяем, нужно ли выводить дополнительные расходы
		УровеньУзла = Узел.ОписаниеПродукции.Уровень + 1;
		
		// Проверка максимальной глубины рекурсии
		Если УровеньУзла > ПараметрыДерева.МаксимальнаяГлубинаРекурсии Тогда
			ПартияПродукции = Узел.ОписаниеПродукции.ПартияПродукции;
			АналитикаУчетаПартийПродукции = Узел.ОписаниеПродукции.АналитикаУчетаПартийПродукции;
			
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				"Достигнута максимальная глубина разузлования (%1 уровней). Партия: %2, Аналитика партий: %3",
				Строка(УровеньУзла),
				Строка(ПартияПродукции),
				Строка(АналитикаУчетаПартийПродукции));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.МаксимальнаяГлубинаРекурсии",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				ТекстСообщения);
			Продолжить;
		КонецЕсли;
		
		ВыводитьДопРасходы = Узел.ПараметрыУзла.Отборы.РазворачиватьДопРасходы 
			И НЕ (Узел.ОписаниеПродукции.Уровень = 0);
		
		// Получаем данные для текущего узла отдельным запросом
		СебестоимостьУзла = СебестоимостьУзла(ПараметрыДерева, Узел.ПараметрыУзла, ВыводитьДопРасходы);
		
		// ДИАГНОСТИКА: содержимое запроса
		КоличествоСтатей = 0;
		КоличествоМатериальных = 0;
		КоличествоТрудозатрат = 0;
		ЕстьКолонкаТипЗатрат = (СебестоимостьУзла.Колонки.Найти("ТипЗатрат") <> Неопределено);
		
		Если ЕстьКолонкаТипЗатрат Тогда
			Для Каждого Строка Из СебестоимостьУзла Цикл
				Если Строка.ТипЗатрат = "Материальные" Тогда
					КоличествоМатериальных = КоличествоМатериальных + 1;
				ИначеЕсли Строка.ТипЗатрат = "Трудозатраты" Тогда
					КоличествоТрудозатрат = КоличествоТрудозатрат + 1;
				ИначеЕсли Строка.ТипЗатрат = "ДопРасходы" Тогда
					КоличествоСтатей = КоличествоСтатей + 1;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"Обработка узла уровня %1: получено строк себестоимости=%2 (материальные=%3, трудозатраты=%4, статьи=%5)",
			Строка(УровеньУзла),
			Строка(СебестоимостьУзла.Количество()),
			Строка(КоличествоМатериальных),
			Строка(КоличествоТрудозатрат),
			Строка(КоличествоСтатей));
		ЗаписьЖурналаРегистрации(
			"СтруктураСебестоимости.Диагностика",
			УровеньЖурналаРегистрации.Информация,
			,
			,
			ТекстСообщения);
			
		// СтандартныеПодсистемы.ЗамерПроизводительности
		ПараметрыДерева.КоличествоСтрок = ПараметрыДерева.КоличествоСтрок + СебестоимостьУзла.Количество();
		// Конец СтандартныеПодсистемы.ЗамерПроизводительности
		
		// Обрабатываем каждую партию в результатах
		ОбработатьРезультатыУзла(ПараметрыДерева, Узел, СебестоимостьУзла, ПройденныйПуть, УзлыСледующегоУровня);
	КонецЦикла;
	
	// НЕ вызываем рекурсивно! Возвращаем узлы следующего уровня для обработки в цикле
	Возврат УзлыСледующегоУровня;
	
КонецФункции

// Обрабатывает результаты запроса для одного узла
Процедура ОбработатьРезультатыУзла(ПараметрыДерева, Узел, СебестоимостьУзла, ПройденныйПуть, УзлыСледующегоУровня)
	
	ПараметрыУзла = Узел.ПараметрыУзла;
	ТаблицаРезультата = Узел.ТаблицаРезультата;
	ОписаниеПродукции = Узел.ОписаниеПродукции;
	
	Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
		Результат = ТаблицаРезультата.Строки;
	Иначе
		Результат = ТаблицаРезультата;
	КонецЕсли;
	
	// ДИАГНОСТИКА
	КоличествоДо = Результат.Количество();
	
	// ДИАГНОСТИКА: параметры обработки
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"ОбработатьРезультатыУзла начало: ТипРезультата='%1', ДобавлятьПолуфабрикаты=%2",
		ПараметрыДерева.ТипРезультата,
		Строка(ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		ТекстСообщения);	
	
	АналитикаУчетаПродукции = ОписаниеПродукции.АналитикаУчетаПродукции;
	ПартияПродукции = ОписаниеПродукции.ПартияПродукции;
	АналитикаУчетаПартийПродукции = ОписаниеПродукции.АналитикаУчетаПартийПродукции;
	УровеньУзла = ОписаниеПродукции.Уровень + 1;
	
	ЭтоРазузлованиеДопРасходов = Ложь;
	
	Для Каждого ТекПартия Из СебестоимостьУзла Цикл
		
		// Проверка на циклическую зависимость
		МассивСтрок = Новый Массив;
		Если ТекПартия.ТребуетсяРазузлование И ТекПартия.КоличествоЗатрата <> 0 Тогда
			ПараметрыОтбора = Новый Структура("Партия, АналитикаУчетаПартий",
				ТекПартия.ПартияЗатрата,
				ТекПартия.АналитикаУчетаПартийЗатрата);
			МассивСтрок = ПройденныйПуть.НайтиСтроки(ПараметрыОтбора);
			
			// Логирование обнаруженного цикла
			Если МассивСтрок.Количество() > 0 Тогда
				ИнформацияОЦикле = Новый Структура;
				ИнформацияОЦикле.Вставить("Уровень", УровеньУзла);
				ИнформацияОЦикле.Вставить("ПартияЗатрата", ТекПартия.ПартияЗатрата);
				ИнформацияОЦикле.Вставить("АналитикаУчетаПартийЗатрата", ТекПартия.АналитикаУчетаПартийЗатрата);
				ИнформацияОЦикле.Вставить("Затрата", ТекПартия.Затрата);
				ИнформацияОЦикле.Вставить("ПартияПродукции", ПартияПродукции);
				ИнформацияОЦикле.Вставить("АналитикаУчетаПартийПродукции", АналитикаУчетаПартийПродукции);
				
				ПараметрыДерева.ОбнаруженныеЦиклы.Добавить(ИнформацияОЦикле);
				
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"Обнаружен циклический переход на уровне %1: Затрата '%2' (Партия: %3, Аналитика партий: %4) -> уже обрабатывалась в пути от Партии: %5, Аналитики партий: %6",
					Строка(УровеньУзла),
					Строка(ТекПартия.Затрата),
					Строка(ТекПартия.ПартияЗатрата),
					Строка(ТекПартия.АналитикаУчетаПартийЗатрата),
					Строка(ПартияПродукции),
					Строка(АналитикаУчетаПартийПродукции));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.ОбнаруженЦикл",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
			КонецЕсли;
		КонецЕсли;
		
		// Добавляем строку в результат
		УсловиеДобавления = ПараметрыДерева.ТипРезультата = "ДеревоЗначений"
			ИЛИ ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат
			ИЛИ Не ТекПартия.ТребуетсяРазузлование;
		
		// ДИАГНОСТИКА: проверка, почему строка не добавляется
		Если НЕ УсловиеДобавления Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				"Строка НЕ добавлена: Затрата='%1', ТипРезультата='%2', ДобавлятьПолуфабрикаты=%3, ТребуетсяРазузлование=%4",
				Строка(ТекПартия.Затрата),
				ПараметрыДерева.ТипРезультата,
				Строка(ПараметрыДерева.ДобавлятьПолуфабрикатыВРезультат),
				Строка(ТекПартия.ТребуетсяРазузлование));
			ЗаписьЖурналаРегистрации(
				"СтруктураСебестоимости.Диагностика",
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				ТекстСообщения);
		КонецЕсли;
		
		Если УсловиеДобавления Тогда			
			СтрокаПартия = Результат.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаПартия, ТекПартия);
			
			// ДИАГНОСТИКА: Какие партии пришли из запроса? (ДО копирования)
			// Выводим для первых 15 затрат, чтобы не засорять лог
			Если ПараметрыДерева.ВыводитьДиагностику И ПараметрыДерева.СчётчикДиагностикиПартий < 15 Тогда
				ПараметрыДерева.СчётчикДиагностикиПартий = ПараметрыДерева.СчётчикДиагностикиПартий + 1;
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					" ДО копирования Ур%1: '%2' | ПартияЗатрата='%3' | ПартВыхИзд='%4'",
					Строка(УровеньУзла),
					Строка(ТекПартия.Затрата),
					Строка(ТекПартия.ПартияЗатрата),
					Строка(ТекПартия.ПартияВыходноеИзделие));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
			КонецЕсли;
			
			СтрокаПартия.Идентификатор = Новый УникальныйИдентификатор();
			Если ТекПартия.ТребуетсяРазузлование
				И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
				И (ТекПартия.СуммаЗатрата <> 0 ИЛИ ТекПартия.СуммаЗатратаЗабалансовая <> 0)
				И МассивСтрок.Количество() = 0 Тогда
				
				СтрокаПартия.ВидСтроки = Перечисления.ВидыСтрокДереваСебестоимости.ПартияПолуфабриката;
				СтрокаПартия.Числитель = ТекПартия.КоличествоЗатрата;
			Иначе
				СтрокаПартия.ВидСтроки = Перечисления.ВидыСтрокДереваСебестоимости.ПартияЗатраты;
				// КРИТИЧНО: НЕ перезаписываем ТребуетсяРазузлование!
				// Это поле уже правильно заполнено из запроса через ЗаполнитьЗначенияСвойств выше
				// и используется отчётом для фильтрации: ГДЕ ТребуетсяРазузлование ИЛИ ВидСтроки = Полуфабрикат
			КонецЕсли;
			
			// КРИТИЧНО: Заполняем поля партии продукции из запроса (ТекПартия)!
			// В запросе себестоимости эти поля называются ПартияВыходноеИзделие, АналитикаУчетаПартийВыходноеИзделие и т.д.
			// и содержат партию и аналитику РОДИТЕЛЬСКОЙ продукции (полуфабриката), в который входит текущая затрата.
			// ЗаполнитьЗначенияСвойств их НЕ копирует, т.к. имена полей разные!
			// Поэтому копируем их ЯВНО из ТекПартия в СтрокаПартия:
			СтрокаПартия.ПартияПродукции = ТекПартия.ПартияВыходноеИзделие;
			СтрокаПартия.АналитикаУчетаПартийПродукции = ТекПартия.АналитикаУчетаПартийВыходноеИзделие;
			СтрокаПартия.АналитикаУчетаПродукции = ТекПартия.АналитикаУчетаВыходноеИзделие;
			
			// ДИАГНОСТИКА: Что получилось ПОСЛЕ копирования?
			// Выводим для первых 15 затрат (счётчик уже увеличили выше)
			Если ПараметрыДерева.ВыводитьДиагностику И ПараметрыДерева.СчётчикДиагностикиПартий <= 15 Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"✅ ПОСЛЕ копирования Ур%1: '%2' | Партия='%3' | ПартПрод='%4'",
					Строка(УровеньУзла),
					Строка(СтрокаПартия.Номенклатура),
					Строка(СтрокаПартия.Партия),
					Строка(СтрокаПартия.ПартияПродукции));
				ЗаписьЖурналаРегистрации(
					"СтруктураСебестоимости.Диагностика",
					УровеньЖурналаРегистрации.Предупреждение,
					,
					,
					ТекстСообщения);
			КонецЕсли;
			
		// КРИТИЧНО: Заполняем аналитику выходного изделия
		// ПартияВыходноеИзделие = партия непосредственного РОДИТЕЛЯ (полуфабриката), 
		// в который входит текущий материал или полуфабрикат
		// ТекПартия приходит из запроса себестоимости и содержит поле ПартияВыходноеИзделие,
		// которое уже заполнено правильно (партия полуфабриката, в который входит материал)
		// Поля уже скопированы через ЗаполнитьЗначенияСвойств выше, поэтому
		// дополнительное заполнение не требуется - данные из запроса уже корректны!
			
			СтрокаПартия.Номенклатура = ТекПартия.Затрата;
			СтрокаПартия.Характеристика = ТекПартия.ХарактеристикаЗатрата;
			СтрокаПартия.Серия = ТекПартия.СерияЗатрата;
			СтрокаПартия.Назначение = ТекПартия.НазначениеЗатрата;
			СтрокаПартия.Партия = ТекПартия.ПартияЗатрата;
			СтрокаПартия.АналитикаУчетаПартий = ТекПартия.АналитикаУчетаПартийЗатрата;
			СтрокаПартия.ЕдиницаИзмерения = ТекПартия.ЕдиницаИзмеренияЗатрата;
			СтрокаПартия.Уровень = УровеньУзла;
			
			СтрокаПартия.Количество = ТекПартия.КоличествоЗатрата;
			СтрокаПартия.Сумма = Окр(ТекПартия.СуммаЗатрата, 2);
			СтрокаПартия.ДопРасходы = Окр(СтрокаПартия.ДопРасходы, 2);
			СтрокаПартия.НалоговыйУчет = Окр(СтрокаПартия.НалоговыйУчет, 2);
			СтрокаПартия.СуммаЗабалансовая = ТекПартия.СуммаЗатратаЗабалансовая;
			
			// Уменьшаем суммовые показатели в узле
			Если ПараметрыУзла.Сумма <> 0 ИЛИ ПараметрыУзла.СуммаЗабалансовая <> 0 Тогда
				ПараметрыУзла.Сумма = ПараметрыУзла.Сумма - СтрокаПартия.Сумма;
				ПараметрыУзла.Материальные = ПараметрыУзла.Материальные - СтрокаПартия.Материальные;
				ПараметрыУзла.ДопРасходы = ПараметрыУзла.ДопРасходы - СтрокаПартия.ДопРасходы;
				ПараметрыУзла.Трудозатраты = ПараметрыУзла.Трудозатраты - СтрокаПартия.Трудозатраты;
				ПараметрыУзла.ПостатейныеПеременные = ПараметрыУзла.ПостатейныеПеременные - СтрокаПартия.ПостатейныеПеременные;
				ПараметрыУзла.ПостатейныеПостоянные = ПараметрыУзла.ПостатейныеПостоянные - СтрокаПартия.ПостатейныеПостоянные;
				ПараметрыУзла.НалоговыйУчет = ПараметрыУзла.НалоговыйУчет - СтрокаПартия.НалоговыйУчет;
				ПараметрыУзла.ПостояннаяРазница = ПараметрыУзла.ПостояннаяРазница - СтрокаПартия.ПостояннаяРазница;
				ПараметрыУзла.ВременнаяРазница = ПараметрыУзла.ВременнаяРазница - СтрокаПартия.ВременнаяРазница;
				ПараметрыУзла.СуммаЗабалансовая = ПараметрыУзла.СуммаЗабалансовая - СтрокаПартия.СуммаЗабалансовая;
				
				ЭтоРазузлованиеДопРасходов = (ТекПартия.ТипЗатрат = "ДопРасходы");
			КонецЕсли;
		КонецЕсли;
		
		// Подготовка узла для следующего уровня
		Если (ТекПартия.ТребуетсяРазузлование
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И (ТекПартия.СуммаЗатрата <> 0 ИЛИ ТекПартия.СуммаЗатратаЗабалансовая <> 0)
			И МассивСтрок.Количество() = 0)
			ИЛИ (ТекПартия.ТребуетсяРазузлованиеДопРасходов
			И Окр(ТекПартия.КоличествоЗатрата, 3) <> 0
			И ТекПартия.ДопРасходы <> 0) Тогда
			
			ПараметрыУзлаПартии = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();
			
			// Добавляем партию в пройденный путь (НЕ для дополнительных расходов)
			Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
				НовыйПуть = ПройденныйПуть.Добавить();
				НовыйПуть.Партия = ТекПартия.ПартияЗатрата;
				НовыйПуть.АналитикаУчетаПартий = ТекПартия.АналитикаУчетаПартийЗатрата;
			КонецЕсли;
			
			Отборы = ПараметрыУзлаПартии.Отборы;
			Отборы.ДанныеПоСебестоимости = ПараметрыУзла.Отборы.ДанныеПоСебестоимости;
			Отборы.Продукция.Добавить(ТекПартия.Затрата);
			Отборы.ХарактеристикиПродукции.Добавить(ТекПартия.ХарактеристикаЗатрата);
			Отборы.СерииПродукции.Добавить(ТекПартия.СерияЗатрата);
			Отборы.ПартииПродукции.Добавить(ТекПартия.ПартияЗатрата);
			Отборы.АналитикиУчетаПартийПродукции.Добавить(ТекПартия.АналитикаУчетаПартийЗатрата);
			Отборы.АналитикаУчетаЗатрата.Добавить(ТекПартия.АналитикаУчетаЗатрата);
			Отборы.Числитель = ТекПартия.КоличествоЗатрата;
			Отборы.КоличествоПродукции = Макс(-ТекПартия.КоличествоЗатрата, ТекПартия.КоличествоЗатрата);
			Отборы.РазворачиватьДопРасходы = ПараметрыУзла.Отборы.РазворачиватьДопРасходы;
			Отборы.ДатаИсходнойПартии = ПараметрыУзла.Отборы.ДатаИсходнойПартии;
			Отборы.ДатаОкончания = ПараметрыУзла.Отборы.ДатаОкончания;
			Отборы.ВключитьНДСВСтоимость = ТекПартия.ВключитьНДСВСтоимость;
			Отборы.ИсключитьНДСИзСтоимости = ТекПартия.ИсключитьНДСИзСтоимости;
			Отборы.АналитикаУчетаВыходноеИзделие = ТекПартия.АналитикаУчетаЗатрата;
			Отборы.СтатьяКалькуляции = ТекПартия.СтатьяКалькуляции;
			
		Если ПараметрыДерева.ТипРезультата = "ДеревоЗначений" Тогда
			ТаблицаРезультатаПартии = СтрокаПартия;
		Иначе
			ТаблицаРезультатаПартии = Результат;
		КонецЕсли;
		
		// КРИТИЧНО: Заполняем ПараметрыУзлаПартии из ТекПартия (а не СтрокаПартия),
		// т.к. СтрокаПартия может быть не создана, если ДобавлятьПолуфабрикатыВРезультат = Ложь
		// Также в старом алгоритме это делается только для обычных партий (НЕ для дополнительных расходов)
		Если НЕ ТекПартия.ТребуетсяРазузлованиеДопРасходов Тогда
			ПараметрыУзлаПартии.Сумма = ТекПартия.СуммаЗатрата;
			ПараметрыУзлаПартии.Материальные = ТекПартия.Материальные;
			ПараметрыУзлаПартии.ДопРасходы = ТекПартия.ДопРасходы;
			ПараметрыУзлаПартии.Трудозатраты = ТекПартия.Трудозатраты;
			ПараметрыУзлаПартии.ПостатейныеПеременные = ТекПартия.ПостатейныеПеременные;
			ПараметрыУзлаПартии.ПостатейныеПостоянные = ТекПартия.ПостатейныеПостоянные;
			ПараметрыУзлаПартии.НалоговыйУчет = ТекПартия.НалоговыйУчет;
			ПараметрыУзлаПартии.ПостояннаяРазница = ТекПартия.ПостояннаяРазница;
			ПараметрыУзлаПартии.ВременнаяРазница = ТекПартия.ВременнаяРазница;
			ПараметрыУзлаПартии.СуммаЗабалансовая = ТекПартия.СуммаЗатратаЗабалансовая;
		КонецЕсли;
			
		НовоеОписаниеПродукции = Новый Структура("АналитикаУчетаПродукции, ПартияПродукции, АналитикаУчетаПартийПродукции");
		НовоеОписаниеПродукции.АналитикаУчетаПродукции = ТекПартия.АналитикаУчетаЗатрата;
		НовоеОписаниеПродукции.ПартияПродукции = ТекПартия.ПартияЗатрата;
		НовоеОписаниеПродукции.АналитикаУчетаПартийПродукции = ТекПартия.АналитикаУчетаПартийЗатрата;
		НовоеОписаниеПродукции.Вставить("Уровень", УровеньУзла);
		
		// Определяем СтрокаПартия: она существует только если УсловиеДобавления было Истина
		// В противном случае (полуфабрикат с ДобавлятьПолуфабрикатыВРезультат = Ложь)
		// передаем Неопределено
		СтрокаДляУзла = Неопределено;
		Если УсловиеДобавления Тогда
			СтрокаДляУзла = СтрокаПартия;
		КонецЕсли;
		
		НовыйУзел = Новый Структура;
		НовыйУзел.Вставить("ПараметрыУзла", ПараметрыУзлаПартии);
		НовыйУзел.Вставить("ТаблицаРезультата", ТаблицаРезультатаПартии);
		НовыйУзел.Вставить("ОписаниеПродукции", НовоеОписаниеПродукции);
		НовыйУзел.Вставить("СтрокаПартия", СтрокаДляУзла);
		
		УзлыСледующегоУровня.Добавить(НовыйУзел);
		КонецЕсли;
		
	КонецЦикла;
	
	// ДИАГНОСТИКА
	КоличествоПосле = Результат.Количество();
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		"ОбработатьРезультатыУзла: добавлено строк=%1 (было=%2, стало=%3), следующий уровень узлов=%4",
		Строка(КоличествоПосле - КоличествоДо),
		Строка(КоличествоДо),
		Строка(КоличествоПосле),
		Строка(УзлыСледующегоУровня.Количество()));
	ЗаписьЖурналаРегистрации(
		"СтруктураСебестоимости.Диагностика",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		ТекстСообщения);
		
	// При наличии данных о разузловании добавим строку на суммы изменения стоимости
	Если СебестоимостьУзла.Количество() > 0 И НЕ ЭтоРазузлованиеДопРасходов Тогда
		УчестьИзменениеСтоимости(ПараметрыУзла, ОписаниеПродукции, Результат);
	КонецЕсли;
	
КонецПроцедуры   

// Пакетное получение себестоимости для нескольких узлов одним запросом (оптимизация N+1)
//
// Параметры:
//  МассивПараметровУзлов - Массив из Структура - Массив параметров узлов для обработки
//  ВыводитьДопРасходы - Булево - Выводить ли дополнительные расходы
//  ОбщиеПараметры - Структура - Общие параметры для всех узлов (ДанныеПоСебестоимости и т.д.)
//
// Возвращаемое значение:
//  Соответствие - Ключ: идентификатор узла (Партия+АналитикаПартий), Значение: ТаблицаЗначений с данными себестоимости
//
Функция СебестоимостьУзловПакетом(МассивПараметровУзлов, ВыводитьДопРасходы, ОбщиеПараметры)
	
	Если МассивПараметровУзлов.Количество() = 0 Тогда
		Возврат Новый Соответствие;
	КонецЕсли;
	
	// Собираем все партии и аналитики для пакетного запроса
	ВсеПартииПродукции = Новый Массив;
	ВсеАналитикиУчетаПартийПродукции = Новый Массив;
	ВсеПродукция = Новый Массив;
	ВсеХарактеристики = Новый Массив;
	ВсеСерии = Новый Массив;
	ВсеНазначения = Новый Массив;
	
	Для Каждого ПараметрыУзла Из МассивПараметровУзлов Цикл
		Отборы = ПараметрыУзла.Отборы;
		
		Для Каждого Партия Из Отборы.ПартииПродукции Цикл
			Если ВсеПартииПродукции.Найти(Партия) = Неопределено Тогда
				ВсеПартииПродукции.Добавить(Партия);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Аналитика Из Отборы.АналитикиУчетаПартийПродукции Цикл
			Если ВсеАналитикиУчетаПартийПродукции.Найти(Аналитика) = Неопределено Тогда
				ВсеАналитикиУчетаПартийПродукции.Добавить(Аналитика);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Продукция Из Отборы.Продукция Цикл
			Если ВсеПродукция.Найти(Продукция) = Неопределено Тогда
				ВсеПродукция.Добавить(Продукция);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Характеристика Из Отборы.ХарактеристикиПродукции Цикл
			Если ВсеХарактеристики.Найти(Характеристика) = Неопределено Тогда
				ВсеХарактеристики.Добавить(Характеристика);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Серия Из Отборы.СерииПродукции Цикл
			Если ВсеСерии.Найти(Серия) = Неопределено Тогда
				ВсеСерии.Добавить(Серия);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Назначение Из Отборы.НазначенияПродукции Цикл
			Если ВсеНазначения.Найти(Назначение) = Неопределено Тогда
				ВсеНазначения.Добавить(Назначение);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// Создаем объединенные параметры для пакетного запроса
	ПараметрыУзлаОбъединенные = СтруктураСебестоимости.ПараметрыУзлаДереваСебестоимости();
	ОтборыОбъединенные = ПараметрыУзлаОбъединенные.Отборы;
	
	// Копируем общие параметры из первого узла (они должны быть одинаковыми)
	ПервыйУзел = МассивПараметровУзлов[0];
	ОтборыОбъединенные.ДанныеПоСебестоимости = ПервыйУзел.Отборы.ДанныеПоСебестоимости;
	ОтборыОбъединенные.РазворачиватьДопРасходы = ПервыйУзел.Отборы.РазворачиватьДопРасходы;
	ОтборыОбъединенные.ДатаОкончания = ПервыйУзел.Отборы.ДатаОкончания;
	ОтборыОбъединенные.ДатаИсходнойПартии = ПервыйУзел.Отборы.ДатаИсходнойПартии;
	
	// Устанавливаем объединенные массивы
	ОтборыОбъединенные.ПартииПродукции = ВсеПартииПродукции;
	ОтборыОбъединенные.АналитикиУчетаПартийПродукции = ВсеАналитикиУчетаПартийПродукции;
	ОтборыОбъединенные.Продукция = ВсеПродукция;
	ОтборыОбъединенные.ХарактеристикиПродукции = ВсеХарактеристики;
	ОтборыОбъединенные.СерииПродукции = ВсеСерии;
	ОтборыОбъединенные.НазначенияПродукции = ВсеНазначения;
	
	// Выполняем один запрос для всех узлов
	Запрос = ЗапросВыпущеннаяПродукция(ПараметрыУзлаОбъединенные, Истина);
	Запрос.Текст = Запрос.Текст + ТекстЗапросаЗатратыНаПродукцию(ВыводитьДопРасходы);
	
	ВсеДанные = Запрос.Выполнить().Выгрузить();
	
	// Временное решение: возвращаем все данные для всех узлов
	// В реальности каждый узел работает с общим набором данных,
	// и фильтрация происходит на уровне обработки через проверки циклов
	// и условий разузлования
	РезультатПоУзлам = Новый Соответствие;
	
	Для Каждого ПараметрыУзла Из МассивПараметровУзлов Цикл
		КлючУзла = СоздатьКлючУзла(ПараметрыУзла);
		// Возвращаем все данные - они уже отфильтрованы запросом по объединенным условиям
		// Каждый узел сам выберет подходящие строки на основе своих отборов
		РезультатПоУзлам.Вставить(КлючУзла, ВсеДанные);
	КонецЦикла;
	
	Возврат РезультатПоУзлам;
	
КонецФункции

// Создает уникальный ключ для узла на основе его параметров
Функция СоздатьКлючУзла(ПараметрыУзла)
	
	Отборы = ПараметрыУзла.Отборы;
	
	КлючПартии = "";
	Для Каждого Партия Из Отборы.ПартииПродукции Цикл
		КлючПартии = КлючПартии + Строка(Партия.УникальныйИдентификатор()) + ";";
	КонецЦикла;
	
	КлючАналитики = "";
	Для Каждого Аналитика Из Отборы.АналитикиУчетаПартийПродукции Цикл
		КлючАналитики = КлючАналитики + Строка(Аналитика.УникальныйИдентификатор()) + ";";
	КонецЦикла;
	
	Возврат КлючПартии + "|" + КлючАналитики;
	
КонецФункции


//	#Удаление
//	#КонецУдаления
//	#Вставка
// 	#КонецВставки

