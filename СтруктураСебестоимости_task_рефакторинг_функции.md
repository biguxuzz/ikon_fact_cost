# Рефакторинг функции ikon_cost_ТекстЗапросаЗатратыНаПродукцию

## Контекст

Функция [`ikon_cost_ТекстЗапросаЗатратыНаПродукцию`](CommonModules/СтруктураСебестоимости/Ext/Module.bsl) (строки 2341-5347) содержит ~3000 строк и формирует SQL-запросы для расчета затрат на продукцию. Проблема: текущий размер функции делает невозможным безопасное внесение изменений.

## Структура текущей функции

Функция состоит из следующих логических блоков (каждый формирует фрагмент SQL):

1. **ВыбытиеИзНЗППоПродукции** (строки 2348-2522) — основной запрос материальных затрат
2. **ВыбывшиеЗатратыСводно** (строки 2525-2550) — сводка выбывших затрат
3. **ПартииПроизводства** (строки 2553-2562) — список партий для обработки
4. **ВыбытиеИзНЗП** (строки 2565-2610) — детализация выбытия из НЗП
5. **ПервичныеПартииВНЗП** (строки 2613-3339) — первичные партии с тремя ОБЪЕДИНИТЬ ВСЕ
6. **ДетализацияПартий** (строки 3342-3529) — детализация партий производства
7. **ЗатратыНаПродукциюПоВсемКомпонентам** (строки 3531-4101) — затраты по всем компонентам
8. **ВыборкаДопРасходовПоТоварам** (строки 4104-4734) — доп расходы по товарам (условно, если `ВыводитьДопРасходы`)
9. **ВыборкаДопРасходовПоПартиям** (строки 4736-5340) — доп расходы по партиям (условно, если `ВыводитьДопРасходы`)

## План рефакторинга

### 1. Создание вспомогательных функций

Разбить большую функцию на 9 отдельных функций, каждая из которых возвращает текст SQL-запроса для своей части:

```bsl
Функция ТекстЗапроса_ВыбытиеИзНЗППоПродукции()
Функция ТекстЗапроса_ВыбывшиеЗатратыСводно()
Функция ТекстЗапроса_ПартииПроизводства()
Функция ТекстЗапроса_ВыбытиеИзНЗП()
Функция ТекстЗапроса_ПервичныеПартииВНЗП()
Функция ТекстЗапроса_ДетализацияПартий()
Функция ТекстЗапроса_ЗатратыНаПродукциюПоВсемКомпонентам()
Функция ТекстЗапроса_ВыборкаДопРасходовПоТоварам()
Функция ТекстЗапроса_ВыборкаДопРасходовПоПартиям()
```



### 2. Модификация основной функции

Упростить `ikon_cost_ТекстЗапросаЗатратыНаПродукцию` до композиции вызовов:

```bsl
Функция ikon_cost_ТекстЗапросаЗатратыНаПродукцию(ВыводитьДопРасходы)
    ТекстыЗапроса = Новый Массив;
    
    ТекстМатериальныеЗатраты = 
        ТекстЗапроса_ВыбытиеИзНЗППоПродукции()
    + ТекстЗапроса_ВыбывшиеЗатратыСводно()
    + ТекстЗапроса_ПартииПроизводства()
    + ТекстЗапроса_ВыбытиеИзНЗП()
    + ТекстЗапроса_ПервичныеПартииВНЗП()
    + ТекстЗапроса_ДетализацияПартий();
    
    ТекстыЗапроса.Добавить(ТекстЗапроса_ЗатратыНаПродукциюПоВсемКомпонентам());
    
    Если ВыводитьДопРасходы Тогда
        ТекстыЗапроса.Добавить(ТекстЗапроса_ВыборкаДопРасходовПоТоварам());
        ТекстыЗапроса.Добавить(ТекстЗапроса_ВыборкаДопРасходовПоПартиям());
    КонецЕсли;
    
    Возврат ТекстМатериальныеЗатраты + СтрСоединить(ТекстыЗапроса, " ОБЪЕДИНИТЬ ВСЕ ");
КонецФункции
```



### 3. Обновление версии

Обновить версию в двух местах:

- [`Configuration.xml`](Configuration.xml) — увеличить последний компонент версии (например, 0.1.0.74 → 0.1.0.75)
- [`CommonModules/СтруктураСебестоимости/Ext/Module.bsl`](CommonModules/СтруктураСебестоимости/Ext/Module.bsl) — в функции `ikon_cost_ПараметрыДереваСебестоимости` обновить версию в первой записи журнала регистрации

### 4. Валидация

После рефакторинга необходимо:

1. Развернуть изменения в тестовую базу (команда из правила 7)
2. Запустить отчет через инструмент `prod_cost_ext` за период 01.01.2025-31.12.2025
3. Проверить журнал регистрации на отсутствие ошибок применения расширения

## Преимущества подхода

- **Модульность**: каждая функция отвечает за свою часть запроса
- **Тестируемость**: можно проверять каждую часть отдельно
- **Готовность к интеграции**: в каждую функцию легко добавить поддержку `ВТУзлыУровня`
- **Читаемость**: основная функция становится декларативной
- **Безопасность**: изменения в одной части не затронут другие