# Рефакторинг функции ikon_cost_ТекстЗапросаЗатратыНаПродукцию

## Контекст

Функция [`ikon_cost_ТекстЗапросаЗатратыНаПродукцию`](CommonModules/СтруктураСебестоимости/Ext/Module.bsl) (строки 2341-5347) содержит ~3000 строк и формирует SQL-запросы для расчета затрат на продукцию. Проблема: текущий размер функции делает невозможным безопасное внесение изменений.

## Структура текущей функции

Функция состоит из следующих логических блоков (каждый формирует фрагмент SQL):

1. **ВыбытиеИзНЗППоПродукции** (строки 2348-2522) — основной запрос материальных затрат
2. **ВыбывшиеЗатратыСводно** (строки 2525-2550) — сводка выбывших затрат
3. **ПартииПроизводства** (строки 2553-2562) — список партий для обработки
4. **ВыбытиеИзНЗП** (строки 2565-2610) — детализация выбытия из НЗП
5. **ПервичныеПартииВНЗП** (строки 2613-3339) — первичные партии с тремя ОБЪЕДИНИТЬ ВСЕ
6. **ДетализацияПартий** (строки 3342-3529) — детализация партий производства
7. **ЗатратыНаПродукциюПоВсемКомпонентам** (строки 3531-4101) — затраты по всем компонентам
8. **ВыборкаДопРасходовПоТоварам** (строки 4104-4734) — доп расходы по товарам (условно, если `ВыводитьДопРасходы`)
9. **ВыборкаДопРасходовПоПартиям** (строки 4736-5340) — доп расходы по партиям (условно, если `ВыводитьДопРасходы`)

## План рефакторинга

### 1. Создание вспомогательных функций

Разбить большую функцию на 9 отдельных функций, каждая из которых возвращает текст SQL-запроса для своей части:

```bsl
Функция ТекстЗапроса_ВыбытиеИзНЗППоПродукции()
Функция ТекстЗапроса_ВыбывшиеЗатратыСводно()
Функция ТекстЗапроса_ПартииПроизводства()
Функция ТекстЗапроса_ВыбытиеИзНЗП()
Функция ТекстЗапроса_ПервичныеПартииВНЗП()
Функция ТекстЗапроса_ДетализацияПартий()
Функция ТекстЗапроса_ЗатратыНаПродукциюПоВсемКомпонентам()
Функция ТекстЗапроса_ВыборкаДопРасходовПоТоварам()
Функция ТекстЗапроса_ВыборкаДопРасходовПоПартиям()
```



### 2. Модификация основной функции

Упростить `ikon_cost_ТекстЗапросаЗатратыНаПродукцию` до композиции вызовов:

```bsl
Функция ikon_cost_ТекстЗапросаЗатратыНаПродукцию(ВыводитьДопРасходы)
    ТекстыЗапроса = Новый Массив;
    
    ТекстМатериальныеЗатраты = 
        ТекстЗапроса_ВыбытиеИзНЗППоПродукции()
    + ТекстЗапроса_ВыбывшиеЗатратыСводно()
    + ТекстЗапроса_ПартииПроизводства()
    + ТекстЗапроса_ВыбытиеИзНЗП()
    + ТекстЗапроса_ПервичныеПартииВНЗП()
    + ТекстЗапроса_ДетализацияПартий();
    
    ТекстыЗапроса.Добавить(ТекстЗапроса_ЗатратыНаПродукциюПоВсемКомпонентам());
    
    Если ВыводитьДопРасходы Тогда
        ТекстыЗапроса.Добавить(ТекстЗапроса_ВыборкаДопРасходовПоТоварам());
        ТекстыЗапроса.Добавить(ТекстЗапроса_ВыборкаДопРасходовПоПартиям());
    КонецЕсли;
    
    Возврат ТекстМатериальныеЗатраты + СтрСоединить(ТекстыЗапроса, " ОБЪЕДИНИТЬ ВСЕ ");
КонецФункции
```



### 3. Обновление версии

Обновить версию в двух местах:

- [`Configuration.xml`](Configuration.xml) — увеличить последний компонент версии (например, 0.1.0.74 → 0.1.0.75)
- [`CommonModules/СтруктураСебестоимости/Ext/Module.bsl`](CommonModules/СтруктураСебестоимости/Ext/Module.bsl) — в функции `ikon_cost_ПараметрыДереваСебестоимости` обновить версию в первой записи журнала регистрации

### 4. Валидация

После рефакторинга необходимо:

1. Развернуть изменения в тестовую базу (команда из правила 7)
2. Запустить отчет через инструмент `prod_cost_ext` за период 01.01.2025-31.12.2025
3. Проверить журнал регистрации на отсутствие ошибок применения расширения

## Преимущества подхода

- **Модульность**: каждая функция отвечает за свою часть запроса
- **Тестируемость**: можно проверять каждую часть отдельно
- **Готовность к интеграции**: в каждую функцию легко добавить поддержку `ВТУзлыУровня`
- **Читаемость**: основная функция становится декларативной
- **Безопасность**: изменения в одной части не затронут другие

## Выполненная работа

### Статус: ✅ Рефакторинг завершен

**Финальная версия:** 0.1.1.133

### Созданные функции

Все блоки функции `ikon_cost_ТекстЗапросаЗатратыНаПродукцию` были вынесены в отдельные функции:

1. ✅ `ikon_cost_ТекстЗапроса_ВыбытиеИзНЗППоПродукции()` — создание временной таблицы ВыбытиеИзНЗППоПродукции
2. ✅ `ikon_cost_ТекстЗапроса_ВыбывшиеЗатратыСводно()` — выбывшие затраты сводно
3. ✅ `ikon_cost_ТекстЗапроса_ПартииПроизводства()` — партии производства
4. ✅ `ikon_cost_ТекстЗапроса_ВыбытиеИзНЗП()` — выбытие из НЗП
5. ✅ `ikon_cost_ТекстЗапроса_ПервичныеПартииВНЗП()` — первичные партии в НЗП
6. ✅ `ikon_cost_ТекстЗапроса_ДетализацияПартий()` — детализация партий
7. ✅ `ikon_cost_ТекстЗапроса_ПриходыНарастающимИтогом()` — приходы нарастающим итогом
8. ✅ `ikon_cost_ТекстЗапроса_РасходыНарастающимИтогом()` — расходы нарастающим итогом
9. ✅ `ikon_cost_ТекстЗапроса_НулевыеПериоды()` — нулевые периоды
10. ✅ `ikon_cost_ТекстЗапроса_ИнтервалыРасходаПартий()` — интервалы расхода партий
11. ✅ `ikon_cost_ТекстЗапроса_ПриходыНарастающимИтогомПоИнтервалам()` — приходы нарастающим итогом по интервалам
12. ✅ `ikon_cost_ТекстЗапроса_ПредварительныйРасходПартий()` — предварительный расход партий
13. ✅ `ikon_cost_ТекстЗапроса_ПартииСводно()` — партии сводно
14. ✅ `ikon_cost_ТекстЗапроса_РасходПартийСводно()` — расход партий сводно
15. ✅ `ikon_cost_ТекстЗапроса_ПервичныеЗатратыПоПериодам()` — первичные затраты по периодам
16. ✅ `ikon_cost_ТекстЗапроса_ПервичныеПартииСводно()` — первичные партии сводно
17. ✅ `ikon_cost_ТекстЗапроса_ПартииПолуфабрикатов()` — партии полуфабрикатов
18. ✅ `ikon_cost_ТекстЗапроса_ТекстМатериальныеЗатратыОбъединение()` — объединение материальных затрат
19. ✅ `ikon_cost_ТекстЗапроса_ТекстМатериалыНачальныеОстаткиНЗПОбъединение()` — объединение начальных остатков НЗП
20. ✅ `ikon_cost_ТекстЗапроса_ТекстТрудозатратыОбъединение()` — объединение трудозатрат
21. ✅ `ikon_cost_ТекстЗапроса_ТекстПрочиеРасходыОбъединение()` — объединение прочих расходов
22. ✅ `ikon_cost_ТекстЗапроса_ТекстДопРасходыОбъединение()` — объединение дополнительных расходов

### Результат рефакторинга

Основная функция `ikon_cost_ТекстЗапросаЗатратыНаПродукцию` теперь компактна и читаема:
- Инициализирует переменные
- Вызывает вспомогательные функции для формирования SQL-запросов
- Объединяет результаты через `ОБЪЕДИНИТЬ ВСЕ`

### Тестирование

После каждого шага рефакторинга выполнялось тестирование:
- ✅ Отчет `prod_cost_ext` (новый алгоритм) — работает корректно
- ✅ Отчет `prod_cost` (старый алгоритм) — работает корректно
- ✅ Журнал регистрации — ошибок применения расширения нет

### Важные замечания

1. **Ключевое слово РАЗРЕШЕННЫЕ**: используется только в первой функции `ikon_cost_ТекстЗапроса_ВыбытиеИзНЗППоПродукции()`, так как это первый запрос в цепочке
2. **Временные таблицы**: порядок создания временных таблиц сохранен — каждая функция создает таблицы в правильной последовательности
3. **Условие ВыводитьДопРасходы**: сохранено в основной функции для блока `ТекстДопРасходыОбъединение`
4. **Совместимость**: результаты нового и старого алгоритмов идентичны